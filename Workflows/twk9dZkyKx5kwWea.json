{"updatedAt":"2025-11-21T18:12:31.224Z","createdAt":"2025-11-20T17:36:40.731Z","id":"twk9dZkyKx5kwWea","name":"[EMKT] UaZapi x Chatwoot v1.0.1-Premium","active":true,"isArchived":false,"nodes":[{"parameters":{"content":"## Tratamento Inicial dos Dados","height":464,"width":860},"type":"n8n-nodes-base.stickyNote","position":[-112,512],"typeVersion":1,"id":"c44eb760-b8fc-4285-96e8-683d8735b4fd","name":"Sticky Note"},{"parameters":{"content":"## InÃ­cio do Processamento","height":1396,"width":208},"type":"n8n-nodes-base.stickyNote","position":[-336,512],"typeVersion":1,"id":"1aa41e65-7ad1-41f0-ae39-a91d2d135ebb","name":"Sticky Note1"},{"parameters":{"content":"## Tratamento do Contato","height":464,"width":1560},"type":"n8n-nodes-base.stickyNote","position":[768,512],"typeVersion":1,"id":"bcc9998f-29fd-465c-99ac-2e34887d4465","name":"Sticky Note2"},{"parameters":{"content":"## Tratamento da Conversa","height":912,"width":860},"type":"n8n-nodes-base.stickyNote","position":[-112,992],"typeVersion":1,"id":"682875c3-dd44-48b6-ba39-87091dd3a814","name":"Sticky Note3"},{"parameters":{"content":"## Tratamento da Mensagem","height":912,"width":1032},"type":"n8n-nodes-base.stickyNote","position":[768,992],"typeVersion":1,"id":"56d205ae-cfe4-4966-a2fd-0bb5fbbe4c69","name":"Sticky Note4"},{"parameters":{"content":"## Final do Processamento","height":1396,"width":208},"type":"n8n-nodes-base.stickyNote","position":[2352,512],"typeVersion":1,"id":"cbc6f3e8-110a-416c-a101-7a3d99e43436","name":"Sticky Note5"},{"parameters":{"content":"```\n                                                                                                                  â–ˆâ–ˆâ–ˆ       â–ˆ                            â–ˆâ–ˆ          â–ˆ   â–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â–ˆ             â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ          â–ˆ                   â–ˆ\n                                                                                                                   â–ˆ       â–ˆâ–ˆâ–ˆ                                       â–ˆ   â–ˆ          â–ˆ                         â–ˆ     â–ˆ         â–ˆâ–ˆâ–ˆ                 â–ˆâ–ˆâ–ˆ\n                                                                                                                   â–ˆ  â–ˆ â–ˆâ–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆ   â–ˆ    â–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ            â–ˆ    â–ˆâ–ˆâ–ˆ    â–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n                                                                                                                   â–ˆ  â–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆ      â–ˆ â–ˆ       â–ˆ â–ˆ  â–ˆ    â–ˆ   â–ˆ    â–ˆ   â–ˆ      â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ     â–ˆ     â–ˆ  â–ˆ    â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ           â–ˆâ–ˆ    â–ˆ â–ˆ   â–ˆâ–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ    â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ      â–ˆ      â–ˆ     â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ   â–ˆ    â–ˆ â–ˆ    â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ  â–ˆ    â–ˆ   â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ     â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ   â–ˆ    â–ˆ â–ˆ    â–ˆ     â–ˆ    â–ˆ â–ˆ  â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                                  â–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆ   â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆ â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ      â–ˆ   â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ    â–ˆ    â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                                                       â–ˆ             â–ˆ                                     â–ˆ\n                                                                                                                                    â–ˆâ–ˆâ–ˆâ–ˆ            â–ˆ                                      â–ˆ\n```","height":200,"width":3680,"color":7},"type":"n8n-nodes-base.stickyNote","position":[-1120,288],"typeVersion":1,"id":"739a9a2b-0c3b-41d3-a8b6-2298cc075467","name":"Sticky Note7"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[448,576],"id":"1a2d94c2-f8c0-4237-9800-fdfc4f3de686","name":"groupEndProcess"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[624,656],"id":"f4d6271d-46b7-4485-b763-b37e4d3c32a9","name":"fromMeEndProcess"},{"parameters":{"assignments":{"assignments":[{"id":"663ff314-a7aa-44b1-bfa8-22ae64a23870","name":"chatwoot","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:        s.chatwoot_base_url,\n    api_version:     s.chatwoot_api_version,\n    token:           s.chatwoot_token,\n    account_id:      s.chatwoot_account_id,\n    inbox_id:        s.chatwoot_inbox_id,\n    inbox_name:      s.chatwoot_inbox_name,\n    track_id:        s.chatwoot_track_id,\n    reply_messages:  s.reply_messages,\n    edit_messages:   s.edit_messages,\n    delete_messages: s.delete_messages\n  };\n})() }}","type":"object"},{"id":"a1a2a399-dea0-4f58-a284-8d38994ea182","name":"api","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:          s.api_base_url,\n    token:             s.api_token,\n    api_instance_name: s.api_instance_name,\n  };\n})() }}","type":"object"},{"id":"65102415-5231-44cb-b3e0-5c98dce21850","name":"integration","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json ?? {};\n  return {\n    ignore_groups:        s.ignore_groups ?? false,\n    reply_messages:       s.reply_messages ?? false,\n    edit_messages:        s.edit_messages ?? false,\n    delete_messages:      s.delete_messages ?? false,\n    reopen_conversation:  s.reopen_conversation ?? false,\n    conversation_pending: s.conversation_pending ?? false,\n    import_contacts:      s.import_contacts ?? false,\n    import_messages:      s.import_messages ?? false,\n    import_days_limit:    s.import_days_limit ?? 0,\n    sign_messages:        s.sign_messages ?? false,\n    sign_delimiter:       s.sign_delimiter ?? ''\n  };\n})() }}","type":"object"},{"id":"45d1d87f-ee7c-4b90-ba59-b14d8874f4dc","name":"group.id","value":"={{ \n  (() => {\n    const msg = $('webhookDataUazapi')?.item?.json?.body.message\n    return msg?.isGroup ? (msg?.chatid || '') : ''\n  })()\n}}","type":"string"},{"id":"0d3da5a5-b975-440f-94b3-3c63531c3edf","name":"group.name","value":"={{\n  (() => {\n    const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n    return msg?.isGroup ? `[ðŸ‘¥] ${msg?.groupName || ''}` : ''\n  })()\n}}","type":"string"},{"id":"e1726d06-91bc-4e48-9361-dec6435db7d1","name":"group.contact","value":"={{\n  (() => {\n    const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n    if (!msg?.isGroup) return ''\n    const number = msg?.sender_pn?.split('@')?.[0] ?? ''\n    const name = (msg?.senderName ?? '')\n      .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n      .trim() || 'Contato'\n    return `[ðŸ‘¤] +${number} | ${name}`\n  })()\n}}","type":"string"},{"id":"e058c51f-71a0-43f3-8cae-448a8c1ccfb2","name":"contact.identifier","value":"={{\n(() => {\n  const base = $('webhookDataUazapi')?.item?.json?.body ?? {};\n  const id1 = base.message?.chatid ?? '';\n  const id2 = base.message?.sender_pn ?? '';\n  const id3 = base.event?.Chat ?? '';\n  const ids = [id1, id2, id3];\n  const whatsappId = ids.find(id => \n    id.endsWith('@s.whatsapp.net') || id.endsWith('@g.us')\n  );\n  if (whatsappId) {\n    return whatsappId;\n  }\n  const lidId = ids.find(id => id.endsWith('@lid'));\n  if (lidId) {\n    return lidId;\n  }\n  return '';\n})()\n}}","type":"string"},{"id":"abf09a47-2772-48d3-b4f7-b0c6b15a69b9","name":"contact.lid","value":"={{\n(() => {\n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message;\n  const isFromMe = !!(msg?.fromMe);\n  const isGroup = !!(msg?.isGroup);\n  if (isFromMe || isGroup) {\n    return '';\n  }\n  return String(msg?.sender_lid ?? '');\n})()\n}}","type":"string"},{"id":"e2ce78a3-4599-483f-be1c-8e96122eeaef","name":"contact.phone_number","value":"={{\n(() => {\n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message ?? {};\n  const chatid = msg.chatid ?? '';\n  const sender_pn = msg.sender_pn ?? '';\n  if (chatid) {\n    if (chatid.endsWith('@g.us') || chatid.endsWith('@lid')) {\n      return '';\n    }\n    if (chatid.endsWith('@s.whatsapp.net')) {\n      const number = chatid.split('@')[0];\n      return '+' + number;\n    }\n  }\n  if (sender_pn && sender_pn.endsWith('@s.whatsapp.net')) {\n    const number = sender_pn.split('@')[0];\n    return '+' + number;\n  }\n  return '';\n})()\n}}","type":"string"},{"id":"4832617f-aafc-4cbf-8fa5-e2502deb7143","name":"contact.full_name","value":"={{\n  (() => {\n    const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n    if (msg?.fromMe) return 'Contato'\n    const raw = msg?.senderName ?? ''\n    const s = raw.normalize('NFKC')\n      .replace(/[^\\p{L}\\p{M}\\s'\\-]/gu,'')\n      .replace(/\\s+/g,' ')\n      .trim()\n    return s || 'Contato'\n  })()\n}}","type":"string"},{"id":"4a7df58d-d6f7-42ba-a09d-5b04910c0555","name":"contact.first_name","value":"={{ (() => { \n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n  if (msg?.fromMe) return 'Contato'\n  const parts = String(msg?.senderName ?? '')\n    .normalize('NFKC')\n    .replace(/[^\\p{L}\\p{M}\\s'-]/gu,'')\n    .replace(/\\s+/g,' ')\n    .trim()\n    .split(' ')\n    .filter(Boolean)\n  return parts[0] || 'Contato'\n})() }}","type":"string"},{"id":"feb8da01-d39a-4571-a215-c93f838b1cd6","name":"contact.middle_name","value":"={{ (() => { \n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n  if (msg?.fromMe) return ''\n  const s = String(msg?.senderName ?? '')\n    .normalize('NFKC')\n    .replace(/[^\\p{L}\\p{M}\\s'-]/gu,'')\n    .replace(/\\s+/g,' ')\n    .trim()\n  if (!s) return ''\n  const parts = s.split(' ').filter(Boolean)\n  return parts.length > 2 ? parts.slice(1, -1).join(' ') : ''\n})() }}","type":"string"},{"id":"13f61b17-5053-42d7-a613-ac7ab0cfabc3","name":"contact.last_name","value":"={{ (() => { \n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n  if (msg?.fromMe) return ''\n  const s = String(msg?.senderName ?? '')\n    .normalize('NFKC')\n    .replace(/[^\\p{L}\\p{M}\\s'-]/gu,'')\n    .replace(/\\s+/g,' ')\n    .trim()\n  const parts = s.split(' ').filter(Boolean)\n  return parts.length > 1 ? parts.at(-1) : ''\n})() }}","type":"string"},{"id":"d50b534d-b02f-43a7-a038-3f6719d47b9b","name":"contact.avatar","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.chat?.imagePreview ??\n  ''\n}}","type":"string"},{"id":"0f64c0d8-fad3-420d-999e-6e6230ac23e3","name":"data.source","value":"={{\n  (\n    $('webhookDataUazapi')?.item?.json?.body?.message?.source ??\n    ''\n  )\n  .trim()\n}}","type":"string"},{"id":"23e6b810-0252-4617-bf33-5ef2a8bdb715","name":"data.message_type","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.messageType ??\n  ''\n}}","type":"string"},{"id":"e1b0aeeb-7b3e-46b3-a6ce-049cc9dcc58f","name":"data.message_id","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.messageid ??\n  ''\n}}","type":"string"},{"id":"9b436741-480b-467b-bb9b-d3c3a3d9980b","name":"data.reply_id","value":"={{\n(() => {\n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message ?? {};\n  const quoted   = String(msg.quoted   ?? '').trim();\n  const reaction = String(msg.reaction ?? '').trim();\n  if (quoted)   return quoted;\n  if (reaction) return reaction;\n  return '';\n})()\n}}","type":"string"},{"id":"8821e853-de4f-4009-8cab-4958f4c99868","name":"data.edited_id","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.edited ??\n  ''\n}}","type":"string"},{"id":"42eb43cf-4dfe-49b1-adf9-9096ec65a663","name":"data.deleted_id","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.event?.MessageIDs?.[0] ??\n  ''\n}}","type":"string"},{"id":"d6eb38ee-31f5-4953-bb1e-086a8dfd4e13","name":"data.message_direction","value":"={{\n  (\n    $('webhookDataUazapi')?.item?.json?.body?.message?.fromMe ??\n    false\n  ) ?\n    'outgoing' :\n    'incoming'\n}}","type":"string"},{"id":"cfba5c5e-18cf-4f29-9840-561c1f5a2be8","name":"data.content","value":"={{\n(() => {\nÂ  // =================================================================\nÂ  // FUNÃ‡ÃƒO AUXILIAR: ConversÃ£o de Markdown (WhatsApp -> Chatwoot)\nÂ  // =================================================================\nÂ  const convertMarkdown = (text) => {\nÂ  Â  if (typeof text !== 'string' || !text) {\nÂ  Â  Â  return '';\nÂ  Â  }\n\nÂ  Â  return text\nÂ  Â  Â  // --- BLOCO DE LIMPEZA DE CARACTERES ---\nÂ  Â  Â  .replace(/\\t/g, ' ')Â  Â  Â // TabulaÃ§Ã£o Horizontal\nÂ  Â  Â  .replace(/\\v/g, '')Â  Â  Â  // TabulaÃ§Ã£o Vertical\nÂ  Â  Â  .replace(/\\f/g, '')Â  Â  Â  // Form Feed (quebra de pÃ¡gina)\nÂ  Â  Â  .replace(/\\u200B/g, '')Â  // Zero-Width Space\nÂ  Â  Â  .replace(/\\uFEFF/g, '')Â  // Byte Order Mark (BOM)\nÂ  Â  Â  .replace(/\\r/g, '')Â  Â  Â  // Carriage Return (Normaliza quebra de linha)\nÂ  Â  Â  .replace(/\\u00A0/g, ' ') // Non-Breaking Space\nÂ  Â  Â Â \nÂ  Â  Â  // --- BLOCO DE CONVERSÃƒO MARKDOWN ---\nÂ  Â  Â  .replace(/```(.*?)```/gs, '`$1`') // MonoespaÃ§ado\nÂ  Â  Â  .replace(/\\*(.*?)\\*/gs, '**$1**') // Negrito\nÂ  Â  Â  .replace(/_(.*?)_/gs, '*$1*')Â  Â  Â // ItÃ¡lico\nÂ  Â  Â  .replace(/~(.*?)~/gs, '~~$1~~');Â  // Riscado\nÂ  };\n\nÂ  // =================================================================\nÂ  // FUNÃ‡ÃƒO AUXILIAR: FormataÃ§Ã£o de Moeda para Produto e PIX\nÂ  // =================================================================\nÂ  const formatCurrency = (value, offset, currencyCode = 'BRL') => {\nÂ  Â  // Verifica se os valores sÃ£o vÃ¡lidos\nÂ  Â  if (value === undefined || value === null) return '';\nÂ  Â Â \nÂ  Â  // Usa o offset para calcular o valor real. PadrÃ£o 1000 se nÃ£o vier.\nÂ  Â  const divisor = offset || 1000;Â \nÂ  Â  const realValue = value / divisor;\n\nÂ  Â  // Se o valor for 0, retorna uma string especÃ­fica\nÂ  Â  if (realValue === 0) return 'Valor a ser definido';\nÂ  Â Â \nÂ  Â  try {\nÂ  Â  Â  // Usa a API de internacionalizaÃ§Ã£o para formatar a moeda\nÂ  Â  Â  return new Intl.NumberFormat('pt-BR', {\nÂ  Â  Â  Â  style: 'currency',\nÂ  Â  Â  Â  currency: currencyCode,\nÂ  Â  Â  }).format(realValue);\nÂ  Â  } catch (e) {\nÂ  Â  Â  // Fallback simples\nÂ  Â  Â  return `${currencyCode} ${realValue.toFixed(2)}`;\nÂ  Â  }\nÂ  };\n\nÂ  // =================================================================\nÂ  // LÃ“GICA DE EXTRAÃ‡ÃƒO DE MENSAGEM\nÂ  // =================================================================\n\nÂ  const msg = $('webhookDataUazapi')?.item?.json?.body?.message ?? {};\nÂ  const cÂ  Â = msg?.content ?? {};\n\nÂ  // Formatters\nÂ  const formatters = {\nÂ  Â  // BotÃµes\nÂ  Â  buttons: () => {\nÂ  Â  Â  const header = convertMarkdown(c?.header?.title ?? '');\nÂ  Â  Â  const body = convertMarkdown(c?.body?.text ?? '');\nÂ  Â  Â  const footer = convertMarkdown(c?.footer?.text ?? '');\nÂ  Â  Â Â \nÂ  Â  Â  const buttonsArray = c?.InteractiveMessage?.NativeFlowMessage?.buttons ?? [];\nÂ  Â  Â Â \nÂ  Â  Â  const options = buttonsArray.map(btn => {\nÂ  Â  Â  Â  let params;\nÂ  Â  Â  Â  try {\nÂ  Â  Â  Â  Â  params = JSON.parse(btn.buttonParamsJSON ?? '{}');\nÂ  Â  Â  Â  } catch (e) {\nÂ  Â  Â  Â  Â  params = {};\nÂ  Â  Â  Â  }\n\nÂ  Â  Â  Â  const text = convertMarkdown(params.display_text ?? 'BotÃ£o');\n\nÂ  Â  Â  Â  if (btn.name === 'cta_url' && params.url) {\nÂ  Â  Â  Â  Â  return `* [${text}](${params.url}) ðŸ”—`;\nÂ  Â  Â  Â  }\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  if (btn.name === 'cta_call' && params.phone_number) {\nÂ  Â  Â  Â  Â  return `* ${text} (${params.phone_number}) ðŸ“ž`;\nÂ  Â  Â  Â  }\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  return `* ${text}`;\nÂ  Â  Â  }).join('\\n');\n\nÂ  Â  Â  const direction = msg.fromMe ? 'Enviada' : 'Recebida';\nÂ  Â  Â  const headerTitle = `ðŸ”˜ _Mensagem com BotÃµes (${direction}):_`;\nÂ  Â  Â  const tipFooter = !msg.fromMeÂ \nÂ  Â  Â  Â  ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`Â \nÂ  Â  Â  Â  : '';\n\nÂ  Â  Â  return `${headerTitle}\\n\\n---\\n\\n${header}\\n\\n${body}\\n\\n${footer}\\n\\n${options}${tipFooter}`;\nÂ  Â  },\nÂ  Â  // Listas\nÂ  Â  list: () => {\nÂ  Â  Â  const direction = msg.fromMe ? 'Enviada' : 'Recebida';\nÂ  Â  Â  const headerTitle = `ðŸ“‹ _Mensagem com Lista (${direction}):_`;\nÂ  Â  Â  const tipFooter = !msg.fromMeÂ \nÂ  Â  Â  Â  ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`Â \nÂ  Â  Â  Â  : '';\n\nÂ  Â  Â  const description = convertMarkdown(c?.description ?? 'Lista');\nÂ  Â  Â  const footer = convertMarkdown(c?.footerText ?? '');\nÂ  Â  Â  const button = convertMarkdown(c?.buttonText ?? '');\nÂ  Â  Â  const sections = c?.sections ?? [];\n\nÂ  Â  Â  const options = sections.map(section => {\nÂ  Â  Â  Â  const sectionTitle = `\\n**${convertMarkdown(section.title ?? 'SeÃ§Ã£o')}**`;\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  const rows = (section.rows ?? []).map(row => {\nÂ  Â  Â  Â  Â  const rowTitle = convertMarkdown(row.title ?? 'OpÃ§Ã£o');\nÂ  Â  Â  Â  Â  const rowDesc = convertMarkdown(row.description ?? '');\nÂ  Â  Â  Â  Â Â \nÂ  Â  Â  Â  Â  if (rowDesc) {\nÂ  Â  Â  Â  Â  Â  return `* **${rowTitle}** - _${rowDesc}_`;\nÂ  Â  Â  Â  Â  }\nÂ  Â  Â  Â  Â  return `* **${rowTitle}**`;\nÂ  Â  Â  Â  }).join('\\n');\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  return `${sectionTitle}\\n${rows}`;\nÂ  Â  Â  }).join('\\n');\n\nÂ  Â  Â  return `${headerTitle}\\n\\n---\\n\\n` +\nÂ  Â  Â  Â  Â  Â  Â `**${description}**\\n\\n` +\nÂ  Â  Â  Â  Â  Â  Â `*Texto do BotÃ£o:* ${button}\\n` +\nÂ  Â  Â  Â  Â  Â  Â `${options}\\n\\n` +\nÂ  Â  Â  Â  Â  Â  Â `_${footer}_` +\nÂ  Â  Â  Â  Â  Â  Â `${tipFooter}`;\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // Enquetes\nÂ  Â  poll: () => {\nÂ  Â  Â  const pollData = c?.pollCreationMessageV3 ?? c?.pollCreationMessage;\nÂ  Â  Â  if (!pollData) return 'Erro ao processar enquete.';\n\nÂ  Â  Â  const question = convertMarkdown(pollData.name ?? 'Enquete');\nÂ  Â  Â Â \nÂ  Â  Â  const options = (pollData.options ?? [])\nÂ  Â  Â  Â  .map((opt, index) => {\nÂ  Â  Â  Â  Â  const optionText = convertMarkdown(opt.optionName ?? 'OpÃ§Ã£o');\nÂ  Â  Â  Â  Â  return `${index + 1}. ${optionText}`;\nÂ  Â  Â  Â  })\nÂ  Â  Â  Â  .join('\\n');Â \n\nÂ  Â  Â  const count = pollData.selectableOptionsCount ?? 0;\nÂ  Â  Â  const footer = (count === 0)\nÂ  Â  Â  Â  ? `_(Permitido votar em mÃºltiplas opÃ§Ãµes)_`\nÂ  Â  Â  Â  : `_(Permitido votar em ${count} opÃ§Ã£o${count > 1 ? 's' : ''})_`;\n\nÂ  Â  Â  const direction = msg.fromMe ? 'Enviada' : 'Recebida';\nÂ  Â  Â  const headerTitle = `ðŸ“Š _Enquete ${direction}:_`;\nÂ  Â  Â Â \nÂ  Â  Â  const tipFooter = !msg.fromMeÂ \nÂ  Â  Â  Â  ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`Â \nÂ  Â  Â  Â  : '';\n\nÂ  Â  Â  return `${headerTitle}\\n\\n---\\n\\n**${question}**\\n\\n${options}\\n\\n${footer}${tipFooter}`;\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // Contatos (vCard Ãšnico ou MÃºltiplo)\nÂ  Â  contacts: () => {\nÂ  Â  Â  // FunÃ§Ã£o auxiliar interna para parsear UM vCard\nÂ  Â  Â  const parseVCard = (vcardString, displayName) => {\nÂ  Â  Â  Â  // FunÃ§Ã£o para extrair um campo (ORG, EMAIL, URL)\nÂ  Â  Â  Â  const getVCardField = (field) => {\nÂ  Â  Â  Â  Â  const match = vcardString.match(new RegExp(`^${field}(?:;.*)?:([^\\\\n\\\\r]+)`, 'm'));\nÂ  Â  Â  Â  Â  return match && match[1] ? match[1].replace(/;$/, '').trim() : null;\nÂ  Â  Â  Â  };\nÂ  Â  Â  Â  // FunÃ§Ã£o para extrair TODOS os telefones (TEL)\nÂ  Â  Â  Â  const getVCardPhones = () => {\nÂ  Â  Â  Â  Â  const phoneMatches = [...vcardString.matchAll(/TEL.*:([^\\n\\\\r]+)/g)];\nÂ  Â  Â  Â  Â  return phoneMatches.map(match => match[1].trim());\nÂ  Â  Â  Â  };\n\nÂ  Â  Â  Â  // Extrai os dados\nÂ  Â  Â  Â  const name = convertMarkdown(displayName ?? 'Contato');\nÂ  Â  Â  Â  const org = getVCardField('ORG');\nÂ  Â  Â  Â  const email = getVCardField('EMAIL');\nÂ  Â  Â  Â  const url = getVCardField('URL');\nÂ  Â  Â  Â  const phones = getVCardPhones();\n\nÂ  Â  Â  Â  // Monta o card dinamicamente\nÂ  Â  Â  Â  const card = [`**${name}**`];\nÂ  Â  Â  Â  if (org) card.push(`ðŸ¢ ${convertMarkdown(org)}`);\nÂ  Â  Â  Â  phones.forEach(phone => {\nÂ  Â  Â  Â  Â  card.push(`ðŸ“ž ${convertMarkdown(phone)}`);\nÂ  Â  Â  Â  });\nÂ  Â  Â  Â  if (email) card.push(`ðŸ“§ ${convertMarkdown(email)}`);\nÂ  Â  Â  Â  if (url) card.push(`ðŸŒ [${convertMarkdown(url)}](${url})`);\n\nÂ  Â  Â  Â  return card.join('\\n');\nÂ  Â  Â  };\n\nÂ  Â  Â  let vcards = []; // Array para guardar os vCards formatados\n\nÂ  Â  Â  if (msg.messageType === 'ContactsArrayMessage') {\nÂ  Â  Â  Â  const contactsArray = c.contacts ?? [];\nÂ  Â  Â  Â  vcards = contactsArray.map(contact =>Â \nÂ  Â  Â  Â  Â  parseVCard(contact.vcard, contact.displayName)\nÂ  Â  Â  Â  );\nÂ  Â  Â  }\nÂ  Â  Â  else if (msg.messageType === 'ContactMessage') {\nÂ  Â  Â  Â  vcards = [parseVCard(c.vcard ?? '', c.displayName ?? 'Contato')];\nÂ  Â  Â  }\n\nÂ  Â  Â  if (vcards.length === 0) return 'Erro ao processar contato.';\n\nÂ  Â  Â  // Monta o cabeÃ§alho\nÂ  Â  Â  const count = vcards.length;\nÂ  Â  Â  const title = count > 1 ? 'Contatos' : 'Contato';\nÂ  Â  Â  let headerTitle;\n\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ‘¤ _${title} Enviado${count > 1 ? 's' : ''}:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ‘¤ _${title} Recebido${count > 1 ? 's' : ''}_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Junta todos os cards, separados por uma linha\nÂ  Â  Â  return `${headerTitle}\\n\\n---\\n\\n${vcards.join('\\n\\n---\\n\\n')}`;\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // Evento (Agendamento)\nÂ  Â  event: () => {\nÂ  Â  Â  const name = convertMarkdown(c?.name ?? 'Evento');\nÂ  Â  Â  const description = convertMarkdown(c?.description ?? '');\nÂ  Â  Â  const location = convertMarkdown(c?.location?.name ?? '');\nÂ  Â  Â  const joinLink = c?.joinLink ?? '';\nÂ  Â  Â Â \nÂ  Â  Â  // FunÃ§Ã£o auxiliar para formatar timestamp (em segundos)\nÂ  Â  Â  const formatTimestamp = (timestamp) => {\nÂ  Â  Â  Â  if (!timestamp || timestamp === 0) return null; // Retorna nulo se nÃ£o houver data\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  const date = new Date(timestamp * 1000); // Converte de segundos para milissegundos\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  return date.toLocaleString('pt-BR', {\nÂ  Â  Â  Â  Â  day: '2-digit', month: '2-digit', year: 'numeric',\nÂ  Â  Â  Â  Â  hour: '2-digit', minute: '2-digit',\nÂ  Â  Â  Â  Â  timeZone: 'America/Sao_Paulo'\nÂ  Â  Â  Â  });\nÂ  Â  Â  };\nÂ  Â  Â Â \nÂ  Â  Â  const formattedStartTime = formatTimestamp(c?.startTime);\nÂ  Â  Â  const formattedEndTime = formatTimestamp(c?.endTime);\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ“† _Evento Criado:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ“† _Evento Recebido_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card dinamicamente\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n\\n**${name}**`];\nÂ  Â  Â Â \nÂ  Â  Â  if (description) card.push(`*${description}*`);\nÂ  Â  Â Â \nÂ  Â  Â  const details = [];\nÂ  Â  Â  if (formattedStartTime) details.push(`ðŸ“† **InÃ­cio:** ${formattedStartTime}`);\nÂ  Â  Â  if (formattedEndTime) details.push(`ðŸ“† **Fim:** ${formattedEndTime}`);Â \nÂ  Â  Â  if (location) details.push(`ðŸ“ **Local:** ${location}`);\nÂ  Â  Â Â \nÂ  Â  Â  if (joinLink) {\nÂ  Â  Â  Â  if (joinLink.includes('/video/')) {\nÂ  Â  Â  Â  Â  details.push(`ðŸ“¹ [Entrar na Chamada de VÃ­deo](${joinLink})`);\nÂ  Â  Â  Â  } else if (joinLink.includes('/audio/') || joinLink.includes('/voice/')) {\nÂ  Â  Â  Â  Â  details.push(`ðŸ“ž [Entrar na Chamada de Voz](${joinLink})`);\nÂ  Â  Â  Â  } else {\nÂ  Â  Â  Â  Â  details.push(`ðŸ”— [Link para o Evento](${joinLink})`);\nÂ  Â  Â  Â  }\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  if (details.length > 0) {\nÂ  Â  Â  Â  card.push(`\\n${details.join('\\n')}`);\nÂ  Â  Â  }\n\nÂ  Â  Â  if (c?.isCanceled === true) {\nÂ  Â  Â  Â  card.push(`\\n\\n**-- EVENTO CANCELADO --**`);\nÂ  Â  Â  }\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\n\nÂ  Â  // Produtos\nÂ  Â  product: () => {\nÂ  Â  Â  const product = c?.product;\nÂ  Â  Â  if (!product) return 'Erro ao processar produto.';\n\nÂ  Â  Â  // Extrai os dados do produto\nÂ  Â  Â  const title = convertMarkdown(product.title ?? 'Produto');\nÂ  Â  Â  const description = convertMarkdown(product.description ?? '');\nÂ  Â  Â  const productLink = product.URL ?? '';\nÂ  Â  Â  const imageURL = product.productImage?.URL ?? '';\n\nÂ  Â  Â  // LÃ³gica de PreÃ§o\nÂ  Â  Â  const currency = product.currencyCode ?? 'BRL';\nÂ  Â  Â  // Usa a funÃ§Ã£o auxiliar global 'formatCurrency'\nÂ  Â  Â  const price = formatCurrency(product.priceAmount1000, 1000, currency);\nÂ  Â  Â  const salePrice = formatCurrency(product.salePriceAmount1000, 1000, currency);\nÂ  Â  Â Â \nÂ  Â  Â  let priceString = '';\nÂ  Â  Â  if (salePrice && salePrice !== 'Valor a ser definido') {\nÂ  Â  Â  Â  priceString = `\\n**${salePrice}** (de ~~${price}~~)`;\nÂ  Â  Â  } else if (price && price !== 'Valor a ser definido') {\nÂ  Â  Â  Â  priceString = `\\n**${price}**`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ›’ _Produto Enviado:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ›’ _Produto Recebido_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\nÂ  Â  Â Â \nÂ  Â  Â  if (imageURL) card.push(`![Imagem do Produto](${imageURL})\\n`);\nÂ  Â  Â Â \nÂ  Â  Â  card.push(`**${title}**`);\nÂ  Â  Â  if (description) card.push(`*${description}*`);\nÂ  Â  Â  if (priceString) card.push(priceString); // Adiciona o preÃ§o\nÂ  Â  Â Â \nÂ  Â  Â  if (productLink) card.push(`\\n[Ver Produto na Loja](${productLink}) ðŸ”—`);\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // CatÃ¡logo\nÂ  Â  catalog: () => {\nÂ  Â  Â  const title = convertMarkdown(c?.title ?? 'CatÃ¡logo');\nÂ  Â  Â  const description = convertMarkdown(c?.description ?? '');\nÂ  Â  Â  // O c.text jÃ¡ contÃ©m a chamada para aÃ§Ã£o e o link\nÂ  Â  Â  const text = convertMarkdown(c?.text ?? '');Â \n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ§¾ _CatÃ¡logo Enviado:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ§¾ _CatÃ¡logo Recebido_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\nÂ  Â  Â Â \nÂ  Â  Â  // O thumbnail Ã© Base64, entÃ£o nÃ£o podemos exibi-lo.\nÂ  Â  Â Â \nÂ  Â  Â  card.push(`**${title}**`); // Nome do NegÃ³cio\nÂ  Â  Â  if (description) card.push(`\\n*${description}*`);\nÂ  Â  Â Â \nÂ  Â  Â  // Adiciona o texto principal que contÃ©m o link\nÂ  Â  Â  if (text) card.push(`\\n${text}`);Â \n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // BotÃ£o de Pix\nÂ  Â  pix: (params) => { // Agora recebe 'params'\nÂ  Â  Â  const pixData = params.payment_settings?.[0]?.pix_static_code ?? {};\nÂ  Â  Â  const amountData = params.total_amount ?? {};\nÂ  Â  Â  const currency = params.currency ?? 'BRL';\nÂ  Â  Â Â \nÂ  Â  Â  // Extrai os dados\nÂ  Â  Â  const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\nÂ  Â  Â  const pixKey = convertMarkdown(pixData.key ?? 'Chave nÃ£o informada');\nÂ  Â  Â  const keyType = convertMarkdown(pixData.key_type ?? '');\nÂ  Â  Â Â \nÂ  Â  Â  // Usa a funÃ§Ã£o auxiliar global 'formatCurrency'\nÂ  Â  Â  // Passa o 'value' e o 'offset' dinamicamente\nÂ  Â  Â  const amount = formatCurrency(amountData.value, amountData.offset, currency);\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Enviada):_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Recebida de **${senderName}**):_`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\nÂ  Â  Â Â \nÂ  Â  Â  card.push(`**Valor:** ${amount}`);\nÂ  Â  Â  card.push(`\\n**Recebedor:** ${merchantName}`);\nÂ  Â  Â  card.push(`**Chave PIX:** \\`${pixKey}\\` (${keyType})`);\nÂ  Â  Â Â \nÂ  Â  Â  if (!msg.fromMe) {\nÂ  Â  Â  Â  card.push(`\\n_Dica: Para pagar, copie a chave PIX e use o app do seu banco._`);\nÂ  Â  Â  }\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\n\nÂ  Â  // Carrinho (PIX DinÃ¢mico / MÃºltiplos Itens)\nÂ  Â  cart: (params) => { // Agora recebe 'params'\nÂ  Â  Â  const currency = params.currency ?? 'BRL';\nÂ  Â  Â  const order = params.order ?? {};\nÂ  Â  Â  const items = order.items ?? [];\nÂ  Â  Â Â \nÂ  Â  Â  // Monta a lista de itens\nÂ  Â  Â  const itemsString = items.map(item => {\nÂ  Â  Â  Â  const name = convertMarkdown(item.name ?? 'Item');\nÂ  Â  Â  Â  const quantity = item.quantity ?? 1;\nÂ  Â  Â  Â  // Usa a funÃ§Ã£o auxiliar global 'formatCurrency'\nÂ  Â  Â  Â  const price = formatCurrency(item.amount?.value, item.amount?.offset, currency);Â \nÂ  Â  Â  Â  return `* ${quantity}x ${name} (${price})`;\nÂ  Â  Â  }).join('\\n');\n\nÂ  Â  Â  // Formata os totais\nÂ  Â  Â  const subtotal = formatCurrency(order.subtotal?.value, order.subtotal?.offset, currency);\nÂ  Â  Â  const discount = formatCurrency(order.discount?.value, order.discount?.offset, currency);\nÂ  Â  Â  const total = formatCurrency(params.total_amount?.value, params.total_amount?.offset, currency);\n\nÂ  Â  Â  // Extrai dados do PIX (o primeiro mÃ©todo de pagamento)\nÂ  Â  Â  const pixSettings = params.payment_settings?.[0] ?? {};\nÂ  Â  Â  const pixData = pixSettings.pix_static_code ?? pixSettings.pix_dynamic_code ?? {};\nÂ  Â  Â  const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\nÂ  Â  Â  const pixKey = convertMarkdown(pixData.key ?? pixData.code ?? 'Chave nÃ£o informada');\nÂ  Â  Â  const keyType = convertMarkdown(pixData.key_type ?? (pixSettings.type === 'pix_dynamic_code' ? 'DinÃ¢mico' : ''));\n\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ›’ _Pedido Enviado:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ›’ _Novo Pedido Recebido_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n\\n**Resumo do Pedido:**\\n`];\nÂ  Â  Â Â \nÂ  Â  Â  // Adiciona o texto do body\nÂ  Â  Â  const bodyText = convertMarkdown(c?.body?.text ?? '');\nÂ  Â  Â  if (bodyText) card.push(`*${bodyText}*\\n`);\nÂ  Â  Â Â \nÂ  Â  Â  card.push(itemsString);\nÂ  Â  Â Â \nÂ  Â  Â  const totals = [];\nÂ  Â  Â  if (subtotal) totals.push(`**Subtotal:** ${subtotal}`);\nÂ  Â  Â  if (discount && order.discount?.value > 0) {\nÂ  Â  Â  Â  totals.push(`**Desconto:** ${discount}`);\nÂ  Â  Â  }\nÂ  Â  Â  if (total) totals.push(`**Total:** **${total}**`);\nÂ  Â  Â Â \nÂ  Â  Â  if (totals.length > 0) {\nÂ  Â  Â  Â  card.push(`\\n${totals.join('\\n')}`);\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  // Adiciona dados do PIX (se existirem)\nÂ  Â  Â  if(pixKey !== 'Chave nÃ£o informada') {\nÂ  Â  Â  Â  card.push(`\\n**Para Pagar (PIX):**`);\nÂ  Â  Â  Â  card.push(`**Recebedor:** ${merchantName}`);\nÂ  Â  Â  Â  card.push(`**Chave PIX:** \\`${pixKey}\\` (${keyType})`);\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  if (!msg.fromMe) {\nÂ  Â  Â  Â  card.push(`\\n_Dica: Para pagar, copie a chave PIX e use o app do seu banco._`);\nÂ  Â  Â  }\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\n\nÂ  Â  // LocalizaÃ§Ã£o EstÃ¡tica\nÂ  Â  location: () => {\nÂ  Â  Â  const lat = c?.degreesLatitude;\nÂ  Â  Â  const long = c?.degreesLongitude;\nÂ  Â  Â  const name = convertMarkdown(c?.name ?? '');\nÂ  Â  Â  const address = convertMarkdown(c?.address ?? '');\n\nÂ  Â  Â  // Cria um link do Google Maps\nÂ  Â  Â  let mapLink = '';\nÂ  Â  Â  if (lat && long) {\nÂ  Â  Â  Â  mapLink = `https://maps.google.com/?q=${lat},${long}`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ“ _LocalizaÃ§Ã£o Enviada:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ“ _LocalizaÃ§Ã£o Recebida_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\n\nÂ  Â  Â  if (name) card.push(`**${name}**`);\nÂ  Â  Â  if (address) card.push(`*${address}*`);\nÂ  Â  Â Â \nÂ  Â  Â  const details = [];\nÂ  Â  Â  if (lat) details.push(`**Latitude:** \\`${lat}\\``);\nÂ  Â  Â  if (long) details.push(`**Longitude:** \\`${long}\\``);\n\nÂ  Â  Â  if (details.length > 0) {\nÂ  Â  Â  Â  if (name || address) {\nÂ  Â  Â  Â  Â  card.push(`\\n${details.join('\\n')}`);\nÂ  Â  Â  Â  } else {\nÂ  Â  Â  Â  Â  card.push(details.join('\\n'));\nÂ  Â  Â  Â  }\nÂ  Â  Â  }\n\nÂ  Â  Â  if (mapLink) {\nÂ  Â  Â  Â  if (name || address || lat || long) {\nÂ  Â  Â  Â  Â  card.push(`\\n[Ver LocalizaÃ§Ã£o no Google Maps](${mapLink}) ðŸŒ`);\nÂ  Â  Â  Â  } else {\nÂ  Â  Â  Â  Â  card.push(`[Ver LocalizaÃ§Ã£o no Google Maps](${mapLink}) ðŸŒ`);\nÂ  Â  Â  Â  }\nÂ  Â  Â  }\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // LocalizaÃ§Ã£o em Tempo Real\nÂ  Â  liveLocation: () => {\nÂ  Â  Â  // Pega os dados da localizaÃ§Ã£o (o Ãºltimo ponto)\nÂ  Â  Â  const lat = c?.degreesLatitude;\nÂ  Â  Â  const long = c?.degreesLongitude;\nÂ  Â  Â  const comm = c?.caption;\n\nÂ  Â  Â  // Cria um link do Google Maps para o Ãºltimo ponto\nÂ  Â  Â  let mapLink = '';\nÂ  Â  Â  if (lat && long) {\nÂ  Â  Â  Â  mapLink = `https://maps.google.com/?q=${lat},${long}`;\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  const senderName = msg?.senderName ?? 'Contato';\n\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ“ _VocÃª iniciou o compartilhamento de localizaÃ§Ã£o em tempo real._`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  headerTitle = `ðŸ“ _${senderName} estÃ¡ compartilhando a localizaÃ§Ã£o em tempo real._`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\n\nÂ  Â  Â  // Adiciona as coordenadas do Ãºltimo ponto, se disponÃ­veis\nÂ  Â  Â  const details = [];\nÂ  Â  Â  if (lat) details.push(`**Latitude Inicial:** \\`${lat}\\``);\nÂ  Â  Â  if (long) details.push(`**Longitude Inicial:** \\`${long}\\`\\n\\n`);\nÂ  Â  Â  if (comm) details.push(`**ComentÃ¡rio:** ${comm}`);\n\nÂ  Â  Â  if (details.length > 0) {\nÂ  Â  Â  Â  card.push(details.join('\\n'));\nÂ  Â  Â  }\n\nÂ  Â  Â  // Adiciona o link do mapa\nÂ  Â  Â  if (mapLink) {\nÂ  Â  Â  Â  if (details.length > 0) card.push('\\n'); // Adiciona espaÃ§o\nÂ  Â  Â  Â  card.push(`[Ver a localizaÃ§Ã£o inicial no Google Maps](${mapLink}) ðŸŒ`);\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  // Adiciona o aviso, como solicitado\nÂ  Â  Â  card.push(`\\n\\n*A localizaÃ§Ã£o atual e em tempo real nÃ£o pode ser exibida no Chatwoot.*\\n` +\nÂ  Â  Â  Â  Â  Â  Â `_Acesse o WhatsApp no celular ou web para acompanhar._`);\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\n\n    // Carrossel\n    carousel: () => {\n      const carouselData = c?.InteractiveMessage?.CarouselMessage;\n      const cards = carouselData?.cards ?? [];\n      if (cards.length === 0) return 'Erro ao processar carrossel.';\n\n      // Pega o texto principal (fora dos cards)\n      const mainBody = convertMarkdown(c?.body?.text ?? '');\n\n      // Itera em cada card para formatÃ¡-lo\n      const formattedCards = cards.map((card, index) => {\n        // 1. Pega a URL da Imagem\n        const imageURL = card?.header?.Media?.ImageMessage?.URL ?? '';\n        \n        // 2. Pega o Texto do Corpo do card\n        const bodyText = convertMarkdown(card?.body?.text ?? '');\n        \n        // 3. Pega o Texto do BotÃ£o\n        let buttonText = '';\n        const button = card?.InteractiveMessage?.NativeFlowMessage?.buttons?.[0];\n        if (button) {\n          try {\n            const params = JSON.parse(button.buttonParamsJSON ?? '{}');\n            buttonText = convertMarkdown(params.display_text ?? 'Ver opÃ§Ã£o');\n          } catch (e) {\n            buttonText = 'Ver opÃ§Ã£o';\n          }\n        }\n\n        // Monta o markdown para este card\n        const cardParts = [];\n        // Usa o texto do botÃ£o como tÃ­tulo, jÃ¡ que nÃ£o hÃ¡ tÃ­tulo de card\n        cardParts.push(`**${index + 1}. ${buttonText}**`);\n        \n        // Formata o corpo do card como uma citaÃ§Ã£o (blockquote)\n        if (bodyText) {\n          const bodyLines = bodyText.split('\\n').map(line => `> ${line}`);\n          cardParts.push(bodyLines.join('\\n'));\n        }\n        \n        return cardParts.join('\\n');\n      }).join('\\n\\n---\\n\\n'); // Separa cada card com uma linha horizontal\n\n      // Monta a mensagem final\n      const direction = msg.fromMe ? 'Enviada' : 'Recebida';\n      const headerTitle = `ðŸŽ  _Mensagem em Carrossel (${direction}):_`;\n      \n      const tipFooter = !msg.fromMe \n        ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._` \n        : '';\n      \n      // Retorna o cabeÃ§alho + o texto principal + os cards formatados\n      return `${headerTitle}\\n\\n**${mainBody}**\\n\\n${formattedCards}${tipFooter}`;\n    }\nÂ  };\n\nÂ  // =================================================================\nÂ  // PROCESSAMENTO E RETORNO\nÂ  // =================================================================\n\nÂ  // 1. Mensagem Interativa (Carrossel)\n  //    Verifica pela chave 'CarouselMessage' PRIMEIRO\nÂ  if (c?.InteractiveMessage?.CarouselMessage) {\nÂ  Â  return formatters.carousel();\nÂ  }\n\n  // 2. Mensagem Interativa (BotÃµes, PIX, Carrinho)\n  //    Verifica pela chave 'NativeFlowMessage'\nÂ  if (c?.InteractiveMessage?.NativeFlowMessage) {\nÂ  Â  // Verifica o tipo de botÃ£o para rotear ao formatter correto\nÂ  Â  const button = c.InteractiveMessage.NativeFlowMessage.buttons?.[0];\nÂ  Â  const buttonName = button?.name;\nÂ  Â Â \nÂ  Â  let params;\nÂ  Â  try {\nÂ  Â  Â  params = JSON.parse(button?.buttonParamsJSON ?? '{}');\nÂ  Â  } catch(e) {\nÂ  Â  Â  params = {};\nÂ  Â  }\nÂ  Â Â \nÂ  Â  if (buttonName === 'payment_info') {\nÂ  Â  Â  return formatters.pix(params); // Roteia para o formatter PIX\nÂ  Â  }\nÂ  Â Â \nÂ  Â  if (buttonName === 'review_and_pay') {\nÂ  Â  Â  return formatters.cart(params); // Roteia para o formatter Carrinho\nÂ  Â  }\nÂ  Â Â \nÂ  Â  // Se nÃ£o for PIX ou Carrinho, continua no formatter de botÃµes padrÃ£o\nÂ  Â  return formatters.buttons();\nÂ  }\n\n  // 3. Mensagem Interativa (Lista)\nÂ  if (c?.sections) {\nÂ  Â  return formatters.list();\nÂ  }\n\nÂ  // 4. Enquete (CriaÃ§Ã£o)\nÂ  const pollTypes = ['PollCreationMessageV3', 'PollCreationMessage'];\nÂ  if (pollTypes.includes(msg?.messageType)) {\nÂ  Â  return formatters.poll();\nÂ  }\n\nÂ  // 5. Enquete (Voto)\nÂ  if (msg?.messageType === 'PollUpdateMessage') {\nÂ  Â  const voteText = convertMarkdown(msg?.vote ?? '');\nÂ  Â  if (!voteText) return ''; // Ignora anulaÃ§Ã£o de voto\n\nÂ  Â  if (msg.fromMe) {\nÂ  Â  Â  return `ðŸ“¤ _Voto Enviado:_\\n\\n**${voteText}**`;\nÂ  Â  } else {\nÂ  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  return `ðŸ“¥ _Voto Recebido_ (de **${senderName}**):\\n\\n**${voteText}**`;\nÂ  Â  }\nÂ  }\n\nÂ  // 6. Resposta a BotÃ£o/Lista\nÂ  if (msg?.buttonOrListid) {\nÂ  Â  const selectionText = convertMarkdown(String(c?.selectedDisplayText ?? c?.title ?? ''));\nÂ  Â  if (!selectionText) return '';\n\nÂ  Â  if (msg.fromMe) {\nÂ  Â  Â  return `ðŸ“¤ _SeleÃ§Ã£o Enviada:_\\n\\n**${selectionText}**`;\nÂ  Â  } else {\nÂ  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  return `ðŸ“¥ _OpÃ§Ã£o Selecionada_ (por **${senderName}**):\\n\\n**${selectionText}**`;\nÂ  Â  }\nÂ  }\nÂ Â \nÂ  // 7. Contato (vCard Ãšnico ou MÃºltiplo)\nÂ  if (['ContactMessage', 'ContactsArrayMessage'].includes(msg.messageType)) {\nÂ  Â  return formatters.contacts();\nÂ  }\nÂ Â \nÂ  // 8. Evento (Agendamento)\nÂ  if (msg?.messageType === 'EventMessage') {\nÂ  Â  return formatters.event();\nÂ  }\n\nÂ  // 9. LocalizaÃ§Ã£o\nÂ  if (msg?.messageType === 'LocationMessage') {\nÂ  Â  return formatters.location();\nÂ  }\nÂ Â \nÂ  // 10. Produto\nÂ  if (msg?.messageType === 'ProductMessage') {\nÂ  Â  return formatters.product();\nÂ  }\nÂ Â \nÂ  // 11. CatÃ¡logo (Link)\nÂ  if (msg?.messageType === 'ExtendedTextMessage' && msg.mediaType === 'cataloglink') {\nÂ  Â  return formatters.catalog();\nÂ  }\n\nÂ  // 12. LocalizaÃ§Ã£o em Tempo Real (LiveLocationMessage)\nÂ  if (msg?.messageType === 'LiveLocationMessage') {\nÂ  Â  return formatters.liveLocation();\nÂ  }\n\nÂ  // 13. ReaÃ§Ãµes\nÂ  if (msg?.messageType === 'ReactionMessage') {\nÂ  Â  const reactionText = String(msg?.text ?? c?.text ?? '');\nÂ  Â  return convertMarkdown(reactionText);\nÂ  }\n\nÂ  // 14. MÃ­dia\nÂ  if (['ImageMessage','VideoMessage','DocumentMessage'].includes(msg?.messageType)) {\nÂ  Â  const caption = String(c?.caption ?? '');\nÂ  Â  return convertMarkdown(caption);\nÂ  }\n\nÂ  // 15. Fallback (Texto comum)\nÂ  const commonText = (\nÂ  Â  String(msg?.text ?? '').trim() ||\nÂ  Â  String(msg?.content?.text ?? '').trim() ||\nÂ  Â  ''\nÂ  );\nÂ Â \nÂ  return convertMarkdown(commonText);\n})()\n}}","type":"string"},{"id":"8b1480c6-16df-429a-93e5-8677bea2c2d8","name":"data.media_key","value":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.message?.mediaType ??\n    ''\n  )\n  .toLowerCase() !== 'url' ?\n  (\n    $('webhookDataUazapi').item.json.body?.message?.content?.mediaKey ??\n    ''\n  ) :\n  ''\n}}","type":"string"},{"id":"898be1ea-ae20-4bc2-8487-2e9055d9ad45","name":"data.direct_path","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.directPath ??\n  ''\n}}","type":"string"},{"id":"e9290c7c-f979-4cdb-b67f-ea7f979ee7ed","name":"data.url","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.URL ??\n  ''\n}}","type":"string"},{"id":"3921b501-9196-47f8-9ff5-01972295574a","name":"data.mimetype","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.mimetype ??\n  ''\n}}","type":"string"},{"id":"3dc97213-639b-40df-98f3-ffa7e0f0bbbb","name":"data.content_type","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.mediaType ??\n  ''\n}}","type":"string"},{"id":"fa8e3c1d-be13-4e11-9c74-7eae2d07c24a","name":"data.filename","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.fileName ??\n  ''\n}}","type":"string"},{"id":"1d15c75e-360d-47f0-94a1-066eff15de97","name":"data.thumbnail","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.product?.productImage?.JPEGThumbnail ??\n  ''\n}}","type":"string"},{"id":"4ded2e97-4559-4597-be0e-d8a913266f32","name":"data.is_group","value":"={{\n  !!(\n    $('webhookDataUazapi')?.item?.json?.body?.message?.isGroup\n  )\n}}","type":"boolean"},{"id":"ebd5caf1-7aec-4332-88d8-6c8ccc1f08be","name":"data.from_me","value":"={{\n  !!(\n    $('webhookDataUazapi')?.item?.json?.body?.message?.fromMe\n  )\n}}","type":"boolean"},{"id":"2369eef3-45df-455d-b30d-cb9106295bcc","name":"data.owner","value":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.message?.owner ??\n    ''\n  )\n  .trim()\n  .replace(/^(.+)$/, '+$1')\n}}","type":"string"},{"id":"92f40871-170f-4bc8-95e2-e136b954cfa3","name":"data.event_type","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.EventType ??\n  ''\n}}","type":"string"}]},"options":{}},"id":"3fb86dd0-2780-4226-bc67-2ecb66dfb61d","name":"normalizedData","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[624,816]},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot?.account_id }}/contacts","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"},{"name":"Content-type","value":"application/json; charset=utf-8"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"name\": \"{{ $('normalizedData')?.item?.json?.data?.is_group ? $('normalizedData').item?.json?.group?.name : $('normalizedData')?.item?.json?.contact?.full_name }}\",\n    \"inbox_id\": {{ $('normalizedData')?.item?.json?.chatwoot.inbox_id }},\n    \"source_id\": \"{{ $('contactVerify')?.item?.json?.identifier_new.split('@').first() }}\",\n    \"phone_number\": \"{{ $('contactVerify')?.item?.json?.phone_number_new }}\",\n    \"identifier\" : \"{{ $('contactVerify')?.item?.json?.identifier_new }}\",\n    \"additional_attributes\": {\n        \"contact_lid\": \"{{ $('contactVerify')?.item?.json?.contact_lid_new }}\"\n    }\n}","options":{"response":{"response":{"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1152,656],"id":"2563003a-ebfe-49bc-8efe-856b01464be3","name":"contactCreate","retryOnFail":true,"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"9306060b-d691-4d8f-a0e2-8f89ede48960","name":"contact_id","value":"={{\n  $json?.payload?.contact?.id ??\n  $json?.contact_id ??\n  $json?.id ??\n  ''\n}}","type":"number"},{"id":"23b01a4b-58a1-4256-b62f-373073a16840","name":"inbox_id","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1328,736],"id":"d20537a7-4c80-4068-b793-e46d14a09db1","name":"contactIdentify","retryOnFail":true},{"parameters":{"url":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot.account_id }}/contacts/{{ $('contactIdentify')?.item?.json?.contact_id }}/conversations","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"},{"name":"Content-type","value":"application/json; charset=utf-8"}]},"options":{}},"id":"5a2ad50a-a616-4457-86c2-bd44079b90ad","name":"conversationFind","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-80,1408],"retryOnFail":true},{"parameters":{"assignments":{"assignments":[{"id":"fc173b4d-2b51-446a-a545-36fe4fc3f9e9","name":"chatwoot","value":"={{ $('normalizedData')?.item?.json?.chatwoot }}","type":"object"},{"id":"2119b12f-7d4d-40b5-99dc-fd0f503bfffc","name":"chatwoot.inbox_id","value":"={{ $('contactIdentify')?.item?.json?.inbox_id }}","type":"number"},{"id":"365992ef-324c-45f6-8770-032326a3467e","name":"api","value":"={{ $('normalizedData')?.item?.json?.api }}","type":"object"},{"id":"d0ffd39f-b950-483e-9097-48e0bac71195","name":"group","value":"={{ $('normalizedData')?.item?.json?.group ?? {} }}","type":"object"},{"id":"cb473388-9aaf-46a8-86fe-c9c37776ed65","name":"contact","value":"={{ $('normalizedData')?.item?.json?.contact }}","type":"object"},{"id":"d72e1e10-8311-44ca-8180-176fd44b03db","name":"contact.contact_id","value":"={{ $('contactIdentify')?.item?.json?.contact_id }}","type":"number"},{"id":"7cef8d6a-13c6-4c6b-bcf1-81e60a5a1d37","name":"data","value":"={{ $('normalizedData')?.item?.json?.data }}","type":"object"},{"id":"9306060b-d691-4d8f-a0e2-8f89ede48960","name":"data.conversation_id","value":"={{ $('conversationIdentify')?.item?.json?.conversation_id }}","type":"number"},{"id":"0624c083-b4e3-480d-93ac-35d1b3c7d519","name":"data.conversation_status","value":"={{ $('conversationFind')?.item?.json?.payload?.[0]?.status ?? '' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[272,1408],"id":"c3270d1e-8389-4649-8101-fd765ea33fc2","name":"processedData"},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.api.base_url }}/message/download","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('processedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"id\": \"{{ $('normalizedData')?.item?.json?.data?.message_id }}\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1152,1248],"id":"20fd98df-f530-41fe-8fa5-e8f779548c02","name":"messageMediaFind","retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id || $('processedData')?.item?.json?.data?.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"=attachments[]","inputDataFieldName":"data"},{"name":"content","value":"={{\n  (\n    ($('processedData')?.item?.json?.data?.is_group === true &&\n     $('processedData')?.item?.json?.data?.from_me === false)\n      ? '**' + ( $('processedData')?.item?.json?.group?.contact ?? '' ) + '**\\n\\n'\n      : ''\n  ) + String($('processedData')?.item?.json?.data?.content ?? '')\n}}"},{"name":"message_type","value":"={{ $('processedData')?.item?.json?.data?.message_direction }}"},{"name":"source_id","value":"={{ $('processedData')?.item?.json?.data?.message_id }}"},{"name":"content_attributes","value":"={\n  \"in_reply_to\": {{ $('messageVerify')?.item?.json?.reply_id ?? $('messageVerify')?.item?.json?.edited_id }}\n}"}]},"options":{}},"id":"1ea3f2b8-d104-4983-a139-c00b8777f985","name":"messageMediaSend","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1680,1248],"retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{\n  (\n    ($('processedData')?.item?.json?.data?.is_group === true &&\n     $('processedData')?.item?.json?.data?.from_me === false)\n      ? '**' + ( $('processedData')?.item?.json?.group?.contact ?? '' ) + '**\\n\\n'\n      : ''\n  ) + String($('processedData')?.item?.json?.data?.content ?? '')\n}}"},{"name":"message_type","value":"={{ $('processedData')?.item?.json?.data?.message_direction }}"},{"name":"source_id","value":"={{ $('processedData')?.item?.json?.data?.message_id }}"},{"name":"content_attributes","value":"={\n  \"in_reply_to\": {{ $('messageVerify')?.item?.json?.reply_id ?? $('messageVerify')?.item?.json?.edited_id }}\n}"}]},"options":{}},"id":"01c8664b-23ff-4b76-a2df-1ee75f5513f2","name":"messageTextSend","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1152,1088],"retryOnFail":true},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2384,1408],"id":"3cdd7299-fb5b-41f1-9824-d487e6d91177","name":"endProcess"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Substitui apenas o campo fileName, preservando todos os outros dados originais\nconst item = $input.item;\n\nif (item.binary?.data && $('processedData')?.item?.json?.data?.filename) {\n  // Monte o nome como quiser:\n  const newfilename = $('processedData')?.item?.json?.data?.filename;\n  item.binary.data.fileName = newfilename;\n}\n\nreturn item;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1504,1248],"id":"1915236e-49a5-4181-9b01-504f90118693","name":"messageMediaRename"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"52ae290c-5ed1-473d-a9ef-0740de74f5bc","leftValue":"={{\n  !!(\n     $('webhookDataUazapi')?.item?.json?.body?.message?.isGroup\n  )\n}}","rightValue":"@g.us","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"b8dd0846-d1b6-4700-8b1e-46504df6321d","leftValue":"={{\n  !!(\n    $('getVariables')?.item?.json?.ignore_groups\n  )\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[272,656],"id":"52dc7c5b-36d4-44ff-a29b-27aaa7f860bb","name":"groupVerify"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"52ae290c-5ed1-473d-a9ef-0740de74f5bc","leftValue":"={{\n(() => {\n  const b = $('webhookDataUazapi')?.item?.json?.body ?? {};\n  const m = b.message ?? {};\n  const ev = b.event ?? {};\n  const toBool = v => (typeof v === 'string' ? v.toLowerCase() === 'true' : !!v);\n  return (toBool(m.fromMe) || !toBool(m.wasSentByApi)) && !toBool(ev.IsFromMe);\n})()\n}}","rightValue":"@g.us","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"94334143-7301-4997-8fd0-b4b903be4c6a","leftValue":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.EventType ??\n    ''\n  )\n  .toLowerCase() === 'messages_update' &&\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.type ??\n    ''\n  )\n  .toLowerCase() !== 'deletedmessage'\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"2bb252c4-28b1-4750-9b3c-d6725895f453","leftValue":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.track_id ??\n  ''\n}}","rightValue":"={{\n  $('getVariables')?.item?.json?.chatwoot_track_id ?\n    $('getVariables').item.json.chatwoot_track_id + \n    '-' + \n    String($('getVariables').item.json.chatwoot_account_id).padStart(4,'0') + \n    '-' + \n    String($('getVariables').item.json.chatwoot_inbox_id).padStart(4,'0') :\n  ''\n}}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[448,736],"id":"7d7a2c0a-2297-4855-b34d-9c3d5ea3beb1","name":"fromMeVerify"},{"parameters":{"content":"# ðŸ’¬ IntegraÃ§Ã£o Premium Chatwoot ðŸ” UaZapi\n### _**v1.0.1 â€¢ atualizado: 2025-11-17**_\n\n## Workflow que recebe mensagens via **webhook** da Uazapi, normaliza os dados e envia para o Chatwoot.\n---\n\n## ðŸ§­ O que este fluxo faz\n- Recebe **Webhook (POST)** da UaZapi (`webhookDataUazapi`) e carrega **variÃ¡veis de integraÃ§Ã£o** no Postgres (`getVariables`).\n- **Normaliza** dados de mensagem/contato/grupo (`normalizedData`) e propaga para o contexto (`processedData`).\n- **Localiza ou cria** o **Contato** (`contactFind` â†’ `contactCreate`/`contactUpdate`) e identifica `contact_id`.\n- **Localiza/abre** a **Conversa** (`conversationFind` â†’ `conversationCreate`/`conversationUpdate`) e define `conversation_id`.\n- Resolve **encadeamento** (reply/edited/deleted) consultando o Postgres (`findMessageReply`).\n- **Roteia** por tipo de entrega (`messageVerify`):\n  - `textMessage` â†’ `messageTextSend`\n  - `mediaMessage` â†’ `messageMediaFind` â†’ `messageMediaDownload` â†’ `messageMediaRename` â†’ `messageMediaSend`\n  - `deletedMessage` â†’ `findMessageDeleted` â†’ `deleteMessage` â†’ `Wait` â†’ `messageDeletedUpdate`\n  - `editedMessage` â†’ `findMessageEdited` â†’ `messageEditedUpdate`\n- Atualiza **avatar do contato** (`getContactPhoto` â†’ `sendContactPhoto`) com thumbnail da conversa ou fallback *UI Avatars*.\n- Aplica filtros de **grupo** (`groupVerify`) e **mensagens â€œde mimâ€ vs API** (`fromMeVerify`) para evitar loops.\n\n---\n\n## ðŸ›  Requisitos\n- **Postgres (credencial):** nÃ³s `getVariables` do Manager (Vermelho) e `findMessageReply`, `findMessageEdited`, `findMessageDeleted`, `messageEditedUpdate`, `messageDeletedUpdate` do Chatwoot (Azuis).\n- **VariÃ¡veis de integraÃ§Ã£o (Preenchidas no Gerenciador de InstÃ¢ncias):**\n  - **Chatwoot:** `chatwoot_base_url`, `chatwoot_api_version`, `chatwoot_token`, `chatwoot_account_id`, `chatwoot_inbox_id`, `chatwoot_inbox_name`, `chatwoot_track_id`\n  - **UaZapi:** `api_base_url`, `api_token`, `api_instance_name`\n  - **ConfiguraÃ§Ãµes:** `ignore_groups`, `reply_messages`, `edit_messages`, `delete_messages`, `reopen_conversation`, `conversation_pending`, `import_*`, `sign_*`\n- **UaZapi:** **Gere um cÃ³digo exclusivo para o seu webhook em** [UUID Generator](https://www.uuidgenerator.net/) e informe no campo `Path` do `webhookDataUaZapi`.\n\n---\n\n## âš™ï¸ InstalaÃ§Ã£o & AtivaÃ§Ã£o\n1. **Importe** o workflow no n8n.  \n2. Associe a **credencial Postgres** aos nÃ³s indicados.  \n3. Ajuste o **Webhook** `webhookDataUazapi` (path pÃºblico) e a origem UaZapi.  \n4. Confirme que `getVariables` lÃª a linha correta (por `api_base_url` e `api_token`).  \n5. **Save** â†’ **Activate**.  \n6. Envie um evento de teste pela UaZapi e verifique criaÃ§Ã£o/atualizaÃ§Ã£o de **contato**, **conversa** e **mensagem**.\n\n---\n\n## ðŸ”€ Regras de Roteamento (resumo)\n- **Ignorar grupos:** `groupVerify` bloqueia quando `ignore_groups = true` e o chat Ã© `@g.us`.\n- **Evitar eco/loop:** `fromMeVerify` descarta mensagens **enviadas pela prÃ³pria API** ou indevidas.\n- **Reply/Edited/Deleted:**\n  - `findMessageReply` mapeia `reply_id`/`edited_id`/`deleted_id` no Postgres.\n  - **Reply** sÃ³ aplica se `reply_messages = true`.\n  - **Edited/Deleted** respeitam `edit_messages` / `delete_messages` e a polÃ­tica **0/NULL** do SQL.\n- **Texto vs MÃ­dia:** `messageVerify` separa por `media_key` vÃ¡lido.\n- **Avatar:** usa `data.thumbnail`; fallback **UI Avatars** com nome saneado.\n\n---\n\n## ðŸ” SeguranÃ§a\n- **HTTPS** em Webhook e Chatwoot API.\n- **Tokens** (UaZapi/Chatwoot) mantidos no Gerenciador de InstÃ¢ncias.","height":2128,"width":768,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-1120,512],"typeVersion":1,"id":"d7bc3728-3874-46e9-9e08-b76b40d52ecb","name":"Sticky Note6"},{"parameters":{"httpMethod":"POST","path":"53fa0d94-ec74-4f80-a4c5-1e06ea53d385","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-256,656],"id":"a6aaa24e-a063-4df8-a55e-17750299d024","name":"webhookDataUazapi","webhookId":"53fa0d94-ec74-4f80-a4c5-1e06ea53d385"},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id }}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/toggle_status","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"contentType":"raw","rawContentType":"application/json; charset=utf-8","body":"={\n    \"status\": \"open\"\n}","options":{"redirect":{"redirect":{}}}},"id":"621733f2-f9f6-481e-ba7e-ed001c014c58","name":"conversationUpdate","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,1488],"retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id }}/conversations","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"contentType":"raw","rawContentType":"application/json; charset=utf-8","body":"={\n    \"source_id\": \"{{ $('normalizedData')?.item?.json?.data?.is_group ? $('processedData')?.item?.json?.group?.id.split('@').first() : $('processedData')?.item?.json?.contact?.phone_number }}\",\n    \"inbox_id\": {{ $('processedData')?.item?.json?.chatwoot?.inbox_id }},\n    \"contact_id\": {{ $('processedData')?.item?.json?.contact?.contact_id }},\n    \"status\": \"{{ $('getVariables')?.item?.json?.conversation_pending ? 'pending' : 'open' }}\"\n}","options":{"redirect":{"redirect":{}}}},"id":"5aa053af-e139-4ec5-9c8d-703ef326d01e","name":"conversationCreate","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,1328],"retryOnFail":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('processedData')?.item?.json?.data?.conversation_id }}","rightValue":0,"operator":{"type":"number","operation":"equals"},"id":"a94220d5-0750-41e6-9731-38863b5f6775"}],"combinator":"and"},"renameOutput":true,"outputKey":"new"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"feb7e1d6-e636-4e5c-a4ed-afb12d66436f","leftValue":"={{ $('processedData')?.item?.json?.data?.conversation_id > 0 && ( $('processedData')?.item?.json?.data?.conversation_status === 'open' || $('processedData')?.item?.json?.data?.conversation_status === 'pending' ) }}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"openedOrPending"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"439f50b9-e41c-40e9-b9c0-b71e1f6aae8c","leftValue":"={{ $('processedData')?.item?.json?.data?.conversation_id > 0 && $('processedData')?.item?.json?.data?.conversation_status === 'open' }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"closed"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[448,1392],"id":"2d1186ce-8f14-468c-a174-2b6de7ce4afb","name":"conversationVerify"},{"parameters":{"content":"## Tratamento da Foto do Contato","height":912,"width":504},"type":"n8n-nodes-base.stickyNote","position":[1824,992],"typeVersion":1,"id":"1a222c34-e9e4-48c2-8ccb-12d9b3763cdf","name":"Sticky Note8"},{"parameters":{"operation":"select","schema":{"__rl":true,"value":"chatwoot_uazapi","mode":"list","cachedResultName":"chatwoot_uazapi"},"table":{"__rl":true,"value":"chatwoot_uazapi_config","mode":"list","cachedResultName":"chatwoot_uazapi_config"},"limit":1,"where":{"values":[{"column":"api_base_url","value":"={{ $('webhookDataUazapi')?.item?.json?.body?.BaseUrl }}"},{"column":"api_token","value":"={{ $('webhookDataUazapi')?.item?.json?.body?.token }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-80,656],"id":"fbb611c9-153b-4700-83ea-13807905452f","name":"getVariables","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"url":"={{ $('processedData')?.item?.json?.contact?.avatar ??\n   ''\n}}","options":{"response":{"response":{"neverError":true,"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2032,1088],"id":"abe2af8b-f7aa-43a9-a824-cdb2388e4a4f","name":"getContactPhoto"},{"parameters":{"method":"PUT","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/contacts/{{ $('processedData')?.item?.json?.contact?.contact_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"},{"name":"Content-type","value":"application/json; charset=utf-8"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"avatar","inputDataFieldName":"data"}]},"options":{"response":{"response":{"neverError":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2208,1088],"id":"37d387fb-dddb-4c3c-a444-a6a55b28b5bf","name":"sendContactPhoto","retryOnFail":true},{"parameters":{"operation":"executeQuery","query":"SELECT\n  $1::integer AS conversation_id,\n  CASE\n    WHEN $2::boolean IS FALSE OR NULLIF($3, '') IS NULL\n    THEN NULL\n    ELSE (\n      SELECT id\n      FROM public.messages\n      WHERE account_id = $4::integer\n        AND inbox_id   = $5::integer\n        AND source_id  = $3\n      ORDER BY created_at DESC\n      LIMIT 1\n    )\n  END AS reply_id,\n  CASE\n    WHEN $6::boolean IS FALSE AND NULLIF($7, '') IS NOT NULL\n    THEN 0\n    WHEN NULLIF($7, '') IS NULL\n    THEN NULL\n    WHEN $6::boolean IS FALSE\n    THEN NULL\n    ELSE (\n      SELECT id\n      FROM public.messages\n      WHERE account_id = $4::integer\n        AND inbox_id   = $5::integer\n        AND source_id  = $7\n      ORDER BY created_at DESC\n      LIMIT 1\n    )\n  END AS edited_id,\n  CASE\n    WHEN $8::boolean IS FALSE AND NULLIF($9, '') IS NOT NULL\n    THEN 0\n    WHEN NULLIF($9, '') IS NULL\n    THEN NULL\n    WHEN $8::boolean IS FALSE\n    THEN NULL\n    ELSE (\n      SELECT id\n      FROM public.messages\n      WHERE account_id = $4::integer\n        AND inbox_id   = $5::integer\n        AND source_id  = $9\n      ORDER BY created_at DESC\n      LIMIT 1\n    )\n  END AS deleted_id;","options":{"queryReplacement":"={{ [\n  String($json?.id ?? $json?.payload?.conversation_id ?? $json?.data?.conversation_id ?? 0),\n  String($('processedData')?.item?.json?.chatwoot?.reply_messages ?? false),\n  String($('processedData')?.item?.json?.data.reply_id ?? ''),\n  String($('processedData')?.item?.json?.chatwoot?.account_id ?? ''),\n  String($('processedData')?.item?.json?.chatwoot?.inbox_id ?? ''),\n  String($('processedData')?.item?.json?.chatwoot?.edit_messages ?? false),\n  String($('processedData')?.item?.json?.data?.edited_id ?? ''),\n  String($('processedData')?.item?.json?.chatwoot?.delete_messages ?? false),\n  String($('processedData')?.item?.json?.data?.deleted_id ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[800,1408],"id":"c175c96e-2788-45f0-b309-f7cbfcc9a563","name":"findMessageReply","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bf9dd4b4-6f2e-4628-ab0a-29f6b8b99c03","leftValue":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.EventType ??\n    ''\n  )\n}}","rightValue":"messages","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"fa2f52c5-befc-445f-ab3f-1cdf5fad99b3","leftValue":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.EventType ??\n    ''\n  )\n  .toLowerCase() === 'messages_update' &&\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.type ??\n    ''\n  )\n  .toLowerCase() === 'deletedmessage'\n}}","rightValue":"messages_update","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[96,656],"id":"d1c4c4e7-bc3c-40ad-8711-893b7c4390e8","name":"messageTypeFilter"},{"parameters":{"operation":"executeQuery","query":"SELECT COALESCE(\n  (SELECT content\n     FROM public.messages\n    WHERE id = $1::integer\n    LIMIT 1),\n    ''\n  ) AS content;","options":{"queryReplacement":"={{\n  [\n    String($('messageVerify')?.item?.json?.deleted_id ?? 0)\n  ]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1152,1408],"id":"c7b45410-14cc-4c20-b627-cd9b883a3332","name":"findMessageDeleted","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1152,1760],"id":"211bbc9b-4d3d-47d0-8b73-ec75ca58de1e","name":"messageSentEndProcess"},{"parameters":{"operation":"executeQuery","query":"SELECT COALESCE(\n  (SELECT content\n     FROM public.messages\n    WHERE id = $1::integer\n    LIMIT 1),\n    ''\n  ) AS content;","options":{"queryReplacement":"={{\n  [\n    String($('messageVerify')?.item?.json?.edited_id ?? 0)\n  ]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1152,1584],"id":"f876a9aa-75a2-4cd5-b8c1-3b9572bdccb5","name":"findMessageEdited","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Mgnr","height":176,"width":166,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-112,624],"typeVersion":1,"id":"4ba31b7a-bd4d-4e2b-87db-556cd8b1db99","name":"Sticky Note9"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[768,1376],"typeVersion":1,"id":"86cb4ee2-7fd3-44ce-af75-115440db293c","name":"Sticky Note10"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1472,1376],"typeVersion":1,"id":"0fb4aaf9-8bca-4759-a134-14b09da12855","name":"Sticky Note11"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1120,1376],"typeVersion":1,"id":"73bf495a-62a2-4ee3-b882-d71fbc26cb84","name":"Sticky Note12"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{\n  String($('processedData')?.item?.json?.data?.media_key ?? '').trim() === '' &&\n  $('findMessageReply')?.item?.json?.deleted_id == null &&\n  $('findMessageReply')?.item?.json?.edited_id == null\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"ed4a34fc-e5c3-403c-8fdf-398a1d4cf3fd"}],"combinator":"and"},"renameOutput":true,"outputKey":"textMessage"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6130e0f5-c301-4433-9fa3-974a66d05383","leftValue":"={{\n  String($('processedData')?.item?.json?.data?.media_key ?? '').trim() !== '' &&\n  $('findMessageReply')?.item?.json?.deleted_id == null &&\n  $('findMessageReply')?.item?.json?.edited_id == null\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"mediaMessage"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"07ca6767-622e-4176-913b-0ab3059c298c","leftValue":"={{ Number($('findMessageReply')?.item?.json?.deleted_id ?? 0) > 0 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"deletedMessage"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4ef1f52b-f800-4f1d-8c4a-327a410d77f5","leftValue":"={{ Number($('findMessageReply')?.item?.json?.edited_id ?? 0) > 0 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"editedMessage"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[976,1360],"id":"a27a6079-aae2-40d6-8b99-9360f293fef4","name":"messageVerify"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1120,1552],"typeVersion":1,"id":"be68bab4-e1ce-4fc5-bc5f-b117063d1bd6","name":"Sticky Note13"},{"parameters":{"content":"# âš–ï¸ Aviso de Propriedade Intelectual & Suporte\n\nEste workflow e sua UI sÃ£o **propriedade intelectual** da EMKT Consultoria e Tecnologia, protegidos pelas Leis **9.610/98 (Direitos Autorais)**, **9.609/98 (Software)** e pela **LGPD â€“ 13.709/18**.\n---\n\n## Uso permitido\n- LicenÃ§a de **uso interno**, nÃ£o exclusiva e intransferÃ­vel.\n- Ã‰ vedada a **distribuiÃ§Ã£o**, **revenda**, **locaÃ§Ã£o**, **cessÃ£o**, **publicaÃ§Ã£o** ou **exposiÃ§Ã£o pÃºblica** (incl. repositÃ³rios/portais).\n\n## ProibiÃ§Ãµes\n- **CÃ³pia** total/parcial, **engenharia reversa**, **descompilaÃ§Ã£o**, **circunvenÃ§Ã£o** de proteÃ§Ãµes.\n- **ModificaÃ§Ãµes** nÃ£o autorizadas, criaÃ§Ã£o de **derivados** ou remoÃ§Ã£o de crÃ©ditos/identificaÃ§Ãµes.\n- **Compartilhamento** do pacote/fluxo, credenciais, URLs de webhook, telas ou prints com terceiros.\n\n## Suporte & Garantia\n- A **garantia de suporte** e atualizaÃ§Ãµes estÃ¡ **condicionada** Ã  manutenÃ§Ã£o do **estado original** do workflow.  \n- Qualquer **alteraÃ§Ã£o nÃ£o autorizada** (cÃ³digo, nÃ³s, credenciais, rotas, lÃ³gica ou layout) **invalida o suporte**.\n- AdequaÃ§Ãµes/integraÃ§Ãµes adicionais requerem **contrataÃ§Ã£o prÃ©via** e **autorizaÃ§Ã£o por escrito**.\n\n---\n\n### ðŸ“ž Contato\nPrecisa de ajuda? Fale conosco pelo WhatsApp Business  \n**(41) 9 8473-9797** â€” [abrir conversa](https://api.whatsapp.com/message/FVXDCWKJFIM4M1)  \n**(79) 9 9977-7712** â€” [abrir conversa](https://api.whatsapp.com/message/2G6M66MXFH7TD1)\n\n> DÃºvidas sobre uso, licenÃ§a ou autorizaÃ§Ã£o: contate a EMKT.\n","height":720,"width":2896,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-336,1920],"typeVersion":1,"id":"d20059b7-c886-430e-9d97-ef73cb62c640","name":"Sticky Note14"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const normalizedData = $('normalizedData')?.first()?.json;\nconst getVariables = $('getVariables')?.first()?.json;\nconst conversationFind = $('conversationFind')?.first()?.json;\n\nconst conversations = $('conversationFind')?.item?.json?.payload;\n\nconst reopen = getVariables?.reopen_conversation;\nconst foundStatus = conversationFind?.payload?.[0]?.status;\nconst expectedStatus = reopen ? (foundStatus ?? 'open') : 'open';\nconst expectedInboxId = normalizedData?.chatwoot?.inbox_id;\n\nconst filteredConversations = conversations.filter(conv => {\n  const inboxMatch = (conv.messages?.[0]?.inbox_id || 0) == expectedInboxId;\n  const statusMatch = (conv.status ?? '') == expectedStatus;\n  return inboxMatch && statusMatch;\n});\n\nconst sortedConversations = filteredConversations.sort((a, b) => b.id - a.id);\n\nconst topConversation = sortedConversations[0];\n\nif (topConversation) {\n  return {\n    json: {\n      conversation_id: topConversation.id\n    }\n  };\n}\n\nreturn {\n  json: {\n    conversation_id: 0\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[96,1408],"id":"6d3c53ea-cff5-40b7-8894-4b40f85e8f51","name":"conversationIdentify"},{"parameters":{"url":"={{ $('messageMediaFind')?.item?.json?.fileURL }}","options":{"response":{"response":{"neverError":true,"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1328,1248],"id":"9e603b96-432a-443a-a135-888a51dafe27","name":"messageMediaDownload","retryOnFail":true},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[768,704],"typeVersion":1,"id":"d158ddf5-5fde-4ac1-8991-2dc4d7e00b90","name":"Sticky Note15"},{"parameters":{"operation":"executeQuery","query":"WITH NormalizedInput AS (\n  SELECT\n    NULLIF($1, '') AS input_identifier,\n    NULLIF($2, '') AS input_lid,\n    NULLIF($3, '') AS input_full_name,\n    NULLIF($4, '') AS input_phone_number,\n    NULLIF($5, '')::integer AS input_account_id\n)\nSELECT\n  COALESCE(c.id, 0) AS contact_id,\n  COALESCE(c.identifier, '') AS identifier_old,\n  COALESCE(ni.input_identifier, '') AS identifier_new,\n  COALESCE(c.additional_attributes ->> 'contact_lid', '') AS contact_lid_old,\n  COALESCE(ni.input_lid, '') AS contact_lid_new,\n  COALESCE(c.name, '') AS name_old,\n  COALESCE(ni.input_full_name, '') AS name_new,\n  COALESCE(c.phone_number, '') AS phone_number_old,\n  COALESCE(ni.input_phone_number, '') AS phone_number_new,\n  CASE\n    WHEN c.id IS NULL THEN true\n    WHEN (\n      COALESCE(c.identifier, '') != COALESCE(ni.input_identifier, '') OR\n      COALESCE(c.additional_attributes ->> 'contact_lid', '') != COALESCE(ni.input_lid, '') OR\n      COALESCE(c.phone_number, '') != COALESCE(ni.input_phone_number, '')\n    ) THEN true\n    WHEN (\n      COALESCE(c.name, '') = 'Contato' AND\n      COALESCE(c.name, '') != COALESCE(ni.input_full_name, '')\n    ) THEN true\n    ELSE false\n  END AS update_data\nFROM NormalizedInput AS ni\nLEFT JOIN contacts AS c ON\n  (c.account_id = ni.input_account_id AND ni.input_account_id IS NOT NULL)\n  AND (\n    (c.identifier = ni.input_identifier AND ni.input_identifier IS NOT NULL) OR\n    (c.additional_attributes ->> 'contact_lid' = ni.input_lid AND ni.input_lid IS NOT NULL) OR\n    (c.phone_number = ni.input_phone_number AND ni.input_phone_number IS NOT NULL)\n  );","options":{"queryReplacement":"={{\n  [\n    String($('normalizedData')?.item?.json?.contact?.identifier) || null,\n    String($('normalizedData')?.item?.json?.contact?.lid),\n    String($('normalizedData')?.item?.json?.contact?.full_name).replace(/'/g, \"''\") || null,\n    String($('normalizedData')?.item?.json?.contact?.phone_number) || null,\n    String($('normalizedData')?.item?.json?.chatwoot?.account_id) || null\n  ]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[800,736],"id":"09bfc2b6-90e8-4460-9e25-5d79a5cd612f","name":"contactFind","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{\n  (\n    $('contactFind')?.item?.json ??\n    {}\n  )\n  .contact_id === 0\n}}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true},"id":"e71ede49-b811-46e9-be73-fcece40f27c8"}],"combinator":"and"},"renameOutput":true,"outputKey":"create"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"342366cd-05e8-4efe-b237-ccf032377806","leftValue":"={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data.contact_id > 0);\n  const shouldUpdate = (data.update_data !== true);\n  return contactIdExists && shouldUpdate;\n})()\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"exists"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7bcd700f-3396-4c45-953c-8b5bcdf1bbbe","leftValue":"={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data.contact_id > 0);\n  const shouldUpdate = (data.update_data === true);\n  return contactIdExists && shouldUpdate;\n})()\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"update"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[976,720],"id":"180b7d0b-a469-4ec6-8653-2d325a2dd65a","name":"contactVerify"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"contacts","mode":"list","cachedResultName":"contacts"},"columns":{"mappingMode":"defineBelow","value":{"identifier":"={{ $('contactVerify')?.item?.json?.identifier_new }}","id":"={{ $('contactVerify').item.json.contact_id }}","additional_attributes":"={{ ({ \"contact_lid\": $('contactVerify')?.item?.json?.contact_lid_new }) }}","name":"={{\n(() => {\n  const data = $('contactVerify')?.item?.json ?? {};\n  \n  const oldName = data.name_old ?? '';\n  const newName = data.name_new ?? '';\n  if (oldName === 'Contato') {\n    return newName;\n  }\n  return oldName;\n})()\n}}","phone_number":"={{ $('contactVerify')?.item?.json?.identifier_new.split('@').last() === 'g.us' ? $('contactVerify')?.item?.json?.phone_number_new : $('contactVerify')?.item?.json?.phone_number_old }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"name","displayName":"name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"email","displayName":"email","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"phone_number","displayName":"phone_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"account_id","displayName":"account_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"additional_attributes","displayName":"additional_attributes","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":false},{"id":"identifier","displayName":"identifier","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"custom_attributes","displayName":"custom_attributes","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"last_activity_at","displayName":"last_activity_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"contact_type","displayName":"contact_type","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"middle_name","displayName":"middle_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_name","displayName":"last_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"location","displayName":"location","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"country_code","displayName":"country_code","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"blocked","displayName":"blocked","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":true},{"id":"company_id","displayName":"company_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1152,816],"id":"c7b78fdc-289a-48a8-a85d-8b44ac48735f","name":"contactUpdate","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1120,784],"typeVersion":1,"id":"ead53782-a17b-4d2c-820c-c60913ba23c1","name":"Sticky Note16"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// 1. Pega os dados originais dos nÃ³s anteriores\n// (Ajuste o nome do nÃ³ 'findMessageReply' se for diferente)\nconst replyData = $('findMessageReply')?.item?.json;\nconst deletedData = $('findMessageDeleted')?.item?.json;\n\nconst originalAttributes = replyData.content_attributes;\nconst originalContent = deletedData.content ?? '';\n\n// 2. PARSE (Sua lÃ³gica - InÃ­cio)\n// Normaliza o 'content_attributes' para um objeto JS\nlet parsedAttributes = {};\n\nif (typeof originalAttributes === 'string') {\n  // Caso 1: Ã‰ uma string JSON (ex: \"{\\\"key\\\":\\\"value\\\"}\")\n  try {\n    // Tenta fazer o parse da string\n    parsedAttributes = JSON.parse(originalAttributes);\n  } catch (e) {\n    // Falha: pode ser uma string vazia \"\" ou \"{}\"\n    parsedAttributes = {};\n  }\n} else if (typeof originalAttributes === 'object' && originalAttributes !== null) {\n  // Caso 2: Ã‰ um objeto JSON (ex: {\"key\":\"value\"})\n  parsedAttributes = originalAttributes;\n}\n\n// 3. MODIFY\n// Adiciona a flag 'deleted'\nparsedAttributes.deleted = true;\n\n// 4. STRINGIFY\n// Converte de volta para a string JSON que o Chatwoot espera\nconst newAttributesString = JSON.stringify(parsedAttributes);\n\n// 5. Prepara o 'content' (a lÃ³gica que vocÃª jÃ¡ tinha)\nconst newContent = (\n  \"ðŸš« _Mensagem ExcluÃ­da:_\" +\n  \"\\n\\n\" + \"---\" + \"\\n\\n\" +\n  (\n    String(originalContent)\n      .replaceAll('~~','')\n      .replace(/([^\\r\\n]+)/g, \"~~$1~~\")\n  )\n)\n  .replaceAll('~~---~~','---');\n\n// 6. Retorna tudo pronto para o nÃ³ SQL\n// Note que 'new_attributes_string' Ã© o JSON stringificado que vocÃª pediu\nreturn {\n  json: {\n    deleted_id: replyData.deleted_id,\n    new_content: newContent,\n    new_attributes: newAttributesString // Ex: \"{\\\"deleted\\\":true}\"\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,1408],"id":"1766c40e-7957-4549-bd4d-af2c93ea8b51","name":"prepareMessageDeleted"},{"parameters":{"operation":"executeQuery","query":"UPDATE public.messages\nSET \n  content = $1,\n  content_attributes = $2::json\nWHERE \n  id = $3::integer\nRETURNING \n  id, content, content_attributes;","options":{"queryReplacement":"={{ [\n  String($('prepareMessageDeleted')?.item?.json?.new_content ?? ''),\n  String(JSON.stringify( $('prepareMessageDeleted')?.item?.json?.new_attributes ?? {} )),\n  String($('prepareMessageDeleted')?.item?.json?.deleted_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1504,1408],"id":"b3e8c5f1-a2a1-49ff-b5ac-be2b6eeb1dc8","name":"updateMessageDeleted","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id }}/messages/{{ $('messageVerify')?.item?.json?.deleted_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"sent"}]},"options":{}},"id":"39551669-d674-49b1-b00a-607cd68b96cf","name":"patchMessageDeleted","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1680,1408],"retryOnFail":true},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id }}/messages/{{ $('messageVerify')?.item?.json?.edited_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"sent"}]},"options":{}},"id":"643fd38b-5107-40e2-9b1e-0f04f23c3623","name":"patchMessageEdited","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1504,1584],"retryOnFail":true},{"parameters":{"operation":"executeQuery","query":"WITH updated AS (\n  UPDATE public.messages\n  SET \n    content = $1\n  WHERE id = $2::integer\n  RETURNING id, content, source_id\n)\nSELECT\n  (SELECT COUNT(*) FROM updated) AS rows_affected,\n  (SELECT content FROM updated LIMIT 1) AS content,\n  (SELECT source_id FROM updated LIMIT 1) AS source_id;","options":{"queryReplacement":"={{ [\n  (\n    \"ðŸ”„ _Mensagem Editada:_\\n\\n\" +\n    (\n      String( $('findMessageEdited')?.item?.json?.content ?? '' )\n        .replaceAll('ðŸ”„ _Mensagem Editada:_\\n\\n','')\n        .replaceAll('~~','')\n        .replace(/([^\\r\\n]+)/g, \"~~$1~~\")\n    ) +\n    \"\\n\\n\" + \"---\" + \"\\n\\n\" +\n      String($('normalizedData')?.item?.json?.data?.content ?? '')\n  )\n    .replaceAll('~~---~~', '---'),\n  \n  String($('findMessageReply')?.item?.json?.edited_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1328,1584],"id":"adf4b5f1-6602-4223-b8e2-fb5c1fec5417","name":"updateMessageEdited","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1296,1552],"typeVersion":1,"id":"085f40ad-29a4-4762-9b22-03fc59c45966","name":"Sticky Note17"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.account_id ?? ''}}"},{"key":"inboxId","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('normalizedData')?.item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('normalizedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('normalizedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('normalizedData')?.item?.json?.data?.conversation_status ?? '' }}"},{"key":"messageId","value":"={{ $('normalizedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('normalizedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('normalizedData')?.item?.json?.data?.message_direction ?? '' }}"},{"key":"eventType","value":"={{ $('normalizedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[800,576],"id":"65db3900-6b28-4212-a73f-61de11281674","name":"executionData1"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('processedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('processedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('processedData')?.item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('processedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('processedData')?.item?.json?.data?.conversation_status ?? '' }}"},{"key":"messageId","value":"={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('processedData')?.item?.json?.data?.message_direction ?? '' }}"},{"key":"eventType","value":"={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[2384,1248],"id":"62bd669f-c66a-43b4-8440-cd9dcbd7a7a2","name":"executionData3"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('processedData')?.item?.json?.chatwoot.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('processedData')?.item?.json?.chatwoot.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('processedData')?.item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('processedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('processedData')?.item?.json?.data?.conversation_status ?? '' }}"},{"key":"messageId","value":"={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('processedData')?.item?.json?.data?.message_direction ?? '' }}"},{"key":"eventType","value":"={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[272,1248],"id":"061f5121-a9eb-4622-b7da-e7b596abf69b","name":"executionData"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ecef90c3-8fe9-40e0-bc79-33b7f88b60ef","leftValue":"={{ $('processedData')?.item?.json?.contact?.avatar ??\n   ''\n}}","rightValue":"http","operator":{"type":"string","operation":"startsWith"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1856,1088],"id":"9ac73a6c-6ea8-4b71-8a3d-940f17700497","name":"avatarVerify"}],"connections":{"normalizedData":{"main":[[{"node":"contactFind","type":"main","index":0},{"node":"executionData1","type":"main","index":0}]]},"contactCreate":{"main":[[{"node":"contactIdentify","type":"main","index":0}],[{"node":"contactFind","type":"main","index":0}]]},"contactIdentify":{"main":[[{"node":"conversationFind","type":"main","index":0}]]},"conversationFind":{"main":[[{"node":"conversationIdentify","type":"main","index":0}]]},"processedData":{"main":[[{"node":"conversationVerify","type":"main","index":0},{"node":"executionData","type":"main","index":0}]]},"messageMediaFind":{"main":[[{"node":"messageMediaDownload","type":"main","index":0}]]},"messageMediaSend":{"main":[[{"node":"avatarVerify","type":"main","index":0}]]},"messageTextSend":{"main":[[{"node":"avatarVerify","type":"main","index":0}]]},"messageMediaRename":{"main":[[{"node":"messageMediaSend","type":"main","index":0}]]},"groupVerify":{"main":[[{"node":"groupEndProcess","type":"main","index":0}],[{"node":"fromMeVerify","type":"main","index":0}]]},"fromMeVerify":{"main":[[{"node":"fromMeEndProcess","type":"main","index":0}],[{"node":"normalizedData","type":"main","index":0}]]},"webhookDataUazapi":{"main":[[{"node":"getVariables","type":"main","index":0}]]},"conversationUpdate":{"main":[[{"node":"findMessageReply","type":"main","index":0}]]},"conversationCreate":{"main":[[{"node":"findMessageReply","type":"main","index":0}]]},"conversationVerify":{"main":[[{"node":"conversationCreate","type":"main","index":0}],[{"node":"findMessageReply","type":"main","index":0}],[{"node":"conversationUpdate","type":"main","index":0}]]},"getVariables":{"main":[[{"node":"messageTypeFilter","type":"main","index":0}]]},"getContactPhoto":{"main":[[{"node":"sendContactPhoto","type":"main","index":0}]]},"sendContactPhoto":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"findMessageReply":{"main":[[{"node":"messageVerify","type":"main","index":0}]]},"messageTypeFilter":{"main":[[{"node":"groupVerify","type":"main","index":0}]]},"findMessageDeleted":{"main":[[{"node":"prepareMessageDeleted","type":"main","index":0}]]},"findMessageEdited":{"main":[[{"node":"updateMessageEdited","type":"main","index":0}]]},"messageVerify":{"main":[[{"node":"messageTextSend","type":"main","index":0}],[{"node":"messageMediaFind","type":"main","index":0}],[{"node":"findMessageDeleted","type":"main","index":0}],[{"node":"findMessageEdited","type":"main","index":0}],[{"node":"messageSentEndProcess","type":"main","index":0}]]},"conversationIdentify":{"main":[[{"node":"processedData","type":"main","index":0}]]},"messageMediaDownload":{"main":[[{"node":"messageMediaRename","type":"main","index":0}]]},"contactFind":{"main":[[{"node":"contactVerify","type":"main","index":0}]]},"contactVerify":{"main":[[{"node":"contactCreate","type":"main","index":0}],[{"node":"contactIdentify","type":"main","index":0}],[{"node":"contactUpdate","type":"main","index":0}]]},"contactUpdate":{"main":[[{"node":"contactIdentify","type":"main","index":0}]]},"prepareMessageDeleted":{"main":[[{"node":"updateMessageDeleted","type":"main","index":0}]]},"updateMessageDeleted":{"main":[[{"node":"patchMessageDeleted","type":"main","index":0}]]},"patchMessageDeleted":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"updateMessageEdited":{"main":[[{"node":"patchMessageEdited","type":"main","index":0}]]},"patchMessageEdited":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"endProcess":{"main":[[{"node":"executionData3","type":"main","index":0}]]},"avatarVerify":{"main":[[{"node":"getContactPhoto","type":"main","index":0}],[{"node":"endProcess","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"webhookDataUazapi":[{"json":{"headers":{"host":"sdn8n.scaladigital.com.br","user-agent":"uazapiGO-Webhook/1.0","content-length":"2436","accept-encoding":"gzip","content-type":"application/json","x-forwarded-for":"187.45.178.254","x-forwarded-host":"sdn8n.scaladigital.com.br","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"9ffe90470d6d","x-real-ip":"187.45.178.254"},"params":{},"query":{},"body":{"BaseUrl":"https://scala.uazapi.com","EventType":"messages","chat":{"chatbot_agentResetMemoryAt":0,"chatbot_disableUntil":0,"chatbot_lastTriggerAt":0,"chatbot_lastTrigger_id":"","id":"r841799abf47f38","image":"","imagePreview":"https://pps.whatsapp.net/v/t61.24694-24/534421439_813499471264811_6538867723055635378_n.jpg?stp=dst-jpg_s96x96_tt6&ccb=11-4&oh=01_Q5Aa3AEL_JL7Ly7qDwXgkJLCVWLvqbeB6JsuVGFgxBv11LSwCQ&oe=6922EB66&_nc_sid=5e03e0&_nc_cat=100","lead_assignedAttendant_id":"","lead_email":"","lead_field01":"","lead_field02":"","lead_field03":"","lead_field04":"","lead_field05":"","lead_field06":"","lead_field07":"","lead_field08":"","lead_field09":"","lead_field10":"","lead_field11":"","lead_field12":"","lead_field13":"","lead_field14":"","lead_field15":"","lead_field16":"","lead_field17":"","lead_field18":"","lead_field19":"","lead_field20":"","lead_fullName":"","lead_isTicketOpen":false,"lead_kanbanOrder":0,"lead_name":"","lead_notes":"","lead_personalid":"","lead_status":"","lead_tags":[],"name":"Alessandro Torres","owner":"556241034986","phone":"+55 62 9244-5646","wa_archived":false,"wa_chatid":"556292445646@s.whatsapp.net","wa_contactName":"","wa_ephemeralExpiration":0,"wa_fastid":"556241034986:556292445646","wa_isBlocked":false,"wa_isGroup":false,"wa_isGroup_admin":false,"wa_isGroup_announce":false,"wa_isGroup_community":false,"wa_isGroup_member":false,"wa_isPinned":false,"wa_label":[],"wa_lastMessageSender":"556292445646@s.whatsapp.net","wa_lastMessageTextVote":"Teste","wa_lastMessageType":"Conversation","wa_lastMsgTimestamp":1763747647000,"wa_muteEndTime":0,"wa_name":"Alessandro Torres","wa_unreadCount":2},"instanceName":"Colbiflex","message":{"buttonOrListid":"","chatid":"556292445646@s.whatsapp.net","content":"Teste","convertOptions":"","edited":"","fromMe":false,"groupName":"Unknown","id":"556241034986:A5A6A64047D09127AACE2513D5A845AC","isGroup":false,"mediaType":"","messageTimestamp":1763747647000,"messageType":"Conversation","messageid":"A5A6A64047D09127AACE2513D5A845AC","owner":"556241034986","quoted":"","reaction":"","sender":"556292445646@s.whatsapp.net","senderName":"Alessandro Torres","sender_lid":"204779829641392@lid","sender_pn":"556292445646@s.whatsapp.net","source":"android","status":"","text":"Teste","track_id":"","track_source":"","type":"text","vote":"","wasSentByApi":false},"owner":"556241034986","token":"4f650afe-fc9f-4df4-8400-6f6678b1800d"},"webhookUrl":"https://sdn8n.scaladigital.com.br/webhook/53fa0d94-ec74-4f80-a4c5-1e06ea53d385","executionMode":"production"}}]},"versionId":"cc26c5a3-df08-466b-b977-7bd894118bd0","activeVersionId":"cc26c5a3-df08-466b-b977-7bd894118bd0","triggerCount":1,"shared":[{"updatedAt":"2025-11-20T17:36:40.731Z","createdAt":"2025-11-20T17:36:40.731Z","role":"workflow:owner","workflowId":"twk9dZkyKx5kwWea","projectId":"Cf0rhzAQivp560yX"}],"activeVersion":{"updatedAt":"2025-11-26T21:17:26.817Z","createdAt":"2025-11-26T21:17:26.817Z","versionId":"cc26c5a3-df08-466b-b977-7bd894118bd0","workflowId":"twk9dZkyKx5kwWea","nodes":[{"parameters":{"content":"## Tratamento Inicial dos Dados","height":464,"width":860},"type":"n8n-nodes-base.stickyNote","position":[-112,512],"typeVersion":1,"id":"c44eb760-b8fc-4285-96e8-683d8735b4fd","name":"Sticky Note"},{"parameters":{"content":"## InÃ­cio do Processamento","height":1396,"width":208},"type":"n8n-nodes-base.stickyNote","position":[-336,512],"typeVersion":1,"id":"1aa41e65-7ad1-41f0-ae39-a91d2d135ebb","name":"Sticky Note1"},{"parameters":{"content":"## Tratamento do Contato","height":464,"width":1560},"type":"n8n-nodes-base.stickyNote","position":[768,512],"typeVersion":1,"id":"bcc9998f-29fd-465c-99ac-2e34887d4465","name":"Sticky Note2"},{"parameters":{"content":"## Tratamento da Conversa","height":912,"width":860},"type":"n8n-nodes-base.stickyNote","position":[-112,992],"typeVersion":1,"id":"682875c3-dd44-48b6-ba39-87091dd3a814","name":"Sticky Note3"},{"parameters":{"content":"## Tratamento da Mensagem","height":912,"width":1032},"type":"n8n-nodes-base.stickyNote","position":[768,992],"typeVersion":1,"id":"56d205ae-cfe4-4966-a2fd-0bb5fbbe4c69","name":"Sticky Note4"},{"parameters":{"content":"## Final do Processamento","height":1396,"width":208},"type":"n8n-nodes-base.stickyNote","position":[2352,512],"typeVersion":1,"id":"cbc6f3e8-110a-416c-a101-7a3d99e43436","name":"Sticky Note5"},{"parameters":{"content":"```\n                                                                                                                  â–ˆâ–ˆâ–ˆ       â–ˆ                            â–ˆâ–ˆ          â–ˆ   â–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â–ˆ             â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ          â–ˆ                   â–ˆ\n                                                                                                                   â–ˆ       â–ˆâ–ˆâ–ˆ                                       â–ˆ   â–ˆ          â–ˆ                         â–ˆ     â–ˆ         â–ˆâ–ˆâ–ˆ                 â–ˆâ–ˆâ–ˆ\n                                                                                                                   â–ˆ  â–ˆ â–ˆâ–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆ   â–ˆ    â–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ            â–ˆ    â–ˆâ–ˆâ–ˆ    â–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n                                                                                                                   â–ˆ  â–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆ      â–ˆ â–ˆ       â–ˆ â–ˆ  â–ˆ    â–ˆ   â–ˆ    â–ˆ   â–ˆ      â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ     â–ˆ     â–ˆ  â–ˆ    â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ           â–ˆâ–ˆ    â–ˆ â–ˆ   â–ˆâ–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ    â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ      â–ˆ      â–ˆ     â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ   â–ˆ    â–ˆ â–ˆ    â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ  â–ˆ    â–ˆ   â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ     â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ   â–ˆ    â–ˆ â–ˆ    â–ˆ     â–ˆ    â–ˆ â–ˆ  â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                                  â–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆ   â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆ â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ      â–ˆ   â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ    â–ˆ    â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                                                       â–ˆ             â–ˆ                                     â–ˆ\n                                                                                                                                    â–ˆâ–ˆâ–ˆâ–ˆ            â–ˆ                                      â–ˆ\n```","height":200,"width":3680,"color":7},"type":"n8n-nodes-base.stickyNote","position":[-1120,288],"typeVersion":1,"id":"739a9a2b-0c3b-41d3-a8b6-2298cc075467","name":"Sticky Note7"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[448,576],"id":"1a2d94c2-f8c0-4237-9800-fdfc4f3de686","name":"groupEndProcess"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[624,656],"id":"f4d6271d-46b7-4485-b763-b37e4d3c32a9","name":"fromMeEndProcess"},{"parameters":{"assignments":{"assignments":[{"id":"663ff314-a7aa-44b1-bfa8-22ae64a23870","name":"chatwoot","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:        s.chatwoot_base_url,\n    api_version:     s.chatwoot_api_version,\n    token:           s.chatwoot_token,\n    account_id:      s.chatwoot_account_id,\n    inbox_id:        s.chatwoot_inbox_id,\n    inbox_name:      s.chatwoot_inbox_name,\n    track_id:        s.chatwoot_track_id,\n    reply_messages:  s.reply_messages,\n    edit_messages:   s.edit_messages,\n    delete_messages: s.delete_messages\n  };\n})() }}","type":"object"},{"id":"a1a2a399-dea0-4f58-a284-8d38994ea182","name":"api","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:          s.api_base_url,\n    token:             s.api_token,\n    api_instance_name: s.api_instance_name,\n  };\n})() }}","type":"object"},{"id":"65102415-5231-44cb-b3e0-5c98dce21850","name":"integration","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json ?? {};\n  return {\n    ignore_groups:        s.ignore_groups ?? false,\n    reply_messages:       s.reply_messages ?? false,\n    edit_messages:        s.edit_messages ?? false,\n    delete_messages:      s.delete_messages ?? false,\n    reopen_conversation:  s.reopen_conversation ?? false,\n    conversation_pending: s.conversation_pending ?? false,\n    import_contacts:      s.import_contacts ?? false,\n    import_messages:      s.import_messages ?? false,\n    import_days_limit:    s.import_days_limit ?? 0,\n    sign_messages:        s.sign_messages ?? false,\n    sign_delimiter:       s.sign_delimiter ?? ''\n  };\n})() }}","type":"object"},{"id":"45d1d87f-ee7c-4b90-ba59-b14d8874f4dc","name":"group.id","value":"={{ \n  (() => {\n    const msg = $('webhookDataUazapi')?.item?.json?.body.message\n    return msg?.isGroup ? (msg?.chatid || '') : ''\n  })()\n}}","type":"string"},{"id":"0d3da5a5-b975-440f-94b3-3c63531c3edf","name":"group.name","value":"={{\n  (() => {\n    const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n    return msg?.isGroup ? `[ðŸ‘¥] ${msg?.groupName || ''}` : ''\n  })()\n}}","type":"string"},{"id":"e1726d06-91bc-4e48-9361-dec6435db7d1","name":"group.contact","value":"={{\n  (() => {\n    const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n    if (!msg?.isGroup) return ''\n    const number = msg?.sender_pn?.split('@')?.[0] ?? ''\n    const name = (msg?.senderName ?? '')\n      .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n      .trim() || 'Contato'\n    return `[ðŸ‘¤] +${number} | ${name}`\n  })()\n}}","type":"string"},{"id":"e058c51f-71a0-43f3-8cae-448a8c1ccfb2","name":"contact.identifier","value":"={{\n(() => {\n  const base = $('webhookDataUazapi')?.item?.json?.body ?? {};\n  const id1 = base.message?.chatid ?? '';\n  const id2 = base.message?.sender_pn ?? '';\n  const id3 = base.event?.Chat ?? '';\n  const ids = [id1, id2, id3];\n  const whatsappId = ids.find(id => \n    id.endsWith('@s.whatsapp.net') || id.endsWith('@g.us')\n  );\n  if (whatsappId) {\n    return whatsappId;\n  }\n  const lidId = ids.find(id => id.endsWith('@lid'));\n  if (lidId) {\n    return lidId;\n  }\n  return '';\n})()\n}}","type":"string"},{"id":"abf09a47-2772-48d3-b4f7-b0c6b15a69b9","name":"contact.lid","value":"={{\n(() => {\n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message;\n  const isFromMe = !!(msg?.fromMe);\n  const isGroup = !!(msg?.isGroup);\n  if (isFromMe || isGroup) {\n    return '';\n  }\n  return String(msg?.sender_lid ?? '');\n})()\n}}","type":"string"},{"id":"e2ce78a3-4599-483f-be1c-8e96122eeaef","name":"contact.phone_number","value":"={{\n(() => {\n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message ?? {};\n  const chatid = msg.chatid ?? '';\n  const sender_pn = msg.sender_pn ?? '';\n  if (chatid) {\n    if (chatid.endsWith('@g.us') || chatid.endsWith('@lid')) {\n      return '';\n    }\n    if (chatid.endsWith('@s.whatsapp.net')) {\n      const number = chatid.split('@')[0];\n      return '+' + number;\n    }\n  }\n  if (sender_pn && sender_pn.endsWith('@s.whatsapp.net')) {\n    const number = sender_pn.split('@')[0];\n    return '+' + number;\n  }\n  return '';\n})()\n}}","type":"string"},{"id":"4832617f-aafc-4cbf-8fa5-e2502deb7143","name":"contact.full_name","value":"={{\n  (() => {\n    const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n    if (msg?.fromMe) return 'Contato'\n    const raw = msg?.senderName ?? ''\n    const s = raw.normalize('NFKC')\n      .replace(/[^\\p{L}\\p{M}\\s'\\-]/gu,'')\n      .replace(/\\s+/g,' ')\n      .trim()\n    return s || 'Contato'\n  })()\n}}","type":"string"},{"id":"4a7df58d-d6f7-42ba-a09d-5b04910c0555","name":"contact.first_name","value":"={{ (() => { \n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n  if (msg?.fromMe) return 'Contato'\n  const parts = String(msg?.senderName ?? '')\n    .normalize('NFKC')\n    .replace(/[^\\p{L}\\p{M}\\s'-]/gu,'')\n    .replace(/\\s+/g,' ')\n    .trim()\n    .split(' ')\n    .filter(Boolean)\n  return parts[0] || 'Contato'\n})() }}","type":"string"},{"id":"feb8da01-d39a-4571-a215-c93f838b1cd6","name":"contact.middle_name","value":"={{ (() => { \n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n  if (msg?.fromMe) return ''\n  const s = String(msg?.senderName ?? '')\n    .normalize('NFKC')\n    .replace(/[^\\p{L}\\p{M}\\s'-]/gu,'')\n    .replace(/\\s+/g,' ')\n    .trim()\n  if (!s) return ''\n  const parts = s.split(' ').filter(Boolean)\n  return parts.length > 2 ? parts.slice(1, -1).join(' ') : ''\n})() }}","type":"string"},{"id":"13f61b17-5053-42d7-a613-ac7ab0cfabc3","name":"contact.last_name","value":"={{ (() => { \n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message\n  if (msg?.fromMe) return ''\n  const s = String(msg?.senderName ?? '')\n    .normalize('NFKC')\n    .replace(/[^\\p{L}\\p{M}\\s'-]/gu,'')\n    .replace(/\\s+/g,' ')\n    .trim()\n  const parts = s.split(' ').filter(Boolean)\n  return parts.length > 1 ? parts.at(-1) : ''\n})() }}","type":"string"},{"id":"d50b534d-b02f-43a7-a038-3f6719d47b9b","name":"contact.avatar","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.chat?.imagePreview ??\n  ''\n}}","type":"string"},{"id":"0f64c0d8-fad3-420d-999e-6e6230ac23e3","name":"data.source","value":"={{\n  (\n    $('webhookDataUazapi')?.item?.json?.body?.message?.source ??\n    ''\n  )\n  .trim()\n}}","type":"string"},{"id":"23e6b810-0252-4617-bf33-5ef2a8bdb715","name":"data.message_type","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.messageType ??\n  ''\n}}","type":"string"},{"id":"e1b0aeeb-7b3e-46b3-a6ce-049cc9dcc58f","name":"data.message_id","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.messageid ??\n  ''\n}}","type":"string"},{"id":"9b436741-480b-467b-bb9b-d3c3a3d9980b","name":"data.reply_id","value":"={{\n(() => {\n  const msg = $('webhookDataUazapi')?.item?.json?.body?.message ?? {};\n  const quoted   = String(msg.quoted   ?? '').trim();\n  const reaction = String(msg.reaction ?? '').trim();\n  if (quoted)   return quoted;\n  if (reaction) return reaction;\n  return '';\n})()\n}}","type":"string"},{"id":"8821e853-de4f-4009-8cab-4958f4c99868","name":"data.edited_id","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.edited ??\n  ''\n}}","type":"string"},{"id":"42eb43cf-4dfe-49b1-adf9-9096ec65a663","name":"data.deleted_id","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.event?.MessageIDs?.[0] ??\n  ''\n}}","type":"string"},{"id":"d6eb38ee-31f5-4953-bb1e-086a8dfd4e13","name":"data.message_direction","value":"={{\n  (\n    $('webhookDataUazapi')?.item?.json?.body?.message?.fromMe ??\n    false\n  ) ?\n    'outgoing' :\n    'incoming'\n}}","type":"string"},{"id":"cfba5c5e-18cf-4f29-9840-561c1f5a2be8","name":"data.content","value":"={{\n(() => {\nÂ  // =================================================================\nÂ  // FUNÃ‡ÃƒO AUXILIAR: ConversÃ£o de Markdown (WhatsApp -> Chatwoot)\nÂ  // =================================================================\nÂ  const convertMarkdown = (text) => {\nÂ  Â  if (typeof text !== 'string' || !text) {\nÂ  Â  Â  return '';\nÂ  Â  }\n\nÂ  Â  return text\nÂ  Â  Â  // --- BLOCO DE LIMPEZA DE CARACTERES ---\nÂ  Â  Â  .replace(/\\t/g, ' ')Â  Â  Â // TabulaÃ§Ã£o Horizontal\nÂ  Â  Â  .replace(/\\v/g, '')Â  Â  Â  // TabulaÃ§Ã£o Vertical\nÂ  Â  Â  .replace(/\\f/g, '')Â  Â  Â  // Form Feed (quebra de pÃ¡gina)\nÂ  Â  Â  .replace(/\\u200B/g, '')Â  // Zero-Width Space\nÂ  Â  Â  .replace(/\\uFEFF/g, '')Â  // Byte Order Mark (BOM)\nÂ  Â  Â  .replace(/\\r/g, '')Â  Â  Â  // Carriage Return (Normaliza quebra de linha)\nÂ  Â  Â  .replace(/\\u00A0/g, ' ') // Non-Breaking Space\nÂ  Â  Â Â \nÂ  Â  Â  // --- BLOCO DE CONVERSÃƒO MARKDOWN ---\nÂ  Â  Â  .replace(/```(.*?)```/gs, '`$1`') // MonoespaÃ§ado\nÂ  Â  Â  .replace(/\\*(.*?)\\*/gs, '**$1**') // Negrito\nÂ  Â  Â  .replace(/_(.*?)_/gs, '*$1*')Â  Â  Â // ItÃ¡lico\nÂ  Â  Â  .replace(/~(.*?)~/gs, '~~$1~~');Â  // Riscado\nÂ  };\n\nÂ  // =================================================================\nÂ  // FUNÃ‡ÃƒO AUXILIAR: FormataÃ§Ã£o de Moeda para Produto e PIX\nÂ  // =================================================================\nÂ  const formatCurrency = (value, offset, currencyCode = 'BRL') => {\nÂ  Â  // Verifica se os valores sÃ£o vÃ¡lidos\nÂ  Â  if (value === undefined || value === null) return '';\nÂ  Â Â \nÂ  Â  // Usa o offset para calcular o valor real. PadrÃ£o 1000 se nÃ£o vier.\nÂ  Â  const divisor = offset || 1000;Â \nÂ  Â  const realValue = value / divisor;\n\nÂ  Â  // Se o valor for 0, retorna uma string especÃ­fica\nÂ  Â  if (realValue === 0) return 'Valor a ser definido';\nÂ  Â Â \nÂ  Â  try {\nÂ  Â  Â  // Usa a API de internacionalizaÃ§Ã£o para formatar a moeda\nÂ  Â  Â  return new Intl.NumberFormat('pt-BR', {\nÂ  Â  Â  Â  style: 'currency',\nÂ  Â  Â  Â  currency: currencyCode,\nÂ  Â  Â  }).format(realValue);\nÂ  Â  } catch (e) {\nÂ  Â  Â  // Fallback simples\nÂ  Â  Â  return `${currencyCode} ${realValue.toFixed(2)}`;\nÂ  Â  }\nÂ  };\n\nÂ  // =================================================================\nÂ  // LÃ“GICA DE EXTRAÃ‡ÃƒO DE MENSAGEM\nÂ  // =================================================================\n\nÂ  const msg = $('webhookDataUazapi')?.item?.json?.body?.message ?? {};\nÂ  const cÂ  Â = msg?.content ?? {};\n\nÂ  // Formatters\nÂ  const formatters = {\nÂ  Â  // BotÃµes\nÂ  Â  buttons: () => {\nÂ  Â  Â  const header = convertMarkdown(c?.header?.title ?? '');\nÂ  Â  Â  const body = convertMarkdown(c?.body?.text ?? '');\nÂ  Â  Â  const footer = convertMarkdown(c?.footer?.text ?? '');\nÂ  Â  Â Â \nÂ  Â  Â  const buttonsArray = c?.InteractiveMessage?.NativeFlowMessage?.buttons ?? [];\nÂ  Â  Â Â \nÂ  Â  Â  const options = buttonsArray.map(btn => {\nÂ  Â  Â  Â  let params;\nÂ  Â  Â  Â  try {\nÂ  Â  Â  Â  Â  params = JSON.parse(btn.buttonParamsJSON ?? '{}');\nÂ  Â  Â  Â  } catch (e) {\nÂ  Â  Â  Â  Â  params = {};\nÂ  Â  Â  Â  }\n\nÂ  Â  Â  Â  const text = convertMarkdown(params.display_text ?? 'BotÃ£o');\n\nÂ  Â  Â  Â  if (btn.name === 'cta_url' && params.url) {\nÂ  Â  Â  Â  Â  return `* [${text}](${params.url}) ðŸ”—`;\nÂ  Â  Â  Â  }\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  if (btn.name === 'cta_call' && params.phone_number) {\nÂ  Â  Â  Â  Â  return `* ${text} (${params.phone_number}) ðŸ“ž`;\nÂ  Â  Â  Â  }\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  return `* ${text}`;\nÂ  Â  Â  }).join('\\n');\n\nÂ  Â  Â  const direction = msg.fromMe ? 'Enviada' : 'Recebida';\nÂ  Â  Â  const headerTitle = `ðŸ”˜ _Mensagem com BotÃµes (${direction}):_`;\nÂ  Â  Â  const tipFooter = !msg.fromMeÂ \nÂ  Â  Â  Â  ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`Â \nÂ  Â  Â  Â  : '';\n\nÂ  Â  Â  return `${headerTitle}\\n\\n---\\n\\n${header}\\n\\n${body}\\n\\n${footer}\\n\\n${options}${tipFooter}`;\nÂ  Â  },\nÂ  Â  // Listas\nÂ  Â  list: () => {\nÂ  Â  Â  const direction = msg.fromMe ? 'Enviada' : 'Recebida';\nÂ  Â  Â  const headerTitle = `ðŸ“‹ _Mensagem com Lista (${direction}):_`;\nÂ  Â  Â  const tipFooter = !msg.fromMeÂ \nÂ  Â  Â  Â  ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`Â \nÂ  Â  Â  Â  : '';\n\nÂ  Â  Â  const description = convertMarkdown(c?.description ?? 'Lista');\nÂ  Â  Â  const footer = convertMarkdown(c?.footerText ?? '');\nÂ  Â  Â  const button = convertMarkdown(c?.buttonText ?? '');\nÂ  Â  Â  const sections = c?.sections ?? [];\n\nÂ  Â  Â  const options = sections.map(section => {\nÂ  Â  Â  Â  const sectionTitle = `\\n**${convertMarkdown(section.title ?? 'SeÃ§Ã£o')}**`;\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  const rows = (section.rows ?? []).map(row => {\nÂ  Â  Â  Â  Â  const rowTitle = convertMarkdown(row.title ?? 'OpÃ§Ã£o');\nÂ  Â  Â  Â  Â  const rowDesc = convertMarkdown(row.description ?? '');\nÂ  Â  Â  Â  Â Â \nÂ  Â  Â  Â  Â  if (rowDesc) {\nÂ  Â  Â  Â  Â  Â  return `* **${rowTitle}** - _${rowDesc}_`;\nÂ  Â  Â  Â  Â  }\nÂ  Â  Â  Â  Â  return `* **${rowTitle}**`;\nÂ  Â  Â  Â  }).join('\\n');\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  return `${sectionTitle}\\n${rows}`;\nÂ  Â  Â  }).join('\\n');\n\nÂ  Â  Â  return `${headerTitle}\\n\\n---\\n\\n` +\nÂ  Â  Â  Â  Â  Â  Â `**${description}**\\n\\n` +\nÂ  Â  Â  Â  Â  Â  Â `*Texto do BotÃ£o:* ${button}\\n` +\nÂ  Â  Â  Â  Â  Â  Â `${options}\\n\\n` +\nÂ  Â  Â  Â  Â  Â  Â `_${footer}_` +\nÂ  Â  Â  Â  Â  Â  Â `${tipFooter}`;\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // Enquetes\nÂ  Â  poll: () => {\nÂ  Â  Â  const pollData = c?.pollCreationMessageV3 ?? c?.pollCreationMessage;\nÂ  Â  Â  if (!pollData) return 'Erro ao processar enquete.';\n\nÂ  Â  Â  const question = convertMarkdown(pollData.name ?? 'Enquete');\nÂ  Â  Â Â \nÂ  Â  Â  const options = (pollData.options ?? [])\nÂ  Â  Â  Â  .map((opt, index) => {\nÂ  Â  Â  Â  Â  const optionText = convertMarkdown(opt.optionName ?? 'OpÃ§Ã£o');\nÂ  Â  Â  Â  Â  return `${index + 1}. ${optionText}`;\nÂ  Â  Â  Â  })\nÂ  Â  Â  Â  .join('\\n');Â \n\nÂ  Â  Â  const count = pollData.selectableOptionsCount ?? 0;\nÂ  Â  Â  const footer = (count === 0)\nÂ  Â  Â  Â  ? `_(Permitido votar em mÃºltiplas opÃ§Ãµes)_`\nÂ  Â  Â  Â  : `_(Permitido votar em ${count} opÃ§Ã£o${count > 1 ? 's' : ''})_`;\n\nÂ  Â  Â  const direction = msg.fromMe ? 'Enviada' : 'Recebida';\nÂ  Â  Â  const headerTitle = `ðŸ“Š _Enquete ${direction}:_`;\nÂ  Â  Â Â \nÂ  Â  Â  const tipFooter = !msg.fromMeÂ \nÂ  Â  Â  Â  ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`Â \nÂ  Â  Â  Â  : '';\n\nÂ  Â  Â  return `${headerTitle}\\n\\n---\\n\\n**${question}**\\n\\n${options}\\n\\n${footer}${tipFooter}`;\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // Contatos (vCard Ãšnico ou MÃºltiplo)\nÂ  Â  contacts: () => {\nÂ  Â  Â  // FunÃ§Ã£o auxiliar interna para parsear UM vCard\nÂ  Â  Â  const parseVCard = (vcardString, displayName) => {\nÂ  Â  Â  Â  // FunÃ§Ã£o para extrair um campo (ORG, EMAIL, URL)\nÂ  Â  Â  Â  const getVCardField = (field) => {\nÂ  Â  Â  Â  Â  const match = vcardString.match(new RegExp(`^${field}(?:;.*)?:([^\\\\n\\\\r]+)`, 'm'));\nÂ  Â  Â  Â  Â  return match && match[1] ? match[1].replace(/;$/, '').trim() : null;\nÂ  Â  Â  Â  };\nÂ  Â  Â  Â  // FunÃ§Ã£o para extrair TODOS os telefones (TEL)\nÂ  Â  Â  Â  const getVCardPhones = () => {\nÂ  Â  Â  Â  Â  const phoneMatches = [...vcardString.matchAll(/TEL.*:([^\\n\\\\r]+)/g)];\nÂ  Â  Â  Â  Â  return phoneMatches.map(match => match[1].trim());\nÂ  Â  Â  Â  };\n\nÂ  Â  Â  Â  // Extrai os dados\nÂ  Â  Â  Â  const name = convertMarkdown(displayName ?? 'Contato');\nÂ  Â  Â  Â  const org = getVCardField('ORG');\nÂ  Â  Â  Â  const email = getVCardField('EMAIL');\nÂ  Â  Â  Â  const url = getVCardField('URL');\nÂ  Â  Â  Â  const phones = getVCardPhones();\n\nÂ  Â  Â  Â  // Monta o card dinamicamente\nÂ  Â  Â  Â  const card = [`**${name}**`];\nÂ  Â  Â  Â  if (org) card.push(`ðŸ¢ ${convertMarkdown(org)}`);\nÂ  Â  Â  Â  phones.forEach(phone => {\nÂ  Â  Â  Â  Â  card.push(`ðŸ“ž ${convertMarkdown(phone)}`);\nÂ  Â  Â  Â  });\nÂ  Â  Â  Â  if (email) card.push(`ðŸ“§ ${convertMarkdown(email)}`);\nÂ  Â  Â  Â  if (url) card.push(`ðŸŒ [${convertMarkdown(url)}](${url})`);\n\nÂ  Â  Â  Â  return card.join('\\n');\nÂ  Â  Â  };\n\nÂ  Â  Â  let vcards = []; // Array para guardar os vCards formatados\n\nÂ  Â  Â  if (msg.messageType === 'ContactsArrayMessage') {\nÂ  Â  Â  Â  const contactsArray = c.contacts ?? [];\nÂ  Â  Â  Â  vcards = contactsArray.map(contact =>Â \nÂ  Â  Â  Â  Â  parseVCard(contact.vcard, contact.displayName)\nÂ  Â  Â  Â  );\nÂ  Â  Â  }\nÂ  Â  Â  else if (msg.messageType === 'ContactMessage') {\nÂ  Â  Â  Â  vcards = [parseVCard(c.vcard ?? '', c.displayName ?? 'Contato')];\nÂ  Â  Â  }\n\nÂ  Â  Â  if (vcards.length === 0) return 'Erro ao processar contato.';\n\nÂ  Â  Â  // Monta o cabeÃ§alho\nÂ  Â  Â  const count = vcards.length;\nÂ  Â  Â  const title = count > 1 ? 'Contatos' : 'Contato';\nÂ  Â  Â  let headerTitle;\n\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ‘¤ _${title} Enviado${count > 1 ? 's' : ''}:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ‘¤ _${title} Recebido${count > 1 ? 's' : ''}_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Junta todos os cards, separados por uma linha\nÂ  Â  Â  return `${headerTitle}\\n\\n---\\n\\n${vcards.join('\\n\\n---\\n\\n')}`;\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // Evento (Agendamento)\nÂ  Â  event: () => {\nÂ  Â  Â  const name = convertMarkdown(c?.name ?? 'Evento');\nÂ  Â  Â  const description = convertMarkdown(c?.description ?? '');\nÂ  Â  Â  const location = convertMarkdown(c?.location?.name ?? '');\nÂ  Â  Â  const joinLink = c?.joinLink ?? '';\nÂ  Â  Â Â \nÂ  Â  Â  // FunÃ§Ã£o auxiliar para formatar timestamp (em segundos)\nÂ  Â  Â  const formatTimestamp = (timestamp) => {\nÂ  Â  Â  Â  if (!timestamp || timestamp === 0) return null; // Retorna nulo se nÃ£o houver data\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  const date = new Date(timestamp * 1000); // Converte de segundos para milissegundos\nÂ  Â  Â  Â Â \nÂ  Â  Â  Â  return date.toLocaleString('pt-BR', {\nÂ  Â  Â  Â  Â  day: '2-digit', month: '2-digit', year: 'numeric',\nÂ  Â  Â  Â  Â  hour: '2-digit', minute: '2-digit',\nÂ  Â  Â  Â  Â  timeZone: 'America/Sao_Paulo'\nÂ  Â  Â  Â  });\nÂ  Â  Â  };\nÂ  Â  Â Â \nÂ  Â  Â  const formattedStartTime = formatTimestamp(c?.startTime);\nÂ  Â  Â  const formattedEndTime = formatTimestamp(c?.endTime);\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ“† _Evento Criado:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ“† _Evento Recebido_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card dinamicamente\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n\\n**${name}**`];\nÂ  Â  Â Â \nÂ  Â  Â  if (description) card.push(`*${description}*`);\nÂ  Â  Â Â \nÂ  Â  Â  const details = [];\nÂ  Â  Â  if (formattedStartTime) details.push(`ðŸ“† **InÃ­cio:** ${formattedStartTime}`);\nÂ  Â  Â  if (formattedEndTime) details.push(`ðŸ“† **Fim:** ${formattedEndTime}`);Â \nÂ  Â  Â  if (location) details.push(`ðŸ“ **Local:** ${location}`);\nÂ  Â  Â Â \nÂ  Â  Â  if (joinLink) {\nÂ  Â  Â  Â  if (joinLink.includes('/video/')) {\nÂ  Â  Â  Â  Â  details.push(`ðŸ“¹ [Entrar na Chamada de VÃ­deo](${joinLink})`);\nÂ  Â  Â  Â  } else if (joinLink.includes('/audio/') || joinLink.includes('/voice/')) {\nÂ  Â  Â  Â  Â  details.push(`ðŸ“ž [Entrar na Chamada de Voz](${joinLink})`);\nÂ  Â  Â  Â  } else {\nÂ  Â  Â  Â  Â  details.push(`ðŸ”— [Link para o Evento](${joinLink})`);\nÂ  Â  Â  Â  }\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  if (details.length > 0) {\nÂ  Â  Â  Â  card.push(`\\n${details.join('\\n')}`);\nÂ  Â  Â  }\n\nÂ  Â  Â  if (c?.isCanceled === true) {\nÂ  Â  Â  Â  card.push(`\\n\\n**-- EVENTO CANCELADO --**`);\nÂ  Â  Â  }\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\n\nÂ  Â  // Produtos\nÂ  Â  product: () => {\nÂ  Â  Â  const product = c?.product;\nÂ  Â  Â  if (!product) return 'Erro ao processar produto.';\n\nÂ  Â  Â  // Extrai os dados do produto\nÂ  Â  Â  const title = convertMarkdown(product.title ?? 'Produto');\nÂ  Â  Â  const description = convertMarkdown(product.description ?? '');\nÂ  Â  Â  const productLink = product.URL ?? '';\nÂ  Â  Â  const imageURL = product.productImage?.URL ?? '';\n\nÂ  Â  Â  // LÃ³gica de PreÃ§o\nÂ  Â  Â  const currency = product.currencyCode ?? 'BRL';\nÂ  Â  Â  // Usa a funÃ§Ã£o auxiliar global 'formatCurrency'\nÂ  Â  Â  const price = formatCurrency(product.priceAmount1000, 1000, currency);\nÂ  Â  Â  const salePrice = formatCurrency(product.salePriceAmount1000, 1000, currency);\nÂ  Â  Â Â \nÂ  Â  Â  let priceString = '';\nÂ  Â  Â  if (salePrice && salePrice !== 'Valor a ser definido') {\nÂ  Â  Â  Â  priceString = `\\n**${salePrice}** (de ~~${price}~~)`;\nÂ  Â  Â  } else if (price && price !== 'Valor a ser definido') {\nÂ  Â  Â  Â  priceString = `\\n**${price}**`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ›’ _Produto Enviado:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ›’ _Produto Recebido_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\nÂ  Â  Â Â \nÂ  Â  Â  if (imageURL) card.push(`![Imagem do Produto](${imageURL})\\n`);\nÂ  Â  Â Â \nÂ  Â  Â  card.push(`**${title}**`);\nÂ  Â  Â  if (description) card.push(`*${description}*`);\nÂ  Â  Â  if (priceString) card.push(priceString); // Adiciona o preÃ§o\nÂ  Â  Â Â \nÂ  Â  Â  if (productLink) card.push(`\\n[Ver Produto na Loja](${productLink}) ðŸ”—`);\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // CatÃ¡logo\nÂ  Â  catalog: () => {\nÂ  Â  Â  const title = convertMarkdown(c?.title ?? 'CatÃ¡logo');\nÂ  Â  Â  const description = convertMarkdown(c?.description ?? '');\nÂ  Â  Â  // O c.text jÃ¡ contÃ©m a chamada para aÃ§Ã£o e o link\nÂ  Â  Â  const text = convertMarkdown(c?.text ?? '');Â \n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ§¾ _CatÃ¡logo Enviado:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ§¾ _CatÃ¡logo Recebido_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\nÂ  Â  Â Â \nÂ  Â  Â  // O thumbnail Ã© Base64, entÃ£o nÃ£o podemos exibi-lo.\nÂ  Â  Â Â \nÂ  Â  Â  card.push(`**${title}**`); // Nome do NegÃ³cio\nÂ  Â  Â  if (description) card.push(`\\n*${description}*`);\nÂ  Â  Â Â \nÂ  Â  Â  // Adiciona o texto principal que contÃ©m o link\nÂ  Â  Â  if (text) card.push(`\\n${text}`);Â \n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // BotÃ£o de Pix\nÂ  Â  pix: (params) => { // Agora recebe 'params'\nÂ  Â  Â  const pixData = params.payment_settings?.[0]?.pix_static_code ?? {};\nÂ  Â  Â  const amountData = params.total_amount ?? {};\nÂ  Â  Â  const currency = params.currency ?? 'BRL';\nÂ  Â  Â Â \nÂ  Â  Â  // Extrai os dados\nÂ  Â  Â  const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\nÂ  Â  Â  const pixKey = convertMarkdown(pixData.key ?? 'Chave nÃ£o informada');\nÂ  Â  Â  const keyType = convertMarkdown(pixData.key_type ?? '');\nÂ  Â  Â Â \nÂ  Â  Â  // Usa a funÃ§Ã£o auxiliar global 'formatCurrency'\nÂ  Â  Â  // Passa o 'value' e o 'offset' dinamicamente\nÂ  Â  Â  const amount = formatCurrency(amountData.value, amountData.offset, currency);\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Enviada):_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Recebida de **${senderName}**):_`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\nÂ  Â  Â Â \nÂ  Â  Â  card.push(`**Valor:** ${amount}`);\nÂ  Â  Â  card.push(`\\n**Recebedor:** ${merchantName}`);\nÂ  Â  Â  card.push(`**Chave PIX:** \\`${pixKey}\\` (${keyType})`);\nÂ  Â  Â Â \nÂ  Â  Â  if (!msg.fromMe) {\nÂ  Â  Â  Â  card.push(`\\n_Dica: Para pagar, copie a chave PIX e use o app do seu banco._`);\nÂ  Â  Â  }\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\n\nÂ  Â  // Carrinho (PIX DinÃ¢mico / MÃºltiplos Itens)\nÂ  Â  cart: (params) => { // Agora recebe 'params'\nÂ  Â  Â  const currency = params.currency ?? 'BRL';\nÂ  Â  Â  const order = params.order ?? {};\nÂ  Â  Â  const items = order.items ?? [];\nÂ  Â  Â Â \nÂ  Â  Â  // Monta a lista de itens\nÂ  Â  Â  const itemsString = items.map(item => {\nÂ  Â  Â  Â  const name = convertMarkdown(item.name ?? 'Item');\nÂ  Â  Â  Â  const quantity = item.quantity ?? 1;\nÂ  Â  Â  Â  // Usa a funÃ§Ã£o auxiliar global 'formatCurrency'\nÂ  Â  Â  Â  const price = formatCurrency(item.amount?.value, item.amount?.offset, currency);Â \nÂ  Â  Â  Â  return `* ${quantity}x ${name} (${price})`;\nÂ  Â  Â  }).join('\\n');\n\nÂ  Â  Â  // Formata os totais\nÂ  Â  Â  const subtotal = formatCurrency(order.subtotal?.value, order.subtotal?.offset, currency);\nÂ  Â  Â  const discount = formatCurrency(order.discount?.value, order.discount?.offset, currency);\nÂ  Â  Â  const total = formatCurrency(params.total_amount?.value, params.total_amount?.offset, currency);\n\nÂ  Â  Â  // Extrai dados do PIX (o primeiro mÃ©todo de pagamento)\nÂ  Â  Â  const pixSettings = params.payment_settings?.[0] ?? {};\nÂ  Â  Â  const pixData = pixSettings.pix_static_code ?? pixSettings.pix_dynamic_code ?? {};\nÂ  Â  Â  const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\nÂ  Â  Â  const pixKey = convertMarkdown(pixData.key ?? pixData.code ?? 'Chave nÃ£o informada');\nÂ  Â  Â  const keyType = convertMarkdown(pixData.key_type ?? (pixSettings.type === 'pix_dynamic_code' ? 'DinÃ¢mico' : ''));\n\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ›’ _Pedido Enviado:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ›’ _Novo Pedido Recebido_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n\\n**Resumo do Pedido:**\\n`];\nÂ  Â  Â Â \nÂ  Â  Â  // Adiciona o texto do body\nÂ  Â  Â  const bodyText = convertMarkdown(c?.body?.text ?? '');\nÂ  Â  Â  if (bodyText) card.push(`*${bodyText}*\\n`);\nÂ  Â  Â Â \nÂ  Â  Â  card.push(itemsString);\nÂ  Â  Â Â \nÂ  Â  Â  const totals = [];\nÂ  Â  Â  if (subtotal) totals.push(`**Subtotal:** ${subtotal}`);\nÂ  Â  Â  if (discount && order.discount?.value > 0) {\nÂ  Â  Â  Â  totals.push(`**Desconto:** ${discount}`);\nÂ  Â  Â  }\nÂ  Â  Â  if (total) totals.push(`**Total:** **${total}**`);\nÂ  Â  Â Â \nÂ  Â  Â  if (totals.length > 0) {\nÂ  Â  Â  Â  card.push(`\\n${totals.join('\\n')}`);\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  // Adiciona dados do PIX (se existirem)\nÂ  Â  Â  if(pixKey !== 'Chave nÃ£o informada') {\nÂ  Â  Â  Â  card.push(`\\n**Para Pagar (PIX):**`);\nÂ  Â  Â  Â  card.push(`**Recebedor:** ${merchantName}`);\nÂ  Â  Â  Â  card.push(`**Chave PIX:** \\`${pixKey}\\` (${keyType})`);\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  if (!msg.fromMe) {\nÂ  Â  Â  Â  card.push(`\\n_Dica: Para pagar, copie a chave PIX e use o app do seu banco._`);\nÂ  Â  Â  }\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\n\nÂ  Â  // LocalizaÃ§Ã£o EstÃ¡tica\nÂ  Â  location: () => {\nÂ  Â  Â  const lat = c?.degreesLatitude;\nÂ  Â  Â  const long = c?.degreesLongitude;\nÂ  Â  Â  const name = convertMarkdown(c?.name ?? '');\nÂ  Â  Â  const address = convertMarkdown(c?.address ?? '');\n\nÂ  Â  Â  // Cria um link do Google Maps\nÂ  Â  Â  let mapLink = '';\nÂ  Â  Â  if (lat && long) {\nÂ  Â  Â  Â  mapLink = `https://maps.google.com/?q=${lat},${long}`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Define o cabeÃ§alho\nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ“ _LocalizaÃ§Ã£o Enviada:_`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  Â  headerTitle = `ðŸ“ _LocalizaÃ§Ã£o Recebida_ (de **${senderName}**):`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\n\nÂ  Â  Â  if (name) card.push(`**${name}**`);\nÂ  Â  Â  if (address) card.push(`*${address}*`);\nÂ  Â  Â Â \nÂ  Â  Â  const details = [];\nÂ  Â  Â  if (lat) details.push(`**Latitude:** \\`${lat}\\``);\nÂ  Â  Â  if (long) details.push(`**Longitude:** \\`${long}\\``);\n\nÂ  Â  Â  if (details.length > 0) {\nÂ  Â  Â  Â  if (name || address) {\nÂ  Â  Â  Â  Â  card.push(`\\n${details.join('\\n')}`);\nÂ  Â  Â  Â  } else {\nÂ  Â  Â  Â  Â  card.push(details.join('\\n'));\nÂ  Â  Â  Â  }\nÂ  Â  Â  }\n\nÂ  Â  Â  if (mapLink) {\nÂ  Â  Â  Â  if (name || address || lat || long) {\nÂ  Â  Â  Â  Â  card.push(`\\n[Ver LocalizaÃ§Ã£o no Google Maps](${mapLink}) ðŸŒ`);\nÂ  Â  Â  Â  } else {\nÂ  Â  Â  Â  Â  card.push(`[Ver LocalizaÃ§Ã£o no Google Maps](${mapLink}) ðŸŒ`);\nÂ  Â  Â  Â  }\nÂ  Â  Â  }\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\nÂ  Â Â \nÂ  Â  // LocalizaÃ§Ã£o em Tempo Real\nÂ  Â  liveLocation: () => {\nÂ  Â  Â  // Pega os dados da localizaÃ§Ã£o (o Ãºltimo ponto)\nÂ  Â  Â  const lat = c?.degreesLatitude;\nÂ  Â  Â  const long = c?.degreesLongitude;\nÂ  Â  Â  const comm = c?.caption;\n\nÂ  Â  Â  // Cria um link do Google Maps para o Ãºltimo ponto\nÂ  Â  Â  let mapLink = '';\nÂ  Â  Â  if (lat && long) {\nÂ  Â  Â  Â  mapLink = `https://maps.google.com/?q=${lat},${long}`;\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  let headerTitle;\nÂ  Â  Â  const senderName = msg?.senderName ?? 'Contato';\n\nÂ  Â  Â  if (msg.fromMe) {\nÂ  Â  Â  Â  headerTitle = `ðŸ“ _VocÃª iniciou o compartilhamento de localizaÃ§Ã£o em tempo real._`;\nÂ  Â  Â  } else {\nÂ  Â  Â  Â  headerTitle = `ðŸ“ _${senderName} estÃ¡ compartilhando a localizaÃ§Ã£o em tempo real._`;\nÂ  Â  Â  }\n\nÂ  Â  Â  // Monta o card\nÂ  Â  Â  const card = [`${headerTitle}\\n\\n---\\n`];\n\nÂ  Â  Â  // Adiciona as coordenadas do Ãºltimo ponto, se disponÃ­veis\nÂ  Â  Â  const details = [];\nÂ  Â  Â  if (lat) details.push(`**Latitude Inicial:** \\`${lat}\\``);\nÂ  Â  Â  if (long) details.push(`**Longitude Inicial:** \\`${long}\\`\\n\\n`);\nÂ  Â  Â  if (comm) details.push(`**ComentÃ¡rio:** ${comm}`);\n\nÂ  Â  Â  if (details.length > 0) {\nÂ  Â  Â  Â  card.push(details.join('\\n'));\nÂ  Â  Â  }\n\nÂ  Â  Â  // Adiciona o link do mapa\nÂ  Â  Â  if (mapLink) {\nÂ  Â  Â  Â  if (details.length > 0) card.push('\\n'); // Adiciona espaÃ§o\nÂ  Â  Â  Â  card.push(`[Ver a localizaÃ§Ã£o inicial no Google Maps](${mapLink}) ðŸŒ`);\nÂ  Â  Â  }\nÂ  Â  Â Â \nÂ  Â  Â  // Adiciona o aviso, como solicitado\nÂ  Â  Â  card.push(`\\n\\n*A localizaÃ§Ã£o atual e em tempo real nÃ£o pode ser exibida no Chatwoot.*\\n` +\nÂ  Â  Â  Â  Â  Â  Â `_Acesse o WhatsApp no celular ou web para acompanhar._`);\n\nÂ  Â  Â  return card.join('\\n');\nÂ  Â  },\n\n    // Carrossel\n    carousel: () => {\n      const carouselData = c?.InteractiveMessage?.CarouselMessage;\n      const cards = carouselData?.cards ?? [];\n      if (cards.length === 0) return 'Erro ao processar carrossel.';\n\n      // Pega o texto principal (fora dos cards)\n      const mainBody = convertMarkdown(c?.body?.text ?? '');\n\n      // Itera em cada card para formatÃ¡-lo\n      const formattedCards = cards.map((card, index) => {\n        // 1. Pega a URL da Imagem\n        const imageURL = card?.header?.Media?.ImageMessage?.URL ?? '';\n        \n        // 2. Pega o Texto do Corpo do card\n        const bodyText = convertMarkdown(card?.body?.text ?? '');\n        \n        // 3. Pega o Texto do BotÃ£o\n        let buttonText = '';\n        const button = card?.InteractiveMessage?.NativeFlowMessage?.buttons?.[0];\n        if (button) {\n          try {\n            const params = JSON.parse(button.buttonParamsJSON ?? '{}');\n            buttonText = convertMarkdown(params.display_text ?? 'Ver opÃ§Ã£o');\n          } catch (e) {\n            buttonText = 'Ver opÃ§Ã£o';\n          }\n        }\n\n        // Monta o markdown para este card\n        const cardParts = [];\n        // Usa o texto do botÃ£o como tÃ­tulo, jÃ¡ que nÃ£o hÃ¡ tÃ­tulo de card\n        cardParts.push(`**${index + 1}. ${buttonText}**`);\n        \n        // Formata o corpo do card como uma citaÃ§Ã£o (blockquote)\n        if (bodyText) {\n          const bodyLines = bodyText.split('\\n').map(line => `> ${line}`);\n          cardParts.push(bodyLines.join('\\n'));\n        }\n        \n        return cardParts.join('\\n');\n      }).join('\\n\\n---\\n\\n'); // Separa cada card com uma linha horizontal\n\n      // Monta a mensagem final\n      const direction = msg.fromMe ? 'Enviada' : 'Recebida';\n      const headerTitle = `ðŸŽ  _Mensagem em Carrossel (${direction}):_`;\n      \n      const tipFooter = !msg.fromMe \n        ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._` \n        : '';\n      \n      // Retorna o cabeÃ§alho + o texto principal + os cards formatados\n      return `${headerTitle}\\n\\n**${mainBody}**\\n\\n${formattedCards}${tipFooter}`;\n    }\nÂ  };\n\nÂ  // =================================================================\nÂ  // PROCESSAMENTO E RETORNO\nÂ  // =================================================================\n\nÂ  // 1. Mensagem Interativa (Carrossel)\n  //    Verifica pela chave 'CarouselMessage' PRIMEIRO\nÂ  if (c?.InteractiveMessage?.CarouselMessage) {\nÂ  Â  return formatters.carousel();\nÂ  }\n\n  // 2. Mensagem Interativa (BotÃµes, PIX, Carrinho)\n  //    Verifica pela chave 'NativeFlowMessage'\nÂ  if (c?.InteractiveMessage?.NativeFlowMessage) {\nÂ  Â  // Verifica o tipo de botÃ£o para rotear ao formatter correto\nÂ  Â  const button = c.InteractiveMessage.NativeFlowMessage.buttons?.[0];\nÂ  Â  const buttonName = button?.name;\nÂ  Â Â \nÂ  Â  let params;\nÂ  Â  try {\nÂ  Â  Â  params = JSON.parse(button?.buttonParamsJSON ?? '{}');\nÂ  Â  } catch(e) {\nÂ  Â  Â  params = {};\nÂ  Â  }\nÂ  Â Â \nÂ  Â  if (buttonName === 'payment_info') {\nÂ  Â  Â  return formatters.pix(params); // Roteia para o formatter PIX\nÂ  Â  }\nÂ  Â Â \nÂ  Â  if (buttonName === 'review_and_pay') {\nÂ  Â  Â  return formatters.cart(params); // Roteia para o formatter Carrinho\nÂ  Â  }\nÂ  Â Â \nÂ  Â  // Se nÃ£o for PIX ou Carrinho, continua no formatter de botÃµes padrÃ£o\nÂ  Â  return formatters.buttons();\nÂ  }\n\n  // 3. Mensagem Interativa (Lista)\nÂ  if (c?.sections) {\nÂ  Â  return formatters.list();\nÂ  }\n\nÂ  // 4. Enquete (CriaÃ§Ã£o)\nÂ  const pollTypes = ['PollCreationMessageV3', 'PollCreationMessage'];\nÂ  if (pollTypes.includes(msg?.messageType)) {\nÂ  Â  return formatters.poll();\nÂ  }\n\nÂ  // 5. Enquete (Voto)\nÂ  if (msg?.messageType === 'PollUpdateMessage') {\nÂ  Â  const voteText = convertMarkdown(msg?.vote ?? '');\nÂ  Â  if (!voteText) return ''; // Ignora anulaÃ§Ã£o de voto\n\nÂ  Â  if (msg.fromMe) {\nÂ  Â  Â  return `ðŸ“¤ _Voto Enviado:_\\n\\n**${voteText}**`;\nÂ  Â  } else {\nÂ  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  return `ðŸ“¥ _Voto Recebido_ (de **${senderName}**):\\n\\n**${voteText}**`;\nÂ  Â  }\nÂ  }\n\nÂ  // 6. Resposta a BotÃ£o/Lista\nÂ  if (msg?.buttonOrListid) {\nÂ  Â  const selectionText = convertMarkdown(String(c?.selectedDisplayText ?? c?.title ?? ''));\nÂ  Â  if (!selectionText) return '';\n\nÂ  Â  if (msg.fromMe) {\nÂ  Â  Â  return `ðŸ“¤ _SeleÃ§Ã£o Enviada:_\\n\\n**${selectionText}**`;\nÂ  Â  } else {\nÂ  Â  Â  const senderName = msg?.senderName ?? 'Contato';\nÂ  Â  Â  return `ðŸ“¥ _OpÃ§Ã£o Selecionada_ (por **${senderName}**):\\n\\n**${selectionText}**`;\nÂ  Â  }\nÂ  }\nÂ Â \nÂ  // 7. Contato (vCard Ãšnico ou MÃºltiplo)\nÂ  if (['ContactMessage', 'ContactsArrayMessage'].includes(msg.messageType)) {\nÂ  Â  return formatters.contacts();\nÂ  }\nÂ Â \nÂ  // 8. Evento (Agendamento)\nÂ  if (msg?.messageType === 'EventMessage') {\nÂ  Â  return formatters.event();\nÂ  }\n\nÂ  // 9. LocalizaÃ§Ã£o\nÂ  if (msg?.messageType === 'LocationMessage') {\nÂ  Â  return formatters.location();\nÂ  }\nÂ Â \nÂ  // 10. Produto\nÂ  if (msg?.messageType === 'ProductMessage') {\nÂ  Â  return formatters.product();\nÂ  }\nÂ Â \nÂ  // 11. CatÃ¡logo (Link)\nÂ  if (msg?.messageType === 'ExtendedTextMessage' && msg.mediaType === 'cataloglink') {\nÂ  Â  return formatters.catalog();\nÂ  }\n\nÂ  // 12. LocalizaÃ§Ã£o em Tempo Real (LiveLocationMessage)\nÂ  if (msg?.messageType === 'LiveLocationMessage') {\nÂ  Â  return formatters.liveLocation();\nÂ  }\n\nÂ  // 13. ReaÃ§Ãµes\nÂ  if (msg?.messageType === 'ReactionMessage') {\nÂ  Â  const reactionText = String(msg?.text ?? c?.text ?? '');\nÂ  Â  return convertMarkdown(reactionText);\nÂ  }\n\nÂ  // 14. MÃ­dia\nÂ  if (['ImageMessage','VideoMessage','DocumentMessage'].includes(msg?.messageType)) {\nÂ  Â  const caption = String(c?.caption ?? '');\nÂ  Â  return convertMarkdown(caption);\nÂ  }\n\nÂ  // 15. Fallback (Texto comum)\nÂ  const commonText = (\nÂ  Â  String(msg?.text ?? '').trim() ||\nÂ  Â  String(msg?.content?.text ?? '').trim() ||\nÂ  Â  ''\nÂ  );\nÂ Â \nÂ  return convertMarkdown(commonText);\n})()\n}}","type":"string"},{"id":"8b1480c6-16df-429a-93e5-8677bea2c2d8","name":"data.media_key","value":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.message?.mediaType ??\n    ''\n  )\n  .toLowerCase() !== 'url' ?\n  (\n    $('webhookDataUazapi').item.json.body?.message?.content?.mediaKey ??\n    ''\n  ) :\n  ''\n}}","type":"string"},{"id":"898be1ea-ae20-4bc2-8487-2e9055d9ad45","name":"data.direct_path","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.directPath ??\n  ''\n}}","type":"string"},{"id":"e9290c7c-f979-4cdb-b67f-ea7f979ee7ed","name":"data.url","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.URL ??\n  ''\n}}","type":"string"},{"id":"3921b501-9196-47f8-9ff5-01972295574a","name":"data.mimetype","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.mimetype ??\n  ''\n}}","type":"string"},{"id":"3dc97213-639b-40df-98f3-ffa7e0f0bbbb","name":"data.content_type","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.mediaType ??\n  ''\n}}","type":"string"},{"id":"fa8e3c1d-be13-4e11-9c74-7eae2d07c24a","name":"data.filename","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.fileName ??\n  ''\n}}","type":"string"},{"id":"1d15c75e-360d-47f0-94a1-066eff15de97","name":"data.thumbnail","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.content?.product?.productImage?.JPEGThumbnail ??\n  ''\n}}","type":"string"},{"id":"4ded2e97-4559-4597-be0e-d8a913266f32","name":"data.is_group","value":"={{\n  !!(\n    $('webhookDataUazapi')?.item?.json?.body?.message?.isGroup\n  )\n}}","type":"boolean"},{"id":"ebd5caf1-7aec-4332-88d8-6c8ccc1f08be","name":"data.from_me","value":"={{\n  !!(\n    $('webhookDataUazapi')?.item?.json?.body?.message?.fromMe\n  )\n}}","type":"boolean"},{"id":"2369eef3-45df-455d-b30d-cb9106295bcc","name":"data.owner","value":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.message?.owner ??\n    ''\n  )\n  .trim()\n  .replace(/^(.+)$/, '+$1')\n}}","type":"string"},{"id":"92f40871-170f-4bc8-95e2-e136b954cfa3","name":"data.event_type","value":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.EventType ??\n  ''\n}}","type":"string"}]},"options":{}},"id":"3fb86dd0-2780-4226-bc67-2ecb66dfb61d","name":"normalizedData","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[624,816]},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot?.account_id }}/contacts","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"},{"name":"Content-type","value":"application/json; charset=utf-8"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"name\": \"{{ $('normalizedData')?.item?.json?.data?.is_group ? $('normalizedData').item?.json?.group?.name : $('normalizedData')?.item?.json?.contact?.full_name }}\",\n    \"inbox_id\": {{ $('normalizedData')?.item?.json?.chatwoot.inbox_id }},\n    \"source_id\": \"{{ $('contactVerify')?.item?.json?.identifier_new.split('@').first() }}\",\n    \"phone_number\": \"{{ $('contactVerify')?.item?.json?.phone_number_new }}\",\n    \"identifier\" : \"{{ $('contactVerify')?.item?.json?.identifier_new }}\",\n    \"additional_attributes\": {\n        \"contact_lid\": \"{{ $('contactVerify')?.item?.json?.contact_lid_new }}\"\n    }\n}","options":{"response":{"response":{"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1152,656],"id":"2563003a-ebfe-49bc-8efe-856b01464be3","name":"contactCreate","retryOnFail":true,"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"9306060b-d691-4d8f-a0e2-8f89ede48960","name":"contact_id","value":"={{\n  $json?.payload?.contact?.id ??\n  $json?.contact_id ??\n  $json?.id ??\n  ''\n}}","type":"number"},{"id":"23b01a4b-58a1-4256-b62f-373073a16840","name":"inbox_id","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1328,736],"id":"d20537a7-4c80-4068-b793-e46d14a09db1","name":"contactIdentify","retryOnFail":true},{"parameters":{"url":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot.account_id }}/contacts/{{ $('contactIdentify')?.item?.json?.contact_id }}/conversations","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"},{"name":"Content-type","value":"application/json; charset=utf-8"}]},"options":{}},"id":"5a2ad50a-a616-4457-86c2-bd44079b90ad","name":"conversationFind","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-80,1408],"retryOnFail":true},{"parameters":{"assignments":{"assignments":[{"id":"fc173b4d-2b51-446a-a545-36fe4fc3f9e9","name":"chatwoot","value":"={{ $('normalizedData')?.item?.json?.chatwoot }}","type":"object"},{"id":"2119b12f-7d4d-40b5-99dc-fd0f503bfffc","name":"chatwoot.inbox_id","value":"={{ $('contactIdentify')?.item?.json?.inbox_id }}","type":"number"},{"id":"365992ef-324c-45f6-8770-032326a3467e","name":"api","value":"={{ $('normalizedData')?.item?.json?.api }}","type":"object"},{"id":"d0ffd39f-b950-483e-9097-48e0bac71195","name":"group","value":"={{ $('normalizedData')?.item?.json?.group ?? {} }}","type":"object"},{"id":"cb473388-9aaf-46a8-86fe-c9c37776ed65","name":"contact","value":"={{ $('normalizedData')?.item?.json?.contact }}","type":"object"},{"id":"d72e1e10-8311-44ca-8180-176fd44b03db","name":"contact.contact_id","value":"={{ $('contactIdentify')?.item?.json?.contact_id }}","type":"number"},{"id":"7cef8d6a-13c6-4c6b-bcf1-81e60a5a1d37","name":"data","value":"={{ $('normalizedData')?.item?.json?.data }}","type":"object"},{"id":"9306060b-d691-4d8f-a0e2-8f89ede48960","name":"data.conversation_id","value":"={{ $('conversationIdentify')?.item?.json?.conversation_id }}","type":"number"},{"id":"0624c083-b4e3-480d-93ac-35d1b3c7d519","name":"data.conversation_status","value":"={{ $('conversationFind')?.item?.json?.payload?.[0]?.status ?? '' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[272,1408],"id":"c3270d1e-8389-4649-8101-fd765ea33fc2","name":"processedData"},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.api.base_url }}/message/download","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('processedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"id\": \"{{ $('normalizedData')?.item?.json?.data?.message_id }}\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1152,1248],"id":"20fd98df-f530-41fe-8fa5-e8f779548c02","name":"messageMediaFind","retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id || $('processedData')?.item?.json?.data?.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"=attachments[]","inputDataFieldName":"data"},{"name":"content","value":"={{\n  (\n    ($('processedData')?.item?.json?.data?.is_group === true &&\n     $('processedData')?.item?.json?.data?.from_me === false)\n      ? '**' + ( $('processedData')?.item?.json?.group?.contact ?? '' ) + '**\\n\\n'\n      : ''\n  ) + String($('processedData')?.item?.json?.data?.content ?? '')\n}}"},{"name":"message_type","value":"={{ $('processedData')?.item?.json?.data?.message_direction }}"},{"name":"source_id","value":"={{ $('processedData')?.item?.json?.data?.message_id }}"},{"name":"content_attributes","value":"={\n  \"in_reply_to\": {{ $('messageVerify')?.item?.json?.reply_id ?? $('messageVerify')?.item?.json?.edited_id }}\n}"}]},"options":{}},"id":"1ea3f2b8-d104-4983-a139-c00b8777f985","name":"messageMediaSend","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1680,1248],"retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{\n  (\n    ($('processedData')?.item?.json?.data?.is_group === true &&\n     $('processedData')?.item?.json?.data?.from_me === false)\n      ? '**' + ( $('processedData')?.item?.json?.group?.contact ?? '' ) + '**\\n\\n'\n      : ''\n  ) + String($('processedData')?.item?.json?.data?.content ?? '')\n}}"},{"name":"message_type","value":"={{ $('processedData')?.item?.json?.data?.message_direction }}"},{"name":"source_id","value":"={{ $('processedData')?.item?.json?.data?.message_id }}"},{"name":"content_attributes","value":"={\n  \"in_reply_to\": {{ $('messageVerify')?.item?.json?.reply_id ?? $('messageVerify')?.item?.json?.edited_id }}\n}"}]},"options":{}},"id":"01c8664b-23ff-4b76-a2df-1ee75f5513f2","name":"messageTextSend","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1152,1088],"retryOnFail":true},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2384,1408],"id":"3cdd7299-fb5b-41f1-9824-d487e6d91177","name":"endProcess"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Substitui apenas o campo fileName, preservando todos os outros dados originais\nconst item = $input.item;\n\nif (item.binary?.data && $('processedData')?.item?.json?.data?.filename) {\n  // Monte o nome como quiser:\n  const newfilename = $('processedData')?.item?.json?.data?.filename;\n  item.binary.data.fileName = newfilename;\n}\n\nreturn item;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1504,1248],"id":"1915236e-49a5-4181-9b01-504f90118693","name":"messageMediaRename"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"52ae290c-5ed1-473d-a9ef-0740de74f5bc","leftValue":"={{\n  !!(\n     $('webhookDataUazapi')?.item?.json?.body?.message?.isGroup\n  )\n}}","rightValue":"@g.us","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"b8dd0846-d1b6-4700-8b1e-46504df6321d","leftValue":"={{\n  !!(\n    $('getVariables')?.item?.json?.ignore_groups\n  )\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[272,656],"id":"52dc7c5b-36d4-44ff-a29b-27aaa7f860bb","name":"groupVerify"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"52ae290c-5ed1-473d-a9ef-0740de74f5bc","leftValue":"={{\n(() => {\n  const b = $('webhookDataUazapi')?.item?.json?.body ?? {};\n  const m = b.message ?? {};\n  const ev = b.event ?? {};\n  const toBool = v => (typeof v === 'string' ? v.toLowerCase() === 'true' : !!v);\n  return (toBool(m.fromMe) || !toBool(m.wasSentByApi)) && !toBool(ev.IsFromMe);\n})()\n}}","rightValue":"@g.us","operator":{"type":"boolean","operation":"false","singleValue":true}},{"id":"94334143-7301-4997-8fd0-b4b903be4c6a","leftValue":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.EventType ??\n    ''\n  )\n  .toLowerCase() === 'messages_update' &&\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.type ??\n    ''\n  )\n  .toLowerCase() !== 'deletedmessage'\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"2bb252c4-28b1-4750-9b3c-d6725895f453","leftValue":"={{\n  $('webhookDataUazapi')?.item?.json?.body?.message?.track_id ??\n  ''\n}}","rightValue":"={{\n  $('getVariables')?.item?.json?.chatwoot_track_id ?\n    $('getVariables').item.json.chatwoot_track_id + \n    '-' + \n    String($('getVariables').item.json.chatwoot_account_id).padStart(4,'0') + \n    '-' + \n    String($('getVariables').item.json.chatwoot_inbox_id).padStart(4,'0') :\n  ''\n}}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[448,736],"id":"7d7a2c0a-2297-4855-b34d-9c3d5ea3beb1","name":"fromMeVerify"},{"parameters":{"content":"# ðŸ’¬ IntegraÃ§Ã£o Premium Chatwoot ðŸ” UaZapi\n### _**v1.0.1 â€¢ atualizado: 2025-11-17**_\n\n## Workflow que recebe mensagens via **webhook** da Uazapi, normaliza os dados e envia para o Chatwoot.\n---\n\n## ðŸ§­ O que este fluxo faz\n- Recebe **Webhook (POST)** da UaZapi (`webhookDataUazapi`) e carrega **variÃ¡veis de integraÃ§Ã£o** no Postgres (`getVariables`).\n- **Normaliza** dados de mensagem/contato/grupo (`normalizedData`) e propaga para o contexto (`processedData`).\n- **Localiza ou cria** o **Contato** (`contactFind` â†’ `contactCreate`/`contactUpdate`) e identifica `contact_id`.\n- **Localiza/abre** a **Conversa** (`conversationFind` â†’ `conversationCreate`/`conversationUpdate`) e define `conversation_id`.\n- Resolve **encadeamento** (reply/edited/deleted) consultando o Postgres (`findMessageReply`).\n- **Roteia** por tipo de entrega (`messageVerify`):\n  - `textMessage` â†’ `messageTextSend`\n  - `mediaMessage` â†’ `messageMediaFind` â†’ `messageMediaDownload` â†’ `messageMediaRename` â†’ `messageMediaSend`\n  - `deletedMessage` â†’ `findMessageDeleted` â†’ `deleteMessage` â†’ `Wait` â†’ `messageDeletedUpdate`\n  - `editedMessage` â†’ `findMessageEdited` â†’ `messageEditedUpdate`\n- Atualiza **avatar do contato** (`getContactPhoto` â†’ `sendContactPhoto`) com thumbnail da conversa ou fallback *UI Avatars*.\n- Aplica filtros de **grupo** (`groupVerify`) e **mensagens â€œde mimâ€ vs API** (`fromMeVerify`) para evitar loops.\n\n---\n\n## ðŸ›  Requisitos\n- **Postgres (credencial):** nÃ³s `getVariables` do Manager (Vermelho) e `findMessageReply`, `findMessageEdited`, `findMessageDeleted`, `messageEditedUpdate`, `messageDeletedUpdate` do Chatwoot (Azuis).\n- **VariÃ¡veis de integraÃ§Ã£o (Preenchidas no Gerenciador de InstÃ¢ncias):**\n  - **Chatwoot:** `chatwoot_base_url`, `chatwoot_api_version`, `chatwoot_token`, `chatwoot_account_id`, `chatwoot_inbox_id`, `chatwoot_inbox_name`, `chatwoot_track_id`\n  - **UaZapi:** `api_base_url`, `api_token`, `api_instance_name`\n  - **ConfiguraÃ§Ãµes:** `ignore_groups`, `reply_messages`, `edit_messages`, `delete_messages`, `reopen_conversation`, `conversation_pending`, `import_*`, `sign_*`\n- **UaZapi:** **Gere um cÃ³digo exclusivo para o seu webhook em** [UUID Generator](https://www.uuidgenerator.net/) e informe no campo `Path` do `webhookDataUaZapi`.\n\n---\n\n## âš™ï¸ InstalaÃ§Ã£o & AtivaÃ§Ã£o\n1. **Importe** o workflow no n8n.  \n2. Associe a **credencial Postgres** aos nÃ³s indicados.  \n3. Ajuste o **Webhook** `webhookDataUazapi` (path pÃºblico) e a origem UaZapi.  \n4. Confirme que `getVariables` lÃª a linha correta (por `api_base_url` e `api_token`).  \n5. **Save** â†’ **Activate**.  \n6. Envie um evento de teste pela UaZapi e verifique criaÃ§Ã£o/atualizaÃ§Ã£o de **contato**, **conversa** e **mensagem**.\n\n---\n\n## ðŸ”€ Regras de Roteamento (resumo)\n- **Ignorar grupos:** `groupVerify` bloqueia quando `ignore_groups = true` e o chat Ã© `@g.us`.\n- **Evitar eco/loop:** `fromMeVerify` descarta mensagens **enviadas pela prÃ³pria API** ou indevidas.\n- **Reply/Edited/Deleted:**\n  - `findMessageReply` mapeia `reply_id`/`edited_id`/`deleted_id` no Postgres.\n  - **Reply** sÃ³ aplica se `reply_messages = true`.\n  - **Edited/Deleted** respeitam `edit_messages` / `delete_messages` e a polÃ­tica **0/NULL** do SQL.\n- **Texto vs MÃ­dia:** `messageVerify` separa por `media_key` vÃ¡lido.\n- **Avatar:** usa `data.thumbnail`; fallback **UI Avatars** com nome saneado.\n\n---\n\n## ðŸ” SeguranÃ§a\n- **HTTPS** em Webhook e Chatwoot API.\n- **Tokens** (UaZapi/Chatwoot) mantidos no Gerenciador de InstÃ¢ncias.","height":2128,"width":768,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-1120,512],"typeVersion":1,"id":"d7bc3728-3874-46e9-9e08-b76b40d52ecb","name":"Sticky Note6"},{"parameters":{"httpMethod":"POST","path":"53fa0d94-ec74-4f80-a4c5-1e06ea53d385","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-256,656],"id":"a6aaa24e-a063-4df8-a55e-17750299d024","name":"webhookDataUazapi","webhookId":"53fa0d94-ec74-4f80-a4c5-1e06ea53d385"},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id }}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/toggle_status","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"contentType":"raw","rawContentType":"application/json; charset=utf-8","body":"={\n    \"status\": \"open\"\n}","options":{"redirect":{"redirect":{}}}},"id":"621733f2-f9f6-481e-ba7e-ed001c014c58","name":"conversationUpdate","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,1488],"retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id }}/conversations","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"contentType":"raw","rawContentType":"application/json; charset=utf-8","body":"={\n    \"source_id\": \"{{ $('normalizedData')?.item?.json?.data?.is_group ? $('processedData')?.item?.json?.group?.id.split('@').first() : $('processedData')?.item?.json?.contact?.phone_number }}\",\n    \"inbox_id\": {{ $('processedData')?.item?.json?.chatwoot?.inbox_id }},\n    \"contact_id\": {{ $('processedData')?.item?.json?.contact?.contact_id }},\n    \"status\": \"{{ $('getVariables')?.item?.json?.conversation_pending ? 'pending' : 'open' }}\"\n}","options":{"redirect":{"redirect":{}}}},"id":"5aa053af-e139-4ec5-9c8d-703ef326d01e","name":"conversationCreate","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,1328],"retryOnFail":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('processedData')?.item?.json?.data?.conversation_id }}","rightValue":0,"operator":{"type":"number","operation":"equals"},"id":"a94220d5-0750-41e6-9731-38863b5f6775"}],"combinator":"and"},"renameOutput":true,"outputKey":"new"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"feb7e1d6-e636-4e5c-a4ed-afb12d66436f","leftValue":"={{ $('processedData')?.item?.json?.data?.conversation_id > 0 && ( $('processedData')?.item?.json?.data?.conversation_status === 'open' || $('processedData')?.item?.json?.data?.conversation_status === 'pending' ) }}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"openedOrPending"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"439f50b9-e41c-40e9-b9c0-b71e1f6aae8c","leftValue":"={{ $('processedData')?.item?.json?.data?.conversation_id > 0 && $('processedData')?.item?.json?.data?.conversation_status === 'open' }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"closed"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[448,1392],"id":"2d1186ce-8f14-468c-a174-2b6de7ce4afb","name":"conversationVerify"},{"parameters":{"content":"## Tratamento da Foto do Contato","height":912,"width":504},"type":"n8n-nodes-base.stickyNote","position":[1824,992],"typeVersion":1,"id":"1a222c34-e9e4-48c2-8ccb-12d9b3763cdf","name":"Sticky Note8"},{"parameters":{"operation":"select","schema":{"__rl":true,"value":"chatwoot_uazapi","mode":"list","cachedResultName":"chatwoot_uazapi"},"table":{"__rl":true,"value":"chatwoot_uazapi_config","mode":"list","cachedResultName":"chatwoot_uazapi_config"},"limit":1,"where":{"values":[{"column":"api_base_url","value":"={{ $('webhookDataUazapi')?.item?.json?.body?.BaseUrl }}"},{"column":"api_token","value":"={{ $('webhookDataUazapi')?.item?.json?.body?.token }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-80,656],"id":"fbb611c9-153b-4700-83ea-13807905452f","name":"getVariables","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"url":"={{ $('processedData')?.item?.json?.contact?.avatar ??\n   ''\n}}","options":{"response":{"response":{"neverError":true,"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2032,1088],"id":"abe2af8b-f7aa-43a9-a824-cdb2388e4a4f","name":"getContactPhoto"},{"parameters":{"method":"PUT","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/contacts/{{ $('processedData')?.item?.json?.contact?.contact_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"},{"name":"Content-type","value":"application/json; charset=utf-8"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"avatar","inputDataFieldName":"data"}]},"options":{"response":{"response":{"neverError":true}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2208,1088],"id":"37d387fb-dddb-4c3c-a444-a6a55b28b5bf","name":"sendContactPhoto","retryOnFail":true},{"parameters":{"operation":"executeQuery","query":"SELECT\n  $1::integer AS conversation_id,\n  CASE\n    WHEN $2::boolean IS FALSE OR NULLIF($3, '') IS NULL\n    THEN NULL\n    ELSE (\n      SELECT id\n      FROM public.messages\n      WHERE account_id = $4::integer\n        AND inbox_id   = $5::integer\n        AND source_id  = $3\n      ORDER BY created_at DESC\n      LIMIT 1\n    )\n  END AS reply_id,\n  CASE\n    WHEN $6::boolean IS FALSE AND NULLIF($7, '') IS NOT NULL\n    THEN 0\n    WHEN NULLIF($7, '') IS NULL\n    THEN NULL\n    WHEN $6::boolean IS FALSE\n    THEN NULL\n    ELSE (\n      SELECT id\n      FROM public.messages\n      WHERE account_id = $4::integer\n        AND inbox_id   = $5::integer\n        AND source_id  = $7\n      ORDER BY created_at DESC\n      LIMIT 1\n    )\n  END AS edited_id,\n  CASE\n    WHEN $8::boolean IS FALSE AND NULLIF($9, '') IS NOT NULL\n    THEN 0\n    WHEN NULLIF($9, '') IS NULL\n    THEN NULL\n    WHEN $8::boolean IS FALSE\n    THEN NULL\n    ELSE (\n      SELECT id\n      FROM public.messages\n      WHERE account_id = $4::integer\n        AND inbox_id   = $5::integer\n        AND source_id  = $9\n      ORDER BY created_at DESC\n      LIMIT 1\n    )\n  END AS deleted_id;","options":{"queryReplacement":"={{ [\n  String($json?.id ?? $json?.payload?.conversation_id ?? $json?.data?.conversation_id ?? 0),\n  String($('processedData')?.item?.json?.chatwoot?.reply_messages ?? false),\n  String($('processedData')?.item?.json?.data.reply_id ?? ''),\n  String($('processedData')?.item?.json?.chatwoot?.account_id ?? ''),\n  String($('processedData')?.item?.json?.chatwoot?.inbox_id ?? ''),\n  String($('processedData')?.item?.json?.chatwoot?.edit_messages ?? false),\n  String($('processedData')?.item?.json?.data?.edited_id ?? ''),\n  String($('processedData')?.item?.json?.chatwoot?.delete_messages ?? false),\n  String($('processedData')?.item?.json?.data?.deleted_id ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[800,1408],"id":"c175c96e-2788-45f0-b309-f7cbfcc9a563","name":"findMessageReply","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bf9dd4b4-6f2e-4628-ab0a-29f6b8b99c03","leftValue":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.EventType ??\n    ''\n  )\n}}","rightValue":"messages","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"fa2f52c5-befc-445f-ab3f-1cdf5fad99b3","leftValue":"={{\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.EventType ??\n    ''\n  )\n  .toLowerCase() === 'messages_update' &&\n  String(\n    $('webhookDataUazapi')?.item?.json?.body?.type ??\n    ''\n  )\n  .toLowerCase() === 'deletedmessage'\n}}","rightValue":"messages_update","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[96,656],"id":"d1c4c4e7-bc3c-40ad-8711-893b7c4390e8","name":"messageTypeFilter"},{"parameters":{"operation":"executeQuery","query":"SELECT COALESCE(\n  (SELECT content\n     FROM public.messages\n    WHERE id = $1::integer\n    LIMIT 1),\n    ''\n  ) AS content;","options":{"queryReplacement":"={{\n  [\n    String($('messageVerify')?.item?.json?.deleted_id ?? 0)\n  ]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1152,1408],"id":"c7b45410-14cc-4c20-b627-cd9b883a3332","name":"findMessageDeleted","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1152,1760],"id":"211bbc9b-4d3d-47d0-8b73-ec75ca58de1e","name":"messageSentEndProcess"},{"parameters":{"operation":"executeQuery","query":"SELECT COALESCE(\n  (SELECT content\n     FROM public.messages\n    WHERE id = $1::integer\n    LIMIT 1),\n    ''\n  ) AS content;","options":{"queryReplacement":"={{\n  [\n    String($('messageVerify')?.item?.json?.edited_id ?? 0)\n  ]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1152,1584],"id":"f876a9aa-75a2-4cd5-b8c1-3b9572bdccb5","name":"findMessageEdited","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Mgnr","height":176,"width":166,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-112,624],"typeVersion":1,"id":"4ba31b7a-bd4d-4e2b-87db-556cd8b1db99","name":"Sticky Note9"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[768,1376],"typeVersion":1,"id":"86cb4ee2-7fd3-44ce-af75-115440db293c","name":"Sticky Note10"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1472,1376],"typeVersion":1,"id":"0fb4aaf9-8bca-4759-a134-14b09da12855","name":"Sticky Note11"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1120,1376],"typeVersion":1,"id":"73bf495a-62a2-4ee3-b882-d71fbc26cb84","name":"Sticky Note12"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{\n  String($('processedData')?.item?.json?.data?.media_key ?? '').trim() === '' &&\n  $('findMessageReply')?.item?.json?.deleted_id == null &&\n  $('findMessageReply')?.item?.json?.edited_id == null\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"ed4a34fc-e5c3-403c-8fdf-398a1d4cf3fd"}],"combinator":"and"},"renameOutput":true,"outputKey":"textMessage"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6130e0f5-c301-4433-9fa3-974a66d05383","leftValue":"={{\n  String($('processedData')?.item?.json?.data?.media_key ?? '').trim() !== '' &&\n  $('findMessageReply')?.item?.json?.deleted_id == null &&\n  $('findMessageReply')?.item?.json?.edited_id == null\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"mediaMessage"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"07ca6767-622e-4176-913b-0ab3059c298c","leftValue":"={{ Number($('findMessageReply')?.item?.json?.deleted_id ?? 0) > 0 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"deletedMessage"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4ef1f52b-f800-4f1d-8c4a-327a410d77f5","leftValue":"={{ Number($('findMessageReply')?.item?.json?.edited_id ?? 0) > 0 }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"editedMessage"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[976,1360],"id":"a27a6079-aae2-40d6-8b99-9360f293fef4","name":"messageVerify"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1120,1552],"typeVersion":1,"id":"be68bab4-e1ce-4fc5-bc5f-b117063d1bd6","name":"Sticky Note13"},{"parameters":{"content":"# âš–ï¸ Aviso de Propriedade Intelectual & Suporte\n\nEste workflow e sua UI sÃ£o **propriedade intelectual** da EMKT Consultoria e Tecnologia, protegidos pelas Leis **9.610/98 (Direitos Autorais)**, **9.609/98 (Software)** e pela **LGPD â€“ 13.709/18**.\n---\n\n## Uso permitido\n- LicenÃ§a de **uso interno**, nÃ£o exclusiva e intransferÃ­vel.\n- Ã‰ vedada a **distribuiÃ§Ã£o**, **revenda**, **locaÃ§Ã£o**, **cessÃ£o**, **publicaÃ§Ã£o** ou **exposiÃ§Ã£o pÃºblica** (incl. repositÃ³rios/portais).\n\n## ProibiÃ§Ãµes\n- **CÃ³pia** total/parcial, **engenharia reversa**, **descompilaÃ§Ã£o**, **circunvenÃ§Ã£o** de proteÃ§Ãµes.\n- **ModificaÃ§Ãµes** nÃ£o autorizadas, criaÃ§Ã£o de **derivados** ou remoÃ§Ã£o de crÃ©ditos/identificaÃ§Ãµes.\n- **Compartilhamento** do pacote/fluxo, credenciais, URLs de webhook, telas ou prints com terceiros.\n\n## Suporte & Garantia\n- A **garantia de suporte** e atualizaÃ§Ãµes estÃ¡ **condicionada** Ã  manutenÃ§Ã£o do **estado original** do workflow.  \n- Qualquer **alteraÃ§Ã£o nÃ£o autorizada** (cÃ³digo, nÃ³s, credenciais, rotas, lÃ³gica ou layout) **invalida o suporte**.\n- AdequaÃ§Ãµes/integraÃ§Ãµes adicionais requerem **contrataÃ§Ã£o prÃ©via** e **autorizaÃ§Ã£o por escrito**.\n\n---\n\n### ðŸ“ž Contato\nPrecisa de ajuda? Fale conosco pelo WhatsApp Business  \n**(41) 9 8473-9797** â€” [abrir conversa](https://api.whatsapp.com/message/FVXDCWKJFIM4M1)  \n**(79) 9 9977-7712** â€” [abrir conversa](https://api.whatsapp.com/message/2G6M66MXFH7TD1)\n\n> DÃºvidas sobre uso, licenÃ§a ou autorizaÃ§Ã£o: contate a EMKT.\n","height":720,"width":2896,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-336,1920],"typeVersion":1,"id":"d20059b7-c886-430e-9d97-ef73cb62c640","name":"Sticky Note14"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const normalizedData = $('normalizedData')?.first()?.json;\nconst getVariables = $('getVariables')?.first()?.json;\nconst conversationFind = $('conversationFind')?.first()?.json;\n\nconst conversations = $('conversationFind')?.item?.json?.payload;\n\nconst reopen = getVariables?.reopen_conversation;\nconst foundStatus = conversationFind?.payload?.[0]?.status;\nconst expectedStatus = reopen ? (foundStatus ?? 'open') : 'open';\nconst expectedInboxId = normalizedData?.chatwoot?.inbox_id;\n\nconst filteredConversations = conversations.filter(conv => {\n  const inboxMatch = (conv.messages?.[0]?.inbox_id || 0) == expectedInboxId;\n  const statusMatch = (conv.status ?? '') == expectedStatus;\n  return inboxMatch && statusMatch;\n});\n\nconst sortedConversations = filteredConversations.sort((a, b) => b.id - a.id);\n\nconst topConversation = sortedConversations[0];\n\nif (topConversation) {\n  return {\n    json: {\n      conversation_id: topConversation.id\n    }\n  };\n}\n\nreturn {\n  json: {\n    conversation_id: 0\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[96,1408],"id":"6d3c53ea-cff5-40b7-8894-4b40f85e8f51","name":"conversationIdentify"},{"parameters":{"url":"={{ $('messageMediaFind')?.item?.json?.fileURL }}","options":{"response":{"response":{"neverError":true,"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1328,1248],"id":"9e603b96-432a-443a-a135-888a51dafe27","name":"messageMediaDownload","retryOnFail":true},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[768,704],"typeVersion":1,"id":"d158ddf5-5fde-4ac1-8991-2dc4d7e00b90","name":"Sticky Note15"},{"parameters":{"operation":"executeQuery","query":"WITH NormalizedInput AS (\n  SELECT\n    NULLIF($1, '') AS input_identifier,\n    NULLIF($2, '') AS input_lid,\n    NULLIF($3, '') AS input_full_name,\n    NULLIF($4, '') AS input_phone_number,\n    NULLIF($5, '')::integer AS input_account_id\n)\nSELECT\n  COALESCE(c.id, 0) AS contact_id,\n  COALESCE(c.identifier, '') AS identifier_old,\n  COALESCE(ni.input_identifier, '') AS identifier_new,\n  COALESCE(c.additional_attributes ->> 'contact_lid', '') AS contact_lid_old,\n  COALESCE(ni.input_lid, '') AS contact_lid_new,\n  COALESCE(c.name, '') AS name_old,\n  COALESCE(ni.input_full_name, '') AS name_new,\n  COALESCE(c.phone_number, '') AS phone_number_old,\n  COALESCE(ni.input_phone_number, '') AS phone_number_new,\n  CASE\n    WHEN c.id IS NULL THEN true\n    WHEN (\n      COALESCE(c.identifier, '') != COALESCE(ni.input_identifier, '') OR\n      COALESCE(c.additional_attributes ->> 'contact_lid', '') != COALESCE(ni.input_lid, '') OR\n      COALESCE(c.phone_number, '') != COALESCE(ni.input_phone_number, '')\n    ) THEN true\n    WHEN (\n      COALESCE(c.name, '') = 'Contato' AND\n      COALESCE(c.name, '') != COALESCE(ni.input_full_name, '')\n    ) THEN true\n    ELSE false\n  END AS update_data\nFROM NormalizedInput AS ni\nLEFT JOIN contacts AS c ON\n  (c.account_id = ni.input_account_id AND ni.input_account_id IS NOT NULL)\n  AND (\n    (c.identifier = ni.input_identifier AND ni.input_identifier IS NOT NULL) OR\n    (c.additional_attributes ->> 'contact_lid' = ni.input_lid AND ni.input_lid IS NOT NULL) OR\n    (c.phone_number = ni.input_phone_number AND ni.input_phone_number IS NOT NULL)\n  );","options":{"queryReplacement":"={{\n  [\n    String($('normalizedData')?.item?.json?.contact?.identifier) || null,\n    String($('normalizedData')?.item?.json?.contact?.lid),\n    String($('normalizedData')?.item?.json?.contact?.full_name).replace(/'/g, \"''\") || null,\n    String($('normalizedData')?.item?.json?.contact?.phone_number) || null,\n    String($('normalizedData')?.item?.json?.chatwoot?.account_id) || null\n  ]\n}}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[800,736],"id":"09bfc2b6-90e8-4460-9e25-5d79a5cd612f","name":"contactFind","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{\n  (\n    $('contactFind')?.item?.json ??\n    {}\n  )\n  .contact_id === 0\n}}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true},"id":"e71ede49-b811-46e9-be73-fcece40f27c8"}],"combinator":"and"},"renameOutput":true,"outputKey":"create"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"342366cd-05e8-4efe-b237-ccf032377806","leftValue":"={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data.contact_id > 0);\n  const shouldUpdate = (data.update_data !== true);\n  return contactIdExists && shouldUpdate;\n})()\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"exists"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7bcd700f-3396-4c45-953c-8b5bcdf1bbbe","leftValue":"={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data.contact_id > 0);\n  const shouldUpdate = (data.update_data === true);\n  return contactIdExists && shouldUpdate;\n})()\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"update"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[976,720],"id":"180b7d0b-a469-4ec6-8653-2d325a2dd65a","name":"contactVerify"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"contacts","mode":"list","cachedResultName":"contacts"},"columns":{"mappingMode":"defineBelow","value":{"identifier":"={{ $('contactVerify')?.item?.json?.identifier_new }}","id":"={{ $('contactVerify').item.json.contact_id }}","additional_attributes":"={{ ({ \"contact_lid\": $('contactVerify')?.item?.json?.contact_lid_new }) }}","name":"={{\n(() => {\n  const data = $('contactVerify')?.item?.json ?? {};\n  \n  const oldName = data.name_old ?? '';\n  const newName = data.name_new ?? '';\n  if (oldName === 'Contato') {\n    return newName;\n  }\n  return oldName;\n})()\n}}","phone_number":"={{ $('contactVerify')?.item?.json?.identifier_new.split('@').last() === 'g.us' ? $('contactVerify')?.item?.json?.phone_number_new : $('contactVerify')?.item?.json?.phone_number_old }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"name","displayName":"name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"email","displayName":"email","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"phone_number","displayName":"phone_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"account_id","displayName":"account_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"additional_attributes","displayName":"additional_attributes","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":false},{"id":"identifier","displayName":"identifier","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"custom_attributes","displayName":"custom_attributes","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"last_activity_at","displayName":"last_activity_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"contact_type","displayName":"contact_type","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"middle_name","displayName":"middle_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_name","displayName":"last_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"location","displayName":"location","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"country_code","displayName":"country_code","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"blocked","displayName":"blocked","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":true},{"id":"company_id","displayName":"company_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1152,816],"id":"c7b78fdc-289a-48a8-a85d-8b44ac48735f","name":"contactUpdate","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1120,784],"typeVersion":1,"id":"ead53782-a17b-4d2c-820c-c60913ba23c1","name":"Sticky Note16"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// 1. Pega os dados originais dos nÃ³s anteriores\n// (Ajuste o nome do nÃ³ 'findMessageReply' se for diferente)\nconst replyData = $('findMessageReply')?.item?.json;\nconst deletedData = $('findMessageDeleted')?.item?.json;\n\nconst originalAttributes = replyData.content_attributes;\nconst originalContent = deletedData.content ?? '';\n\n// 2. PARSE (Sua lÃ³gica - InÃ­cio)\n// Normaliza o 'content_attributes' para um objeto JS\nlet parsedAttributes = {};\n\nif (typeof originalAttributes === 'string') {\n  // Caso 1: Ã‰ uma string JSON (ex: \"{\\\"key\\\":\\\"value\\\"}\")\n  try {\n    // Tenta fazer o parse da string\n    parsedAttributes = JSON.parse(originalAttributes);\n  } catch (e) {\n    // Falha: pode ser uma string vazia \"\" ou \"{}\"\n    parsedAttributes = {};\n  }\n} else if (typeof originalAttributes === 'object' && originalAttributes !== null) {\n  // Caso 2: Ã‰ um objeto JSON (ex: {\"key\":\"value\"})\n  parsedAttributes = originalAttributes;\n}\n\n// 3. MODIFY\n// Adiciona a flag 'deleted'\nparsedAttributes.deleted = true;\n\n// 4. STRINGIFY\n// Converte de volta para a string JSON que o Chatwoot espera\nconst newAttributesString = JSON.stringify(parsedAttributes);\n\n// 5. Prepara o 'content' (a lÃ³gica que vocÃª jÃ¡ tinha)\nconst newContent = (\n  \"ðŸš« _Mensagem ExcluÃ­da:_\" +\n  \"\\n\\n\" + \"---\" + \"\\n\\n\" +\n  (\n    String(originalContent)\n      .replaceAll('~~','')\n      .replace(/([^\\r\\n]+)/g, \"~~$1~~\")\n  )\n)\n  .replaceAll('~~---~~','---');\n\n// 6. Retorna tudo pronto para o nÃ³ SQL\n// Note que 'new_attributes_string' Ã© o JSON stringificado que vocÃª pediu\nreturn {\n  json: {\n    deleted_id: replyData.deleted_id,\n    new_content: newContent,\n    new_attributes: newAttributesString // Ex: \"{\\\"deleted\\\":true}\"\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,1408],"id":"1766c40e-7957-4549-bd4d-af2c93ea8b51","name":"prepareMessageDeleted"},{"parameters":{"operation":"executeQuery","query":"UPDATE public.messages\nSET \n  content = $1,\n  content_attributes = $2::json\nWHERE \n  id = $3::integer\nRETURNING \n  id, content, content_attributes;","options":{"queryReplacement":"={{ [\n  String($('prepareMessageDeleted')?.item?.json?.new_content ?? ''),\n  String(JSON.stringify( $('prepareMessageDeleted')?.item?.json?.new_attributes ?? {} )),\n  String($('prepareMessageDeleted')?.item?.json?.deleted_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1504,1408],"id":"b3e8c5f1-a2a1-49ff-b5ac-be2b6eeb1dc8","name":"updateMessageDeleted","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id }}/messages/{{ $('messageVerify')?.item?.json?.deleted_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"sent"}]},"options":{}},"id":"39551669-d674-49b1-b00a-607cd68b96cf","name":"patchMessageDeleted","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1680,1408],"retryOnFail":true},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id }}/messages/{{ $('messageVerify')?.item?.json?.edited_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"sent"}]},"options":{}},"id":"643fd38b-5107-40e2-9b1e-0f04f23c3623","name":"patchMessageEdited","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1504,1584],"retryOnFail":true},{"parameters":{"operation":"executeQuery","query":"WITH updated AS (\n  UPDATE public.messages\n  SET \n    content = $1\n  WHERE id = $2::integer\n  RETURNING id, content, source_id\n)\nSELECT\n  (SELECT COUNT(*) FROM updated) AS rows_affected,\n  (SELECT content FROM updated LIMIT 1) AS content,\n  (SELECT source_id FROM updated LIMIT 1) AS source_id;","options":{"queryReplacement":"={{ [\n  (\n    \"ðŸ”„ _Mensagem Editada:_\\n\\n\" +\n    (\n      String( $('findMessageEdited')?.item?.json?.content ?? '' )\n        .replaceAll('ðŸ”„ _Mensagem Editada:_\\n\\n','')\n        .replaceAll('~~','')\n        .replace(/([^\\r\\n]+)/g, \"~~$1~~\")\n    ) +\n    \"\\n\\n\" + \"---\" + \"\\n\\n\" +\n      String($('normalizedData')?.item?.json?.data?.content ?? '')\n  )\n    .replaceAll('~~---~~', '---'),\n  \n  String($('findMessageReply')?.item?.json?.edited_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1328,1584],"id":"adf4b5f1-6602-4223-b8e2-fb5c1fec5417","name":"updateMessageEdited","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[1296,1552],"typeVersion":1,"id":"085f40ad-29a4-4762-9b22-03fc59c45966","name":"Sticky Note17"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.account_id ?? ''}}"},{"key":"inboxId","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('normalizedData')?.item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('normalizedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('normalizedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('normalizedData')?.item?.json?.data?.conversation_status ?? '' }}"},{"key":"messageId","value":"={{ $('normalizedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('normalizedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('normalizedData')?.item?.json?.data?.message_direction ?? '' }}"},{"key":"eventType","value":"={{ $('normalizedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[800,576],"id":"65db3900-6b28-4212-a73f-61de11281674","name":"executionData1"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('processedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('processedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('processedData')?.item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('processedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('processedData')?.item?.json?.data?.conversation_status ?? '' }}"},{"key":"messageId","value":"={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('processedData')?.item?.json?.data?.message_direction ?? '' }}"},{"key":"eventType","value":"={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[2384,1248],"id":"62bd669f-c66a-43b4-8440-cd9dcbd7a7a2","name":"executionData3"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('processedData')?.item?.json?.chatwoot.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('processedData')?.item?.json?.chatwoot.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('processedData')?.item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('processedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('processedData')?.item?.json?.data?.conversation_status ?? '' }}"},{"key":"messageId","value":"={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('processedData')?.item?.json?.data?.message_direction ?? '' }}"},{"key":"eventType","value":"={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[272,1248],"id":"061f5121-a9eb-4622-b7da-e7b596abf69b","name":"executionData"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ecef90c3-8fe9-40e0-bc79-33b7f88b60ef","leftValue":"={{ $('processedData')?.item?.json?.contact?.avatar ??\n   ''\n}}","rightValue":"http","operator":{"type":"string","operation":"startsWith"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1856,1088],"id":"9ac73a6c-6ea8-4b71-8a3d-940f17700497","name":"avatarVerify"}],"connections":{"normalizedData":{"main":[[{"node":"contactFind","type":"main","index":0},{"node":"executionData1","type":"main","index":0}]]},"contactCreate":{"main":[[{"node":"contactIdentify","type":"main","index":0}],[{"node":"contactFind","type":"main","index":0}]]},"contactIdentify":{"main":[[{"node":"conversationFind","type":"main","index":0}]]},"conversationFind":{"main":[[{"node":"conversationIdentify","type":"main","index":0}]]},"processedData":{"main":[[{"node":"conversationVerify","type":"main","index":0},{"node":"executionData","type":"main","index":0}]]},"messageMediaFind":{"main":[[{"node":"messageMediaDownload","type":"main","index":0}]]},"messageMediaSend":{"main":[[{"node":"avatarVerify","type":"main","index":0}]]},"messageTextSend":{"main":[[{"node":"avatarVerify","type":"main","index":0}]]},"messageMediaRename":{"main":[[{"node":"messageMediaSend","type":"main","index":0}]]},"groupVerify":{"main":[[{"node":"groupEndProcess","type":"main","index":0}],[{"node":"fromMeVerify","type":"main","index":0}]]},"fromMeVerify":{"main":[[{"node":"fromMeEndProcess","type":"main","index":0}],[{"node":"normalizedData","type":"main","index":0}]]},"webhookDataUazapi":{"main":[[{"node":"getVariables","type":"main","index":0}]]},"conversationUpdate":{"main":[[{"node":"findMessageReply","type":"main","index":0}]]},"conversationCreate":{"main":[[{"node":"findMessageReply","type":"main","index":0}]]},"conversationVerify":{"main":[[{"node":"conversationCreate","type":"main","index":0}],[{"node":"findMessageReply","type":"main","index":0}],[{"node":"conversationUpdate","type":"main","index":0}]]},"getVariables":{"main":[[{"node":"messageTypeFilter","type":"main","index":0}]]},"getContactPhoto":{"main":[[{"node":"sendContactPhoto","type":"main","index":0}]]},"sendContactPhoto":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"findMessageReply":{"main":[[{"node":"messageVerify","type":"main","index":0}]]},"messageTypeFilter":{"main":[[{"node":"groupVerify","type":"main","index":0}]]},"findMessageDeleted":{"main":[[{"node":"prepareMessageDeleted","type":"main","index":0}]]},"findMessageEdited":{"main":[[{"node":"updateMessageEdited","type":"main","index":0}]]},"messageVerify":{"main":[[{"node":"messageTextSend","type":"main","index":0}],[{"node":"messageMediaFind","type":"main","index":0}],[{"node":"findMessageDeleted","type":"main","index":0}],[{"node":"findMessageEdited","type":"main","index":0}],[{"node":"messageSentEndProcess","type":"main","index":0}]]},"conversationIdentify":{"main":[[{"node":"processedData","type":"main","index":0}]]},"messageMediaDownload":{"main":[[{"node":"messageMediaRename","type":"main","index":0}]]},"contactFind":{"main":[[{"node":"contactVerify","type":"main","index":0}]]},"contactVerify":{"main":[[{"node":"contactCreate","type":"main","index":0}],[{"node":"contactIdentify","type":"main","index":0}],[{"node":"contactUpdate","type":"main","index":0}]]},"contactUpdate":{"main":[[{"node":"contactIdentify","type":"main","index":0}]]},"prepareMessageDeleted":{"main":[[{"node":"updateMessageDeleted","type":"main","index":0}]]},"updateMessageDeleted":{"main":[[{"node":"patchMessageDeleted","type":"main","index":0}]]},"patchMessageDeleted":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"updateMessageEdited":{"main":[[{"node":"patchMessageEdited","type":"main","index":0}]]},"patchMessageEdited":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"endProcess":{"main":[[{"node":"executionData3","type":"main","index":0}]]},"avatarVerify":{"main":[[{"node":"getContactPhoto","type":"main","index":0}],[{"node":"endProcess","type":"main","index":0}]]}},"authors":"system migration","name":null,"description":null,"autosaved":false},"tags":[{"updatedAt":"2025-11-16T22:16:21.421Z","createdAt":"2025-11-16T22:16:21.421Z","id":"aawu1QmRhGC0eQOa","name":"Uazapi"},{"updatedAt":"2025-11-20T17:34:44.792Z","createdAt":"2025-11-20T17:34:44.792Z","id":"RhIrKuplA6oJB0ck","name":"Premium"},{"updatedAt":"2025-11-20T17:34:44.828Z","createdAt":"2025-11-20T17:34:44.828Z","id":"ffkEJ4KMIqqIHfFo","name":"Chatwoot"}]}