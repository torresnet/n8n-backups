{"updatedAt":"2025-11-21T17:47:36.166Z","createdAt":"2025-11-20T17:36:27.969Z","id":"o19aA0Bt4YMQtbiw","name":"[EMKT] Chatwoot x UaZapi v1.0.1-Premium","active":true,"isArchived":false,"nodes":[{"parameters":{"content":"## Tratamento Inicial dos Dados","height":424,"width":516},"type":"n8n-nodes-base.stickyNote","position":[-816,-832],"typeVersion":1,"id":"1590f52d-e910-46fb-b712-57e314d5a0f6","name":"Sticky Note"},{"parameters":{"content":"## InÃ­cio do Processamento","height":1144,"width":208},"type":"n8n-nodes-base.stickyNote","position":[-1040,-832],"typeVersion":1,"id":"2ce283e3-2eaf-44ea-bd6f-f5031bece627","name":"Sticky Note1"},{"parameters":{"content":"```\n                                                                                  â–ˆâ–ˆâ–ˆ       â–ˆ                            â–ˆâ–ˆ          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ          â–ˆ                   â–ˆ              â–ˆ   â–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â–ˆ\n                                                                                   â–ˆ       â–ˆâ–ˆâ–ˆ                                       â–ˆ     â–ˆ         â–ˆâ–ˆâ–ˆ                 â–ˆâ–ˆâ–ˆ             â–ˆ   â–ˆ          â–ˆ\n                                                                                   â–ˆ  â–ˆ â–ˆâ–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ     â–ˆ   â–ˆ    â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ           â–ˆ    â–ˆâ–ˆâ–ˆ    â–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n                                                                                   â–ˆ  â–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆ      â–ˆ â–ˆ       â–ˆ â–ˆ  â–ˆ    â–ˆ     â–ˆ  â–ˆ    â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ     â–ˆ   â–ˆ    â–ˆ   â–ˆ      â–ˆ â–ˆ  â–ˆ â–ˆ          â–ˆâ–ˆ    â–ˆ â–ˆ   â–ˆâ–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ    â–ˆ     â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ       â–ˆ      â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ   â–ˆ    â–ˆ â–ˆ    â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ  â–ˆ    â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ     â–ˆ   â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ   â–ˆ    â–ˆ â–ˆ    â–ˆ     â–ˆ    â–ˆ â–ˆ  â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                  â–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆ â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ    â–ˆ   â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ      â–ˆ   â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ    â–ˆ    â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                       â–ˆ             â–ˆ                                                                                         â–ˆ\n                                                                                                    â–ˆâ–ˆâ–ˆâ–ˆ            â–ˆ                                                                                          â–ˆ\n```","height":200,"width":3132,"color":7},"type":"n8n-nodes-base.stickyNote","position":[-1824,-1056],"typeVersion":1,"id":"de7e34b1-b9f1-4826-8656-aa2a274b923c","name":"Sticky Note7"},{"parameters":{"content":"## Final do Processamento","height":1144,"width":208},"type":"n8n-nodes-base.stickyNote","position":[1104,-832],"typeVersion":1,"id":"c30937ff-1159-451f-87ba-9fbbe17a9ded","name":"Sticky Note3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"251049eb-7cb5-454f-a495-072ab8d4f644","leftValue":"={{ $('messageSentVerify')?.item?.json?.data?.attachments }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-432,-288],"id":"03e1c1b7-19f2-40f6-a125-60491ee2709c","name":"messageVerify"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1136,-368],"id":"05938d33-c3ba-4422-be5c-599a3d9b58de","name":"endProcess"},{"parameters":{"content":"# ðŸ’¬ IntegraÃ§Ã£o Premium Chatwoot ðŸ” UaZapi\n### _**v1.0.1 â€¢ atualizado: 2025-11-17**_\n\n## Workflow que recebe mensagens via **webhook** do Chatwoot, normaliza os dados e envia para a UaZapi.\n---\n\n## ðŸ§­ O que este fluxo faz\n- Recebe **Webhook (POST)** do Chatwoot (`webhookDataChatwoot`) e carrega **variÃ¡veis de integraÃ§Ã£o** no Postgres (`getVariables`).\n- **Normaliza** contato, conversa e mensagem (`normalizedData`) e propaga para o contexto (`processedData`).\n- **Roteia** por tipo de entrega (`messageSentVerify` â†’ `messageVerify`):\n  - `msg_created` (evento `message_created` **sem** `source_id`)  \n    - **Texto:** `messageTextSend`  \n    - **MÃ­dia:** `messageMediaFields` â†’ `messageMediaSend`\n  - `msg_deleted` (evento `message_updated` com `deleted=true` **e** `delete_messages=true`)  \n    - Busca conteÃºdo original: `findMessageDeleted` â†’ valida direÃ§Ã£o (`deleteVerify`) â†’ apaga na UaZapi (`deleteMessage`) â†’ atualiza histÃ³rico no Chatwoot/DB com *strike-through* (`messageDeletedUpdate`)\n- ApÃ³s envio de texto **ou** mÃ­dia, atualiza o `source_id` no Postgres para manter o vÃ­nculo com a UaZapi (`messageUpdate`).\n- Assina a mensagem opcionalmente com o **nome do atendente** (flag `sign_messages`), e agrega `replyid` apenas quando **`reply_messages=true`** e houver `reply_id`.\n\n---\n\n## ðŸ›  Requisitos\n- **Postgres (credencial):** nÃ³s `getVariables` do Manager (Vermelho) e `messageUpdate`, `messageDeletedUpdate` do Chatwoot (Azuis).\n- **VariÃ¡veis de integraÃ§Ã£o (Preenchidas no Gerenciador de InstÃ¢ncias):**\n  - **Chatwoot:** `chatwoot_base_url`, `chatwoot_api_version`, `chatwoot_token`, `chatwoot_account_id`, `chatwoot_inbox_id`, `chatwoot_inbox_name`, `chatwoot_track_id`\n  - **UaZapi:** `api_base_url`, `api_token`, `api_instance_name`\n  - **ConfiguraÃ§Ãµes:** `ignore_groups`, `reply_messages`, `edit_messages`, `delete_messages`, `reopen_conversation`, `conversation_pending`, `import_*`, `sign_*`\n- **Chatwoot:** **Gere um cÃ³digo exclusivo para o seu webhook em** [UUID Generator](https://www.uuidgenerator.net/) e informe no campo `Path` do `webhookDataChatwoot`.\n\n---\n\n## âš™ï¸ InstalaÃ§Ã£o & AtivaÃ§Ã£o\n1. **Importe** o workflow no n8n.  \n2. Associe a **credencial Postgres** aos nÃ³s indicados.  \n3. Ajuste o **Webhook** `webhookDataChatwoot` (path pÃºblico) e configure os **webhooks de saÃ­da** no Chatwoot.  \n4. Confirme que `getVariables` retorna a linha correta por `chatwoot_account_id` e `chatwoot_inbox_id`.  \n5. **Save** â†’ **Activate**.  \n6. Envie uma mensagem pelo Chatwoot e valide o envio na UaZapi e a atualizaÃ§Ã£o do `source_id`.\n\n---\n\n## ðŸ”€ Regras de Roteamento (resumo)\n- **CriaÃ§Ã£o de mensagem:** `message_created` **sem** `source_id` â†’ envia para a UaZapi.  \n- **Texto vs MÃ­dia:** `messageVerify` checa `data_url`  \n  - vazio â†’ **texto** (`messageTextSend`)  \n  - preenchido â†’ **mÃ­dia** (`messageMediaFields` â†’ `messageMediaSend`)\n- **Reply:** `replyid` sÃ³ Ã© enviado se `reply_messages = true` **e** houver `reply_id`.\n- **Assinatura opcional:** quando `sign_messages = true`, prefixa o conteÃºdo com `*Atendente:*`.\n- **ExclusÃ£o:** `message_updated` com `deleted=true` **e** `delete_messages = true`  \n  - apenas se `direction = incoming` (`deleteVerify`)  \n  - apaga na UaZapi e grava histÃ³rico com *strike-through* no Chatwoot/DB.\n- **Rastreamento:** define `track_id` no formato `track-account-inbox` (com `account_id` e `inbox_id` **padStart(4)**) e `track_source = chatwoot`.\n\n---\n\n## ðŸ” SeguranÃ§a\n- **HTTPS** no Webhook e nas APIs (Chatwoot/UaZapi).\n- **Tokens** (Chatwoot/UaZapi) mantidos no Gerenciador de InstÃ¢ncias.\n","height":1856,"width":768,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-1824,-832],"typeVersion":1,"id":"03079e33-9305-441e-88d8-59b18cfaf2b6","name":"Sticky Note Chatwoot â†’ UaZapi"},{"parameters":{"httpMethod":"POST","path":"6a936a6e-9056-465a-934f-e46564e5cbd3","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-976,-704],"id":"d6cfbd85-c9b9-42e6-8d4e-87e774b8d1e0","name":"webhookDataChatwoot","webhookId":"6a936a6e-9056-465a-934f-e46564e5cbd3"},{"parameters":{"operation":"select","schema":{"__rl":true,"value":"chatwoot_uazapi","mode":"list","cachedResultName":"chatwoot_uazapi"},"table":{"__rl":true,"value":"chatwoot_uazapi_config","mode":"list","cachedResultName":"chatwoot_uazapi_config"},"limit":1,"where":{"values":[{"column":"chatwoot_account_id","value":"={{ $('webhookDataChatwoot')?.item?.json?.body?.account?.id ?? 0 }}"},{"column":"chatwoot_inbox_id","value":"={{ $('webhookDataChatwoot')?.item?.json?.body?.conversation?.inbox_id ?? 0 }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-784,-704],"id":"1ed207bb-5b7f-4f95-a6ba-3402ae3884ac","name":"getVariables","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE public.messages\nSET \n  content = $1,\n  content_attributes = $2::json\nWHERE \n  id = $3::integer\nRETURNING \n  id, content, content_attributes;","options":{"queryReplacement":"={{ [\n  String($('messageDeletedPrepare')?.item?.json?.new_content ?? ''),\n  String(JSON.stringify( $('messageDeletedPrepare')?.item?.json?.new_attributes ?? {} )),\n  String($('messageDeletedPrepare')?.item?.json?.message_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[272,160],"id":"173a7289-d695-4031-aa97-4a7ee634eb05","name":"messageDeletedUpdate","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Mngr","height":176,"width":166,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-816,-736],"typeVersion":1,"id":"569f6db4-04f8-4b43-afb5-ec4ea3d2aba5","name":"Sticky Note9"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[64,-320],"typeVersion":1,"id":"4ac51692-bf72-4085-8968-d4d2d6f05803","name":"Sticky Note10"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[240,128],"typeVersion":1,"id":"a95b1bd4-48d1-4026-924a-f4a464f8c576","name":"Sticky Note11"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_created' &&\n  $('webhookDataChatwoot')?.item?.json?.body?.private !== true &&\n  !String($('webhookDataChatwoot')?.item?.json?.body?.source_id ?? '').trim()\n}}","rightValue":"message_created","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"e71ede49-b811-46e9-be73-fcece40f27c8"}],"combinator":"and"},"renameOutput":true,"outputKey":"msg_created"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7bcd700f-3396-4c45-953c-8b5bcdf1bbbe","leftValue":"={{ \n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_updated' &&\n  ( $('webhookDataChatwoot')?.item?.json?.body.conversation?.messages[0].content_attributes?.deleted ||\n    $('webhookDataChatwoot')?.item?.json?.body?.content_attributes?.deleted\n  ) &&\n  $('processedData')?.item?.json?.chatwoot?.delete_messages === true\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"msg_deleted"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-608,-96],"id":"8fb6c026-b069-45b8-ba40-322bedc9f468","name":"messageSentVerify"},{"parameters":{"content":"# âš–ï¸ Aviso de Propriedade Intelectual & Suporte\n\nEste workflow e sua UI sÃ£o **propriedade intelectual** da EMKT Consultoria e Tecnologia, protegidos pelas Leis **9.610/98 (Direitos Autorais)**, **9.609/98 (Software)** e pela **LGPD â€“ 13.709/18**.\n---\n\n## Uso permitido\n- LicenÃ§a de **uso interno**, nÃ£o exclusiva e intransferÃ­vel.\n- Ã‰ vedada a **distribuiÃ§Ã£o**, **revenda**, **locaÃ§Ã£o**, **cessÃ£o**, **publicaÃ§Ã£o** ou **exposiÃ§Ã£o pÃºblica** (incl. repositÃ³rios/portais).\n\n## ProibiÃ§Ãµes\n- **CÃ³pia** total/parcial, **engenharia reversa**, **descompilaÃ§Ã£o**, **circunvenÃ§Ã£o** de proteÃ§Ãµes.\n- **ModificaÃ§Ãµes** nÃ£o autorizadas, criaÃ§Ã£o de **derivados** ou remoÃ§Ã£o de crÃ©ditos/identificaÃ§Ãµes.\n- **Compartilhamento** do pacote/fluxo, credenciais, URLs de webhook, telas ou prints com terceiros.\n\n## Suporte & Garantia\n- A **garantia de suporte** e atualizaÃ§Ãµes estÃ¡ **condicionada** Ã  manutenÃ§Ã£o do **estado original** do workflow.  \n- Qualquer **alteraÃ§Ã£o nÃ£o autorizada** (cÃ³digo, nÃ³s, credenciais, rotas, lÃ³gica ou layout) **invalida o suporte**.\n- AdequaÃ§Ãµes/integraÃ§Ãµes adicionais requerem **contrataÃ§Ã£o prÃ©via** e **autorizaÃ§Ã£o por escrito**.\n\n---\n\n### ðŸ“ž Contato\nPrecisa de ajuda? Fale conosco pelo WhatsApp Business  \n**(41) 9 8473-9797** â€” [abrir conversa](https://api.whatsapp.com/message/FVXDCWKJFIM4M1)  \n**(79) 9 9977-7712** â€” [abrir conversa](https://api.whatsapp.com/message/2G6M66MXFH7TD1)\n\n> DÃºvidas sobre uso, licenÃ§a ou autorizaÃ§Ã£o: contate a EMKT.\n","height":704,"width":2352,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-1040,320],"typeVersion":1,"id":"2f22778d-736b-47d1-9d21-6b71e7a7b25e","name":"Sticky Note14"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cef6a5a6-8219-4157-b619-78b9929ecc31","leftValue":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_created' &&\n  $('webhookDataChatwoot')?.item?.json?.body?.private !== true &&\n  !String($('webhookDataChatwoot')?.item?.json?.body?.source_id ?? '').trim()\n}}","rightValue":"message_created|message_updated","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"bf9dd4b4-6f2e-4628-ab0a-29f6b8b99c03","leftValue":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_updated' &&\n  $('webhookDataChatwoot')?.item?.json?.body?.content_attributes.deleted &&\n  $('webhookDataChatwoot')?.item?.json?.body?.message_type === 'outgoing'\n}}","rightValue":"messages","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-608,-704],"id":"5f8055b2-49a9-4314-88d2-eb12e3c7c01b","name":"messageTypeFilter"},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot?.account_id }}/contacts","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"},{"name":"Content-type","value":"application/json; charset=utf-8"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"name\": \"{{ $('normalizedData')?.item?.json?.data?.is_group ? $('normalizedData')?.item?.json?.group?.name : $('normalizedData')?.item?.json?.contact?.full_name }}\",\n  \"inbox_id\": {{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id }},\n  \"source_id\": \"{{ $('contactAction')?.item?.json?.identifier?.split('@')?.first() }}\",\n  \"phone_number\": \"{{ $('normalizedData')?.item?.json?.contact?.phone_number_new }}\",\n  \"identifier\": \"{{ $('contactAction')?.item?.json?.identifier_new }}\",\n  \"additional_attributes\": {\n    \"contact_lid\": \"{{ $('contactAction')?.item?.json?.contact_lid_new }}\"\n  }\n}\n","options":{"response":{"response":{"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,-784],"id":"19474722-86b2-4007-96d8-87ffbef0cf29","name":"contactCreate","retryOnFail":true,"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"23b01a4b-58a1-4256-b62f-373073a16840","name":"identifier","value":"={{ $('contactAction')?.item?.json?.identifier_new }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[800,-704],"id":"108f4e21-5aa0-4ef0-954d-075a98e4ec58","name":"contactIdentify","retryOnFail":true},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[240,-736],"typeVersion":1,"id":"0a027828-4bb1-437d-9600-47a69ee83c66","name":"Sticky Note15"},{"parameters":{"operation":"executeQuery","query":"WITH NormalizedInput AS (\n  SELECT\n    NULLIF($1, '') AS input_identifier,\n    NULLIF($2, '') AS input_lid,\n    NULLIF($3, '') AS input_full_name,\n    NULLIF($4, '') AS input_phone_number,\n    NULLIF($5, '')::integer AS input_account_id\n)\nSELECT\n  COALESCE(c.id, 0) AS contact_id,\n  COALESCE(c.identifier, '') AS identifier_old,\n  COALESCE(ni.input_identifier, '') AS identifier_new,\n  COALESCE(c.additional_attributes ->> 'contact_lid', '') AS contact_lid_old,\n  COALESCE(ni.input_lid, '') AS contact_lid_new,\n  COALESCE(c.name, '') AS name_old,\n  COALESCE(ni.input_full_name, '') AS name_new,\n  COALESCE(c.phone_number, '') AS phone_number_old,\n  COALESCE(ni.input_phone_number, '') AS phone_number_new,\n  CASE\n    WHEN c.id IS NULL THEN true\n    WHEN \n      (\n        COALESCE(c.identifier, '') != COALESCE(ni.input_identifier, '') OR\n        COALESCE(c.additional_attributes ->> 'contact_lid', '') != COALESCE(ni.input_lid, '') OR\n        COALESCE(c.phone_number, '') != COALESCE(ni.input_phone_number, '')\n      )\n    THEN true\n    WHEN \n      (\n        COALESCE(c.name, '') = 'Contato' AND\n        COALESCE(c.name, '') != COALESCE(ni.input_full_name, '')\n      )\n    THEN true\n    ELSE false\n  END AS update_data\nFROM\n  NormalizedInput AS ni\nLEFT JOIN\n  contacts AS c ON\n    (c.account_id = ni.input_account_id AND ni.input_account_id IS NOT NULL)\n    AND\n    (\n      (c.identifier = ni.input_identifier AND ni.input_identifier IS NOT NULL)\n      OR\n      (c.additional_attributes ->> 'contact_lid' = ni.input_lid AND ni.input_lid IS NOT NULL)\n      OR\n      (c.phone_number = ni.input_phone_number AND ni.input_phone_number IS NOT NULL)\n    );","options":{"queryReplacement":"={{ [\n  String((() => {\n    try {\n      const jid = $('contactVerify')?.item?.json?.jid;\n      if (jid) return jid;\n    } catch (e) {}\n    return $('normalizedData')?.item?.json?.contact?.identifier ?? '';\n  })()),\n  String((() => {\n    try {\n      const lid = $('contactVerify')?.item?.json?.lid;\n      if (lid) return lid;\n    } catch (e) {}\n    return $('normalizedData')?.item?.json.contact.lid ?? '';\n  })()),\n  String($('normalizedData')?.item?.json?.contact?.full_name ?? ''),\n  String($('normalizedData')?.item?.json?.contact?.phone_number ?? ''),\n  String($('normalizedData')?.item?.json?.chatwoot?.account_id ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[272,-704],"id":"6ebf668d-14d7-4434-86bb-2be1d2d33b39","name":"contactFind","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"contacts","mode":"list","cachedResultName":"contacts"},"columns":{"mappingMode":"defineBelow","value":{"identifier":"={{ $('contactAction')?.item?.json?.identifier_new }}","id":"={{ $('contactAction')?.item?.json?.contact_id }}","additional_attributes":"={{ ({ \"contact_lid\": $('contactAction')?.item?.json?.contact_lid_new }) }}","name":"={{\n(() => {\n  const data = $('contactAction')?.item?.json ?? {};\n  \n  const oldName = data?.name_old ?? '';\n  const newName = data?.name_new ?? '';\n  if (oldName === 'Contato') {\n    return newName;\n  }\n  return oldName;\n})()\n}}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"name","displayName":"name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"email","displayName":"email","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"phone_number","displayName":"phone_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"account_id","displayName":"account_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"additional_attributes","displayName":"additional_attributes","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":false},{"id":"identifier","displayName":"identifier","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"custom_attributes","displayName":"custom_attributes","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"last_activity_at","displayName":"last_activity_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"contact_type","displayName":"contact_type","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"middle_name","displayName":"middle_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_name","displayName":"last_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"location","displayName":"location","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"country_code","displayName":"country_code","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"blocked","displayName":"blocked","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":true},{"id":"company_id","displayName":"company_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[624,-624],"id":"d6ace460-cf31-41a7-b58a-2fff17893561","name":"contactUpdate","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[592,-656],"typeVersion":1,"id":"f3ccb207-17b4-445d-9ee9-9c23df12c735","name":"Sticky Note16"},{"parameters":{"content":"## Tratamento do Contato","height":424,"width":1380},"type":"n8n-nodes-base.stickyNote","position":[-288,-832],"typeVersion":1,"id":"93443949-84c8-427a-9ed3-8019b64a1958","name":"Sticky Note4"},{"parameters":{"content":"## Tratamento da Mensagem","height":712,"width":1908},"type":"n8n-nodes-base.stickyNote","position":[-816,-400],"typeVersion":1,"id":"7ccd3dc2-75d0-4a60-a49e-32c902a808ad","name":"Sticky Note5"},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.api?.base_url }}/chat/check","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('normalizedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"numbers\": [\n    \"{{ $('normalizedData')?.item?.json?.contact?.phone_number }}\"\n  ]\n}","options":{}},"id":"33569bdf-5c87-4290-a45a-f27e116fa0d1","name":"contactValidation","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-80,-624],"retryOnFail":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{\n  (\n    $('contactFind')?.item?.json ??\n    {}\n  )\n  .contact_id === 0\n}}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true},"id":"e71ede49-b811-46e9-be73-fcece40f27c8"}],"combinator":"and"},"renameOutput":true,"outputKey":"create"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"342366cd-05e8-4efe-b237-ccf032377806","leftValue":"={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data?.contact_id > 0);\n  const shouldUpdate = (data?.update_data !== true);\n  return contactIdExists && shouldUpdate;\n})()\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"exists"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7bcd700f-3396-4c45-953c-8b5bcdf1bbbe","leftValue":"={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data?.contact_id > 0);\n  const shouldUpdate = (data?.update_data === true);\n  return contactIdExists && shouldUpdate;\n})()\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"update"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[448,-720],"id":"93eac197-fc7f-48a4-8faa-4dd13b427348","name":"contactAction"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2ec9a8fb-a140-4361-80c0-8d8f797bf409","leftValue":"={{ $('contactValidation')?.item?.json?.isInWhatsapp }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[96,-624],"id":"8e3cd16c-6d20-4758-8e11-f1873d951540","name":"contactVerify"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"342366cd-05e8-4efe-b237-ccf032377806","leftValue":"={{ $('normalizedData')?.item?.json?.contact?.identifier?.split('@').last() }}","rightValue":"g.us","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"group"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('normalizedData')?.item?.json?.contact?.identifier?.split('@').last() }}","rightValue":"s.whatsapp.net","operator":{"type":"string","operation":"equals"},"id":"e71ede49-b811-46e9-be73-fcece40f27c8"}],"combinator":"and"},"renameOutput":true,"outputKey":"jid"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7bcd700f-3396-4c45-953c-8b5bcdf1bbbe","leftValue":"={{ $('normalizedData')?.item?.json?.contact?.identifier?.split('@').last() }}","rightValue":"lid","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"lid"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-256,-736],"id":"3a991b39-e9b3-4c04-a0e3-0cb3b733ca62","name":"identifierVerify"},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('normalizedData')?.item?.json?.data?.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{\n(() => {\n  // 1. Pega os dados do contato de forma segura\n  const contact = $('normalizedData')?.item?.json?.contact ?? {};\n  \n  // 2. Extrai os dados (com fallback para 'N/A' se estiverem vazios)\n  const name = contact.full_name || 'N/A';\n  const phone = contact.phone_number || 'N/A';\n\n  // 3. Monta o card de erro formatado\n  const card = [];\n  \n  // TÃ­tulo sugestivo com emoji\n  card.push(`âŒ **Falha ao Enviar: Contato InvÃ¡lido**`);\n  card.push(`\\n---\\n`);\n  card.push(`NÃ£o foi possÃ­vel enviar a mensagem. O contato abaixo parece ter um nÃºmero de WhatsApp invÃ¡lido ou inexistente.`);\n  \n  // InformaÃ§Ãµes (sem o identifier)\n  card.push(`\\n**Nome:** ${name}`);\n  card.push(`**Telefone:** ${phone}`);\n  card.push(`\\n---\\n`);\n  \n  // Texto final com a instruÃ§Ã£o\n  card.push(`_**AÃ§Ã£o Recomendada:** Verifique se o nÃºmero de telefone estÃ¡ correto (incluindo DDI + DDD), ajuste o cadastro do contato e tente enviar a mensagem novamente._`);\n\n  return card.join('\\n');\n})()\n}}"},{"name":"message_type","value":"=incoming"},{"name":"source_id","value":"={{ $('normalizedData').item.json.data.message_id }}"},{"name":"private","value":"={{ true }}"}]},"options":{}},"id":"a16131ab-fc38-4564-9fe9-c2e8dad94823","name":"contactMessage","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[272,-544],"retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.api?.base_url }}/send/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('normalizedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"number\": \"{{ $('processedData')?.item?.json?.contact?.identifier }}\",\n  \"text\": \"{{ ((\n               $('processedData')?.item?.json?.integration?.sign_messages_mode !== 'none' &&\n               $('processedData')?.item?.json?.data?.sender\n             )\n             ? (\n                 '*' +\n                 ( $('processedData')?.item?.json?.data?.sender ?? '' ) +\n                 ':*' +\n                 ( $('processedData')?.item?.json?.integration?.sign_delimiter ?? '\\\\n' )\n               )\n             : ''\n           ) +\n           String($('processedData')?.item?.json?.data?.content ?? '')\n             .replace(/\\\\n/g, '\\\\n')\n  }}\",\n  \"replyid\": \"{{\n                $('processedData')?.item?.json?.chatwoot?.reply_messages === true &&\n                String($('processedData')?.item?.json?.data?.reply_id ?? '')\n                  .trim()\n                  .length > 0\n                ? $('processedData')?.item?.json?.data?.reply_id\n                : ''\n              }}\",\n  \"track_id\": \"{{\n                 `${$('getVariables')?.item?.json?.chatwoot_track_id ?? ''}` +\n                 '-' +\n                 `${String($('getVariables')?.item?.json?.chatwoot_account_id ?? '').padStart(4,'0')}` +\n                 '-' +\n                 `${String($('getVariables')?.item?.json?.chatwoot_inbox_id ?? '').padStart(4,'0')}`\n               }}\",\n  \"track_source\": \"chatwoot\"\n}","options":{"response":{"response":{}}}},"id":"7eef82ae-ea63-4721-9d45-ede16f2d8149","name":"messageTextSend","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-256,-368],"retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.api.base_url }}/send/media","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('processedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"number\": \"{{ $('processedData')?.item?.json?.contact?.identifier }}\",\n  \"text\": \"{{ (( $('processedData')?.item?.json?.integration?.sign_messages_mode !== 'none' &&\n               $('processedData')?.item?.json?.data?.sender )\n               ? ('*' + ( $('processedData')?.item?.json?.data?.sender ?? '' ) + \n                 ':*' + ( $('processedData')?.item?.json?.integration?.sign_delimiter ?? '\\\\n' ))\n               : '' ) +\n             String($('messageMediaFields')?.item?.json?.data?.content ?? '')\n               .replace(/\\n/g,'\\\\n')\n           }}\",\n  \"replyid\": \"{{\n    $('processedData')?.item?.json?.chatwoot?.reply_messages === true &&\n    String($('processedData')?.item?.json?.data?.reply_id ?? '')\n      .trim()\n      .length > 0\n      ? $('processedData')?.item?.json?.data?.reply_id\n      : ''\n  }}\",\n  \"type\": \"{{ $('messageMediaFields')?.item?.json?.type }}\",\n  \"file\": \"{{ $('messageMediaFields')?.item?.json?.url }}\",\n  \"docName\": \"{{ $('messageMediaFields')?.item?.json?.filename }}\",\n  \"track_id\": \"{{\n    `${$('getVariables')?.item?.json?.chatwoot_track_id ?? ''}` +\n    '-' +\n    `${String($('getVariables')?.item?.json?.chatwoot_account_id ?? '').padStart(4, '0')}` +\n    '-' +\n    `${String($('getVariables')?.item?.json?.chatwoot_inbox_id ?? '').padStart(4, '0')}`\n  }}\",\n  \"track_source\": \"chatwoot\"\n}\n","options":{}},"id":"8f00cb76-0b18-437b-b32e-a82449960d1b","name":"messageMediaSend","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[272,-128],"retryOnFail":true},{"parameters":{"assignments":{"assignments":[{"id":"77c8dae6-2659-438d-b2ac-7b8d5a256165","name":"url","value":"={{ $('messageMediaLoop')?.item?.json?.currentAttachment?.data_url }}","type":"string"},{"id":"eaa9ebf4-e2af-4926-b821-100da4776575","name":"filename","value":"={{ $('messageMediaLoop')?.item?.json?.currentAttachment?.filename }}","type":"string"},{"id":"6668f3d0-2066-43ac-ba7b-b905c3d6fbc0","name":"type","value":"={{ $('messageMediaLoop')?.item?.json?.currentAttachment?.file_type }}","type":"string"},{"id":"9c331318-54a8-4bef-8ac3-bd23482c5bed","name":"mimeType","value":"={{ \n  (() => {\n    const type = $('messageMediaLoop')?.item?.json?.currentAttachment?.filename.split('.').last();\n    switch (type) {\n      case 'doc': return 'application/msword';\n      case 'docx': return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n      case 'jpeg': return 'image/jpeg';\n      case 'jpg': return 'image/jpeg';\n      case 'mp3': return 'audio/ogg; codecs=opus';\n      case 'mp4': return 'video/mp4';\n      case 'ogg': return 'audio/ogg; codecs=opus';\n      case 'pdf': return 'application/pdf';\n      case 'pfx': return 'application/x-pkcs12';\n      case 'png': return 'image/png';\n      case 'rar': return 'application/vnd.rar';\n      case 'xls': return 'application/vnd.ms-excel';\n      case 'xlsx': return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n      case 'zip': return 'application/zip';\n      default: return 'application/octet-stream';\n    }\n  })()\n}}","type":"string"},{"id":"f8e63388-2dc7-4905-82d5-d77f82b6e4e2","name":"data.content","value":"={{ \n  $('messageMediaLoop')?.item?.json?.currentAttachment?.content ??\n  ''\n}}","type":"string"},{"id":"78c3514c-ec46-4f05-a5c3-86fc31e79122","name":"item","value":"={{\n  $('messageMediaLoop')?.item?.json?.currentAttachment?.item ??\n  ''\n}}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[96,-128],"id":"c42bc997-d1ed-4365-bf78-c53455a9f74c","name":"messageMediaFields"},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id || $('processedData')?.item?.json?.data?.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"=attachments[]","inputDataFieldName":"data"},{"name":"message_type","value":"={{ $('processedData')?.item?.json?.data?.direction }}"},{"name":"source_id","value":"={{ $('messageMediaSend')?.item?.json?.messageid }}"}]},"options":{}},"id":"05ce5bf1-efe7-4e57-a199-43c72ada223b","name":"createMessageInChatwoot","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[800,-208],"retryOnFail":true},{"parameters":{"url":"={{ $('messageMediaFields')?.item?.json?.url }}","options":{"response":{"response":{"neverError":true,"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,-208],"id":"475d9be5-7437-4cbf-bcb8-7ba644471bae","name":"messageMediaDownload","retryOnFail":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"16c3d6c6-556b-4ba0-abc3-406f76b662d0","leftValue":"={{ $('messageMediaFields')?.item?.json?.item }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[448,-128],"id":"1df5dd05-2da7-45b9-b27c-17f4b3f7aee5","name":"messageMediaVerify"},{"parameters":{"operation":"executeQuery","query":"WITH updated AS (\n  UPDATE public.messages\n  SET source_id = $1\n  WHERE id = $2::integer\n  RETURNING id, source_id\n)\nSELECT\n  (SELECT COUNT(*) FROM updated) AS rows_affected,\n  (SELECT source_id FROM updated LIMIT 1) AS source_id;","options":{"queryReplacement":"={{ [\n  String($json?.messageid ?? ''),\n  String($('processedData')?.item?.json?.data?.message_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[976,-208],"id":"29e302f1-4d1d-4d27-936c-8ea3af88c45a","name":"messageMediaUpdate","alwaysOutputData":true,"executeOnce":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"operation":"executeQuery","query":"WITH updated AS (\n  UPDATE public.messages\n  SET source_id = $1\n  WHERE id = $2::integer\n  RETURNING id, source_id\n)\nSELECT\n  (SELECT COUNT(*) FROM updated) AS rows_affected,\n  (SELECT source_id FROM updated LIMIT 1) AS source_id;","options":{"queryReplacement":"={{ [\n  String($json?.messageid ?? $('messageMediaLoop')?.item?.json?.messageid ?? ''),\n  String($('processedData')?.item?.json?.data.message_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[272,-368],"id":"85dfdfb9-01f8-400a-a093-dc1460b9d4d0","name":"messageTextUpdate","alwaysOutputData":true,"executeOnce":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"assignments":{"assignments":[{"id":"fc173b4d-2b51-446a-a545-36fe4fc3f9e9","name":"chatwoot","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:        s.chatwoot_base_url,\n    api_version:     s.chatwoot_api_version,\n    token:           s.chatwoot_token,\n    account_id:      s.chatwoot_account_id,\n    inbox_id:        s.chatwoot_inbox_id,\n    inbox_name:      s.chatwoot_inbox_name,\n    track_id:        s.chatwoot_track_id,\n    reply_messages:  s.reply_messages,\n    edit_messages:   s.edit_messages,\n    delete_messages: s.delete_messages\n  };\n})() }}","type":"object"},{"id":"365992ef-324c-45f6-8770-032326a3467e","name":"api","value":"={{ $('normalizedData')?.item?.json?.api }}","type":"object"},{"id":"f9308e51-fcdd-4475-9d60-78546896588d","name":"integration","value":"={{ $('normalizedData')?.item?.json?.integration }}","type":"object"},{"id":"cb473388-9aaf-46a8-86fe-c9c37776ed65","name":"contact","value":"={{ $('normalizedData')?.item?.json?.contact }}","type":"object"},{"id":"7cef8d6a-13c6-4c6b-bcf1-81e60a5a1d37","name":"data","value":"={{ $('normalizedData').item?.json?.data }}","type":"object"},{"id":"fed18daf-ce00-4acf-b20d-b57a4a366939","name":"contact.identifier","value":"={{ $('contactIdentify')?.item?.json?.identifier ?? '' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-784,-96],"id":"0e5c8759-4670-409a-a84f-c95acdb2bc69","name":"processedData"},{"parameters":{"assignments":{"assignments":[{"id":"37609540-0631-4eb3-808b-a2b20f1b90a2","name":"chatwoot","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:   s.chatwoot_base_url,\n    api_version:s.chatwoot_api_version,\n    token:      s.chatwoot_token,\n    account_id: s.chatwoot_account_id,\n    inbox_id:   s.chatwoot_inbox_id,\n    inbox_name: s.chatwoot_inbox_name,\n    track_id:   s.chatwoot_track_id,\n  };\n})() }}","type":"object"},{"id":"84596df0-c964-4e49-b538-07f44c2957d9","name":"api","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:          s.api_base_url,\n    token:             s.api_token,\n    api_instance_name: s.api_instance_name,\n  };\n})() }}","type":"object"},{"id":"4260e205-91f4-4f15-9263-27bdcd4e29d1","name":"integration","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json ?? {};\n  return {\n    ignore_groups:        s.ignore_groups ?? false,\n    reply_messages:       s.reply_messages ?? false,\n    edit_messages:        s.edit_messages ?? false,\n    delete_messages:      s.delete_messages ?? false,\n    reopen_conversation:  s.reopen_conversation ?? false,\n    conversation_pending: s.conversation_pending ?? false,\n    import_contacts:      s.import_contacts ?? false,\n    import_messages:      s.import_messages ?? false,\n    import_days_limit:    s.import_days_limit ?? 0,\n    sign_messages:        s.sign_messages ?? false,\n    sign_delimiter:       s.sign_delimiter ?? ''\n  };\n})() }}","type":"object"},{"id":"92edb1f3-4c01-43c1-ab66-5bae3b88272a","name":"contact.contact_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.contact_inbox?.contact_id ??\n  0\n}}","type":"number"},{"id":"e058c51f-71a0-43f3-8cae-448a8c1ccfb2","name":"contact.identifier","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.identifier ??\n  ''\n}}","type":"string"},{"id":"bd2a4034-caa8-4a5e-96dc-1d44dd6dc107","name":"contact.lid","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.sender?.additional_attributes?.contact_lid ??\n  ''\n}}","type":"string"},{"id":"5c9147af-3eba-4ca4-9112-205261f7a4cc","name":"contact.phone_number","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.phone_number ??\n  ''\n}}","type":"string"},{"id":"4832617f-aafc-4cbf-8fa5-e2502deb7143","name":"contact.full_name","value":"={{\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation?.meta?.sender?.name ||\n    ''\n  )\n  .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n  .trim()\n  ||\n  'Contato'\n}}","type":"string"},{"id":"4a7df58d-d6f7-42ba-a09d-5b04910c0555","name":"contact.first_name","value":"={{\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.name ||\n    ''\n  )\n  .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n  .trim()\n  .split(/\\s+/)[0] ||\n  'Contato'\n}}","type":"string"},{"id":"feb8da01-d39a-4571-a215-c93f838b1cd6","name":"contact.middle_name","value":"={{ \n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.name ||\n    ''\n  )\n  .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n  .trim()\n  .split(/\\s+/)\n  .slice(1, -1)\n  .join(' ') ||\n  ''\n}}","type":"string"},{"id":"13f61b17-5053-42d7-a613-ac7ab0cfabc3","name":"contact.last_name","value":"={{ \n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.name ||\n    ''\n  )\n  .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n  .trim()\n  .split(/\\s+/)\n  .slice(-1)[0] ||\n  ''\n}}","type":"string"},{"id":"23e6b810-0252-4617-bf33-5ef2a8bdb715","name":"data.message_type","value":"={{ \n  $('webhookDataChatwoot')?.item?.json.body?.conversation.messages?.[0]?.content_type ??\n  ''\n}}","type":"string"},{"id":"cfba5c5e-18cf-4f29-9840-561c1f5a2be8","name":"data.content","value":"={{\n(() => {\n  const b = $('webhookDataChatwoot')?.item?.json?.body ?? {};\n  const isCsat =\n    b.content_attributes?.content_type === 'input_csat' ||\n    b.content_type === 'input_csat';\n\n  // 1. Pega o texto original do Chatwoot\n  const txt = isCsat\n    ? b.content\n    : (b.conversation?.messages?.[0]?.content ?? '');\n\n  // 2. Inicia a cadeia de limpeza e conversÃ£o\n  const convertedTxt = String(txt)\n    // =================================================================\n    // 2.1. BLOCO DE LIMPEZA DE CARACTERES\n    // Remove caracteres invisÃ­veis e normaliza espaÃ§os/quebras de linha\n    // ANTES de aplicar a lÃ³gica de Markdown.\n    // =================================================================\n    \n    // (REMOVER) Caracteres de controle obsoletos\n    .replace(/\\t/g, ' ')    // TabulaÃ§Ã£o Horizontal\n    .replace(/\\v/g, '')     // TabulaÃ§Ã£o Vertical\n    .replace(/\\f/g, '')     // Form Feed (quebra de pÃ¡gina)\n    \n    // (REMOVER) Caracteres \"invisÃ­veis\" comuns de copy-paste\n    .replace(/\\u200B/g, '') // Zero-Width Space\n    .replace(/\\uFEFF/g, '') // Byte Order Mark (BOM)\n    \n    // (NORMALIZAR) Quebras de linha (Windows/Mac -> Unix)\n    // Converte \\r\\n (Windows) e \\r (Mac) para \\n (Unix)\n    // Isso simplifica a conversÃ£o de markdown e o escape final.\n    .replace(/\\r\\n/g, '\\n')\n    .replace(/\\r/g, '\\n')\n        \n    // (NORMALIZAR) EspaÃ§os \"falsos\"\n    // Converte o \"Non-Breaking Space\" (comum em HTML/Word) \n    // para um espaÃ§o comum.\n    .replace(/\\u00A0/g, ' ') \n    \n    // =================================================================\n    // 2.2. BLOCO DE CONVERSÃƒO MARKDOWN (Chatwoot -> WhatsApp)\n    // A ordem aqui Ã© crucial para evitar conflitos.\n    // =================================================================\n    \n    // Links: [Texto do Link](url) -> Texto do Link (url)\n    // O WhatsApp nÃ£o suporta links mascarados, entÃ£o \"desmontamos\" eles.\n    .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '$1 ($2)')\n    \n    // Negrito (Chatwoot -> Marcador TemporÃ¡rio): **texto** -> @@BOLD@@texto@@BOLD@@\n    // Usamos um marcador para nÃ£o conflitar com o itÃ¡lico.\n    .replace(/\\*\\*(.*?)\\*\\*/g, '@@BOLD@@$1@@BOLD@@')\n    \n    // ItÃ¡lico (Chatwoot -> WhatsApp): *texto* -> _texto_\n    // Agora podemos converter o itÃ¡lico sem medo.\n    .replace(/\\*(.*?)\\*/g, '_$1_')\n    \n    // Riscado (Chatwoot -> WhatsApp): ~~texto~~ -> ~texto~\n    .replace(/~~(.*?)~~/g, '~$1~')\n    \n    // CÃ³digo (Chatwoot -> WhatsApp): `texto` -> ```texto```\n    // Converte o \"cÃ³digo\" inline do Chatwoot para o \"monoespaÃ§ado\" do WhatsApp.\n    .replace(/`(.*?)`/g, '```$1```')\n    \n    // Finaliza o Negrito (Marcador TemporÃ¡rio -> WhatsApp): @@BOLD@@ -> *\n    // Agora convertemos nosso marcador para o formato final do WhatsApp.\n    .replace(/@@BOLD@@/g, '*');\n\n  // =================================================================\n  // 3. BLOCO DE ESCAPE PARA JSON\n  // Prepara o texto final para ser inserido em um campo JSON.\n  // =================================================================\n  return convertedTxt\n    // 3.1. Escapa barras invertidas (deve ser o PRIMEIRO)\n    .replace(/\\\\/g, '\\\\\\\\')\n    \n    // 3.2. Escapa quebras de linha (agora sÃ³ temos \\n graÃ§as Ã  normalizaÃ§Ã£o)\n    .replace(/\\n/g, '\\\\n')\n    \n    // 3.3. Escapa aspas duplas\n    .replace(/\"/g, '\\\\\"');\n})()\n}}","type":"string"},{"id":"e4dd23d8-5edd-47b1-8cd6-6781e3d3cd8f","name":"data.direction","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.message_type ??\n  ''\n}}","type":"string"},{"id":"6d663b17-95eb-43bd-ab52-7ba010c5c5a9","name":"data.conversation_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.id ||\n  0\n}}","type":"number"},{"id":"53ee35f4-904a-4ba4-822c-9121e9a7a37a","name":"data.sender","value":"={{ (() => {\n  const mode = $('getVariables')?.item?.json?.sign_messages_mode\n  const assignee = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.meta?.assignee;\n  const sender = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.sender;\n  let signatureName = '';\n  if (mode === 'assigned_name' && assignee) {\n    signatureName = assignee.name || '';\n  } else if (mode === 'assigned_display_name' && assignee) {\n    signatureName = assignee.available_name || assignee.name || '';\n  } else if (mode === 'logged_name' && sender) {\n    signatureName = sender.name || '';\n  } else if (mode === 'logged_display_name' && sender) {\n    signatureName = sender.available_name || sender.name || '';\n  } else {\n    signatureName = '';\n  }\n  return signatureName;\n})() }}","type":"string"},{"id":"e1ec8f48-5b4f-4a89-8959-81673f82c33d","name":"data.message_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.id ??\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.messages?.[0]?.id ??\n  0\n}}","type":"number"},{"id":"f69ec58f-0da7-45b7-b627-2dc82fc80710","name":"data.source_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.source_id ??\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.source_id ??\n  ''\n}}","type":"string"},{"id":"9d2180ef-94d4-40cf-90df-e073d84bbf3b","name":"data.reply_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.content_attributes?.in_reply_to_external_id ??\n  ''\n}}","type":"string"},{"id":"e583d428-c4a5-4342-b898-5491fabd52cc","name":"data.status","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation?.status ??\n  ''\n}}","type":"string"},{"id":"f27ee0aa-d24e-4660-bd9e-387c1791a9a9","name":"data.event_type","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event ??\n  ''\n}}","type":"string"},{"id":"f5b05f21-2a5a-4761-ad6e-6bd7073f422f","name":"data.attachments","value":"={{(() => {\n  const attachments = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.attachments ?? [];\n  \n  // Se nÃ£o houver anexos, retorna um array vazio\n  if (attachments.length === 0) return [];\n\n  // Mapeia todos os attachments do Chatwoot\n  return attachments.map((att, index) => ({\n    data_url: att.data_url,\n    file_type: att.file_type.replace('file','document').replace('audio','ptt'),\n    filename: decodeURIComponent(att.data_url?.split('/')?.pop() ?? 'file'),\n  }));\n})()}}","type":"array"},{"id":"6ede662e-f7fb-415b-ad12-d6792eda567b","name":"data.created_at","value":"={{(() => {\n  const ts = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.created_at;\n  if (!ts) return null; // Evita erro se o valor nÃ£o existir\n  const timestamp = Number(ts) * 1000; // Converte de segundos para milissegundos\n  return new Date(timestamp).toISOString();\n})()}}","type":"string"}]},"options":{}},"id":"50cf6c8a-02d8-4209-98ad-92b14a62f78a","name":"normalizedData","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-432,-704],"retryOnFail":true},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[240,-400],"typeVersion":1,"id":"89b4dbe1-8ace-418f-afc3-043a70589d85","name":"Sticky Note12"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[944,-240],"typeVersion":1,"id":"80bfed3a-ed12-4e83-b833-ce3316baadf9","name":"Sticky Note13"},{"parameters":{"jsCode":"const item = $('processedData')?.first()?.json;\n\n// Extrai o array de attachments do item atual\nconst attachmentsArray = item?.data?.attachments ?? [];\n\nreturn attachmentsArray.map((att, index) => ({\n  currentAttachment: {\n    data_url: att.data_url,\n    file_type: att.file_type,\n    filename: att.filename,\n    content: index === 0 ? $input?.first()?.json?.data.content : '',\n    item: index\n  },\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-256,-208],"id":"b3c3cb65-f4e0-444e-ad7f-546c5241487f","name":"messageMediaSplit"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-80,-208],"id":"b460aef0-674f-4e69-b321-3764c86942c8","name":"messageMediaLoop"},{"parameters":{"operation":"executeQuery","query":"WITH deleted_attachments AS (\n  DELETE FROM attachments\n  WHERE message_id = $1::integer\n  AND id != (\n      SELECT MIN(id)\n      FROM attachments\n      WHERE message_id = $1::integer\n  )\n  RETURNING id\n)\nSELECT COUNT(*) AS total_attachments_removed\nFROM deleted_attachments;","options":{"queryReplacement":"={{ [\n  String($('processedData')?.item?.json?.data?.message_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[96,-288],"id":"a63a39ed-14e1-486a-aa14-d52b2b2268dc","name":"messageMediaRemove","executeOnce":true,"alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.api?.base_url }}/message/find","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('normalizedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"number\": \"{{ $('normalizedData')?.item?.json?.contact?.identifier }}\",\n  \"id\": \"{{ $('processedData')?.item?.json?.data?.source_id }}\"\n}","options":{}},"id":"029c7f68-efd0-496a-b1a7-71c9c805c25b","name":"messageDeletedFind","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-432,160],"retryOnFail":true},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Pega o item atual\nconst item = $input?.item;\nconst root = item.json ?? {};\nconst msg  = root.messages?.[0] ?? {};\nconst c    = msg.content ?? {};\n\n// =================================================================\n// 1. FUNÃ‡ÃƒO AUXILIAR: ConversÃ£o de Markdown (WhatsApp -> Chatwoot)\n// =================================================================\nconst convertMarkdown = (text) => {\n  if (typeof text !== 'string' || !text) {\n    return '';\n  }\n\n  return text\n    // --- LIMPEZA ---\n    .replace(/\\t/g, ' ')\n    .replace(/\\v/g, '')\n    .replace(/\\f/g, '')\n    .replace(/\\u200B/g, '')\n    .replace(/\\uFEFF/g, '')\n    .replace(/\\r/g, '')\n    .replace(/\\u00A0/g, ' ')\n    // --- CONVERSÃƒO MARKDOWN ---\n    .replace(/```(.*?)```/gs, '`$1`') // MonoespaÃ§ado\n    .replace(/\\*(.*?)\\*/gs, '**$1**') // Negrito\n    .replace(/_(.*?)_/gs, '*$1*')     // ItÃ¡lico\n    .replace(/~(.*?)~/gs, '~~$1~~');  // Riscado\n};\n\n// =================================================================\n// 2. FUNÃ‡ÃƒO AUXILIAR: FormataÃ§Ã£o de Moeda\n// =================================================================\nconst formatCurrency = (value, offset, currencyCode = 'BRL') => {\n  if (value === undefined || value === null) return '';\n\n  const divisor   = offset || 1000;\n  const realValue = value / divisor;\n\n  if (realValue === 0) return 'Valor a ser definido';\n\n  try {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: currencyCode,\n    }).format(realValue);\n  } catch (e) {\n    return `${currencyCode} ${realValue.toFixed(2)}`;\n  }\n};\n\n// =================================================================\n// 3. FORMATTERS (BOTÃ•ES, LISTAS, ENQUETE, CONTATO, ETC.)\n// =================================================================\nconst formatters = {\n  // BotÃµes\n  buttons: () => {\n    const header = convertMarkdown(c?.header?.title ?? '');\n    const body   = convertMarkdown(c?.body?.text ?? '');\n    const footer = convertMarkdown(c?.footer?.text ?? '');\n    \n    const buttonsArray = c?.InteractiveMessage?.NativeFlowMessage?.buttons ?? [];\n    \n    const options = buttonsArray.map(btn => {\n      let params;\n      try {\n        params = JSON.parse(btn.buttonParamsJSON ?? '{}');\n      } catch (e) {\n        params = {};\n      }\n\n      const text = convertMarkdown(params.display_text ?? 'BotÃ£o');\n\n      if (btn.name === 'cta_url' && params.url) {\n        return `* [${text}](${params.url}) ðŸ”—`;\n      }\n      \n      if (btn.name === 'cta_call' && params.phone_number) {\n        return `* ${text} (${params.phone_number}) ðŸ“ž`;\n      }\n      \n      return `* ${text}`;\n    }).join('\\n');\n\n    const direction   = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸ”˜ _Mensagem com BotÃµes (${direction}):_`;\n    const tipFooter   = !msg.fromMe\n      ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`\n      : '';\n\n    return `${headerTitle}\\n\\n---\\n\\n${header}\\n\\n${body}\\n\\n${footer}\\n\\n${options}${tipFooter}`;\n  },\n\n  // Listas\n  list: () => {\n    const direction   = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸ“‹ _Mensagem com Lista (${direction}):_`;\n    const tipFooter   = !msg.fromMe\n      ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`\n      : '';\n\n    const description = convertMarkdown(c?.description ?? 'Lista');\n    const footer      = convertMarkdown(c?.footerText ?? '');\n    const button      = convertMarkdown(c?.buttonText ?? '');\n    const sections    = c?.sections ?? [];\n\n    const options = sections.map(section => {\n      const sectionTitle = `\\n**${convertMarkdown(section.title ?? 'SeÃ§Ã£o')}**`;\n      \n      const rows = (section.rows ?? []).map(row => {\n        const rowTitle = convertMarkdown(row.title ?? 'OpÃ§Ã£o');\n        const rowDesc  = convertMarkdown(row.description ?? '');\n        \n        if (rowDesc) {\n          return `* **${rowTitle}** - _${rowDesc}_`;\n        }\n        return `* **${rowTitle}**`;\n      }).join('\\n');\n      \n      return `${sectionTitle}\\n${rows}`;\n    }).join('\\n');\n\n    return `${headerTitle}\\n\\n---\\n\\n` +\n           `**${description}**\\n\\n` +\n           `*Texto do BotÃ£o:* ${button}\\n` +\n           `${options}\\n\\n` +\n           `_${footer}_` +\n           `${tipFooter}`;\n  },\n\n  // Enquetes\n  poll: () => {\n    const pollData = c?.pollCreationMessageV3 ?? c?.pollCreationMessage;\n    if (!pollData) return 'Erro ao processar enquete.';\n\n    const question = convertMarkdown(pollData.name ?? 'Enquete');\n    \n    const options = (pollData.options ?? [])\n      .map((opt, index) => {\n        const optionText = convertMarkdown(opt.optionName ?? 'OpÃ§Ã£o');\n        return `${index + 1}. ${optionText}`;\n      })\n      .join('\\n'); \n\n    const count  = pollData.selectableOptionsCount ?? 0;\n    const footer = (count === 0)\n      ? `_(Permitido votar em mÃºltiplas opÃ§Ãµes)_`\n      : `_(Permitido votar em ${count} opÃ§Ã£o${count > 1 ? 's' : ''})_`;\n\n    const direction   = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸ“Š _Enquete ${direction}:_`;\n    \n    const tipFooter = !msg.fromMe\n      ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`\n      : '';\n\n    return `${headerTitle}\\n\\n---\\n\\n**${question}**\\n\\n${options}\\n\\n${footer}${tipFooter}`;\n  },\n\n  // Contatos (vCard Ãºnico ou mÃºltiplo)\n  contacts: () => {\n    const parseVCard = (vcardString, displayName) => {\n      const getVCardField = (field) => {\n        const match = vcardString.match(new RegExp(`^${field}(?:;.*)?:([^\\\\n\\\\r]+)`, 'm'));\n        return match && match[1] ? match[1].replace(/;$/, '').trim() : null;\n      };\n      const getVCardPhones = () => {\n        const phoneMatches = [...vcardString.matchAll(/TEL.*:([^\\n\\\\r]+)/g)];\n        return phoneMatches.map(match => match[1].trim());\n      };\n\n      const name   = convertMarkdown(displayName ?? 'Contato');\n      const org    = getVCardField('ORG');\n      const email  = getVCardField('EMAIL');\n      const url    = getVCardField('URL');\n      const phones = getVCardPhones();\n\n      const card = [`**${name}**`];\n      if (org)   card.push(`ðŸ¢ ${convertMarkdown(org)}`);\n      phones.forEach(phone => card.push(`ðŸ“ž ${convertMarkdown(phone)}`));\n      if (email) card.push(`ðŸ“§ ${convertMarkdown(email)}`);\n      if (url)   card.push(`ðŸŒ [${convertMarkdown(url)}](${url})`);\n\n      return card.join('\\n');\n    };\n\n    let vcards = [];\n\n    if (msg.messageType === 'ContactsArrayMessage') {\n      const contactsArray = c.contacts ?? [];\n      vcards = contactsArray.map(contact =>\n        parseVCard(contact.vcard, contact.displayName)\n      );\n    } else if (msg.messageType === 'ContactMessage') {\n      vcards = [parseVCard(c.vcard ?? '', c.displayName ?? 'Contato')];\n    }\n\n    if (vcards.length === 0) return 'Erro ao processar contato.';\n\n    const count = vcards.length;\n    const title = count > 1 ? 'Contatos' : 'Contato';\n    let headerTitle;\n\n    if (msg.fromMe) {\n      headerTitle = `ðŸ‘¤ _${title} Enviado${count > 1 ? 's' : ''}:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ‘¤ _${title} Recebido${count > 1 ? 's' : ''}_ (de **${senderName}**):`;\n    }\n\n    return `${headerTitle}\\n\\n---\\n\\n${vcards.join('\\n\\n---\\n\\n')}`;\n  },\n\n  // Evento (Agendamento)\n  event: () => {\n    const name        = convertMarkdown(c?.name ?? 'Evento');\n    const description = convertMarkdown(c?.description ?? '');\n    const location    = convertMarkdown(c?.location?.name ?? '');\n    const joinLink    = c?.joinLink ?? '';\n\n    const formatTimestamp = (timestamp) => {\n      if (!timestamp || timestamp === 0) return null;\n      const date = new Date(timestamp * 1000);\n      return date.toLocaleString('pt-BR', {\n        day: '2-digit', month: '2-digit', year: 'numeric',\n        hour: '2-digit', minute: '2-digit',\n        timeZone: 'America/Sao_Paulo'\n      });\n    };\n\n    const formattedStartTime = formatTimestamp(c?.startTime);\n    const formattedEndTime   = formatTimestamp(c?.endTime);\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ“† _Evento Criado:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ“† _Evento Recebido_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n\\n**${name}**`];\n\n    if (description) card.push(`*${description}*`);\n\n    const details = [];\n    if (formattedStartTime) details.push(`ðŸ“† **InÃ­cio:** ${formattedStartTime}`);\n    if (formattedEndTime)   details.push(`ðŸ“† **Fim:** ${formattedEndTime}`);\n    if (location)           details.push(`ðŸ“ **Local:** ${location}`);\n\n    if (joinLink) {\n      if (joinLink.includes('/video/')) {\n        details.push(`ðŸ“¹ [Entrar na Chamada de VÃ­deo](${joinLink})`);\n      } else if (joinLink.includes('/audio/') || joinLink.includes('/voice/')) {\n        details.push(`ðŸ“ž [Entrar na Chamada de Voz](${joinLink})`);\n      } else {\n        details.push(`ðŸ”— [Link para o Evento](${joinLink})`);\n      }\n    }\n\n    if (details.length > 0) {\n      card.push(`\\n${details.join('\\n')}`);\n    }\n\n    if (c?.isCanceled === true) {\n      card.push(`\\n\\n**-- EVENTO CANCELADO --**`);\n    }\n\n    return card.join('\\n');\n  },\n\n  // Produtos\n  product: () => {\n    const product = c?.product;\n    if (!product) return 'Erro ao processar produto.';\n\n    const title       = convertMarkdown(product.title ?? 'Produto');\n    const description = convertMarkdown(product.description ?? '');\n    const productLink = product.URL ?? '';\n    const imageURL    = product.productImage?.URL ?? '';\n\n    const currency   = product.currencyCode ?? 'BRL';\n    const price      = formatCurrency(product.priceAmount1000,     1000, currency);\n    const salePrice  = formatCurrency(product.salePriceAmount1000, 1000, currency);\n    \n    let priceString = '';\n    if (salePrice && salePrice !== 'Valor a ser definido') {\n      priceString = `\\n**${salePrice}** (de ~~${price}~~)`;\n    } else if (price && price !== 'Valor a ser definido') {\n      priceString = `\\n**${price}**`;\n    }\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ›’ _Produto Enviado:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ›’ _Produto Recebido_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    if (imageURL) card.push(`![Imagem do Produto](${imageURL})\\n`);\n\n    card.push(`**${title}**`);\n    if (description) card.push(`*${description}*`);\n    if (priceString) card.push(priceString);\n    if (productLink) card.push(`\\n[Ver Produto na Loja](${productLink}) ðŸ”—`);\n\n    return card.join('\\n');\n  },\n\n  // CatÃ¡logo\n  catalog: () => {\n    const title       = convertMarkdown(c?.title ?? 'CatÃ¡logo');\n    const description = convertMarkdown(c?.description ?? '');\n    const text        = convertMarkdown(c?.text ?? '');\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ§¾ _CatÃ¡logo Enviado:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ§¾ _CatÃ¡logo Recebido_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    card.push(`**${title}**`);\n    if (description) card.push(`\\n*${description}*`);\n    if (text)        card.push(`\\n${text}`);\n\n    return card.join('\\n');\n  },\n\n  // PIX estÃ¡tico (botÃ£o)\n  pix: (params) => {\n    const pixData    = params.payment_settings?.[0]?.pix_static_code ?? {};\n    const amountData = params.total_amount ?? {};\n    const currency   = params.currency ?? 'BRL';\n\n    const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\n    const pixKey       = convertMarkdown(pixData.key ?? 'Chave nÃ£o informada');\n    const keyType      = convertMarkdown(pixData.key_type ?? '');\n    const amount       = formatCurrency(amountData.value, amountData.offset, currency);\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Enviada):_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Recebida de **${senderName}**):_`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    card.push(`**Valor:** ${amount}`);\n    card.push(`\\n**Recebedor:** ${merchantName}`);\n    card.push(`**Chave PIX:** \\`${pixKey}\\` (${keyType})`);\n\n    if (!msg.fromMe) {\n      card.push(`\\n_Dica: Para pagar, copie a chave PIX e use o app do seu banco._`);\n    }\n\n    return card.join('\\n');\n  },\n\n  // Carrinho (PIX dinÃ¢mico / mÃºltiplos itens)\n  cart: (params) => {\n    const currency = params.currency ?? 'BRL';\n    const order    = params.order ?? {};\n    const items    = order.items ?? [];\n\n    const itemsString = items.map(itemProduct => {\n      const name     = convertMarkdown(itemProduct.name ?? 'Item');\n      const quantity = itemProduct.quantity ?? 1;\n      const price    = formatCurrency(\n        itemProduct.amount?.value,\n        itemProduct.amount?.offset,\n        currency\n      );\n      return `* ${quantity}x ${name} (${price})`;\n    }).join('\\n');\n\n    const subtotal = formatCurrency(order.subtotal?.value, order.subtotal?.offset, currency);\n    const discount = formatCurrency(order.discount?.value, order.discount?.offset, currency);\n    const total    = formatCurrency(params.total_amount?.value, params.total_amount?.offset, currency);\n\n    const pixSettings = params.payment_settings?.[0] ?? {};\n    const pixData     = pixSettings.pix_static_code ?? pixSettings.pix_dynamic_code ?? {};\n    const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\n    const pixKey       = convertMarkdown(pixData.key ?? pixData.code ?? 'Chave nÃ£o informada');\n    const keyType      = convertMarkdown(pixData.key_type ?? (pixSettings.type === 'pix_dynamic_code' ? 'DinÃ¢mico' : ''));\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ›’ _Pedido Enviado:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ›’ _Novo Pedido Recebido_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n\\n**Resumo do Pedido:**\\n`];\n\n    const bodyText = convertMarkdown(c?.body?.text ?? '');\n    if (bodyText) card.push(`*${bodyText}*\\n`);\n\n    card.push(itemsString);\n\n    const totals = [];\n    if (subtotal) totals.push(`**Subtotal:** ${subtotal}`);\n    if (discount && order.discount?.value > 0) {\n      totals.push(`**Desconto:** ${discount}`);\n    }\n    if (total) totals.push(`**Total:** **${total}**`);\n\n    if (totals.length > 0) {\n      card.push(`\\n${totals.join('\\n')}`);\n    }\n\n    if (pixKey !== 'Chave nÃ£o informada') {\n      card.push(`\\n**Para Pagar (PIX):**`);\n      card.push(`**Recebedor:** ${merchantName}`);\n      card.push(`**Chave PIX:** \\`${pixKey}\\` (${keyType})`);\n    }\n\n    if (!msg.fromMe) {\n      card.push(`\\n_Dica: Para pagar, copie a chave PIX e use o app do seu banco._`);\n    }\n\n    return card.join('\\n');\n  },\n\n  // LocalizaÃ§Ã£o estÃ¡tica\n  location: () => {\n    const lat     = c?.degreesLatitude;\n    const long    = c?.degreesLongitude;\n    const name    = convertMarkdown(c?.name ?? '');\n    const address = convertMarkdown(c?.address ?? '');\n\n    let mapLink = '';\n    if (lat && long) {\n      mapLink = `https://maps.google.com/?q=${lat},${long}`;\n    }\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ“ _LocalizaÃ§Ã£o Enviada:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ“ _LocalizaÃ§Ã£o Recebida_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    if (name)    card.push(`**${name}**`);\n    if (address) card.push(`*${address}*`);\n\n    const details = [];\n    if (lat)  details.push(`**Latitude:** \\`${lat}\\``);\n    if (long) details.push(`**Longitude:** \\`${long}\\``);\n\n    if (details.length > 0) {\n      if (name || address) {\n        card.push(`\\n${details.join('\\n')}`);\n      } else {\n        card.push(details.join('\\n'));\n      }\n    }\n\n    if (mapLink) {\n      if (name || address || lat || long) {\n        card.push(`\\n[Ver LocalizaÃ§Ã£o no Google Maps](${mapLink}) ðŸŒ`);\n      } else {\n        card.push(`[Ver LocalizaÃ§Ã£o no Google Maps](${mapLink}) ðŸŒ`);\n      }\n    }\n\n    return card.join('\\n');\n  },\n\n  // LocalizaÃ§Ã£o em tempo real\n  liveLocation: () => {\n    const lat  = c?.degreesLatitude;\n    const long = c?.degreesLongitude;\n    const comm = c?.caption;\n\n    let mapLink = '';\n    if (lat && long) {\n      mapLink = `https://maps.google.com/?q=${lat},${long}`;\n    }\n\n    let headerTitle;\n    const senderName = msg?.senderName ?? 'Contato';\n\n    if (msg.fromMe) {\n      headerTitle = `ðŸ“ _VocÃª iniciou o compartilhamento de localizaÃ§Ã£o em tempo real._`;\n    } else {\n      headerTitle = `ðŸ“ _${senderName} estÃ¡ compartilhando a localizaÃ§Ã£o em tempo real._`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    const details = [];\n    if (lat)  details.push(`**Latitude Inicial:** \\`${lat}\\``);\n    if (long) details.push(`**Longitude Inicial:** \\`${long}\\`\\n\\n`);\n    if (comm) details.push(`**ComentÃ¡rio:** ${comm}`);\n\n    if (details.length > 0) {\n      card.push(details.join('\\n'));\n    }\n\n    if (mapLink) {\n      if (details.length > 0) card.push('\\n');\n      card.push(`[Ver a localizaÃ§Ã£o inicial no Google Maps](${mapLink}) ðŸŒ`);\n    }\n\n    card.push(\n      `\\n\\n*A localizaÃ§Ã£o atual e em tempo real nÃ£o pode ser exibida no Chatwoot.*\\n` +\n      `_Acesse o WhatsApp no celular ou web para acompanhar._`\n    );\n\n    return card.join('\\n');\n  },\n\n  // Carrossel\n  carousel: () => {\n    const carouselData = c?.InteractiveMessage?.CarouselMessage;\n    const cards        = carouselData?.cards ?? [];\n    if (cards.length === 0) return 'Erro ao processar carrossel.';\n\n    const mainBody = convertMarkdown(c?.body?.text ?? '');\n\n    const formattedCards = cards.map((card, index) => {\n      const bodyText = convertMarkdown(card?.body?.text ?? '');\n\n      let buttonText = '';\n      const button   = card?.InteractiveMessage?.NativeFlowMessage?.buttons?.[0];\n      if (button) {\n        try {\n          const params = JSON.parse(button.buttonParamsJSON ?? '{}');\n          buttonText   = convertMarkdown(params.display_text ?? 'Ver opÃ§Ã£o');\n        } catch (e) {\n          buttonText = 'Ver opÃ§Ã£o';\n        }\n      }\n\n      const cardParts = [];\n      cardParts.push(`**${index + 1}. ${buttonText}**`);\n\n      if (bodyText) {\n        const bodyLines = bodyText.split('\\n').map(line => `> ${line}`);\n        cardParts.push(bodyLines.join('\\n'));\n      }\n\n      return cardParts.join('\\n');\n    }).join('\\n\\n---\\n\\n');\n\n    const direction   = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸŽ  _Mensagem em Carrossel (${direction}):_`;\n\n    const tipFooter = !msg.fromMe\n      ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`\n      : '';\n\n    return `${headerTitle}\\n\\n**${mainBody}**\\n\\n${formattedCards}${tipFooter}`;\n  },\n};\n\n// =================================================================\n// 4. PROCESSA CONTEÃšDO EM TEXTO (LÃ“GICA PRINCIPAL)\n// =================================================================\nlet processedContent = '';\n\n// 1. Carrossel\nif (c?.InteractiveMessage?.CarouselMessage) {\n  processedContent = formatters.carousel();\n}\n// 2. Interativa (botÃµes / PIX / carrinho)\nelse if (c?.InteractiveMessage?.NativeFlowMessage) {\n  const button     = c.InteractiveMessage.NativeFlowMessage.buttons?.[0];\n  const buttonName = button?.name;\n\n  let params;\n  try {\n    params = JSON.parse(button?.buttonParamsJSON ?? '{}');\n  } catch (e) {\n    params = {};\n  }\n\n  if (buttonName === 'payment_info') {\n    processedContent = formatters.pix(params);\n  } else if (buttonName === 'review_and_pay') {\n    processedContent = formatters.cart(params);\n  } else {\n    processedContent = formatters.buttons();\n  }\n}\n// 3. Lista\nelse if (c?.sections) {\n  processedContent = formatters.list();\n}\n// 4. Enquete (criaÃ§Ã£o)\nelse if (['PollCreationMessageV3', 'PollCreationMessage'].includes(msg?.messageType)) {\n  processedContent = formatters.poll();\n}\n// 5. Enquete (voto)\nelse if (msg?.messageType === 'PollUpdateMessage') {\n  const voteText = convertMarkdown(msg?.vote ?? '');\n  if (!voteText) {\n    processedContent = '';\n  } else if (msg.fromMe) {\n    processedContent = `ðŸ“¤ _Voto Enviado:_\\n\\n**${voteText}**`;\n  } else {\n    const senderName = msg?.senderName ?? 'Contato';\n    processedContent = `ðŸ“¥ _Voto Recebido_ (de **${senderName}**):\\n\\n**${voteText}**`;\n  }\n}\n// 6. Resposta a botÃ£o/lista\nelse if (msg?.buttonOrListid) {\n  const selectionText = convertMarkdown(String(c?.selectedDisplayText ?? c?.title ?? ''));\n  if (!selectionText) {\n    processedContent = '';\n  } else if (msg.fromMe) {\n    processedContent = `ðŸ“¤ _SeleÃ§Ã£o Enviada:_\\n\\n**${selectionText}**`;\n  } else {\n    const senderName = msg?.senderName ?? 'Contato';\n    processedContent = `ðŸ“¥ _OpÃ§Ã£o Selecionada_ (por **${senderName}**):\\n\\n**${selectionText}**`;\n  }\n}\n// 7. Contatos\nelse if (['ContactMessage', 'ContactsArrayMessage'].includes(msg.messageType)) {\n  processedContent = formatters.contacts();\n}\n// 8. Evento\nelse if (msg?.messageType === 'EventMessage') {\n  processedContent = formatters.event();\n}\n// 9. LocalizaÃ§Ã£o estÃ¡tica\nelse if (msg?.messageType === 'LocationMessage') {\n  processedContent = formatters.location();\n}\n// 10. Produto\nelse if (msg?.messageType === 'ProductMessage') {\n  processedContent = formatters.product();\n}\n// 11. CatÃ¡logo (link)\nelse if (msg?.messageType === 'ExtendedTextMessage' && msg.mediaType === 'cataloglink') {\n  processedContent = formatters.catalog();\n}\n// 12. LocalizaÃ§Ã£o em tempo real\nelse if (msg?.messageType === 'LiveLocationMessage') {\n  processedContent = formatters.liveLocation();\n}\n// 13. ReaÃ§Ãµes\nelse if (msg?.messageType === 'ReactionMessage') {\n  const reactionText = String(msg?.text ?? c?.text ?? '');\n  processedContent   = convertMarkdown(reactionText);\n}\n// 14. MÃ­dia (imagem, vÃ­deo, doc)\nelse if (['ImageMessage','VideoMessage','DocumentMessage'].includes(msg?.messageType)) {\n  const caption = String(c?.caption ?? '');\n  processedContent = convertMarkdown(caption);\n}\n// 15. Texto comum (fallback)\nelse {\n  const commonText = (\n    String(msg?.text ?? '').trim() ||\n    String(msg?.content?.text ?? '').trim() ||\n    ''\n  );\n  processedContent = convertMarkdown(commonText);\n}\n\n// =================================================================\n// 5. TRATAMENTO FINAL PARA DELEÃ‡ÃƒO (MENSAGEM EXCLUÃDA)\n// =================================================================\n\n// Dados originais\nconst deletedMessage     = msg;\nconst originalAttributes = deletedMessage.content_attributes;\nconst sendPayload        = deletedMessage.sendPayload || {};\nconst docName            = sendPayload.docName || '';\nconst rawType            = sendPayload.type || '';\n\n// ConteÃºdo base para riscar\nconst originalContent =\n  processedContent ||\n  deletedMessage.text ||\n  deletedMessage.content?.caption ||\n  deletedMessage.sendPayload?.text ||\n  '';\n\n// Parse dos atributos\nlet parsedAttributes = {};\nif (typeof originalAttributes === 'string') {\n  try {\n    parsedAttributes = JSON.parse(originalAttributes);\n  } catch (e) {\n    parsedAttributes = {};\n  }\n} else if (typeof originalAttributes === 'object' && originalAttributes !== null) {\n  parsedAttributes = originalAttributes;\n}\n\n// Flag de deletado\nparsedAttributes.deleted = true;\nconst newAttributesString = JSON.stringify(parsedAttributes);\n\n// Texto riscado\nlet textPart = '';\nif (originalContent && String(originalContent).trim().length > 0) {\n  textPart = String(originalContent).replace(/([^\\r\\n]+)/g, '~~$1~~');\n}\n\n// Info de arquivo\nlet filePart = '';\n\n// TIPOS que realmente representam mÃ­dia/arquivo\nconst allowedTypes = ['image', 'video', 'audio', 'ptt', 'file', 'document'];\n\nif (rawType && allowedTypes.includes(rawType)) {\n  const typeMap = {\n    image:    'Imagem',\n    video:    'VÃ­deo',\n    audio:    'Ãudio',\n    ptt:      'Ãudio',\n    file:     'Documento',\n    document: 'Documento',\n  };\n\n  const translatedType = typeMap[rawType] || rawType;\n  filePart = `\\n\\nðŸ“Ž *${translatedType}*: ${docName ? '~~' + docName + '~~' : ''}`;\n}\n\n// Novo conteÃºdo final\nconst newContent =\n  'ðŸš« _Mensagem excluÃ­da_: ' +\n  (textPart ? '\\n\\n' + textPart : '') +\n  filePart;\n\n// Resolve o message_id (tenta em vÃ¡rios lugares, incluindo o node \"processedData\")\nconst messageIdFromProcessed =\n  $('processedData')?.item?.json?.data?.message_id ?? null;\n\nconst messageId =\n  root?.data?.message_id ??\n  root?.message_id ??\n  deletedMessage?.message_id ??\n  messageIdFromProcessed ??\n  null;\n\n// =================================================================\n// 6. RETORNO DO ITEM\n// =================================================================\nitem.json = {\n  message_id:              messageId,\n  new_content:             newContent,\n  new_attributes:          newAttributesString,\n  original_rendered_content: processedContent,\n};\n\nreturn item;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-256,160],"id":"6f4eb2d2-84e9-4556-99f3-eb4bfb04722a","name":"messageDeletedPrepare"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"67b615a4-6620-4878-a354-1b740d8970e2","leftValue":"={{ $('processedData')?.item?.json?.data?.direction }}","rightValue":"outgoing","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-80,160],"id":"3cfd82ff-990f-4290-9220-94cf12ffa2bd","name":"messageDeleteVerify"},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.api.base_url }}/message/delete","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('normalizedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"id\": \"{{ $('processedData')?.item?.json?.data?.source_id }}\"\n}","options":{}},"id":"bf80bc1c-e6de-45b2-ac3a-3cf4724a6ff3","name":"messageDelete","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[96,80],"retryOnFail":true},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/messages/{{ $('messageDeletedPrepare')?.item?.json?.message_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"sent"}]},"options":{}},"id":"8ffe4ea5-5d35-49e3-b00e-cec91b970ca7","name":"messageDeletedPatch","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,160],"retryOnFail":true},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('normalizedData').item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('normalizedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('normalizedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('normalizedData')?.item?.json?.data?.status ?? '' }}"},{"key":"messageId","value":"={{ $('normalizedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('normalizedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('normalizedData')?.item?.json?.data?.direction ?? '' }}"},{"key":"eventType","value":"={{ $('normalizedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[-432,-832],"id":"12c86d2a-291e-440e-a139-bfc4e10ffb83","name":"executionData1"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('processedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('processedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('processedData')?.item?.json?.contact.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('processedData').item.json.data.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('processedData')?.item?.json?.data?.status ?? '' }}"},{"key":"messageId","value":"={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('processedData')?.item?.json?.data?.direction ?? '' }}"},{"key":"eventType","value":"={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[-784,-240],"id":"e4e6d506-0649-494f-8412-c0d98483fde3","name":"executionData2"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('processedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('processedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('processedData')?.item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('processedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('processedData')?.item?.json?.data?.status ?? '' }}"},{"key":"messageId","value":"={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('processedData')?.item?.json?.data?.direction ?? '' }}"},{"key":"eventType","value":"={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[1136,-528],"id":"d6a493c9-cfe0-4a18-a44c-9515aee1ba45","name":"executionData3"},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/messages/{{ $('processedData')?.item?.json?.data?.message_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"delivered"}]},"options":{}},"id":"c3117332-6482-4237-9f22-34aa47d1cb32","name":"messageEditedDelivered","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,-368],"retryOnFail":true},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/messages/{{ $('processedData')?.item?.json?.data?.message_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"sent"}]},"options":{}},"id":"011da69d-4d06-4295-828b-14e766c92696","name":"messageEditedSent","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,-368],"retryOnFail":true}],"connections":{"messageVerify":{"main":[[{"node":"messageTextSend","type":"main","index":0}],[{"node":"messageMediaSplit","type":"main","index":0}]]},"webhookDataChatwoot":{"main":[[{"node":"getVariables","type":"main","index":0}]]},"getVariables":{"main":[[{"node":"messageTypeFilter","type":"main","index":0}]]},"messageDeletedUpdate":{"main":[[{"node":"messageDeletedPatch","type":"main","index":0}]]},"messageSentVerify":{"main":[[{"node":"messageVerify","type":"main","index":0}],[{"node":"messageDeletedFind","type":"main","index":0}]]},"messageTypeFilter":{"main":[[{"node":"normalizedData","type":"main","index":0}]]},"contactCreate":{"main":[[{"node":"contactIdentify","type":"main","index":0}]]},"contactFind":{"main":[[{"node":"contactAction","type":"main","index":0}]]},"contactUpdate":{"main":[[{"node":"contactIdentify","type":"main","index":0}]]},"contactIdentify":{"main":[[{"node":"processedData","type":"main","index":0}]]},"contactValidation":{"main":[[{"node":"contactVerify","type":"main","index":0}]]},"contactAction":{"main":[[{"node":"contactCreate","type":"main","index":0}],[{"node":"contactIdentify","type":"main","index":0}],[{"node":"contactUpdate","type":"main","index":0}]]},"contactVerify":{"main":[[{"node":"contactFind","type":"main","index":0}],[{"node":"contactMessage","type":"main","index":0}]]},"identifierVerify":{"main":[[{"node":"contactFind","type":"main","index":0}],[{"node":"contactFind","type":"main","index":0}],[{"node":"contactValidation","type":"main","index":0}],[{"node":"contactValidation","type":"main","index":0}]]},"contactMessage":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"messageTextSend":{"main":[[{"node":"messageTextUpdate","type":"main","index":0}]]},"messageMediaSend":{"main":[[{"node":"messageMediaVerify","type":"main","index":0}]]},"messageMediaFields":{"main":[[{"node":"messageMediaSend","type":"main","index":0}]]},"createMessageInChatwoot":{"main":[[{"node":"messageMediaUpdate","type":"main","index":0}]]},"messageMediaDownload":{"main":[[{"node":"createMessageInChatwoot","type":"main","index":0}]]},"messageMediaVerify":{"main":[[{"node":"messageMediaDownload","type":"main","index":0}],[{"node":"messageMediaLoop","type":"main","index":0}]]},"messageMediaUpdate":{"main":[[{"node":"messageMediaLoop","type":"main","index":0}]]},"messageTextUpdate":{"main":[[{"node":"messageEditedDelivered","type":"main","index":0}]]},"processedData":{"main":[[{"node":"messageSentVerify","type":"main","index":0},{"node":"executionData2","type":"main","index":0}]]},"normalizedData":{"main":[[{"node":"identifierVerify","type":"main","index":0},{"node":"executionData1","type":"main","index":0}]]},"messageMediaSplit":{"main":[[{"node":"messageMediaLoop","type":"main","index":0}]]},"messageMediaLoop":{"main":[[{"node":"messageMediaRemove","type":"main","index":0}],[{"node":"messageMediaFields","type":"main","index":0}]]},"messageMediaRemove":{"main":[[{"node":"messageTextUpdate","type":"main","index":0}]]},"messageDeletedFind":{"main":[[{"node":"messageDeletedPrepare","type":"main","index":0}]]},"messageDeletedPrepare":{"main":[[{"node":"messageDeleteVerify","type":"main","index":0}]]},"messageDeleteVerify":{"main":[[{"node":"messageDelete","type":"main","index":0}],[{"node":"messageDeletedUpdate","type":"main","index":0}]]},"messageDelete":{"main":[[{"node":"messageDeletedUpdate","type":"main","index":0}]]},"messageDeletedPatch":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"endProcess":{"main":[[{"node":"executionData3","type":"main","index":0}]]},"messageEditedDelivered":{"main":[[{"node":"messageEditedSent","type":"main","index":0}]]},"messageEditedSent":{"main":[[{"node":"endProcess","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"a3eda3e8-6685-453c-a4c3-50f4be933b9c","activeVersionId":"a3eda3e8-6685-453c-a4c3-50f4be933b9c","triggerCount":1,"shared":[{"updatedAt":"2025-11-20T17:36:27.969Z","createdAt":"2025-11-20T17:36:27.969Z","role":"workflow:owner","workflowId":"o19aA0Bt4YMQtbiw","projectId":"Cf0rhzAQivp560yX"}],"activeVersion":{"updatedAt":"2025-11-26T21:17:26.817Z","createdAt":"2025-11-26T21:17:26.817Z","versionId":"a3eda3e8-6685-453c-a4c3-50f4be933b9c","workflowId":"o19aA0Bt4YMQtbiw","nodes":[{"parameters":{"content":"## Tratamento Inicial dos Dados","height":424,"width":516},"type":"n8n-nodes-base.stickyNote","position":[-816,-832],"typeVersion":1,"id":"1590f52d-e910-46fb-b712-57e314d5a0f6","name":"Sticky Note"},{"parameters":{"content":"## InÃ­cio do Processamento","height":1144,"width":208},"type":"n8n-nodes-base.stickyNote","position":[-1040,-832],"typeVersion":1,"id":"2ce283e3-2eaf-44ea-bd6f-f5031bece627","name":"Sticky Note1"},{"parameters":{"content":"```\n                                                                                  â–ˆâ–ˆâ–ˆ       â–ˆ                            â–ˆâ–ˆ          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ          â–ˆ                   â–ˆ              â–ˆ   â–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â–ˆ\n                                                                                   â–ˆ       â–ˆâ–ˆâ–ˆ                                       â–ˆ     â–ˆ         â–ˆâ–ˆâ–ˆ                 â–ˆâ–ˆâ–ˆ             â–ˆ   â–ˆ          â–ˆ\n                                                                                   â–ˆ  â–ˆ â–ˆâ–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ     â–ˆ   â–ˆ    â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ           â–ˆ    â–ˆâ–ˆâ–ˆ    â–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n                                                                                   â–ˆ  â–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆ      â–ˆ â–ˆ       â–ˆ â–ˆ  â–ˆ    â–ˆ     â–ˆ  â–ˆ    â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ     â–ˆ   â–ˆ    â–ˆ   â–ˆ      â–ˆ â–ˆ  â–ˆ â–ˆ          â–ˆâ–ˆ    â–ˆ â–ˆ   â–ˆâ–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ    â–ˆ     â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ       â–ˆ      â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ   â–ˆ    â–ˆ â–ˆ    â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ  â–ˆ    â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ     â–ˆ   â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ   â–ˆ    â–ˆ â–ˆ    â–ˆ     â–ˆ    â–ˆ â–ˆ  â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                  â–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆ â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ    â–ˆ   â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ      â–ˆ   â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ    â–ˆ    â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                       â–ˆ             â–ˆ                                                                                         â–ˆ\n                                                                                                    â–ˆâ–ˆâ–ˆâ–ˆ            â–ˆ                                                                                          â–ˆ\n```","height":200,"width":3132,"color":7},"type":"n8n-nodes-base.stickyNote","position":[-1824,-1056],"typeVersion":1,"id":"de7e34b1-b9f1-4826-8656-aa2a274b923c","name":"Sticky Note7"},{"parameters":{"content":"## Final do Processamento","height":1144,"width":208},"type":"n8n-nodes-base.stickyNote","position":[1104,-832],"typeVersion":1,"id":"c30937ff-1159-451f-87ba-9fbbe17a9ded","name":"Sticky Note3"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"251049eb-7cb5-454f-a495-072ab8d4f644","leftValue":"={{ $('messageSentVerify')?.item?.json?.data?.attachments }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-432,-288],"id":"03e1c1b7-19f2-40f6-a125-60491ee2709c","name":"messageVerify"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1136,-368],"id":"05938d33-c3ba-4422-be5c-599a3d9b58de","name":"endProcess"},{"parameters":{"content":"# ðŸ’¬ IntegraÃ§Ã£o Premium Chatwoot ðŸ” UaZapi\n### _**v1.0.1 â€¢ atualizado: 2025-11-17**_\n\n## Workflow que recebe mensagens via **webhook** do Chatwoot, normaliza os dados e envia para a UaZapi.\n---\n\n## ðŸ§­ O que este fluxo faz\n- Recebe **Webhook (POST)** do Chatwoot (`webhookDataChatwoot`) e carrega **variÃ¡veis de integraÃ§Ã£o** no Postgres (`getVariables`).\n- **Normaliza** contato, conversa e mensagem (`normalizedData`) e propaga para o contexto (`processedData`).\n- **Roteia** por tipo de entrega (`messageSentVerify` â†’ `messageVerify`):\n  - `msg_created` (evento `message_created` **sem** `source_id`)  \n    - **Texto:** `messageTextSend`  \n    - **MÃ­dia:** `messageMediaFields` â†’ `messageMediaSend`\n  - `msg_deleted` (evento `message_updated` com `deleted=true` **e** `delete_messages=true`)  \n    - Busca conteÃºdo original: `findMessageDeleted` â†’ valida direÃ§Ã£o (`deleteVerify`) â†’ apaga na UaZapi (`deleteMessage`) â†’ atualiza histÃ³rico no Chatwoot/DB com *strike-through* (`messageDeletedUpdate`)\n- ApÃ³s envio de texto **ou** mÃ­dia, atualiza o `source_id` no Postgres para manter o vÃ­nculo com a UaZapi (`messageUpdate`).\n- Assina a mensagem opcionalmente com o **nome do atendente** (flag `sign_messages`), e agrega `replyid` apenas quando **`reply_messages=true`** e houver `reply_id`.\n\n---\n\n## ðŸ›  Requisitos\n- **Postgres (credencial):** nÃ³s `getVariables` do Manager (Vermelho) e `messageUpdate`, `messageDeletedUpdate` do Chatwoot (Azuis).\n- **VariÃ¡veis de integraÃ§Ã£o (Preenchidas no Gerenciador de InstÃ¢ncias):**\n  - **Chatwoot:** `chatwoot_base_url`, `chatwoot_api_version`, `chatwoot_token`, `chatwoot_account_id`, `chatwoot_inbox_id`, `chatwoot_inbox_name`, `chatwoot_track_id`\n  - **UaZapi:** `api_base_url`, `api_token`, `api_instance_name`\n  - **ConfiguraÃ§Ãµes:** `ignore_groups`, `reply_messages`, `edit_messages`, `delete_messages`, `reopen_conversation`, `conversation_pending`, `import_*`, `sign_*`\n- **Chatwoot:** **Gere um cÃ³digo exclusivo para o seu webhook em** [UUID Generator](https://www.uuidgenerator.net/) e informe no campo `Path` do `webhookDataChatwoot`.\n\n---\n\n## âš™ï¸ InstalaÃ§Ã£o & AtivaÃ§Ã£o\n1. **Importe** o workflow no n8n.  \n2. Associe a **credencial Postgres** aos nÃ³s indicados.  \n3. Ajuste o **Webhook** `webhookDataChatwoot` (path pÃºblico) e configure os **webhooks de saÃ­da** no Chatwoot.  \n4. Confirme que `getVariables` retorna a linha correta por `chatwoot_account_id` e `chatwoot_inbox_id`.  \n5. **Save** â†’ **Activate**.  \n6. Envie uma mensagem pelo Chatwoot e valide o envio na UaZapi e a atualizaÃ§Ã£o do `source_id`.\n\n---\n\n## ðŸ”€ Regras de Roteamento (resumo)\n- **CriaÃ§Ã£o de mensagem:** `message_created` **sem** `source_id` â†’ envia para a UaZapi.  \n- **Texto vs MÃ­dia:** `messageVerify` checa `data_url`  \n  - vazio â†’ **texto** (`messageTextSend`)  \n  - preenchido â†’ **mÃ­dia** (`messageMediaFields` â†’ `messageMediaSend`)\n- **Reply:** `replyid` sÃ³ Ã© enviado se `reply_messages = true` **e** houver `reply_id`.\n- **Assinatura opcional:** quando `sign_messages = true`, prefixa o conteÃºdo com `*Atendente:*`.\n- **ExclusÃ£o:** `message_updated` com `deleted=true` **e** `delete_messages = true`  \n  - apenas se `direction = incoming` (`deleteVerify`)  \n  - apaga na UaZapi e grava histÃ³rico com *strike-through* no Chatwoot/DB.\n- **Rastreamento:** define `track_id` no formato `track-account-inbox` (com `account_id` e `inbox_id` **padStart(4)**) e `track_source = chatwoot`.\n\n---\n\n## ðŸ” SeguranÃ§a\n- **HTTPS** no Webhook e nas APIs (Chatwoot/UaZapi).\n- **Tokens** (Chatwoot/UaZapi) mantidos no Gerenciador de InstÃ¢ncias.\n","height":1856,"width":768,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-1824,-832],"typeVersion":1,"id":"03079e33-9305-441e-88d8-59b18cfaf2b6","name":"Sticky Note Chatwoot â†’ UaZapi"},{"parameters":{"httpMethod":"POST","path":"6a936a6e-9056-465a-934f-e46564e5cbd3","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-976,-704],"id":"d6cfbd85-c9b9-42e6-8d4e-87e774b8d1e0","name":"webhookDataChatwoot","webhookId":"6a936a6e-9056-465a-934f-e46564e5cbd3"},{"parameters":{"operation":"select","schema":{"__rl":true,"value":"chatwoot_uazapi","mode":"list","cachedResultName":"chatwoot_uazapi"},"table":{"__rl":true,"value":"chatwoot_uazapi_config","mode":"list","cachedResultName":"chatwoot_uazapi_config"},"limit":1,"where":{"values":[{"column":"chatwoot_account_id","value":"={{ $('webhookDataChatwoot')?.item?.json?.body?.account?.id ?? 0 }}"},{"column":"chatwoot_inbox_id","value":"={{ $('webhookDataChatwoot')?.item?.json?.body?.conversation?.inbox_id ?? 0 }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-784,-704],"id":"1ed207bb-5b7f-4f95-a6ba-3402ae3884ac","name":"getVariables","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"operation":"executeQuery","query":"UPDATE public.messages\nSET \n  content = $1,\n  content_attributes = $2::json\nWHERE \n  id = $3::integer\nRETURNING \n  id, content, content_attributes;","options":{"queryReplacement":"={{ [\n  String($('messageDeletedPrepare')?.item?.json?.new_content ?? ''),\n  String(JSON.stringify( $('messageDeletedPrepare')?.item?.json?.new_attributes ?? {} )),\n  String($('messageDeletedPrepare')?.item?.json?.message_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[272,160],"id":"173a7289-d695-4031-aa97-4a7ee634eb05","name":"messageDeletedUpdate","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Mngr","height":176,"width":166,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-816,-736],"typeVersion":1,"id":"569f6db4-04f8-4b43-afb5-ec4ea3d2aba5","name":"Sticky Note9"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[64,-320],"typeVersion":1,"id":"4ac51692-bf72-4085-8968-d4d2d6f05803","name":"Sticky Note10"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[240,128],"typeVersion":1,"id":"a95b1bd4-48d1-4026-924a-f4a464f8c576","name":"Sticky Note11"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_created' &&\n  $('webhookDataChatwoot')?.item?.json?.body?.private !== true &&\n  !String($('webhookDataChatwoot')?.item?.json?.body?.source_id ?? '').trim()\n}}","rightValue":"message_created","operator":{"type":"boolean","operation":"true","singleValue":true},"id":"e71ede49-b811-46e9-be73-fcece40f27c8"}],"combinator":"and"},"renameOutput":true,"outputKey":"msg_created"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7bcd700f-3396-4c45-953c-8b5bcdf1bbbe","leftValue":"={{ \n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_updated' &&\n  ( $('webhookDataChatwoot')?.item?.json?.body.conversation?.messages[0].content_attributes?.deleted ||\n    $('webhookDataChatwoot')?.item?.json?.body?.content_attributes?.deleted\n  ) &&\n  $('processedData')?.item?.json?.chatwoot?.delete_messages === true\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"msg_deleted"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-608,-96],"id":"8fb6c026-b069-45b8-ba40-322bedc9f468","name":"messageSentVerify"},{"parameters":{"content":"# âš–ï¸ Aviso de Propriedade Intelectual & Suporte\n\nEste workflow e sua UI sÃ£o **propriedade intelectual** da EMKT Consultoria e Tecnologia, protegidos pelas Leis **9.610/98 (Direitos Autorais)**, **9.609/98 (Software)** e pela **LGPD â€“ 13.709/18**.\n---\n\n## Uso permitido\n- LicenÃ§a de **uso interno**, nÃ£o exclusiva e intransferÃ­vel.\n- Ã‰ vedada a **distribuiÃ§Ã£o**, **revenda**, **locaÃ§Ã£o**, **cessÃ£o**, **publicaÃ§Ã£o** ou **exposiÃ§Ã£o pÃºblica** (incl. repositÃ³rios/portais).\n\n## ProibiÃ§Ãµes\n- **CÃ³pia** total/parcial, **engenharia reversa**, **descompilaÃ§Ã£o**, **circunvenÃ§Ã£o** de proteÃ§Ãµes.\n- **ModificaÃ§Ãµes** nÃ£o autorizadas, criaÃ§Ã£o de **derivados** ou remoÃ§Ã£o de crÃ©ditos/identificaÃ§Ãµes.\n- **Compartilhamento** do pacote/fluxo, credenciais, URLs de webhook, telas ou prints com terceiros.\n\n## Suporte & Garantia\n- A **garantia de suporte** e atualizaÃ§Ãµes estÃ¡ **condicionada** Ã  manutenÃ§Ã£o do **estado original** do workflow.  \n- Qualquer **alteraÃ§Ã£o nÃ£o autorizada** (cÃ³digo, nÃ³s, credenciais, rotas, lÃ³gica ou layout) **invalida o suporte**.\n- AdequaÃ§Ãµes/integraÃ§Ãµes adicionais requerem **contrataÃ§Ã£o prÃ©via** e **autorizaÃ§Ã£o por escrito**.\n\n---\n\n### ðŸ“ž Contato\nPrecisa de ajuda? Fale conosco pelo WhatsApp Business  \n**(41) 9 8473-9797** â€” [abrir conversa](https://api.whatsapp.com/message/FVXDCWKJFIM4M1)  \n**(79) 9 9977-7712** â€” [abrir conversa](https://api.whatsapp.com/message/2G6M66MXFH7TD1)\n\n> DÃºvidas sobre uso, licenÃ§a ou autorizaÃ§Ã£o: contate a EMKT.\n","height":704,"width":2352,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-1040,320],"typeVersion":1,"id":"2f22778d-736b-47d1-9d21-6b71e7a7b25e","name":"Sticky Note14"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cef6a5a6-8219-4157-b619-78b9929ecc31","leftValue":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_created' &&\n  $('webhookDataChatwoot')?.item?.json?.body?.private !== true &&\n  !String($('webhookDataChatwoot')?.item?.json?.body?.source_id ?? '').trim()\n}}","rightValue":"message_created|message_updated","operator":{"type":"boolean","operation":"true","singleValue":true}},{"id":"bf9dd4b4-6f2e-4628-ab0a-29f6b8b99c03","leftValue":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_updated' &&\n  $('webhookDataChatwoot')?.item?.json?.body?.content_attributes.deleted &&\n  $('webhookDataChatwoot')?.item?.json?.body?.message_type === 'outgoing'\n}}","rightValue":"messages","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-608,-704],"id":"5f8055b2-49a9-4314-88d2-eb12e3c7c01b","name":"messageTypeFilter"},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot?.account_id }}/contacts","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"},{"name":"Content-type","value":"application/json; charset=utf-8"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"name\": \"{{ $('normalizedData')?.item?.json?.data?.is_group ? $('normalizedData')?.item?.json?.group?.name : $('normalizedData')?.item?.json?.contact?.full_name }}\",\n  \"inbox_id\": {{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id }},\n  \"source_id\": \"{{ $('contactAction')?.item?.json?.identifier?.split('@')?.first() }}\",\n  \"phone_number\": \"{{ $('normalizedData')?.item?.json?.contact?.phone_number_new }}\",\n  \"identifier\": \"{{ $('contactAction')?.item?.json?.identifier_new }}\",\n  \"additional_attributes\": {\n    \"contact_lid\": \"{{ $('contactAction')?.item?.json?.contact_lid_new }}\"\n  }\n}\n","options":{"response":{"response":{"responseFormat":"json"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,-784],"id":"19474722-86b2-4007-96d8-87ffbef0cf29","name":"contactCreate","retryOnFail":true,"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"23b01a4b-58a1-4256-b62f-373073a16840","name":"identifier","value":"={{ $('contactAction')?.item?.json?.identifier_new }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[800,-704],"id":"108f4e21-5aa0-4ef0-954d-075a98e4ec58","name":"contactIdentify","retryOnFail":true},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[240,-736],"typeVersion":1,"id":"0a027828-4bb1-437d-9600-47a69ee83c66","name":"Sticky Note15"},{"parameters":{"operation":"executeQuery","query":"WITH NormalizedInput AS (\n  SELECT\n    NULLIF($1, '') AS input_identifier,\n    NULLIF($2, '') AS input_lid,\n    NULLIF($3, '') AS input_full_name,\n    NULLIF($4, '') AS input_phone_number,\n    NULLIF($5, '')::integer AS input_account_id\n)\nSELECT\n  COALESCE(c.id, 0) AS contact_id,\n  COALESCE(c.identifier, '') AS identifier_old,\n  COALESCE(ni.input_identifier, '') AS identifier_new,\n  COALESCE(c.additional_attributes ->> 'contact_lid', '') AS contact_lid_old,\n  COALESCE(ni.input_lid, '') AS contact_lid_new,\n  COALESCE(c.name, '') AS name_old,\n  COALESCE(ni.input_full_name, '') AS name_new,\n  COALESCE(c.phone_number, '') AS phone_number_old,\n  COALESCE(ni.input_phone_number, '') AS phone_number_new,\n  CASE\n    WHEN c.id IS NULL THEN true\n    WHEN \n      (\n        COALESCE(c.identifier, '') != COALESCE(ni.input_identifier, '') OR\n        COALESCE(c.additional_attributes ->> 'contact_lid', '') != COALESCE(ni.input_lid, '') OR\n        COALESCE(c.phone_number, '') != COALESCE(ni.input_phone_number, '')\n      )\n    THEN true\n    WHEN \n      (\n        COALESCE(c.name, '') = 'Contato' AND\n        COALESCE(c.name, '') != COALESCE(ni.input_full_name, '')\n      )\n    THEN true\n    ELSE false\n  END AS update_data\nFROM\n  NormalizedInput AS ni\nLEFT JOIN\n  contacts AS c ON\n    (c.account_id = ni.input_account_id AND ni.input_account_id IS NOT NULL)\n    AND\n    (\n      (c.identifier = ni.input_identifier AND ni.input_identifier IS NOT NULL)\n      OR\n      (c.additional_attributes ->> 'contact_lid' = ni.input_lid AND ni.input_lid IS NOT NULL)\n      OR\n      (c.phone_number = ni.input_phone_number AND ni.input_phone_number IS NOT NULL)\n    );","options":{"queryReplacement":"={{ [\n  String((() => {\n    try {\n      const jid = $('contactVerify')?.item?.json?.jid;\n      if (jid) return jid;\n    } catch (e) {}\n    return $('normalizedData')?.item?.json?.contact?.identifier ?? '';\n  })()),\n  String((() => {\n    try {\n      const lid = $('contactVerify')?.item?.json?.lid;\n      if (lid) return lid;\n    } catch (e) {}\n    return $('normalizedData')?.item?.json.contact.lid ?? '';\n  })()),\n  String($('normalizedData')?.item?.json?.contact?.full_name ?? ''),\n  String($('normalizedData')?.item?.json?.contact?.phone_number ?? ''),\n  String($('normalizedData')?.item?.json?.chatwoot?.account_id ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[272,-704],"id":"6ebf668d-14d7-4434-86bb-2be1d2d33b39","name":"contactFind","alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"contacts","mode":"list","cachedResultName":"contacts"},"columns":{"mappingMode":"defineBelow","value":{"identifier":"={{ $('contactAction')?.item?.json?.identifier_new }}","id":"={{ $('contactAction')?.item?.json?.contact_id }}","additional_attributes":"={{ ({ \"contact_lid\": $('contactAction')?.item?.json?.contact_lid_new }) }}","name":"={{\n(() => {\n  const data = $('contactAction')?.item?.json ?? {};\n  \n  const oldName = data?.name_old ?? '';\n  const newName = data?.name_new ?? '';\n  if (oldName === 'Contato') {\n    return newName;\n  }\n  return oldName;\n})()\n}}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":false},{"id":"name","displayName":"name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"email","displayName":"email","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"phone_number","displayName":"phone_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"account_id","displayName":"account_id","required":true,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"created_at","displayName":"created_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updated_at","displayName":"updated_at","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"additional_attributes","displayName":"additional_attributes","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":false},{"id":"identifier","displayName":"identifier","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"custom_attributes","displayName":"custom_attributes","required":false,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true,"removed":true},{"id":"last_activity_at","displayName":"last_activity_at","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"contact_type","displayName":"contact_type","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"middle_name","displayName":"middle_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_name","displayName":"last_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"location","displayName":"location","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"country_code","displayName":"country_code","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"blocked","displayName":"blocked","required":false,"defaultMatch":false,"display":true,"type":"boolean","canBeUsedToMatch":true,"removed":true},{"id":"company_id","displayName":"company_id","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[624,-624],"id":"d6ace460-cf31-41a7-b58a-2fff17893561","name":"contactUpdate","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Cwt","height":176,"width":166,"color":5},"type":"n8n-nodes-base.stickyNote","position":[592,-656],"typeVersion":1,"id":"f3ccb207-17b4-445d-9ee9-9c23df12c735","name":"Sticky Note16"},{"parameters":{"content":"## Tratamento do Contato","height":424,"width":1380},"type":"n8n-nodes-base.stickyNote","position":[-288,-832],"typeVersion":1,"id":"93443949-84c8-427a-9ed3-8019b64a1958","name":"Sticky Note4"},{"parameters":{"content":"## Tratamento da Mensagem","height":712,"width":1908},"type":"n8n-nodes-base.stickyNote","position":[-816,-400],"typeVersion":1,"id":"7ccd3dc2-75d0-4a60-a49e-32c902a808ad","name":"Sticky Note5"},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.api?.base_url }}/chat/check","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('normalizedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"numbers\": [\n    \"{{ $('normalizedData')?.item?.json?.contact?.phone_number }}\"\n  ]\n}","options":{}},"id":"33569bdf-5c87-4290-a45a-f27e116fa0d1","name":"contactValidation","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-80,-624],"retryOnFail":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{\n  (\n    $('contactFind')?.item?.json ??\n    {}\n  )\n  .contact_id === 0\n}}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true},"id":"e71ede49-b811-46e9-be73-fcece40f27c8"}],"combinator":"and"},"renameOutput":true,"outputKey":"create"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"342366cd-05e8-4efe-b237-ccf032377806","leftValue":"={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data?.contact_id > 0);\n  const shouldUpdate = (data?.update_data !== true);\n  return contactIdExists && shouldUpdate;\n})()\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"exists"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7bcd700f-3396-4c45-953c-8b5bcdf1bbbe","leftValue":"={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data?.contact_id > 0);\n  const shouldUpdate = (data?.update_data === true);\n  return contactIdExists && shouldUpdate;\n})()\n}}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"update"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[448,-720],"id":"93eac197-fc7f-48a4-8faa-4dd13b427348","name":"contactAction"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2ec9a8fb-a140-4361-80c0-8d8f797bf409","leftValue":"={{ $('contactValidation')?.item?.json?.isInWhatsapp }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[96,-624],"id":"8e3cd16c-6d20-4758-8e11-f1873d951540","name":"contactVerify"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"342366cd-05e8-4efe-b237-ccf032377806","leftValue":"={{ $('normalizedData')?.item?.json?.contact?.identifier?.split('@').last() }}","rightValue":"g.us","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"group"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('normalizedData')?.item?.json?.contact?.identifier?.split('@').last() }}","rightValue":"s.whatsapp.net","operator":{"type":"string","operation":"equals"},"id":"e71ede49-b811-46e9-be73-fcece40f27c8"}],"combinator":"and"},"renameOutput":true,"outputKey":"jid"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7bcd700f-3396-4c45-953c-8b5bcdf1bbbe","leftValue":"={{ $('normalizedData')?.item?.json?.contact?.identifier?.split('@').last() }}","rightValue":"lid","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"lid"}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-256,-736],"id":"3a991b39-e9b3-4c04-a0e3-0cb3b733ca62","name":"identifierVerify"},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('normalizedData')?.item?.json?.data?.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{\n(() => {\n  // 1. Pega os dados do contato de forma segura\n  const contact = $('normalizedData')?.item?.json?.contact ?? {};\n  \n  // 2. Extrai os dados (com fallback para 'N/A' se estiverem vazios)\n  const name = contact.full_name || 'N/A';\n  const phone = contact.phone_number || 'N/A';\n\n  // 3. Monta o card de erro formatado\n  const card = [];\n  \n  // TÃ­tulo sugestivo com emoji\n  card.push(`âŒ **Falha ao Enviar: Contato InvÃ¡lido**`);\n  card.push(`\\n---\\n`);\n  card.push(`NÃ£o foi possÃ­vel enviar a mensagem. O contato abaixo parece ter um nÃºmero de WhatsApp invÃ¡lido ou inexistente.`);\n  \n  // InformaÃ§Ãµes (sem o identifier)\n  card.push(`\\n**Nome:** ${name}`);\n  card.push(`**Telefone:** ${phone}`);\n  card.push(`\\n---\\n`);\n  \n  // Texto final com a instruÃ§Ã£o\n  card.push(`_**AÃ§Ã£o Recomendada:** Verifique se o nÃºmero de telefone estÃ¡ correto (incluindo DDI + DDD), ajuste o cadastro do contato e tente enviar a mensagem novamente._`);\n\n  return card.join('\\n');\n})()\n}}"},{"name":"message_type","value":"=incoming"},{"name":"source_id","value":"={{ $('normalizedData').item.json.data.message_id }}"},{"name":"private","value":"={{ true }}"}]},"options":{}},"id":"a16131ab-fc38-4564-9fe9-c2e8dad94823","name":"contactMessage","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[272,-544],"retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.api?.base_url }}/send/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('normalizedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"number\": \"{{ $('processedData')?.item?.json?.contact?.identifier }}\",\n  \"text\": \"{{ ((\n               $('processedData')?.item?.json?.integration?.sign_messages_mode !== 'none' &&\n               $('processedData')?.item?.json?.data?.sender\n             )\n             ? (\n                 '*' +\n                 ( $('processedData')?.item?.json?.data?.sender ?? '' ) +\n                 ':*' +\n                 ( $('processedData')?.item?.json?.integration?.sign_delimiter ?? '\\\\n' )\n               )\n             : ''\n           ) +\n           String($('processedData')?.item?.json?.data?.content ?? '')\n             .replace(/\\\\n/g, '\\\\n')\n  }}\",\n  \"replyid\": \"{{\n                $('processedData')?.item?.json?.chatwoot?.reply_messages === true &&\n                String($('processedData')?.item?.json?.data?.reply_id ?? '')\n                  .trim()\n                  .length > 0\n                ? $('processedData')?.item?.json?.data?.reply_id\n                : ''\n              }}\",\n  \"track_id\": \"{{\n                 `${$('getVariables')?.item?.json?.chatwoot_track_id ?? ''}` +\n                 '-' +\n                 `${String($('getVariables')?.item?.json?.chatwoot_account_id ?? '').padStart(4,'0')}` +\n                 '-' +\n                 `${String($('getVariables')?.item?.json?.chatwoot_inbox_id ?? '').padStart(4,'0')}`\n               }}\",\n  \"track_source\": \"chatwoot\"\n}","options":{"response":{"response":{}}}},"id":"7eef82ae-ea63-4721-9d45-ede16f2d8149","name":"messageTextSend","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-256,-368],"retryOnFail":true},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.api.base_url }}/send/media","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('processedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"number\": \"{{ $('processedData')?.item?.json?.contact?.identifier }}\",\n  \"text\": \"{{ (( $('processedData')?.item?.json?.integration?.sign_messages_mode !== 'none' &&\n               $('processedData')?.item?.json?.data?.sender )\n               ? ('*' + ( $('processedData')?.item?.json?.data?.sender ?? '' ) + \n                 ':*' + ( $('processedData')?.item?.json?.integration?.sign_delimiter ?? '\\\\n' ))\n               : '' ) +\n             String($('messageMediaFields')?.item?.json?.data?.content ?? '')\n               .replace(/\\n/g,'\\\\n')\n           }}\",\n  \"replyid\": \"{{\n    $('processedData')?.item?.json?.chatwoot?.reply_messages === true &&\n    String($('processedData')?.item?.json?.data?.reply_id ?? '')\n      .trim()\n      .length > 0\n      ? $('processedData')?.item?.json?.data?.reply_id\n      : ''\n  }}\",\n  \"type\": \"{{ $('messageMediaFields')?.item?.json?.type }}\",\n  \"file\": \"{{ $('messageMediaFields')?.item?.json?.url }}\",\n  \"docName\": \"{{ $('messageMediaFields')?.item?.json?.filename }}\",\n  \"track_id\": \"{{\n    `${$('getVariables')?.item?.json?.chatwoot_track_id ?? ''}` +\n    '-' +\n    `${String($('getVariables')?.item?.json?.chatwoot_account_id ?? '').padStart(4, '0')}` +\n    '-' +\n    `${String($('getVariables')?.item?.json?.chatwoot_inbox_id ?? '').padStart(4, '0')}`\n  }}\",\n  \"track_source\": \"chatwoot\"\n}\n","options":{}},"id":"8f00cb76-0b18-437b-b32e-a82449960d1b","name":"messageMediaSend","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[272,-128],"retryOnFail":true},{"parameters":{"assignments":{"assignments":[{"id":"77c8dae6-2659-438d-b2ac-7b8d5a256165","name":"url","value":"={{ $('messageMediaLoop')?.item?.json?.currentAttachment?.data_url }}","type":"string"},{"id":"eaa9ebf4-e2af-4926-b821-100da4776575","name":"filename","value":"={{ $('messageMediaLoop')?.item?.json?.currentAttachment?.filename }}","type":"string"},{"id":"6668f3d0-2066-43ac-ba7b-b905c3d6fbc0","name":"type","value":"={{ $('messageMediaLoop')?.item?.json?.currentAttachment?.file_type }}","type":"string"},{"id":"9c331318-54a8-4bef-8ac3-bd23482c5bed","name":"mimeType","value":"={{ \n  (() => {\n    const type = $('messageMediaLoop')?.item?.json?.currentAttachment?.filename.split('.').last();\n    switch (type) {\n      case 'doc': return 'application/msword';\n      case 'docx': return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n      case 'jpeg': return 'image/jpeg';\n      case 'jpg': return 'image/jpeg';\n      case 'mp3': return 'audio/ogg; codecs=opus';\n      case 'mp4': return 'video/mp4';\n      case 'ogg': return 'audio/ogg; codecs=opus';\n      case 'pdf': return 'application/pdf';\n      case 'pfx': return 'application/x-pkcs12';\n      case 'png': return 'image/png';\n      case 'rar': return 'application/vnd.rar';\n      case 'xls': return 'application/vnd.ms-excel';\n      case 'xlsx': return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n      case 'zip': return 'application/zip';\n      default: return 'application/octet-stream';\n    }\n  })()\n}}","type":"string"},{"id":"f8e63388-2dc7-4905-82d5-d77f82b6e4e2","name":"data.content","value":"={{ \n  $('messageMediaLoop')?.item?.json?.currentAttachment?.content ??\n  ''\n}}","type":"string"},{"id":"78c3514c-ec46-4f05-a5c3-86fc31e79122","name":"item","value":"={{\n  $('messageMediaLoop')?.item?.json?.currentAttachment?.item ??\n  ''\n}}","type":"number"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[96,-128],"id":"c42bc997-d1ed-4365-bf78-c53455a9f74c","name":"messageMediaFields"},{"parameters":{"method":"POST","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id || $('processedData')?.item?.json?.data?.conversation_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"=attachments[]","inputDataFieldName":"data"},{"name":"message_type","value":"={{ $('processedData')?.item?.json?.data?.direction }}"},{"name":"source_id","value":"={{ $('messageMediaSend')?.item?.json?.messageid }}"}]},"options":{}},"id":"05ce5bf1-efe7-4e57-a199-43c72ada223b","name":"createMessageInChatwoot","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[800,-208],"retryOnFail":true},{"parameters":{"url":"={{ $('messageMediaFields')?.item?.json?.url }}","options":{"response":{"response":{"neverError":true,"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,-208],"id":"475d9be5-7437-4cbf-bcb8-7ba644471bae","name":"messageMediaDownload","retryOnFail":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"16c3d6c6-556b-4ba0-abc3-406f76b662d0","leftValue":"={{ $('messageMediaFields')?.item?.json?.item }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[448,-128],"id":"1df5dd05-2da7-45b9-b27c-17f4b3f7aee5","name":"messageMediaVerify"},{"parameters":{"operation":"executeQuery","query":"WITH updated AS (\n  UPDATE public.messages\n  SET source_id = $1\n  WHERE id = $2::integer\n  RETURNING id, source_id\n)\nSELECT\n  (SELECT COUNT(*) FROM updated) AS rows_affected,\n  (SELECT source_id FROM updated LIMIT 1) AS source_id;","options":{"queryReplacement":"={{ [\n  String($json?.messageid ?? ''),\n  String($('processedData')?.item?.json?.data?.message_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[976,-208],"id":"29e302f1-4d1d-4d27-936c-8ea3af88c45a","name":"messageMediaUpdate","alwaysOutputData":true,"executeOnce":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"operation":"executeQuery","query":"WITH updated AS (\n  UPDATE public.messages\n  SET source_id = $1\n  WHERE id = $2::integer\n  RETURNING id, source_id\n)\nSELECT\n  (SELECT COUNT(*) FROM updated) AS rows_affected,\n  (SELECT source_id FROM updated LIMIT 1) AS source_id;","options":{"queryReplacement":"={{ [\n  String($json?.messageid ?? $('messageMediaLoop')?.item?.json?.messageid ?? ''),\n  String($('processedData')?.item?.json?.data.message_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[272,-368],"id":"85dfdfb9-01f8-400a-a093-dc1460b9d4d0","name":"messageTextUpdate","alwaysOutputData":true,"executeOnce":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"assignments":{"assignments":[{"id":"fc173b4d-2b51-446a-a545-36fe4fc3f9e9","name":"chatwoot","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:        s.chatwoot_base_url,\n    api_version:     s.chatwoot_api_version,\n    token:           s.chatwoot_token,\n    account_id:      s.chatwoot_account_id,\n    inbox_id:        s.chatwoot_inbox_id,\n    inbox_name:      s.chatwoot_inbox_name,\n    track_id:        s.chatwoot_track_id,\n    reply_messages:  s.reply_messages,\n    edit_messages:   s.edit_messages,\n    delete_messages: s.delete_messages\n  };\n})() }}","type":"object"},{"id":"365992ef-324c-45f6-8770-032326a3467e","name":"api","value":"={{ $('normalizedData')?.item?.json?.api }}","type":"object"},{"id":"f9308e51-fcdd-4475-9d60-78546896588d","name":"integration","value":"={{ $('normalizedData')?.item?.json?.integration }}","type":"object"},{"id":"cb473388-9aaf-46a8-86fe-c9c37776ed65","name":"contact","value":"={{ $('normalizedData')?.item?.json?.contact }}","type":"object"},{"id":"7cef8d6a-13c6-4c6b-bcf1-81e60a5a1d37","name":"data","value":"={{ $('normalizedData').item?.json?.data }}","type":"object"},{"id":"fed18daf-ce00-4acf-b20d-b57a4a366939","name":"contact.identifier","value":"={{ $('contactIdentify')?.item?.json?.identifier ?? '' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-784,-96],"id":"0e5c8759-4670-409a-a84f-c95acdb2bc69","name":"processedData"},{"parameters":{"assignments":{"assignments":[{"id":"37609540-0631-4eb3-808b-a2b20f1b90a2","name":"chatwoot","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:   s.chatwoot_base_url,\n    api_version:s.chatwoot_api_version,\n    token:      s.chatwoot_token,\n    account_id: s.chatwoot_account_id,\n    inbox_id:   s.chatwoot_inbox_id,\n    inbox_name: s.chatwoot_inbox_name,\n    track_id:   s.chatwoot_track_id,\n  };\n})() }}","type":"object"},{"id":"84596df0-c964-4e49-b538-07f44c2957d9","name":"api","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:          s.api_base_url,\n    token:             s.api_token,\n    api_instance_name: s.api_instance_name,\n  };\n})() }}","type":"object"},{"id":"4260e205-91f4-4f15-9263-27bdcd4e29d1","name":"integration","value":"={{ (() => {\n  const s = $('getVariables')?.item?.json ?? {};\n  return {\n    ignore_groups:        s.ignore_groups ?? false,\n    reply_messages:       s.reply_messages ?? false,\n    edit_messages:        s.edit_messages ?? false,\n    delete_messages:      s.delete_messages ?? false,\n    reopen_conversation:  s.reopen_conversation ?? false,\n    conversation_pending: s.conversation_pending ?? false,\n    import_contacts:      s.import_contacts ?? false,\n    import_messages:      s.import_messages ?? false,\n    import_days_limit:    s.import_days_limit ?? 0,\n    sign_messages:        s.sign_messages ?? false,\n    sign_delimiter:       s.sign_delimiter ?? ''\n  };\n})() }}","type":"object"},{"id":"92edb1f3-4c01-43c1-ab66-5bae3b88272a","name":"contact.contact_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.contact_inbox?.contact_id ??\n  0\n}}","type":"number"},{"id":"e058c51f-71a0-43f3-8cae-448a8c1ccfb2","name":"contact.identifier","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.identifier ??\n  ''\n}}","type":"string"},{"id":"bd2a4034-caa8-4a5e-96dc-1d44dd6dc107","name":"contact.lid","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.sender?.additional_attributes?.contact_lid ??\n  ''\n}}","type":"string"},{"id":"5c9147af-3eba-4ca4-9112-205261f7a4cc","name":"contact.phone_number","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.phone_number ??\n  ''\n}}","type":"string"},{"id":"4832617f-aafc-4cbf-8fa5-e2502deb7143","name":"contact.full_name","value":"={{\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation?.meta?.sender?.name ||\n    ''\n  )\n  .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n  .trim()\n  ||\n  'Contato'\n}}","type":"string"},{"id":"4a7df58d-d6f7-42ba-a09d-5b04910c0555","name":"contact.first_name","value":"={{\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.name ||\n    ''\n  )\n  .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n  .trim()\n  .split(/\\s+/)[0] ||\n  'Contato'\n}}","type":"string"},{"id":"feb8da01-d39a-4571-a215-c93f838b1cd6","name":"contact.middle_name","value":"={{ \n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.name ||\n    ''\n  )\n  .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n  .trim()\n  .split(/\\s+/)\n  .slice(1, -1)\n  .join(' ') ||\n  ''\n}}","type":"string"},{"id":"13f61b17-5053-42d7-a613-ac7ab0cfabc3","name":"contact.last_name","value":"={{ \n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation.meta?.sender?.name ||\n    ''\n  )\n  .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n  .trim()\n  .split(/\\s+/)\n  .slice(-1)[0] ||\n  ''\n}}","type":"string"},{"id":"23e6b810-0252-4617-bf33-5ef2a8bdb715","name":"data.message_type","value":"={{ \n  $('webhookDataChatwoot')?.item?.json.body?.conversation.messages?.[0]?.content_type ??\n  ''\n}}","type":"string"},{"id":"cfba5c5e-18cf-4f29-9840-561c1f5a2be8","name":"data.content","value":"={{\n(() => {\n  const b = $('webhookDataChatwoot')?.item?.json?.body ?? {};\n  const isCsat =\n    b.content_attributes?.content_type === 'input_csat' ||\n    b.content_type === 'input_csat';\n\n  // 1. Pega o texto original do Chatwoot\n  const txt = isCsat\n    ? b.content\n    : (b.conversation?.messages?.[0]?.content ?? '');\n\n  // 2. Inicia a cadeia de limpeza e conversÃ£o\n  const convertedTxt = String(txt)\n    // =================================================================\n    // 2.1. BLOCO DE LIMPEZA DE CARACTERES\n    // Remove caracteres invisÃ­veis e normaliza espaÃ§os/quebras de linha\n    // ANTES de aplicar a lÃ³gica de Markdown.\n    // =================================================================\n    \n    // (REMOVER) Caracteres de controle obsoletos\n    .replace(/\\t/g, ' ')    // TabulaÃ§Ã£o Horizontal\n    .replace(/\\v/g, '')     // TabulaÃ§Ã£o Vertical\n    .replace(/\\f/g, '')     // Form Feed (quebra de pÃ¡gina)\n    \n    // (REMOVER) Caracteres \"invisÃ­veis\" comuns de copy-paste\n    .replace(/\\u200B/g, '') // Zero-Width Space\n    .replace(/\\uFEFF/g, '') // Byte Order Mark (BOM)\n    \n    // (NORMALIZAR) Quebras de linha (Windows/Mac -> Unix)\n    // Converte \\r\\n (Windows) e \\r (Mac) para \\n (Unix)\n    // Isso simplifica a conversÃ£o de markdown e o escape final.\n    .replace(/\\r\\n/g, '\\n')\n    .replace(/\\r/g, '\\n')\n        \n    // (NORMALIZAR) EspaÃ§os \"falsos\"\n    // Converte o \"Non-Breaking Space\" (comum em HTML/Word) \n    // para um espaÃ§o comum.\n    .replace(/\\u00A0/g, ' ') \n    \n    // =================================================================\n    // 2.2. BLOCO DE CONVERSÃƒO MARKDOWN (Chatwoot -> WhatsApp)\n    // A ordem aqui Ã© crucial para evitar conflitos.\n    // =================================================================\n    \n    // Links: [Texto do Link](url) -> Texto do Link (url)\n    // O WhatsApp nÃ£o suporta links mascarados, entÃ£o \"desmontamos\" eles.\n    .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '$1 ($2)')\n    \n    // Negrito (Chatwoot -> Marcador TemporÃ¡rio): **texto** -> @@BOLD@@texto@@BOLD@@\n    // Usamos um marcador para nÃ£o conflitar com o itÃ¡lico.\n    .replace(/\\*\\*(.*?)\\*\\*/g, '@@BOLD@@$1@@BOLD@@')\n    \n    // ItÃ¡lico (Chatwoot -> WhatsApp): *texto* -> _texto_\n    // Agora podemos converter o itÃ¡lico sem medo.\n    .replace(/\\*(.*?)\\*/g, '_$1_')\n    \n    // Riscado (Chatwoot -> WhatsApp): ~~texto~~ -> ~texto~\n    .replace(/~~(.*?)~~/g, '~$1~')\n    \n    // CÃ³digo (Chatwoot -> WhatsApp): `texto` -> ```texto```\n    // Converte o \"cÃ³digo\" inline do Chatwoot para o \"monoespaÃ§ado\" do WhatsApp.\n    .replace(/`(.*?)`/g, '```$1```')\n    \n    // Finaliza o Negrito (Marcador TemporÃ¡rio -> WhatsApp): @@BOLD@@ -> *\n    // Agora convertemos nosso marcador para o formato final do WhatsApp.\n    .replace(/@@BOLD@@/g, '*');\n\n  // =================================================================\n  // 3. BLOCO DE ESCAPE PARA JSON\n  // Prepara o texto final para ser inserido em um campo JSON.\n  // =================================================================\n  return convertedTxt\n    // 3.1. Escapa barras invertidas (deve ser o PRIMEIRO)\n    .replace(/\\\\/g, '\\\\\\\\')\n    \n    // 3.2. Escapa quebras de linha (agora sÃ³ temos \\n graÃ§as Ã  normalizaÃ§Ã£o)\n    .replace(/\\n/g, '\\\\n')\n    \n    // 3.3. Escapa aspas duplas\n    .replace(/\"/g, '\\\\\"');\n})()\n}}","type":"string"},{"id":"e4dd23d8-5edd-47b1-8cd6-6781e3d3cd8f","name":"data.direction","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.message_type ??\n  ''\n}}","type":"string"},{"id":"6d663b17-95eb-43bd-ab52-7ba010c5c5a9","name":"data.conversation_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.id ||\n  0\n}}","type":"number"},{"id":"53ee35f4-904a-4ba4-822c-9121e9a7a37a","name":"data.sender","value":"={{ (() => {\n  const mode = $('getVariables')?.item?.json?.sign_messages_mode\n  const assignee = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.meta?.assignee;\n  const sender = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.sender;\n  let signatureName = '';\n  if (mode === 'assigned_name' && assignee) {\n    signatureName = assignee.name || '';\n  } else if (mode === 'assigned_display_name' && assignee) {\n    signatureName = assignee.available_name || assignee.name || '';\n  } else if (mode === 'logged_name' && sender) {\n    signatureName = sender.name || '';\n  } else if (mode === 'logged_display_name' && sender) {\n    signatureName = sender.available_name || sender.name || '';\n  } else {\n    signatureName = '';\n  }\n  return signatureName;\n})() }}","type":"string"},{"id":"e1ec8f48-5b4f-4a89-8959-81673f82c33d","name":"data.message_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.id ??\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.messages?.[0]?.id ??\n  0\n}}","type":"number"},{"id":"f69ec58f-0da7-45b7-b627-2dc82fc80710","name":"data.source_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.source_id ??\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.source_id ??\n  ''\n}}","type":"string"},{"id":"9d2180ef-94d4-40cf-90df-e073d84bbf3b","name":"data.reply_id","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.content_attributes?.in_reply_to_external_id ??\n  ''\n}}","type":"string"},{"id":"e583d428-c4a5-4342-b898-5491fabd52cc","name":"data.status","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation?.status ??\n  ''\n}}","type":"string"},{"id":"f27ee0aa-d24e-4660-bd9e-387c1791a9a9","name":"data.event_type","value":"={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event ??\n  ''\n}}","type":"string"},{"id":"f5b05f21-2a5a-4761-ad6e-6bd7073f422f","name":"data.attachments","value":"={{(() => {\n  const attachments = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.attachments ?? [];\n  \n  // Se nÃ£o houver anexos, retorna um array vazio\n  if (attachments.length === 0) return [];\n\n  // Mapeia todos os attachments do Chatwoot\n  return attachments.map((att, index) => ({\n    data_url: att.data_url,\n    file_type: att.file_type.replace('file','document').replace('audio','ptt'),\n    filename: decodeURIComponent(att.data_url?.split('/')?.pop() ?? 'file'),\n  }));\n})()}}","type":"array"},{"id":"6ede662e-f7fb-415b-ad12-d6792eda567b","name":"data.created_at","value":"={{(() => {\n  const ts = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.created_at;\n  if (!ts) return null; // Evita erro se o valor nÃ£o existir\n  const timestamp = Number(ts) * 1000; // Converte de segundos para milissegundos\n  return new Date(timestamp).toISOString();\n})()}}","type":"string"}]},"options":{}},"id":"50cf6c8a-02d8-4209-98ad-92b14a62f78a","name":"normalizedData","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-432,-704],"retryOnFail":true},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[240,-400],"typeVersion":1,"id":"89b4dbe1-8ace-418f-afc3-043a70589d85","name":"Sticky Note12"},{"parameters":{"content":"### Postgres Cwt","height":176,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[944,-240],"typeVersion":1,"id":"80bfed3a-ed12-4e83-b833-ce3316baadf9","name":"Sticky Note13"},{"parameters":{"jsCode":"const item = $('processedData')?.first()?.json;\n\n// Extrai o array de attachments do item atual\nconst attachmentsArray = item?.data?.attachments ?? [];\n\nreturn attachmentsArray.map((att, index) => ({\n  currentAttachment: {\n    data_url: att.data_url,\n    file_type: att.file_type,\n    filename: att.filename,\n    content: index === 0 ? $input?.first()?.json?.data.content : '',\n    item: index\n  },\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-256,-208],"id":"b3c3cb65-f4e0-444e-ad7f-546c5241487f","name":"messageMediaSplit"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-80,-208],"id":"b460aef0-674f-4e69-b321-3764c86942c8","name":"messageMediaLoop"},{"parameters":{"operation":"executeQuery","query":"WITH deleted_attachments AS (\n  DELETE FROM attachments\n  WHERE message_id = $1::integer\n  AND id != (\n      SELECT MIN(id)\n      FROM attachments\n      WHERE message_id = $1::integer\n  )\n  RETURNING id\n)\nSELECT COUNT(*) AS total_attachments_removed\nFROM deleted_attachments;","options":{"queryReplacement":"={{ [\n  String($('processedData')?.item?.json?.data?.message_id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[96,-288],"id":"a63a39ed-14e1-486a-aa14-d52b2b2268dc","name":"messageMediaRemove","executeOnce":true,"alwaysOutputData":true,"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.api?.base_url }}/message/find","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('normalizedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"number\": \"{{ $('normalizedData')?.item?.json?.contact?.identifier }}\",\n  \"id\": \"{{ $('processedData')?.item?.json?.data?.source_id }}\"\n}","options":{}},"id":"029c7f68-efd0-496a-b1a7-71c9c805c25b","name":"messageDeletedFind","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-432,160],"retryOnFail":true},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Pega o item atual\nconst item = $input?.item;\nconst root = item.json ?? {};\nconst msg  = root.messages?.[0] ?? {};\nconst c    = msg.content ?? {};\n\n// =================================================================\n// 1. FUNÃ‡ÃƒO AUXILIAR: ConversÃ£o de Markdown (WhatsApp -> Chatwoot)\n// =================================================================\nconst convertMarkdown = (text) => {\n  if (typeof text !== 'string' || !text) {\n    return '';\n  }\n\n  return text\n    // --- LIMPEZA ---\n    .replace(/\\t/g, ' ')\n    .replace(/\\v/g, '')\n    .replace(/\\f/g, '')\n    .replace(/\\u200B/g, '')\n    .replace(/\\uFEFF/g, '')\n    .replace(/\\r/g, '')\n    .replace(/\\u00A0/g, ' ')\n    // --- CONVERSÃƒO MARKDOWN ---\n    .replace(/```(.*?)```/gs, '`$1`') // MonoespaÃ§ado\n    .replace(/\\*(.*?)\\*/gs, '**$1**') // Negrito\n    .replace(/_(.*?)_/gs, '*$1*')     // ItÃ¡lico\n    .replace(/~(.*?)~/gs, '~~$1~~');  // Riscado\n};\n\n// =================================================================\n// 2. FUNÃ‡ÃƒO AUXILIAR: FormataÃ§Ã£o de Moeda\n// =================================================================\nconst formatCurrency = (value, offset, currencyCode = 'BRL') => {\n  if (value === undefined || value === null) return '';\n\n  const divisor   = offset || 1000;\n  const realValue = value / divisor;\n\n  if (realValue === 0) return 'Valor a ser definido';\n\n  try {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: currencyCode,\n    }).format(realValue);\n  } catch (e) {\n    return `${currencyCode} ${realValue.toFixed(2)}`;\n  }\n};\n\n// =================================================================\n// 3. FORMATTERS (BOTÃ•ES, LISTAS, ENQUETE, CONTATO, ETC.)\n// =================================================================\nconst formatters = {\n  // BotÃµes\n  buttons: () => {\n    const header = convertMarkdown(c?.header?.title ?? '');\n    const body   = convertMarkdown(c?.body?.text ?? '');\n    const footer = convertMarkdown(c?.footer?.text ?? '');\n    \n    const buttonsArray = c?.InteractiveMessage?.NativeFlowMessage?.buttons ?? [];\n    \n    const options = buttonsArray.map(btn => {\n      let params;\n      try {\n        params = JSON.parse(btn.buttonParamsJSON ?? '{}');\n      } catch (e) {\n        params = {};\n      }\n\n      const text = convertMarkdown(params.display_text ?? 'BotÃ£o');\n\n      if (btn.name === 'cta_url' && params.url) {\n        return `* [${text}](${params.url}) ðŸ”—`;\n      }\n      \n      if (btn.name === 'cta_call' && params.phone_number) {\n        return `* ${text} (${params.phone_number}) ðŸ“ž`;\n      }\n      \n      return `* ${text}`;\n    }).join('\\n');\n\n    const direction   = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸ”˜ _Mensagem com BotÃµes (${direction}):_`;\n    const tipFooter   = !msg.fromMe\n      ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`\n      : '';\n\n    return `${headerTitle}\\n\\n---\\n\\n${header}\\n\\n${body}\\n\\n${footer}\\n\\n${options}${tipFooter}`;\n  },\n\n  // Listas\n  list: () => {\n    const direction   = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸ“‹ _Mensagem com Lista (${direction}):_`;\n    const tipFooter   = !msg.fromMe\n      ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`\n      : '';\n\n    const description = convertMarkdown(c?.description ?? 'Lista');\n    const footer      = convertMarkdown(c?.footerText ?? '');\n    const button      = convertMarkdown(c?.buttonText ?? '');\n    const sections    = c?.sections ?? [];\n\n    const options = sections.map(section => {\n      const sectionTitle = `\\n**${convertMarkdown(section.title ?? 'SeÃ§Ã£o')}**`;\n      \n      const rows = (section.rows ?? []).map(row => {\n        const rowTitle = convertMarkdown(row.title ?? 'OpÃ§Ã£o');\n        const rowDesc  = convertMarkdown(row.description ?? '');\n        \n        if (rowDesc) {\n          return `* **${rowTitle}** - _${rowDesc}_`;\n        }\n        return `* **${rowTitle}**`;\n      }).join('\\n');\n      \n      return `${sectionTitle}\\n${rows}`;\n    }).join('\\n');\n\n    return `${headerTitle}\\n\\n---\\n\\n` +\n           `**${description}**\\n\\n` +\n           `*Texto do BotÃ£o:* ${button}\\n` +\n           `${options}\\n\\n` +\n           `_${footer}_` +\n           `${tipFooter}`;\n  },\n\n  // Enquetes\n  poll: () => {\n    const pollData = c?.pollCreationMessageV3 ?? c?.pollCreationMessage;\n    if (!pollData) return 'Erro ao processar enquete.';\n\n    const question = convertMarkdown(pollData.name ?? 'Enquete');\n    \n    const options = (pollData.options ?? [])\n      .map((opt, index) => {\n        const optionText = convertMarkdown(opt.optionName ?? 'OpÃ§Ã£o');\n        return `${index + 1}. ${optionText}`;\n      })\n      .join('\\n'); \n\n    const count  = pollData.selectableOptionsCount ?? 0;\n    const footer = (count === 0)\n      ? `_(Permitido votar em mÃºltiplas opÃ§Ãµes)_`\n      : `_(Permitido votar em ${count} opÃ§Ã£o${count > 1 ? 's' : ''})_`;\n\n    const direction   = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸ“Š _Enquete ${direction}:_`;\n    \n    const tipFooter = !msg.fromMe\n      ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`\n      : '';\n\n    return `${headerTitle}\\n\\n---\\n\\n**${question}**\\n\\n${options}\\n\\n${footer}${tipFooter}`;\n  },\n\n  // Contatos (vCard Ãºnico ou mÃºltiplo)\n  contacts: () => {\n    const parseVCard = (vcardString, displayName) => {\n      const getVCardField = (field) => {\n        const match = vcardString.match(new RegExp(`^${field}(?:;.*)?:([^\\\\n\\\\r]+)`, 'm'));\n        return match && match[1] ? match[1].replace(/;$/, '').trim() : null;\n      };\n      const getVCardPhones = () => {\n        const phoneMatches = [...vcardString.matchAll(/TEL.*:([^\\n\\\\r]+)/g)];\n        return phoneMatches.map(match => match[1].trim());\n      };\n\n      const name   = convertMarkdown(displayName ?? 'Contato');\n      const org    = getVCardField('ORG');\n      const email  = getVCardField('EMAIL');\n      const url    = getVCardField('URL');\n      const phones = getVCardPhones();\n\n      const card = [`**${name}**`];\n      if (org)   card.push(`ðŸ¢ ${convertMarkdown(org)}`);\n      phones.forEach(phone => card.push(`ðŸ“ž ${convertMarkdown(phone)}`));\n      if (email) card.push(`ðŸ“§ ${convertMarkdown(email)}`);\n      if (url)   card.push(`ðŸŒ [${convertMarkdown(url)}](${url})`);\n\n      return card.join('\\n');\n    };\n\n    let vcards = [];\n\n    if (msg.messageType === 'ContactsArrayMessage') {\n      const contactsArray = c.contacts ?? [];\n      vcards = contactsArray.map(contact =>\n        parseVCard(contact.vcard, contact.displayName)\n      );\n    } else if (msg.messageType === 'ContactMessage') {\n      vcards = [parseVCard(c.vcard ?? '', c.displayName ?? 'Contato')];\n    }\n\n    if (vcards.length === 0) return 'Erro ao processar contato.';\n\n    const count = vcards.length;\n    const title = count > 1 ? 'Contatos' : 'Contato';\n    let headerTitle;\n\n    if (msg.fromMe) {\n      headerTitle = `ðŸ‘¤ _${title} Enviado${count > 1 ? 's' : ''}:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ‘¤ _${title} Recebido${count > 1 ? 's' : ''}_ (de **${senderName}**):`;\n    }\n\n    return `${headerTitle}\\n\\n---\\n\\n${vcards.join('\\n\\n---\\n\\n')}`;\n  },\n\n  // Evento (Agendamento)\n  event: () => {\n    const name        = convertMarkdown(c?.name ?? 'Evento');\n    const description = convertMarkdown(c?.description ?? '');\n    const location    = convertMarkdown(c?.location?.name ?? '');\n    const joinLink    = c?.joinLink ?? '';\n\n    const formatTimestamp = (timestamp) => {\n      if (!timestamp || timestamp === 0) return null;\n      const date = new Date(timestamp * 1000);\n      return date.toLocaleString('pt-BR', {\n        day: '2-digit', month: '2-digit', year: 'numeric',\n        hour: '2-digit', minute: '2-digit',\n        timeZone: 'America/Sao_Paulo'\n      });\n    };\n\n    const formattedStartTime = formatTimestamp(c?.startTime);\n    const formattedEndTime   = formatTimestamp(c?.endTime);\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ“† _Evento Criado:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ“† _Evento Recebido_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n\\n**${name}**`];\n\n    if (description) card.push(`*${description}*`);\n\n    const details = [];\n    if (formattedStartTime) details.push(`ðŸ“† **InÃ­cio:** ${formattedStartTime}`);\n    if (formattedEndTime)   details.push(`ðŸ“† **Fim:** ${formattedEndTime}`);\n    if (location)           details.push(`ðŸ“ **Local:** ${location}`);\n\n    if (joinLink) {\n      if (joinLink.includes('/video/')) {\n        details.push(`ðŸ“¹ [Entrar na Chamada de VÃ­deo](${joinLink})`);\n      } else if (joinLink.includes('/audio/') || joinLink.includes('/voice/')) {\n        details.push(`ðŸ“ž [Entrar na Chamada de Voz](${joinLink})`);\n      } else {\n        details.push(`ðŸ”— [Link para o Evento](${joinLink})`);\n      }\n    }\n\n    if (details.length > 0) {\n      card.push(`\\n${details.join('\\n')}`);\n    }\n\n    if (c?.isCanceled === true) {\n      card.push(`\\n\\n**-- EVENTO CANCELADO --**`);\n    }\n\n    return card.join('\\n');\n  },\n\n  // Produtos\n  product: () => {\n    const product = c?.product;\n    if (!product) return 'Erro ao processar produto.';\n\n    const title       = convertMarkdown(product.title ?? 'Produto');\n    const description = convertMarkdown(product.description ?? '');\n    const productLink = product.URL ?? '';\n    const imageURL    = product.productImage?.URL ?? '';\n\n    const currency   = product.currencyCode ?? 'BRL';\n    const price      = formatCurrency(product.priceAmount1000,     1000, currency);\n    const salePrice  = formatCurrency(product.salePriceAmount1000, 1000, currency);\n    \n    let priceString = '';\n    if (salePrice && salePrice !== 'Valor a ser definido') {\n      priceString = `\\n**${salePrice}** (de ~~${price}~~)`;\n    } else if (price && price !== 'Valor a ser definido') {\n      priceString = `\\n**${price}**`;\n    }\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ›’ _Produto Enviado:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ›’ _Produto Recebido_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    if (imageURL) card.push(`![Imagem do Produto](${imageURL})\\n`);\n\n    card.push(`**${title}**`);\n    if (description) card.push(`*${description}*`);\n    if (priceString) card.push(priceString);\n    if (productLink) card.push(`\\n[Ver Produto na Loja](${productLink}) ðŸ”—`);\n\n    return card.join('\\n');\n  },\n\n  // CatÃ¡logo\n  catalog: () => {\n    const title       = convertMarkdown(c?.title ?? 'CatÃ¡logo');\n    const description = convertMarkdown(c?.description ?? '');\n    const text        = convertMarkdown(c?.text ?? '');\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ§¾ _CatÃ¡logo Enviado:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ§¾ _CatÃ¡logo Recebido_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    card.push(`**${title}**`);\n    if (description) card.push(`\\n*${description}*`);\n    if (text)        card.push(`\\n${text}`);\n\n    return card.join('\\n');\n  },\n\n  // PIX estÃ¡tico (botÃ£o)\n  pix: (params) => {\n    const pixData    = params.payment_settings?.[0]?.pix_static_code ?? {};\n    const amountData = params.total_amount ?? {};\n    const currency   = params.currency ?? 'BRL';\n\n    const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\n    const pixKey       = convertMarkdown(pixData.key ?? 'Chave nÃ£o informada');\n    const keyType      = convertMarkdown(pixData.key_type ?? '');\n    const amount       = formatCurrency(amountData.value, amountData.offset, currency);\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Enviada):_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Recebida de **${senderName}**):_`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    card.push(`**Valor:** ${amount}`);\n    card.push(`\\n**Recebedor:** ${merchantName}`);\n    card.push(`**Chave PIX:** \\`${pixKey}\\` (${keyType})`);\n\n    if (!msg.fromMe) {\n      card.push(`\\n_Dica: Para pagar, copie a chave PIX e use o app do seu banco._`);\n    }\n\n    return card.join('\\n');\n  },\n\n  // Carrinho (PIX dinÃ¢mico / mÃºltiplos itens)\n  cart: (params) => {\n    const currency = params.currency ?? 'BRL';\n    const order    = params.order ?? {};\n    const items    = order.items ?? [];\n\n    const itemsString = items.map(itemProduct => {\n      const name     = convertMarkdown(itemProduct.name ?? 'Item');\n      const quantity = itemProduct.quantity ?? 1;\n      const price    = formatCurrency(\n        itemProduct.amount?.value,\n        itemProduct.amount?.offset,\n        currency\n      );\n      return `* ${quantity}x ${name} (${price})`;\n    }).join('\\n');\n\n    const subtotal = formatCurrency(order.subtotal?.value, order.subtotal?.offset, currency);\n    const discount = formatCurrency(order.discount?.value, order.discount?.offset, currency);\n    const total    = formatCurrency(params.total_amount?.value, params.total_amount?.offset, currency);\n\n    const pixSettings = params.payment_settings?.[0] ?? {};\n    const pixData     = pixSettings.pix_static_code ?? pixSettings.pix_dynamic_code ?? {};\n    const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\n    const pixKey       = convertMarkdown(pixData.key ?? pixData.code ?? 'Chave nÃ£o informada');\n    const keyType      = convertMarkdown(pixData.key_type ?? (pixSettings.type === 'pix_dynamic_code' ? 'DinÃ¢mico' : ''));\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ›’ _Pedido Enviado:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ›’ _Novo Pedido Recebido_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n\\n**Resumo do Pedido:**\\n`];\n\n    const bodyText = convertMarkdown(c?.body?.text ?? '');\n    if (bodyText) card.push(`*${bodyText}*\\n`);\n\n    card.push(itemsString);\n\n    const totals = [];\n    if (subtotal) totals.push(`**Subtotal:** ${subtotal}`);\n    if (discount && order.discount?.value > 0) {\n      totals.push(`**Desconto:** ${discount}`);\n    }\n    if (total) totals.push(`**Total:** **${total}**`);\n\n    if (totals.length > 0) {\n      card.push(`\\n${totals.join('\\n')}`);\n    }\n\n    if (pixKey !== 'Chave nÃ£o informada') {\n      card.push(`\\n**Para Pagar (PIX):**`);\n      card.push(`**Recebedor:** ${merchantName}`);\n      card.push(`**Chave PIX:** \\`${pixKey}\\` (${keyType})`);\n    }\n\n    if (!msg.fromMe) {\n      card.push(`\\n_Dica: Para pagar, copie a chave PIX e use o app do seu banco._`);\n    }\n\n    return card.join('\\n');\n  },\n\n  // LocalizaÃ§Ã£o estÃ¡tica\n  location: () => {\n    const lat     = c?.degreesLatitude;\n    const long    = c?.degreesLongitude;\n    const name    = convertMarkdown(c?.name ?? '');\n    const address = convertMarkdown(c?.address ?? '');\n\n    let mapLink = '';\n    if (lat && long) {\n      mapLink = `https://maps.google.com/?q=${lat},${long}`;\n    }\n\n    let headerTitle;\n    if (msg.fromMe) {\n      headerTitle = `ðŸ“ _LocalizaÃ§Ã£o Enviada:_`;\n    } else {\n      const senderName = msg?.senderName ?? 'Contato';\n      headerTitle = `ðŸ“ _LocalizaÃ§Ã£o Recebida_ (de **${senderName}**):`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    if (name)    card.push(`**${name}**`);\n    if (address) card.push(`*${address}*`);\n\n    const details = [];\n    if (lat)  details.push(`**Latitude:** \\`${lat}\\``);\n    if (long) details.push(`**Longitude:** \\`${long}\\``);\n\n    if (details.length > 0) {\n      if (name || address) {\n        card.push(`\\n${details.join('\\n')}`);\n      } else {\n        card.push(details.join('\\n'));\n      }\n    }\n\n    if (mapLink) {\n      if (name || address || lat || long) {\n        card.push(`\\n[Ver LocalizaÃ§Ã£o no Google Maps](${mapLink}) ðŸŒ`);\n      } else {\n        card.push(`[Ver LocalizaÃ§Ã£o no Google Maps](${mapLink}) ðŸŒ`);\n      }\n    }\n\n    return card.join('\\n');\n  },\n\n  // LocalizaÃ§Ã£o em tempo real\n  liveLocation: () => {\n    const lat  = c?.degreesLatitude;\n    const long = c?.degreesLongitude;\n    const comm = c?.caption;\n\n    let mapLink = '';\n    if (lat && long) {\n      mapLink = `https://maps.google.com/?q=${lat},${long}`;\n    }\n\n    let headerTitle;\n    const senderName = msg?.senderName ?? 'Contato';\n\n    if (msg.fromMe) {\n      headerTitle = `ðŸ“ _VocÃª iniciou o compartilhamento de localizaÃ§Ã£o em tempo real._`;\n    } else {\n      headerTitle = `ðŸ“ _${senderName} estÃ¡ compartilhando a localizaÃ§Ã£o em tempo real._`;\n    }\n\n    const card = [`${headerTitle}\\n\\n---\\n`];\n\n    const details = [];\n    if (lat)  details.push(`**Latitude Inicial:** \\`${lat}\\``);\n    if (long) details.push(`**Longitude Inicial:** \\`${long}\\`\\n\\n`);\n    if (comm) details.push(`**ComentÃ¡rio:** ${comm}`);\n\n    if (details.length > 0) {\n      card.push(details.join('\\n'));\n    }\n\n    if (mapLink) {\n      if (details.length > 0) card.push('\\n');\n      card.push(`[Ver a localizaÃ§Ã£o inicial no Google Maps](${mapLink}) ðŸŒ`);\n    }\n\n    card.push(\n      `\\n\\n*A localizaÃ§Ã£o atual e em tempo real nÃ£o pode ser exibida no Chatwoot.*\\n` +\n      `_Acesse o WhatsApp no celular ou web para acompanhar._`\n    );\n\n    return card.join('\\n');\n  },\n\n  // Carrossel\n  carousel: () => {\n    const carouselData = c?.InteractiveMessage?.CarouselMessage;\n    const cards        = carouselData?.cards ?? [];\n    if (cards.length === 0) return 'Erro ao processar carrossel.';\n\n    const mainBody = convertMarkdown(c?.body?.text ?? '');\n\n    const formattedCards = cards.map((card, index) => {\n      const bodyText = convertMarkdown(card?.body?.text ?? '');\n\n      let buttonText = '';\n      const button   = card?.InteractiveMessage?.NativeFlowMessage?.buttons?.[0];\n      if (button) {\n        try {\n          const params = JSON.parse(button.buttonParamsJSON ?? '{}');\n          buttonText   = convertMarkdown(params.display_text ?? 'Ver opÃ§Ã£o');\n        } catch (e) {\n          buttonText = 'Ver opÃ§Ã£o';\n        }\n      }\n\n      const cardParts = [];\n      cardParts.push(`**${index + 1}. ${buttonText}**`);\n\n      if (bodyText) {\n        const bodyLines = bodyText.split('\\n').map(line => `> ${line}`);\n        cardParts.push(bodyLines.join('\\n'));\n      }\n\n      return cardParts.join('\\n');\n    }).join('\\n\\n---\\n\\n');\n\n    const direction   = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸŽ  _Mensagem em Carrossel (${direction}):_`;\n\n    const tipFooter = !msg.fromMe\n      ? `\\n\\n_Dica: Acesse pelo celular ou web para responder._`\n      : '';\n\n    return `${headerTitle}\\n\\n**${mainBody}**\\n\\n${formattedCards}${tipFooter}`;\n  },\n};\n\n// =================================================================\n// 4. PROCESSA CONTEÃšDO EM TEXTO (LÃ“GICA PRINCIPAL)\n// =================================================================\nlet processedContent = '';\n\n// 1. Carrossel\nif (c?.InteractiveMessage?.CarouselMessage) {\n  processedContent = formatters.carousel();\n}\n// 2. Interativa (botÃµes / PIX / carrinho)\nelse if (c?.InteractiveMessage?.NativeFlowMessage) {\n  const button     = c.InteractiveMessage.NativeFlowMessage.buttons?.[0];\n  const buttonName = button?.name;\n\n  let params;\n  try {\n    params = JSON.parse(button?.buttonParamsJSON ?? '{}');\n  } catch (e) {\n    params = {};\n  }\n\n  if (buttonName === 'payment_info') {\n    processedContent = formatters.pix(params);\n  } else if (buttonName === 'review_and_pay') {\n    processedContent = formatters.cart(params);\n  } else {\n    processedContent = formatters.buttons();\n  }\n}\n// 3. Lista\nelse if (c?.sections) {\n  processedContent = formatters.list();\n}\n// 4. Enquete (criaÃ§Ã£o)\nelse if (['PollCreationMessageV3', 'PollCreationMessage'].includes(msg?.messageType)) {\n  processedContent = formatters.poll();\n}\n// 5. Enquete (voto)\nelse if (msg?.messageType === 'PollUpdateMessage') {\n  const voteText = convertMarkdown(msg?.vote ?? '');\n  if (!voteText) {\n    processedContent = '';\n  } else if (msg.fromMe) {\n    processedContent = `ðŸ“¤ _Voto Enviado:_\\n\\n**${voteText}**`;\n  } else {\n    const senderName = msg?.senderName ?? 'Contato';\n    processedContent = `ðŸ“¥ _Voto Recebido_ (de **${senderName}**):\\n\\n**${voteText}**`;\n  }\n}\n// 6. Resposta a botÃ£o/lista\nelse if (msg?.buttonOrListid) {\n  const selectionText = convertMarkdown(String(c?.selectedDisplayText ?? c?.title ?? ''));\n  if (!selectionText) {\n    processedContent = '';\n  } else if (msg.fromMe) {\n    processedContent = `ðŸ“¤ _SeleÃ§Ã£o Enviada:_\\n\\n**${selectionText}**`;\n  } else {\n    const senderName = msg?.senderName ?? 'Contato';\n    processedContent = `ðŸ“¥ _OpÃ§Ã£o Selecionada_ (por **${senderName}**):\\n\\n**${selectionText}**`;\n  }\n}\n// 7. Contatos\nelse if (['ContactMessage', 'ContactsArrayMessage'].includes(msg.messageType)) {\n  processedContent = formatters.contacts();\n}\n// 8. Evento\nelse if (msg?.messageType === 'EventMessage') {\n  processedContent = formatters.event();\n}\n// 9. LocalizaÃ§Ã£o estÃ¡tica\nelse if (msg?.messageType === 'LocationMessage') {\n  processedContent = formatters.location();\n}\n// 10. Produto\nelse if (msg?.messageType === 'ProductMessage') {\n  processedContent = formatters.product();\n}\n// 11. CatÃ¡logo (link)\nelse if (msg?.messageType === 'ExtendedTextMessage' && msg.mediaType === 'cataloglink') {\n  processedContent = formatters.catalog();\n}\n// 12. LocalizaÃ§Ã£o em tempo real\nelse if (msg?.messageType === 'LiveLocationMessage') {\n  processedContent = formatters.liveLocation();\n}\n// 13. ReaÃ§Ãµes\nelse if (msg?.messageType === 'ReactionMessage') {\n  const reactionText = String(msg?.text ?? c?.text ?? '');\n  processedContent   = convertMarkdown(reactionText);\n}\n// 14. MÃ­dia (imagem, vÃ­deo, doc)\nelse if (['ImageMessage','VideoMessage','DocumentMessage'].includes(msg?.messageType)) {\n  const caption = String(c?.caption ?? '');\n  processedContent = convertMarkdown(caption);\n}\n// 15. Texto comum (fallback)\nelse {\n  const commonText = (\n    String(msg?.text ?? '').trim() ||\n    String(msg?.content?.text ?? '').trim() ||\n    ''\n  );\n  processedContent = convertMarkdown(commonText);\n}\n\n// =================================================================\n// 5. TRATAMENTO FINAL PARA DELEÃ‡ÃƒO (MENSAGEM EXCLUÃDA)\n// =================================================================\n\n// Dados originais\nconst deletedMessage     = msg;\nconst originalAttributes = deletedMessage.content_attributes;\nconst sendPayload        = deletedMessage.sendPayload || {};\nconst docName            = sendPayload.docName || '';\nconst rawType            = sendPayload.type || '';\n\n// ConteÃºdo base para riscar\nconst originalContent =\n  processedContent ||\n  deletedMessage.text ||\n  deletedMessage.content?.caption ||\n  deletedMessage.sendPayload?.text ||\n  '';\n\n// Parse dos atributos\nlet parsedAttributes = {};\nif (typeof originalAttributes === 'string') {\n  try {\n    parsedAttributes = JSON.parse(originalAttributes);\n  } catch (e) {\n    parsedAttributes = {};\n  }\n} else if (typeof originalAttributes === 'object' && originalAttributes !== null) {\n  parsedAttributes = originalAttributes;\n}\n\n// Flag de deletado\nparsedAttributes.deleted = true;\nconst newAttributesString = JSON.stringify(parsedAttributes);\n\n// Texto riscado\nlet textPart = '';\nif (originalContent && String(originalContent).trim().length > 0) {\n  textPart = String(originalContent).replace(/([^\\r\\n]+)/g, '~~$1~~');\n}\n\n// Info de arquivo\nlet filePart = '';\n\n// TIPOS que realmente representam mÃ­dia/arquivo\nconst allowedTypes = ['image', 'video', 'audio', 'ptt', 'file', 'document'];\n\nif (rawType && allowedTypes.includes(rawType)) {\n  const typeMap = {\n    image:    'Imagem',\n    video:    'VÃ­deo',\n    audio:    'Ãudio',\n    ptt:      'Ãudio',\n    file:     'Documento',\n    document: 'Documento',\n  };\n\n  const translatedType = typeMap[rawType] || rawType;\n  filePart = `\\n\\nðŸ“Ž *${translatedType}*: ${docName ? '~~' + docName + '~~' : ''}`;\n}\n\n// Novo conteÃºdo final\nconst newContent =\n  'ðŸš« _Mensagem excluÃ­da_: ' +\n  (textPart ? '\\n\\n' + textPart : '') +\n  filePart;\n\n// Resolve o message_id (tenta em vÃ¡rios lugares, incluindo o node \"processedData\")\nconst messageIdFromProcessed =\n  $('processedData')?.item?.json?.data?.message_id ?? null;\n\nconst messageId =\n  root?.data?.message_id ??\n  root?.message_id ??\n  deletedMessage?.message_id ??\n  messageIdFromProcessed ??\n  null;\n\n// =================================================================\n// 6. RETORNO DO ITEM\n// =================================================================\nitem.json = {\n  message_id:              messageId,\n  new_content:             newContent,\n  new_attributes:          newAttributesString,\n  original_rendered_content: processedContent,\n};\n\nreturn item;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-256,160],"id":"6f4eb2d2-84e9-4556-99f3-eb4bfb04722a","name":"messageDeletedPrepare"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"67b615a4-6620-4878-a354-1b740d8970e2","leftValue":"={{ $('processedData')?.item?.json?.data?.direction }}","rightValue":"outgoing","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-80,160],"id":"3cfd82ff-990f-4290-9220-94cf12ffa2bd","name":"messageDeleteVerify"},{"parameters":{"method":"POST","url":"={{ $('normalizedData')?.item?.json?.api.base_url }}/message/delete","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('normalizedData')?.item?.json?.api?.token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"id\": \"{{ $('processedData')?.item?.json?.data?.source_id }}\"\n}","options":{}},"id":"bf80bc1c-e6de-45b2-ac3a-3cf4724a6ff3","name":"messageDelete","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[96,80],"retryOnFail":true},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/messages/{{ $('messageDeletedPrepare')?.item?.json?.message_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"sent"}]},"options":{}},"id":"8ffe4ea5-5d35-49e3-b00e-cec91b970ca7","name":"messageDeletedPatch","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,160],"retryOnFail":true},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('normalizedData').item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('normalizedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('normalizedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('normalizedData')?.item?.json?.data?.status ?? '' }}"},{"key":"messageId","value":"={{ $('normalizedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('normalizedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('normalizedData')?.item?.json?.data?.direction ?? '' }}"},{"key":"eventType","value":"={{ $('normalizedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[-432,-832],"id":"12c86d2a-291e-440e-a139-bfc4e10ffb83","name":"executionData1"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('processedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('processedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('processedData')?.item?.json?.contact.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('processedData').item.json.data.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('processedData')?.item?.json?.data?.status ?? '' }}"},{"key":"messageId","value":"={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('processedData')?.item?.json?.data?.direction ?? '' }}"},{"key":"eventType","value":"={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[-784,-240],"id":"e4e6d506-0649-494f-8412-c0d98483fde3","name":"executionData2"},{"parameters":{"dataToSave":{"values":[{"key":"baseUrl","value":"={{ $('processedData')?.item?.json?.chatwoot?.base_url ?? '' }}"},{"key":"accountId","value":"={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"},{"key":"inboxId","value":"={{ $('processedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"},{"key":"contactId","value":"={{ $('processedData')?.item?.json?.contact?.contact_id ?? '' }}"},{"key":"contactIdentifier","value":"={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"},{"key":"conversationId","value":"={{ $('processedData')?.item?.json?.data?.conversation_id ?? '' }}"},{"key":"conversationStatus","value":"={{ $('processedData')?.item?.json?.data?.status ?? '' }}"},{"key":"messageId","value":"={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"},{"key":"messageType","value":"={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"},{"key":"messageDirection","value":"={{ $('processedData')?.item?.json?.data?.direction ?? '' }}"},{"key":"eventType","value":"={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"}]}},"type":"n8n-nodes-base.executionData","typeVersion":1.1,"position":[1136,-528],"id":"d6a493c9-cfe0-4a18-a44c-9515aee1ba45","name":"executionData3"},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/messages/{{ $('processedData')?.item?.json?.data?.message_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"delivered"}]},"options":{}},"id":"c3117332-6482-4237-9f22-34aa47d1cb32","name":"messageEditedDelivered","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[448,-368],"retryOnFail":true},{"parameters":{"method":"PATCH","url":"={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/messages/{{ $('processedData')?.item?.json?.data?.message_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"api_access_token","value":"={{ $('processedData')?.item?.json?.chatwoot?.token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"status","value":"sent"}]},"options":{}},"id":"011da69d-4d06-4295-828b-14e766c92696","name":"messageEditedSent","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[624,-368],"retryOnFail":true}],"connections":{"messageVerify":{"main":[[{"node":"messageTextSend","type":"main","index":0}],[{"node":"messageMediaSplit","type":"main","index":0}]]},"webhookDataChatwoot":{"main":[[{"node":"getVariables","type":"main","index":0}]]},"getVariables":{"main":[[{"node":"messageTypeFilter","type":"main","index":0}]]},"messageDeletedUpdate":{"main":[[{"node":"messageDeletedPatch","type":"main","index":0}]]},"messageSentVerify":{"main":[[{"node":"messageVerify","type":"main","index":0}],[{"node":"messageDeletedFind","type":"main","index":0}]]},"messageTypeFilter":{"main":[[{"node":"normalizedData","type":"main","index":0}]]},"contactCreate":{"main":[[{"node":"contactIdentify","type":"main","index":0}]]},"contactFind":{"main":[[{"node":"contactAction","type":"main","index":0}]]},"contactUpdate":{"main":[[{"node":"contactIdentify","type":"main","index":0}]]},"contactIdentify":{"main":[[{"node":"processedData","type":"main","index":0}]]},"contactValidation":{"main":[[{"node":"contactVerify","type":"main","index":0}]]},"contactAction":{"main":[[{"node":"contactCreate","type":"main","index":0}],[{"node":"contactIdentify","type":"main","index":0}],[{"node":"contactUpdate","type":"main","index":0}]]},"contactVerify":{"main":[[{"node":"contactFind","type":"main","index":0}],[{"node":"contactMessage","type":"main","index":0}]]},"identifierVerify":{"main":[[{"node":"contactFind","type":"main","index":0}],[{"node":"contactFind","type":"main","index":0}],[{"node":"contactValidation","type":"main","index":0}],[{"node":"contactValidation","type":"main","index":0}]]},"contactMessage":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"messageTextSend":{"main":[[{"node":"messageTextUpdate","type":"main","index":0}]]},"messageMediaSend":{"main":[[{"node":"messageMediaVerify","type":"main","index":0}]]},"messageMediaFields":{"main":[[{"node":"messageMediaSend","type":"main","index":0}]]},"createMessageInChatwoot":{"main":[[{"node":"messageMediaUpdate","type":"main","index":0}]]},"messageMediaDownload":{"main":[[{"node":"createMessageInChatwoot","type":"main","index":0}]]},"messageMediaVerify":{"main":[[{"node":"messageMediaDownload","type":"main","index":0}],[{"node":"messageMediaLoop","type":"main","index":0}]]},"messageMediaUpdate":{"main":[[{"node":"messageMediaLoop","type":"main","index":0}]]},"messageTextUpdate":{"main":[[{"node":"messageEditedDelivered","type":"main","index":0}]]},"processedData":{"main":[[{"node":"messageSentVerify","type":"main","index":0},{"node":"executionData2","type":"main","index":0}]]},"normalizedData":{"main":[[{"node":"identifierVerify","type":"main","index":0},{"node":"executionData1","type":"main","index":0}]]},"messageMediaSplit":{"main":[[{"node":"messageMediaLoop","type":"main","index":0}]]},"messageMediaLoop":{"main":[[{"node":"messageMediaRemove","type":"main","index":0}],[{"node":"messageMediaFields","type":"main","index":0}]]},"messageMediaRemove":{"main":[[{"node":"messageTextUpdate","type":"main","index":0}]]},"messageDeletedFind":{"main":[[{"node":"messageDeletedPrepare","type":"main","index":0}]]},"messageDeletedPrepare":{"main":[[{"node":"messageDeleteVerify","type":"main","index":0}]]},"messageDeleteVerify":{"main":[[{"node":"messageDelete","type":"main","index":0}],[{"node":"messageDeletedUpdate","type":"main","index":0}]]},"messageDelete":{"main":[[{"node":"messageDeletedUpdate","type":"main","index":0}]]},"messageDeletedPatch":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"endProcess":{"main":[[{"node":"executionData3","type":"main","index":0}]]},"messageEditedDelivered":{"main":[[{"node":"messageEditedSent","type":"main","index":0}]]},"messageEditedSent":{"main":[[{"node":"endProcess","type":"main","index":0}]]}},"authors":"system migration","name":null,"description":null,"autosaved":false},"tags":[{"updatedAt":"2025-11-16T22:16:21.421Z","createdAt":"2025-11-16T22:16:21.421Z","id":"aawu1QmRhGC0eQOa","name":"Uazapi"},{"updatedAt":"2025-11-20T17:34:44.792Z","createdAt":"2025-11-20T17:34:44.792Z","id":"RhIrKuplA6oJB0ck","name":"Premium"},{"updatedAt":"2025-11-20T17:34:44.828Z","createdAt":"2025-11-20T17:34:44.828Z","id":"ffkEJ4KMIqqIHfFo","name":"Chatwoot"}]}