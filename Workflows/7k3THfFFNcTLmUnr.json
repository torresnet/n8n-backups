{"updatedAt":"2025-11-22T13:50:32.486Z","createdAt":"2025-11-20T17:35:53.188Z","id":"7k3THfFFNcTLmUnr","name":"[EMKT] Settings Database v1.0.1-Premium","active":true,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[64,2064],"id":"39c70610-cb61-4c38-bc29-87f40412cc2f","name":"executeManually","disabled":true},{"parameters":{"html":"<!doctype html>\n<html lang=\"pt-BR\">\n\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n  <title>Integração Chatwoot x UaZapi - Configuração</title>\n  <script src=\"https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4\"></script>\n  <style>\n    .card {\n      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05)\n    }\n\n    .btn {\n      padding: .5rem .75rem;\n      border-radius: .5rem;\n      font-size: .875rem;\n      line-height: 1rem;\n      cursor: pointer;\n      font-weight: 500\n    }\n\n    .btn:disabled {\n      opacity: .6;\n      cursor: not-allowed\n    }\n\n    .btn-secondary {\n      background: #e2e8f0;\n      color: #0f172a\n    }\n\n    .btn-secondary:hover:not(:disabled) {\n      background: #cbd5e1\n    }\n\n    .btn-primary {\n      background: #16a34a;\n      color: #fff\n    }\n\n    .btn-primary:hover:not(:disabled) {\n      background: #15803d\n    }\n\n    .btn-warn {\n      background: #f59e0b;\n      color: #111827\n    }\n\n    .btn-warn:hover:not(:disabled) {\n      background: #d97706\n    }\n\n    .tbl tr {\n      cursor: pointer\n    }\n\n    .tbl tr:hover {\n      background: #f8fafc\n    }\n\n    .tabs {\n      display: flex;\n      gap: .25rem;\n      padding: .25rem\n    }\n\n    .tab-btn {\n      appearance: none;\n      border: 1px solid #cbd5e1;\n      border-bottom: none;\n      background: #f1f5f9;\n      color: #475569;\n      padding: .5rem .75rem;\n      font-size: .875rem;\n      line-height: 1rem;\n      border-top-left-radius: .5rem;\n      border-top-right-radius: .5rem;\n      cursor: pointer\n    }\n\n    .tab-btn:hover {\n      background: #e2e8f0;\n      color: #0f172a\n    }\n\n    .tab-btn[aria-selected=\"true\"] {\n      background: #fff;\n      color: #0f172a;\n      box-shadow: inset 0 -3px 0 #16a34a;\n      position: relative;\n      z-index: 1\n    }\n\n    .tab-rail {\n      border-bottom: 1px solid #cbd5e1;\n      background: #f8fafc;\n      border-top-left-radius: .5rem;\n      border-top-right-radius: .5rem\n    }\n\n    .tab-panel {\n      display: none\n    }\n\n    .tab-panel.active {\n      display: block\n    }\n\n    .modal-body {\n      max-height: min(70vh, 800px);\n      overflow: auto\n    }\n\n    @media (max-width:640px) {\n      .modal-body {\n        max-height: 70vh\n      }\n    }\n\n    .modal-body::after {\n      content: '';\n      display: block;\n      height: 1.5rem\n    }\n\n    .toggle {\n      position: relative;\n      width: 44px;\n      height: 24px\n    }\n\n    .toggle input {\n      appearance: none;\n      width: 44px;\n      height: 24px;\n      border-radius: 999px;\n      background: #cbd5e1;\n      outline: none;\n      cursor: pointer;\n      transition: background .15s\n    }\n\n    .toggle input:checked {\n      background: #16a34a\n    }\n\n    .toggle .dot {\n      position: absolute;\n      top: 3px;\n      left: 3px;\n      width: 18px;\n      height: 18px;\n      border-radius: 999px;\n      background: #fff;\n      transition: transform .15s\n    }\n\n    .toggle input:checked+.dot {\n      transform: translateX(20px)\n    }\n\n    .field {\n      position: relative;\n      border: 1px solid #e2e8f0;\n      border-radius: .5rem;\n      padding: .5rem .75rem;\n      background: #fff\n    }\n\n    .help {\n      font-size: .8rem;\n      color: #64748b\n    }\n\n    .req::after {\n      content: \" *\";\n      color: #dc2626;\n      font-weight: 600\n    }\n\n    .tip-err {\n      margin-top: .25rem;\n      background: #fff7ed;\n      color: #92400e;\n      border: 1px solid #fcd34d;\n      padding: .4rem .6rem;\n      border-radius: .5rem;\n      font-size: .85rem;\n      display: flex;\n      align-items: center;\n      gap: .4rem\n    }\n\n    .tip-err svg {\n      width: 18px;\n      height: 18px\n    }\n\n    .field.err {\n      border-color: #fca5a5\n    }\n\n    input::placeholder,\n    textarea::placeholder {\n      color: #94a3b8;\n      opacity: 1;\n    }\n  </style>\n</head>\n\n<body class=\"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900\">\n  <main class=\"max-w-4xl mx-auto px-6 py-10\">\n    <h1 class=\"text-3xl font-semibold tracking-tight mb-1\">Integração Chatwoot x UaZapi</h1>\n    <div id=\"top-banner\" class=\"hidden\"></div>\n\n    <section id=\"setup-view\" class=\"card rounded-xl border bg-white overflow-hidden\"\n      style=\"{{ ($('checkTableData')?.item?.json?.tableExists && !$('checkTableData')?.item?.json?.needsMigration) ? 'display:none;' : '' }}\">\n\n      <div id=\"setup-create-content\" style=\"{{ $('checkTableData')?.item?.json?.tableExists ? 'display:none;' : '' }}\">\n\n        <div class=\"flex items-start gap-4 p-6 border-b\">\n          <div class=\"h-12 w-12 shrink-0 rounded-full bg-amber-100 flex items-center justify-center\">\n            <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-amber-700\" viewBox=\"0 0 24 24\" fill=\"none\"\n              stroke=\"currentColor\">\n              <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\n                d=\"M12 9v2m0 4h.01M12 19a7 7 0 100-14 7 7 0 000 14z\" />\n            </svg>\n          </div>\n\n          <div>\n            <h2 class=\"text-lg font-semibold text-amber-800\">Tabela de configuração não encontrada!</h2>\n            <p class=\"mt-1 text-slate-600\">A tabela <strong>{{ $('checkTableData')?.item?.json?.database?.schema\n                }}.{{ $('checkTableData')?.item?.json?.database?.table_name }}</strong> não existe. Deseja\n              criá-la agora?</p>\n\n          </div>\n        </div>\n\n        <div class=\"mx-6 mt-6 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg p-3\">\n          <div class=\"flex items-start gap-1.5\">\n            <svg class=\"h-5 w-5 shrink-0 text-amber-500 mt-0.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\"\n              aria-hidden=\"true\">\n              <path fill-rule=\"evenodd\"\n                d=\"M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.593c.74 1.316-.206 2.958-1.742 2.958H3.48c-1.536 0-2.482-1.642-1.741-2.958L8.257 3.1zM11 14a1 1 0 10-2 0 1 1 0 002 0zm-.25-6.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5z\"\n                clip-rule=\"evenodd\" />\n            </svg>\n            <div>\n              <strong>Atenção:</strong>\n              A VERSÃO DO SCHEMA não necessariamente precisa ser igual a versão do <strong>Kit de\n                Integração</strong>. Quando for necessário alterar, já informaremos a nova versão automaticamente.\n            </div>\n          </div>\n        </div>\n        <div class=\"p-6 grid gap-4 sm:grid-cols-[2fr_2fr_1fr]\">\n\n          <div class=\"rounded-lg bg-slate-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-slate-500\">SCHEMA</div>\n            <div class=\"mt-1 font-medium text-slate-900\">{{ $('checkTableData')?.item?.json?.database?.schema }}\n            </div>\n          </div>\n          <div class=\"rounded-lg bg-slate-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-slate-500\">TABELA</div>\n            <div class=\"mt-1 font-medium text-slate-900\">{{\n              $('checkTableData')?.item?.json?.database?.table_name }}</div>\n          </div>\n          <div class=\"rounded-lg bg-emerald-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-emerald-600 whitespace-nowrap\">VERSÃO DO SCHEMA\n            </div>\n            <div class=\"mt-1 font-medium text-emerald-800\">{{ $('checkTableData')?.item?.json?.expected_version\n              }}</div>\n          </div>\n        </div>\n\n      </div>\n      <div class=\"p-6 border-t flex flex-wrap gap-2 items-center\">\n        <form id=\"frmCreateDb\" class=\"flex gap-2 items-center\">\n          <input type=\"hidden\" name=\"action\" value=\"create\">\n          <input type=\"hidden\" name=\"schema\" value=\"{{ $('checkTableData')?.item?.json?.database?.schema }}\">\n          <input type=\"hidden\" name=\"table_name\" value=\"{{ $('checkTableData')?.item?.json?.database?.table_name }}\">\n          <input type=\"hidden\" name=\"version\" value=\"{{ $('checkTableData')?.item?.json?.database?.version}}\">\n          <button type=\"submit\" class=\"btn btn-warn\" id=\"btnCreateTable\">Criar Tabela Agora</button>\n        </form>\n      </div>\n      </div>\n\n      <div id=\"setup-migrate-content\"\n        style=\"{{ !($('checkTableData')?.item?.json?.tableExists && $('checkTableData')?.item?.json?.needsMigration) ? 'display:none;' : '' }}\">\n        <div class=\"flex items-start gap-4 p-6 border-b\">\n          <div class=\"h-12 w-12 shrink-0 rounded-full bg-blue-100 flex items-center justify-center\">\n            <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-blue-700\" fill=\"none\" viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\" stroke-width=\"2\">\n              <path stroke-linecap=\"round\" stroke-linejoin=\"round\"\n                d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15\" />\n            </svg>\n          </div>\n          <div>\n            <h2 class=\"text-lg font-semibold text-blue-800\">Atualização de Schema Necessária!</h2>\n            <p class=\"mt-1 text-slate-600\">\n              A estrutura da tabela <strong>{{ $('checkTableData')?.item?.json?.database?.schema }}.{{\n                $('checkTableData')?.item?.json?.database?.table_name }}</strong> precisa ser atualizada.\n            </p>\n            <div class=\"mt-2 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg p-3\">\n              <div class=\"flex items-start gap-1.5\">\n                <svg class=\"h-5 w-5 shrink-0 text-amber-500 mt-0.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\"\n                  aria-hidden=\"true\">\n                  <path fill-rule=\"evenodd\"\n                    d=\"M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.593c.74 1.316-.206 2.958-1.742 2.958H3.48c-1.536 0-2.482-1.642-1.741-2.958L8.257 3.1zM11 14a1 1 0 10-2 0 1 1 0 002 0zm-.25-6.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5z\"\n                    clip-rule=\"evenodd\" />\n                </svg>\n                <div>\n                  <strong>Atenção:</strong>\n                  Se precisar manter a versão atual (<strong>{{\n                    $('checkTableData')?.item?.json?.current_db_version || 'N/A' }}</strong>), você\n                  deverá reverter este workflow para uma versão compatível. Prosseguir atualizará o\n                  banco de dados para a versão <strong>{{\n                    $('checkTableData')?.item?.json?.expected_version }}</strong>.\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class=\"p-6 grid gap-4 sm:grid-cols-[2fr_2fr_1fr_1fr]\">\n          <div class=\"rounded-lg bg-slate-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-slate-500\">SCHEMA</div>\n            <div class=\"mt-1 font-medium text-slate-900\">{{ $('checkTableData')?.item?.json?.database?.schema }}\n            </div>\n          </div>\n          <div class=\"rounded-lg bg-slate-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-slate-500\">TABELA</div>\n            <div class=\"mt-1 font-medium text-slate-900\">{{\n              $('checkTableData')?.item?.json?.database?.table_name }}</div>\n          </div>\n          <div class=\"rounded-lg bg-red-50 border border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-red-600 whitespace-nowrap\">VERSÃO ATUAL</div>\n            <div class=\"mt-1 font-medium text-red-800\">{{ $('checkTableData')?.item?.json?.current_db_version\n              || 'N/A' }}</div>\n          </div>\n          <div class=\"rounded-lg bg-emerald-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-emerald-600 whitespace-nowrap\">VERSÃO ESPERADA\n            </div>\n            <div class=\"mt-1 font-medium text-emerald-800\">{{ $('checkTableData')?.item?.json?.expected_version\n              }}</div>\n          </div>\n        </div>\n        <div class=\"p-6 border-t flex flex-wrap gap-2 items-center\">\n          <form id=\"frmUpdateSchema\" class=\"flex gap-2 items-center\">\n            <input type=\"hidden\" name=\"action\" value=\"migrate\">\n            <input type=\"hidden\" name=\"schema\" value=\"{{ $('checkTableData')?.item?.json?.database?.schema }}\">\n            <input type=\"hidden\" name=\"table_name\" value=\"{{ $('checkTableData')?.item?.json?.database?.table_name }}\">\n            <input type=\"hidden\" name=\"target_version\" value=\"{{ $('checkTableData')?.item?.json?.expected_version }}\">\n            <input type=\"hidden\" name=\"version\" value=\"{{ $('checkTableData')?.item?.json?.database?.version}}\">\n            <button type=\"submit\" class=\"btn btn-primary\" id=\"btnUpdateSchema\">Atualizar Schema\n              Agora</button>\n          </form>\n        </div>\n      </div>\n\n      <div id=\"setup-banner\" class=\"hidden mx-6 mb-4\"></div>\n    </section>\n\n    <section id=\"config-view\" class=\"card rounded-xl border bg-white overflow-hidden\"\n      style=\"{{ !($('checkTableData')?.item?.json?.tableExists && !$('checkTableData')?.item?.json?.needsMigration) ? 'display:none;' : '' }}\">\n\n      <header class=\"p-5 flex items-center justify-between border-b\">\n        <div>\n          <h2 class=\"text-xl font-semibold tracking-tight\">Configurar Instâncias</h2>\n          <div class=\"text-sm text-slate-600 mt-1\">Schema: <strong>{{\n              $('checkTableData')?.item?.json?.database?.schema }}</strong> • Tabela: <strong>{{\n              $('checkTableData')?.item?.json?.database?.table_name }}</strong></div>\n        </div>\n        <div class=\"flex gap-2\"><button id=\"btnAdd\" class=\"btn btn-primary\">Incluir instância</button></div>\n      </header>\n      <div\n        class=\"mx-5 mt-4 flex items-start gap-3 rounded-lg border border-amber-300 bg-amber-50 px-3 py-2 text-sm text-amber-900\"\n        role=\"alert\">\n        <svg class=\"h-5 w-5 shrink-0 text-amber-500 mt-0.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\" aria-hidden=\"true\">\n          <path fill-rule=\"evenodd\"\n            d=\"M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.593c.74 1.316-.206 2.958-1.742 2.958H3.48c-1.536 0-2.482-1.642-1.741-2.958L8.257 3.1zM11 14a1 1 0 10-2 0 1 1 0 002 0zm-.25-6.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5z\"\n            clip-rule=\"evenodd\" />\n        </svg>\n        <p><span class=\"font-medium\">Dê um <em>duplo-clique</em></span> sobre a linha que quer editar ou clique\n          em <span class=\"italic\"><strong>Incluir instância</strong></span>.</p>\n      </div>\n      <div class=\"p-5\">\n        <div class=\"mb-3 flex flex-wrap items-center gap-3\">\n          <label class=\"text-sm text-slate-600\">Registros por página<select id=\"pageSize\"\n              class=\"ml-2 rounded-md border px-2 py-1\">\n              <option value=\"10\" selected>10</option>\n              <option value=\"20\">20</option>\n              <option value=\"50\">50</option>\n              <option value=\"100\">100</option>\n            </select></label>\n          <div class=\"text-sm text-slate-500\" id=\"rangeInfo\">Exibindo 0–0 de 0</div>\n          <div class=\"ml-auto flex items-center gap-2\"><button id=\"prevBtn\"\n              class=\"btn btn-secondary\">Anterior</button><span id=\"pageInfo\" class=\"text-sm text-slate-600\">Página\n              1/1</span><button id=\"nextBtn\" class=\"btn btn-secondary\">Próxima</button></div>\n        </div>\n        <div id=\"emptyState\" class=\"rounded-lg border bg-slate-50 p-6 text-center\" style=\"display: none;\">\n          <p class=\"text-slate-600 mb-3\">Nenhuma instância cadastrada.</p><button id=\"btnAddEmpty\"\n            class=\"btn btn-primary\">Incluir instância</button>\n        </div>\n        <div class=\"overflow-x-auto\">\n          <table id=\"grid\" class=\"tbl hidden w-full text-left text-sm border-separate border-spacing-y-2\"\n            style=\"display: none;\">\n            <thead>\n              <tr class=\"text-slate-500\">\n                <th class=\"px-3\">ID</th>\n                <th class=\"px-3\">Instance Name</th>\n                <th class=\"px-3\">Inbox Name</th>\n                <th class=\"px-3\">Account#</th>\n                <th class=\"px-3\">Inbox#</th>\n                <th class=\"px-3\">Atualizado</th>\n              </tr>\n            </thead>\n            <tbody id=\"tbody\"></tbody>\n          </table>\n        </div>\n      </div>\n    </section>\n    <p class=\"mt-6 text-center text-xs text-slate-500\">\n      Disponibilizado por <strong>{{ $('checkTableData')?.item?.json?.automation?.branding }}</strong>\n      <span class=\"ml-1\">|</span>\n      <span class=\"ml-1\">Kit de Integração v{{ $('checkTableData')?.item?.json?.database?.kitVersion }}, Schema v{{\n        $('checkTableData')?.item?.json?.database?.version }}</span>\n    </p>\n  </main>\n\n  <script>\n    // === VARIÁVEIS GLOBAIS ===\n    const CHECK = {{ JSON.stringify($('checkTableData')?.item?.json) }};\n    const INSTANCES = {{ JSON.stringify(($('checkTableData')?.item?.json?.instances) || []) }};\n    const SCHEMA = \"{{ $('checkTableData')?.item?.json?.database?.schema }}\";\n    const TABLE = \"{{ $('checkTableData')?.item?.json?.database?.table_name }}\";\n    const VERSION = \"{{ $('checkTableData')?.item?.json?.database?.version }}\";\n    const WEBHOOK_URL = \"/webhook/{{ $('checkTableData')?.item?.json?.webhook.path }}\";\n\n    // === HELPERS ===\n    const ls = { get(k) { try { return window.localStorage.getItem(k); } catch { return null; } }, set(k, v) { try { window.localStorage.setItem(k, v); } catch { } }, del(k) { try { window.localStorage.removeItem(k); } catch { } } };\n\n    function showBanner(id, kind, text) {\n      const el = document.getElementById(id);\n      if (!el) return;\n      const ICONS = { ok: `<svg class=\"h-5 w-5 text-emerald-600\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" /></svg>`, warn: `<svg class=\"h-5 w-5 text-amber-600\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z\" /></svg>`, error: `<svg class=\"h-5 w-5 text-red-600\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\" /></svg>` };\n      const iconHtml = ICONS[kind] || ICONS.error;\n      const colorClass = kind === 'error' ? 'border-red-300 bg-red-50 text-red-900' : kind === 'warn' ? 'border-amber-300 bg-amber-50 text-amber-900' : 'border-emerald-300 bg-emerald-50 text-emerald-900';\n      el.className = `mx-6 my-3 rounded-lg border px-4 py-3 text-sm ${colorClass}`;\n      el.innerHTML = `<div class=\"flex items-start gap-3\"><div class=\"shrink-0 mt-0.5\">${iconHtml}</div><div class=\"flex-1\">${text}</div></div>`;\n      el.classList.remove('hidden');\n    }\n\n    function showTopBanner(kind, text) {\n      const el = document.getElementById('top-banner');\n      if (!el) return;\n      const colorClass = kind === 'ok' ? 'border-emerald-300 bg-emerald-50 text-emerald-800' : kind === 'warn' ? 'border-amber-300 bg-amber-50 text-amber-800' : 'border-red-300 bg-red-50 text-red-800';\n      el.className = `mx-0 mb-4 rounded-lg border px-3 py-2 text-sm ${colorClass}`;\n      el.textContent = text;\n      el.classList.remove('hidden');\n    }\n\n    // === MODAL DE CONFIRMAÇÃO DE EXCLUSÃO (Global) ===\n    function showConfirmationModal() {\n      return new Promise((resolve, reject) => {\n        const modalHtml = `\n                <div id=\"confirm-modal-backdrop\" class=\"fixed inset-0 z-[60] grid place-items-center bg-black/40 p-4\">\n                  <div class=\"w-full max-w-md rounded-xl border bg-white card p-6 text-center\">\n                    <div class=\"mx-auto h-12 w-12 shrink-0 rounded-full bg-amber-100 flex items-center justify-center\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-amber-700\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01M12 19a7 7 0 100-14 7 7 0 000 14z\" />\n                      </svg>\n                    </div>\n                    <h2 class=\"text-lg font-semibold mt-4\">Confirmar Exclusão</h2>\n                    <p class=\"mt-2 text-slate-600\">Tem certeza que deseja excluir esta instância? A ação não poderá ser desfeita.</p>\n                    <div class=\"mt-6 flex justify-center gap-3\">\n                      <button type=\"button\" id=\"btnCancelDelete\" class=\"btn btn-secondary\">Cancelar</button>\n                      <button type=\"button\" id=\"btnConfirmDelete\" class=\"btn btn-warn\">Sim, Excluir</button>\n                    </div>\n                  </div>\n                </div>`;\n        const wrap = document.createElement('div');\n        wrap.innerHTML = modalHtml;\n        document.body.appendChild(wrap);\n        const backdrop = wrap.querySelector('#confirm-modal-backdrop');\n        const btnCancel = wrap.querySelector('#btnCancelDelete');\n        const btnConfirm = wrap.querySelector('#btnConfirmDelete');\n        const cleanup = () => {\n          document.removeEventListener('keydown', handleEsc);\n          wrap.remove();\n        };\n        const handleEsc = (e) => {\n          if (e.key === 'Escape') {\n            cleanup();\n            reject();\n          }\n        };\n        btnCancel.addEventListener('click', () => {\n          cleanup();\n          reject();\n        });\n        btnConfirm.addEventListener('click', () => {\n          cleanup();\n          resolve();\n        });\n        backdrop.addEventListener('click', (e) => {\n          if (e.target.id === 'confirm-modal-backdrop') {\n            cleanup();\n            reject();\n          }\n        });\n        document.addEventListener('keydown', handleEsc);\n        btnConfirm.focus();\n      });\n    }\n\n    // === MODAL DE CONFIRMAÇÃO DE MIGRAÇÃO (Global) ===\n    function showMigrationConfirmationModal() {\n      return new Promise((resolve, reject) => {\n        const modalHtml = `\n              <div id=\"migrate-confirm-modal-backdrop\" class=\"fixed inset-0 z-[60] grid place-items-center bg-black/40 p-4\">\n                <div class=\"w-full max-w-md rounded-xl border bg-white card p-6 text-center\">\n                   <div class=\"mx-auto h-12 w-12 shrink-0 rounded-full bg-blue-100 flex items-center justify-center\">\n                     <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-blue-700\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\">\n                       <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15\" />\n                     </svg>\n                   </div>\n                   <h2 class=\"text-lg font-semibold mt-4\">Confirmar Atualização do Schema</h2>\n                   <p class=\"mt-2 text-slate-600\">\n                     Tem certeza que deseja atualizar a estrutura do banco de dados para a versão <strong>${CHECK.expected_version}</strong>?\n                     Esta ação pode alterar ou remover colunas existentes.\n                   </p>\n                   <div class=\"mt-6 flex justify-center gap-3\">\n                     <button type=\"button\" id=\"btnCancelMigrate\" class=\"btn btn-secondary\">Cancelar</button>\n                     <button type=\"button\" id=\"btnConfirmMigrate\" class=\"btn btn-primary\">Sim, Atualizar Schema</button>\n                   </div>\n                 </div>\n              </div>`;\n        const wrap = document.createElement('div');\n        wrap.innerHTML = modalHtml;\n        document.body.appendChild(wrap);\n        const backdrop = wrap.querySelector('#migrate-confirm-modal-backdrop');\n        const btnCancel = wrap.querySelector('#btnCancelMigrate');\n        const btnConfirm = wrap.querySelector('#btnConfirmMigrate');\n        const cleanup = () => {\n          document.removeEventListener('keydown', handleEsc);\n          wrap.remove();\n        };\n        const handleEsc = (e) => {\n          if (e.key === 'Escape') {\n            cleanup();\n            reject();\n          }\n        };\n        btnCancel.addEventListener('click', () => {\n          cleanup();\n          reject();\n        });\n        btnConfirm.addEventListener('click', () => {\n          cleanup();\n          resolve();\n        });\n        backdrop.addEventListener('click', (e) => {\n          if (e.target.id === 'migrate-confirm-modal-backdrop') {\n            cleanup();\n            reject();\n          }\n        });\n        document.addEventListener('keydown', handleEsc);\n        btnConfirm.focus();\n      });\n    }\n\n    // === INICIALIZAÇÃO ===\n    document.addEventListener('DOMContentLoaded', () => {\n      if (ls.get('cw:uazapi:justCreated') === '1' && CHECK?.tableExists && !CHECK?.needsMigration) {\n        ls.del('cw:uazapi:justCreated'); showTopBanner('ok', 'Tabela criada com sucesso!');\n      }\n      if (ls.get('cw:uazapi:justMigrated') === '1' && CHECK?.tableExists && !CHECK?.needsMigration) {\n        ls.del('cw:uazapi:justMigrated'); showTopBanner('ok', `Schema atualizado para v${CHECK.expected_version}!`);\n      }\n      document.getElementById('frmCreateDb')?.addEventListener('submit', handleCreateDbSubmit);\n      document.getElementById('frmUpdateSchema')?.addEventListener('submit', handleUpdateSchemaSubmit);\n\n      const configView = document.getElementById('config-view');\n      if (configView && configView.style.display !== 'none') {\n        initList();\n      }\n    });\n\n    // === HANDLERS PARA SETUP VIEW ===\n    async function handleCreateDbSubmit(e) {\n      e.preventDefault();\n      const btn = document.getElementById('btnCreateTable');\n      btn.disabled = true;\n      btn.textContent = 'Criando...';\n\n      try {\n        const fd = new FormData(e.target);\n        fd.set('action', 'create');\n        const res = await fetch(WEBHOOK_URL, {\n          method: 'POST',\n          body: fd,\n          headers: { 'Accept': 'application/json' }\n        });\n\n        let data = {};\n        try {\n          data = await res.json();\n        } catch { }\n\n        if (!res.ok) {\n          throw new Error(data.friendlyMessage || 'Falha ao criar a tabela.');\n        }\n\n        // Função anônima para atualizar a UI para o estado de \"Sucesso\"\n        (() => {\n          const header = document.querySelector('#setup-view .border-b');\n          if (header) {\n            const iconWrap = header.querySelector('.h-12');\n            if (iconWrap) {\n              iconWrap.classList.remove('bg-amber-100');\n              iconWrap.classList.add('bg-emerald-100');\n              const svg = iconWrap.querySelector('svg');\n              if (svg) {\n                svg.outerHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-emerald-700\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"/></svg>`;\n              }\n            }\n            const h2 = header.querySelector('h2');\n            if (h2) {\n              h2.className = 'text-lg font-semibold text-emerald-800';\n              h2.textContent = 'Tudo certo!';\n            }\n            const p = header.querySelector('p');\n            if (p) {\n              p.innerHTML = `O banco de dados <strong>${SCHEMA}.${TABLE}</strong> já existe e está pronto para uso.`;\n            }\n          }\n          btn.textContent = 'Criado!';\n          btn.disabled = true;\n        })();\n\n        // HTML para o banner de sucesso pós-criação\n        const bannerHtml = `\n      <div class=\"flex items-start gap-3\">\n        <div class=\"flex-1\">\n          <p class=\"font-medium\">Tabela criada com sucesso!</p>\n          <p class=\"mt-1 text-slate-700\">Você pode criar uma instância modelo ou ir direto para o gerenciador.</p>\n          <div class=\"mt-3 flex items-center gap-3\">\n            <span class=\"text-sm\">Criar instância modelo</span>\n            <label class=\"toggle\">\n              <input id=\"seedToggle\" type=\"checkbox\" />\n              <span class=\"dot\"></span>\n            </label>\n          </div>\n          <div class=\"mt-4\">\n            <button id=\"goManagerBtn\" class=\"btn btn-primary\" type=\"button\">Ir para o Gerenciador</button>\n          </div>\n        </div>\n      </div>`;\n\n        showBanner('setup-banner', 'ok', bannerHtml);\n\n        // Adiciona o listener ao novo botão \"Ir para o Gerenciador\"\n        document.getElementById('goManagerBtn')?.addEventListener('click', async (ev) => {\n          ev.currentTarget.disabled = true;\n          ev.currentTarget.textContent = 'Processando...';\n\n          if (document.getElementById('seedToggle')?.checked) {\n            try {\n              await seedDefaultInstance();\n            } catch { }\n          }\n\n          ls.set('cw:uazapi:justCreated', '1');\n          (window.top || window).location.replace(WEBHOOK_URL);\n        });\n\n      } catch (err) {\n        showBanner('setup-banner', 'error', err.message || 'Ocorreu um erro de rede.');\n        btn.disabled = false;\n        btn.textContent = 'Criar Tabela Agora';\n      }\n    }\n\n    async function handleUpdateSchemaSubmit(e) {\n      e.preventDefault();\n      const btn = document.getElementById('btnUpdateSchema');\n      const originalText = btn.textContent;\n      const bannerId = 'setup-banner';\n\n      try {\n        await showMigrationConfirmationModal();\n      } catch {\n        return;\n      }\n\n      btn.disabled = true;\n      btn.textContent = 'Atualizando Schema...';\n\n      try {\n        const fd = new FormData(e.target);\n        const res = await fetch(WEBHOOK_URL, { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });\n        let data = {};\n        try {\n          data = await res.json();\n        } catch (parseError) {\n          const textResponse = await res.text();\n          if (!res.ok) {\n            throw new Error(data.friendlyMessage || `Falha ao atualizar o schema (HTTP ${res.status}). Resposta: ${textResponse}`);\n          }\n          console.warn(\"Status da resposta OK, mas parse JSON falhou.\");\n        }\n\n        if (!res.ok) {\n          throw new Error(data.friendlyMessage || 'Falha ao atualizar o schema.');\n        }\n\n        ls.set('cw:uazapi:justMigrated', '1');\n        showBanner(bannerId, 'ok', 'Schema atualizado com sucesso! Recarregando página...');\n        setTimeout(() => { (window.top || window).location.replace(WEBHOOK_URL); }, 1500);\n\n      } catch (err) {\n        showBanner(bannerId, 'error', err.message || 'Ocorreu um erro de rede ao tentar atualizar.');\n        btn.disabled = false;\n        btn.textContent = originalText;\n      }\n    }\n\n    async function seedDefaultInstance() {\n      const now = Date.now();\n      const fd = new FormData();\n      fd.set('action', 'upsert');\n      fd.set('schema', SCHEMA);\n      fd.set('table_name', TABLE);\n      fd.set('chatwoot_base_url', 'https://app.chatwoot.com');\n      fd.set('chatwoot_api_version', 'v1');\n      fd.set('chatwoot_token', `cw-token-exemplo-${now}`);\n      fd.set('chatwoot_account_id', '1');\n      fd.set('chatwoot_inbox_id', '1');\n      fd.set('chatwoot_inbox_name', 'Instância Modelo');\n      fd.set('chatwoot_track_id', `track-id-exemplo-${now}`);\n      fd.set('api_base_url', 'https://api.uazapi.com');\n      fd.set('api_token', `uazapi-token-exemplo-${now}`);\n      fd.set('api_instance_name', 'Instância Modelo');\n      fd.set('ignore_groups', 'true');\n      fd.set('reply_messages', 'true');\n      fd.set('edit_messages', 'true');\n      fd.set('delete_messages', 'true');\n      fd.set('reopen_conversation', 'true');\n      fd.set('conversation_pending', 'false');\n      fd.set('import_contacts', 'false');\n      fd.set('import_messages', 'false');\n      fd.set('import_days_limit', '7');\n      fd.set('sign_messages_mode', 'none');\n      fd.set('sign_delimiter', '\\\\n\\\\n');\n      const res = await fetch(WEBHOOK_URL, { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });\n      if (!res.ok) { console.warn('Falha ao criar instância modelo:', await res.json()); }\n    }\n\n    // === LÓGICA DA LISTA E MODAL (CONFIG VIEW) ===\n    function initList() {\n      const DATA = Array.isArray(INSTANCES) ? INSTANCES : [];\n      const tbody = document.getElementById('tbody');\n      const empty = document.getElementById('emptyState');\n      const grid = document.getElementById('grid');\n      const btnAdd = document.getElementById('btnAdd');\n      const btnAddEmpty = document.getElementById('btnAddEmpty');\n      const pageSizeEl = document.getElementById('pageSize');\n      const pageInfo = document.getElementById('pageInfo');\n      const rangeInfo = document.getElementById('rangeInfo');\n      const prevBtn = document.getElementById('prevBtn');\n      const nextBtn = document.getElementById('nextBtn');\n      let page = 1; let pageSize = parseInt(pageSizeEl.value, 10);\n\n      function fmtDate(s) { if (!s) return ''; try { return new Date(s).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }); } catch { return s; } }\n\n      function render() {\n        tbody.innerHTML = ''; const total = DATA.length;\n        if (!total) {\n          empty.style.display = 'block';\n          grid.style.display = 'none';\n          pageInfo.textContent = 'Página 1/1'; rangeInfo.textContent = 'Exibindo 0–0 de 0'; prevBtn.disabled = true; nextBtn.disabled = true; return;\n        }\n        empty.style.display = 'none';\n        grid.style.display = 'table';\n        const pages = Math.max(1, Math.ceil(total / pageSize)); page = Math.min(page, pages); const start = (page - 1) * pageSize; const end = Math.min(start + pageSize, total);\n        DATA.slice(start, end).forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td class=\"px-3 py-2 font-medium text-slate-800\">${r.id}</td><td class=\"px-3 py-2\">${r.api_instance_name ?? ''}</td><td class=\"px-3 py-2\">${r.chatwoot_inbox_name ?? ''}</td><td class=\"px-3 py-2\">${r.chatwoot_account_id ?? ''}</td><td class=\"px-3 py-2\">${r.chatwoot_inbox_id ?? ''}</td><td class=\"px-3 py-2 text-slate-500\">${fmtDate(r.updated_at)}</td>`; tr.addEventListener('dblclick', () => openModal(r)); tbody.appendChild(tr); });\n        pageInfo.textContent = `Página ${page}/${pages}`; rangeInfo.textContent = `Exibindo ${total ? start + 1 : 0}–${end} de ${total}`; prevBtn.disabled = page <= 1; nextBtn.disabled = page >= pages;\n      }\n\n      prevBtn?.addEventListener('click', () => { if (page > 1) { page--; render(); } });\n      nextBtn?.addEventListener('click', () => { if (page < Math.max(1, Math.ceil(DATA.length / pageSize))) { page++; render(); } });\n      pageSizeEl?.addEventListener('change', e => { pageSize = parseInt(e.target.value, 10); page = 1; render(); });\n      btnAdd?.addEventListener('click', () => openModal(null));\n      btnAddEmpty?.addEventListener('click', () => openModal(null));\n      render();\n\n      function activateTab(modal, btn, all) { all.forEach(b => { b.setAttribute('aria-selected', 'false'); b.tabIndex = -1; }); btn.setAttribute('aria-selected', 'true'); btn.tabIndex = 0; btn.focus(); const id = btn.getAttribute('data-tab'); modal.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active')); modal.querySelector('#' + id).classList.add('active'); }\n\n      function openModal(row) {\n        const isEdit = !!row;\n        const v = isEdit ? { ...row } : { chatwoot_base_url: '', chatwoot_api_version: 'v1', chatwoot_token: '', chatwoot_account_id: '', chatwoot_inbox_id: '', chatwoot_inbox_name: '', chatwoot_track_id: '', api_base_url: '', api_token: '', api_instance_name: '', ignore_groups: true, reply_messages: true, edit_messages: true, delete_messages: true, reopen_conversation: true, conversation_pending: false, import_contacts: false, import_messages: false, import_days_limit: 7, sign_messages_mode: 'none', sign_delimiter: '\\\\n\\\\n' };\n        const currentSignMode = v.sign_messages_mode ?? 'none';\n        let delim = v.sign_delimiter ?? '\\\\n\\\\n';\n        if (!['\\\\n\\\\n', '\\\\n', ' '].includes(delim)) delim = '\\\\n\\\\n';\n        const html = `<div class=\"fixed inset-0 z-50 grid place-items-center bg-black/40 p-4\" id=\"modal-backdrop\">\n                        <div class=\"w-full max-w-4xl rounded-xl border bg-white card\">\n                            <form id=\"frm\" novalidate class=\"p-0\">\n                            <input type=\"hidden\" name=\"schema\" value=\"${SCHEMA}\">\n                            <input type=\"hidden\" name=\"table_name\" value=\"${TABLE}\">\n                            <input type=\"hidden\" name=\"id\" value=\"${isEdit ? v.id : ''}\">\n                            <div class=\"px-6 pt-6 pb-4 flex items-start justify-between gap-4 border-b\">\n                                <h2 class=\"text-lg font-semibold\">\n                                ${isEdit ? 'Editar instância' : 'Nova instância'}\n                                ${isEdit ? `<span class=\"ml-2 text-xs font-normal text-slate-500\">ID ${v.id}</span>` : ''}\n                                </h2>\n                                <div class=\"flex gap-2\">\n                                <button type=\"button\" id=\"btnClose\" class=\"btn btn-secondary\">Fechar</button>\n                                ${isEdit ? `<button type=\"submit\" id=\"btnDelete\" class=\"btn btn-warn\">Excluir</button>` : ''}\n                                <button type=\"submit\" id=\"btnUpsert\" class=\"btn btn-primary\">${isEdit ? 'Salvar alterações' : 'Incluir'}</button>\n                                </div>\n                            </div>\n                            <div id=\"modal-banner\" class=\"hidden mx-6 mt-3\"></div>\n\n                            <div class=\"tab-rail px-4 pt-3\">\n                                <div class=\"tabs\" role=\"tablist\" aria-label=\"Seções de configuração\">\n                                <button type=\"button\" data-tab=\"tab-chatwoot\" class=\"tab-btn\" role=\"tab\" aria-selected=\"true\" tabindex=\"0\">Chatwoot</button>\n                                <button type=\"button\" data-tab=\"tab-api\" class=\"tab-btn\" role=\"tab\" aria-selected=\"false\" tabindex=\"-1\">UaZapi</button>\n                                <button type=\"button\" data-tab=\"tab-config\" class=\"tab-btn\" role=\"tab\" aria-selected=\"false\" tabindex=\"-1\">Configurações</button>\n                                </div>\n                            </div>\n\n                            <div class=\"modal-body px-6 pt-4 space-y-6\">\n                                <section id=\"tab-chatwoot\" class=\"tab-panel active\" role=\"tabpanel\">\n                                <div class=\"grid gap-4 md:grid-cols-2\">\n                                    <label class=\"block field\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">Base URL</span>\n                                        <span class=\"help\">Endereço da sua API do Chatwoot</span>\n                                    </div>\n                                    <input name=\"chatwoot_base_url\" required type=\"url\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"https://api.seuchatwoot.com\" value=\"${v.chatwoot_base_url}\">\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">API Version</span>\n                                        <span class=\"help\">Geralmente \"v1\"</span>\n                                    </div>\n                                    <input name=\"chatwoot_api_version\" required class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"v1\" value=\"${v.chatwoot_api_version}\">\n                                    </label>\n\n                                    <label class=\"block field md:col-span-2\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">Token</span>\n                                        <span class=\"help\">Token de acesso obtido no Perfil do Usuário</span>\n                                    </div>\n                                    <input name=\"chatwoot_token\" required type=\"password\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"seu-token-chatwoot\" value=\"${v.chatwoot_token}\">\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">Account ID</span>\n                                        <span class=\"help\">ID da conta no Chatwoot</span>\n                                    </div>\n                                    <input name=\"chatwoot_account_id\" required type=\"number\" min=\"1\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"1\" value=\"${v.chatwoot_account_id}\">\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">Inbox ID</span>\n                                        <span class=\"help\">ID da Caixa de Entrada</span>\n                                    </div>\n                                    <input name=\"chatwoot_inbox_id\" required type=\"number\" min=\"1\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"1\" value=\"${v.chatwoot_inbox_id}\">\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <span class=\"text-xs uppercase text-slate-500\">Inbox name</span>\n                                    <input name=\"chatwoot_inbox_name\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"nome-da-inbox\" value=\"${v.chatwoot_inbox_name}\">\n                                    <div class=\"help mt-1\">Apenas descritivo, para facilitar a identificação.</div>\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <span class=\"text-xs uppercase text-slate-500 req\">Track ID</span>\n                                    <input name=\"chatwoot_track_id\" required type=\"password\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"id-do-chatwoot\" value=\"${v.chatwoot_track_id}\">\n                                    <div class=\"help mt-1\">Installation Identifier, obtido em Settings no SuperAdmin.</div>\n                                    </label>\n                                </div>\n                                </section>\n\n                                <section id=\"tab-api\" class=\"tab-panel\" role=\"tabpanel\">\n                                <div class=\"grid gap-4 md:grid-cols-2\">\n                                    <label class=\"block field md:col-span-2\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">API Base URL</span>\n                                        <span class=\"help\">Endereço do seu Servidor da UaZapi</span>\n                                    </div>\n                                    <input name=\"api_base_url\" required type=\"url\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"https://api.seuservidor.com\" value=\"${v.api_base_url}\">\n                                    </label>\n\n                                    <label class=\"block field md:col-span-2\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">API Token</span>\n                                        <span class=\"help\">Token fornecido no Painel da UaZapi</span>\n                                    </div>\n                                    <input name=\"api_token\" required type=\"password\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"seu-token-api\" value=\"${v.api_token}\">\n                                    </label>\n\n                                    <label class=\"block field md:col-span-2\">\n                                    <span class=\"text-xs uppercase text-slate-500\">Instance name</span>\n                                    <input name=\"api_instance_name\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"minha-instancia\" value=\"${v.api_instance_name}\">\n                                    <div class=\"help mt-1\">Apenas descritivo, para facilitar a identificação.</div>\n                                    </label>\n                                </div>\n                                </section>\n\n                                <section id=\"tab-config\" class=\"tab-panel\" role=\"tabpanel\">\n                                <div class=\"grid gap-4\">\n                                    <div class=\"grid gap-3 md:grid-cols-2 lg:grid-cols-3\">\n                                    ${[\n            ['ignore_groups', 'Ignorar grupos', 'Evita receber mensagens de grupos.'],\n            ['reply_messages', 'Responder mensagens', 'Habilita as respostas de mensagens enviadas ou recebidas.'],\n            ['edit_messages', 'Permitir edição', 'Habilita o recebimento de mensagens editadas.'],\n            ['delete_messages', 'Permitir exclusão', 'Habilita a exclusão de mensagens enviadas ou recebidas.'],\n            ['reopen_conversation', 'Reabrir conversa', 'Reabrir a mesma conversa anterior, que foi marcada como Resolvida.'],\n            ['conversation_pending', 'Abrir como Pendente', 'Abrir uma nova conversa como Pendente.']\n          ].map(([n, l, h]) => `\n                                        <div class=\"field flex items-center justify-between gap-3\">\n                                        <div>\n                                            <div class=\"text-sm font-medium text-slate-800\">${l}</div>\n                                            <div class=\"help\">${h}</div>\n                                        </div>\n                                        <label class=\"toggle\">\n                                            <input type=\"checkbox\" name=\"${n}\" ${v[n] ? 'checked' : ''}/>\n                                            <span class=\"dot\"></span>\n                                        </label>\n                                        </div>`).join('')}\n                                    </div>\n\n                                    <div class=\"grid gap-3 md:grid-cols-3\">\n                                    <div class=\"field flex items-center justify-between gap-3 opacity-60 cursor-not-allowed\">\n                                        <div>\n                                        <div class=\"text-sm font-medium text-slate-800 flex items-center gap-2\">\n                                            Importar contatos\n                                            <span class=\"text-xs font-semibold bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full\">Em breve</span>\n                                        </div>\n                                        <div class=\"help\">Importar contatos na leitura do QrCode.</div>\n                                        </div>\n                                        <label class=\"toggle\">\n                                        <input type=\"checkbox\" name=\"import_contacts\" ${v.import_contacts ? 'checked' : ''} disabled/>\n                                        <span class=\"dot\"></span>\n                                        </label>\n                                    </div>\n\n                                    <div class=\"field flex items-center justify-between gap-3 opacity-60 cursor-not-allowed\">\n                                        <div>\n                                        <div class=\"text-sm font-medium text-slate-800 flex items-center gap-2\">\n                                            Importar mensagens\n                                            <span class=\"text-xs font-semibold bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full\">Em breve</span>\n                                        </div>\n                                        <div class=\"help\">Importar mensagens na leitura do QrCode.</div>\n                                        </div>\n                                        <label class=\"toggle\">\n                                        <input type=\"checkbox\" name=\"import_messages\" ${v.import_messages ? 'checked' : ''} disabled/>\n                                        <span class=\"dot\"></span>\n                                        </label>\n                                    </div>\n\n                                    <label class=\"block field opacity-60 cursor-not-allowed\">\n                                        <div class=\"flex items-center justify-between\">\n                                        <div class=\"text-sm font-medium text-slate-800 flex items-center gap-2\">\n                                            Dias a importar\n                                            <span class=\"text-xs font-semibold bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full\">Em breve</span>\n                                        </div>\n                                        <span class=\"help\">Limitado pelo WhatsApp</span>\n                                        </div>\n                                        <input name=\"import_days_limit\" type=\"number\" min=\"0\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"7\" value=\"${v.import_days_limit}\" disabled>\n                                    </label>\n                                    </div>\n\n                                    <div class=\"grid gap-3 md:grid-cols-2 items-stretch\">\n                                    <label class=\"block field md:col-span-1\">\n                                        <span class=\"text-sm font-medium text-slate-800\">Assinar mensagens</span>\n                                        <select name=\"sign_messages_mode\" class=\"mt-1 w-full rounded-md border px-3 py-2\">\n                                        <option value=\"none\" ${currentSignMode === 'none' ? 'selected' : ''}>Não assinar</option>\n                                        <option value=\"assigned_name\" ${currentSignMode === 'assigned_name' ? 'selected' : ''}>Nome do Agente Atribuído</option>\n                                        <option value=\"assigned_display_name\" ${currentSignMode === 'assigned_display_name' ? 'selected' : ''}>Nome de Exibição do Agente Atribuído</option>\n                                        <option value=\"logged_name\" ${currentSignMode === 'logged_name' ? 'selected' : ''}>Nome do Agente Logado</option>\n                                        <option value=\"logged_display_name\" ${currentSignMode === 'logged_display_name' ? 'selected' : ''}>Nome de Exibição do Agente Logado</option>\n                                        </select>\n                                        <div class=\"help mt-1\">Define qual nome usar (se houver) no início das mensagens.</div>\n                                    </label>\n\n                                    <label class=\"block field md:col-span-1\">\n                                        <span class=\"text-sm font-medium text-slate-800\">Delimitador</span>\n                                        <select name=\"sign_delimiter\" class=\"mt-1 w-full rounded-md border px-3 py-2\">\n                                        <option value=\"\\\\n\\\\n\" ${delim === '\\\\n\\\\n' ? 'selected' : ''}>Pular 2 linhas (\\\\n\\\\n)</option>\n                                        <option value=\"\\\\n\" ${delim === '\\\\n' ? 'selected' : ''}>Pular 1 linha (\\\\n)</option>\n                                        <option value=\" \" ${delim === ' ' ? 'selected' : ''}>Espaço ( )</option>\n                                        </select>\n                                        <div class=\"help mt-1\">Inserido após o nome do Agente, se a assinatura estiver habilitada.</div>\n                                    </label>\n                                    </div>\n                                </div>\n                                </section>\n                            </div>\n                            </form>\n                        </div>\n                        </div>`;\n        const wrap = document.createElement('div'); wrap.innerHTML = html; document.body.appendChild(wrap);\n        const tabs = wrap.querySelectorAll('[data-tab]'); tabs.forEach(btn => btn.addEventListener('click', () => activateTab(wrap, btn, tabs))); tabs.forEach((btn, idx) => btn.addEventListener('keydown', e => { if (e.key === 'ArrowRight') { e.preventDefault(); activateTab(wrap, tabs[(idx + 1) % tabs.length], tabs); } if (e.key === 'ArrowLeft') { e.preventDefault(); activateTab(wrap, tabs[(idx - 1 + tabs.length) % tabs.length], tabs); } }));\n        wrap.querySelector('#btnClose').addEventListener('click', () => wrap.remove());\n        const backdrop = wrap.querySelector('#modal-backdrop'); const dialog = backdrop.firstElementChild; backdrop.addEventListener('click', (e) => { if (e.target === e.currentTarget) { e.preventDefault(); e.stopPropagation(); } }); dialog.addEventListener('click', (e) => e.stopPropagation()); wrap.querySelector('#frm').addEventListener('submit', handleModalSubmit);\n      }\n\n      function clearFieldErrors(form) { form.querySelectorAll('.tip-err').forEach(el => el.remove()); form.querySelectorAll('.field.err').forEach(el => el.classList.remove('err')); }\n\n      function showFieldError(input, msg = 'Preencha este campo.') {\n        const field = input.closest('.field'); if (!field) return; field.classList.add('err'); const tip = document.createElement('div'); tip.className = 'tip-err'; tip.innerHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01M12 19a7 7 0 100-14 7 7 0 000 14z\"/></svg><span>${msg}</span>`; field.appendChild(tip);\n      }\n\n      async function handleModalSubmit(e) {\n        e.preventDefault();\n        const frm = e.target;\n        const submitter = e.submitter;\n        const original = submitter.textContent;\n\n        if (submitter.id === 'btnDelete') {\n          try {\n            await showConfirmationModal(); // Chama a função global\n          } catch {\n            return;\n          }\n        }\n\n        clearFieldErrors(frm);\n        const requiredNames = ['chatwoot_base_url', 'chatwoot_api_version', 'chatwoot_token', 'chatwoot_account_id', 'chatwoot_inbox_id', 'chatwoot_track_id', 'api_base_url', 'api_token'];\n        const invalid = [];\n        requiredNames.forEach(n => {\n          const el = frm.querySelector(`[name=\"${n}\"]`);\n          if (!el) return;\n          const val = (el.value ?? '').toString().trim();\n          if (!val || (el.type === 'number' && Number(val) < 1)) { invalid.push(el); showFieldError(el); }\n        });\n        if (invalid.length) {\n          showBanner('modal-banner', 'warn', 'Alguns campos obrigatórios precisam ser preenchidos.');\n          const first = invalid[0];\n          first.focus({ preventScroll: false });\n          first.scrollIntoView({ behavior: 'smooth', block: 'center' });\n          return;\n        }\n        submitter.disabled = true;\n        submitter.textContent = 'Aguarde…';\n\n        (function () {\n          const bools = ['ignore_groups', 'reply_messages', 'edit_messages', 'delete_messages', 'reopen_conversation', 'conversation_pending', 'import_contacts', 'import_messages'];\n          bools.forEach(n => {\n            const cb = frm.querySelector(`input[name=\"${n}\"]`);\n            if (!cb) return;\n            if (!cb.checked) {\n              const h = document.createElement('input'); h.type = 'hidden'; h.name = n; h.value = 'false'; frm.appendChild(h);\n            } else { cb.value = 'true'; }\n          });\n        })();\n\n        const fd = new FormData(frm);\n        if (submitter.id === 'btnDelete') {\n          fd.set('action', 'delete');\n        } else {\n          fd.set('action', 'upsert');\n        }\n\n        try {\n          const res = await fetch(WEBHOOK_URL, { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });\n          let data = {}; try { data = await res.json(); } catch { }\n          if (!res.ok) {\n            throw new Error(data.friendlyMessage || 'Falha ao processar a solicitação.');\n          }\n          showBanner('modal-banner', 'ok', 'Operação realizada com sucesso. Atualizando…');\n          setTimeout(() => { (window.top || window).location.replace(WEBHOOK_URL); }, 800);\n        } catch (err) {\n          showBanner('modal-banner', 'error', err.message || 'Ocorreu um erro de rede.');\n          submitter.disabled = false;\n          submitter.textContent = original;\n        }\n      }\n    }\n  </script>\n</body>\n\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[1744,432],"id":"46b50260-ee1a-4843-a1a6-1b5cfcc7f7ea","name":"htmlConfig"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"text/html; charset=utf-8"},{"name":"Cache-Control","value":"no-store"}]}}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1920,432],"id":"8efa3d82-b08d-458a-9c4b-895a9aa28fa5","name":"respondConfigUi"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// VALIDAÇÃO DO BASIC AUTH (Function Item / Each item)\n\n// Pega user/pass definidos no node \"setVariables\" (um único registro)\nconst { auth: { user, pass } } = $('setVariables')?.item?.json;\n\n// Monta o header esperado\nconst expected = 'Basic ' + Buffer.from(`${user}:${pass}`).toString('base64');\n\n// Escreve no item atual\n$json.expectedAuth = expected;\n$json.reqAuth = $('setVariables')?.item?.json?.headers?.authorization ?? '';\n\n// Versão do kit de integração\n$json.database.version = '1.0.0';\n\n// Versão do banco de dados\n$json.database.kitVersion = '1.0.1';\n\n// Retorna apenas o item atual (não um array)\nreturn $json;"},"id":"5f39d525-bd55-426c-b22b-2dc49e507112","name":"authHeaderConfig","type":"n8n-nodes-base.code","typeVersion":2,"position":[1216,512]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b150a62e-a3b4-442d-ba6d-5e7f4b718bb9","leftValue":"={{ $('authHeaderConfig')?.item?.json?.reqAuth }}","rightValue":"={{ $('authHeaderConfig')?.item?.json?.expectedAuth }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1392,512],"id":"17c8e17a-ebbb-40fe-8cea-c7c422ef51cb","name":"authVerifyConfig"},{"parameters":{"respondWith":"text","responseBody":"={{ $('noAuthMessage')?.item?.json?.body }}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"WWW-Authenticate","value":"Basic realm=\"Config UI\", charset=\"UTF-8\""},{"name":"Content-Type","value":"text/html; charset=utf-8"},{"name":"Cache-Control","value":"no-store"}]}}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1744,592],"id":"52fd7319-64b9-4e30-a66f-2c55b428084e","name":"respondAuthConfig"},{"parameters":{"operation":"executeQuery","query":"-- INSERT OU UPDATE DA INSTÂNCIA\nWITH\n-- 1) Normaliza os valores recebidos dos parâmetros\nvals AS (\n  SELECT\n    NULLIF($1, '')::text      AS chatwoot_base_url,\n    NULLIF($2, '')::text      AS chatwoot_api_version,\n    NULLIF($3, '')::text      AS chatwoot_token,\n    NULLIF($4, '')::int       AS chatwoot_account_id,\n    NULLIF($5, '')::int       AS chatwoot_inbox_id,\n    NULLIF($6, '')::text      AS chatwoot_inbox_name,\n    NULLIF($7, '')::text      AS chatwoot_track_id,\n    NULLIF($8, '')::text      AS api_base_url,\n    NULLIF($9, '')::text      AS api_token,\n    NULLIF($10, '')::text     AS api_instance_name,\n    NULLIF($11, '')::boolean  AS ignore_groups,\n    NULLIF($12, '')::boolean  AS reply_messages,\n    NULLIF($13, '')::boolean  AS edit_messages,\n    NULLIF($14, '')::boolean  AS delete_messages,\n    NULLIF($15, '')::boolean  AS reopen_conversation,\n    NULLIF($16, '')::boolean  AS conversation_pending,\n    NULLIF($17, '')::boolean  AS import_contacts,\n    NULLIF($18, '')::boolean  AS import_messages,\n    NULLIF($19, '')::int      AS import_days_limit,\n    NULLIF($20, '')::text     AS sign_messages_mode,\n    NULLIF($21, '')::text     AS sign_delimiter,\n    NULLIF($22, '')::bigint   AS _id\n),\n\n-- 2) Tenta ATUALIZAR somente se um ID explícito for fornecido\nupd AS (\n  UPDATE {{$json.schema}}.{{$json.table_name}} t\n  SET\n    chatwoot_base_url  = v.chatwoot_base_url,\n    chatwoot_api_version = v.chatwoot_api_version,\n    chatwoot_token       = v.chatwoot_token,\n    chatwoot_account_id  = v.chatwoot_account_id,\n    chatwoot_inbox_id    = v.chatwoot_inbox_id,\n    chatwoot_inbox_name  = v.chatwoot_inbox_name,\n    chatwoot_track_id    = v.chatwoot_track_id,\n    api_base_url         = v.api_base_url,\n    api_token            = v.api_token,\n    api_instance_name    = v.api_instance_name,\n    ignore_groups        = v.ignore_groups,\n    reply_messages       = v.reply_messages,\n    edit_messages        = v.edit_messages,\n    delete_messages      = v.delete_messages,\n    reopen_conversation  = v.reopen_conversation,\n    conversation_pending = v.conversation_pending,\n    import_contacts      = v.import_contacts,\n    import_messages      = v.import_messages,\n    import_days_limit    = v.import_days_limit,\n    sign_messages_mode   = v.sign_messages_mode,\n    sign_delimiter       = v.sign_delimiter,\n    updated_at           = NOW()\n  FROM vals v\n  WHERE\n      (v._id IS NOT NULL AND t.id = v._id)\n  RETURNING t.id\n)\n\n-- 3) Se não atualizou, faz o INSERT\nINSERT INTO {{$json.schema}}.{{$json.table_name}} (\n  chatwoot_base_url, chatwoot_api_version, chatwoot_token,\n  chatwoot_account_id, chatwoot_inbox_id, chatwoot_inbox_name, chatwoot_track_id,\n  api_base_url, api_token, api_instance_name,\n  ignore_groups, reply_messages, edit_messages, delete_messages,\n  reopen_conversation, conversation_pending,\n  import_contacts, import_messages, import_days_limit,\n  sign_messages_mode, sign_delimiter, updated_at\n)\nSELECT\n  v.chatwoot_base_url, v.chatwoot_api_version, v.chatwoot_token,\n  v.chatwoot_account_id, v.chatwoot_inbox_id, v.chatwoot_inbox_name, v.chatwoot_track_id,\n  v.api_base_url, v.api_token, v.api_instance_name,\n  v.ignore_groups, v.reply_messages, v.edit_messages, v.delete_messages,\n  v.reopen_conversation, v.conversation_pending,\n  v.import_contacts, v.import_messages, v.import_days_limit,\n  v.sign_messages_mode, v.sign_delimiter, NOW()\nFROM vals v\nWHERE NOT EXISTS (SELECT 1 FROM upd)\nRETURNING id;","options":{"queryReplacement":"={{ [\n  String($('setUpsert')?.item?.json?.chatwoot_base_url ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_api_version ?? 'v1'),\n  String($('setUpsert')?.item?.json?.chatwoot_token ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_account_id ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_inbox_id ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_inbox_name ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_track_id ?? ''),\n  String($('setUpsert')?.item?.json?.api_base_url ?? ''),\n  String($('setUpsert')?.item?.json?.api_token ?? ''),\n  String($('setUpsert')?.item?.json?.api_instance_name ?? ''),\n  String($('setUpsert')?.item?.json?.ignore_groups ?? 'true'),\n  String($('setUpsert')?.item?.json?.reply_messages ?? 'true'),\n  String($('setUpsert')?.item?.json?.edit_messages ?? 'true'),\n  String($('setUpsert')?.item?.json?.delete_messages ?? 'true'),\n  String($('setUpsert')?.item?.json?.reopen_conversation ?? 'true'),\n  String($('setUpsert')?.item?.json?.conversation_pending ?? 'false'),\n  String($('setUpsert')?.item?.json?.import_contacts ?? 'false'),\n  String($('setUpsert')?.item?.json?.import_messages ?? 'false'),\n  String($('setUpsert')?.item?.json?.import_days_limit ?? '7'),\n  String($('setUpsert')?.item?.json?.sign_messages_mode ?? 'none'),\n  String($('setUpsert')?.item?.json?.sign_delimiter ?? '\\n\\n'),\n  String($('setUpsert')?.item?.json?.id ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1392,1088],"id":"0757d7bd-9f62-4152-a4e2-50eafebf98c7","name":"instanceUpsert","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"-- 1. Define os parâmetros de sessão a partir do n8n\nSELECT\n  SET_CONFIG('n8n.schema', $1, false),\n  SET_CONFIG('n8n.table_name', $2, false),\n  SET_CONFIG('n8n.version', $3, false);\n\n-- 2. Cria o schema (lendo a variável de sessão)\nDO $ddl$\nDECLARE\n  _sch text := current_setting('n8n.schema');\nBEGIN\n  IF _sch = '' THEN\n    RAISE EXCEPTION 'n8n.schema parameter is empty';\n  END IF;\n  EXECUTE format('CREATE SCHEMA IF NOT EXISTS %I', _sch);\nEND\n$ddl$;\n\n-- 3. Cria as tabelas (lendo as variáveis de sessão)\nDO $$\nDECLARE\n  _sch text := current_setting('n8n.schema');\n  _tbl text := current_setting('n8n.table_name');\n  _ver text := current_setting('n8n.version');\nBEGIN\n  IF _tbl = '' OR _ver = '' THEN\n     RAISE EXCEPTION 'n8n.table_name or n8n.version is empty';\n  END IF;\n  \n  IF to_regclass(format('%I.%I', _sch, _tbl)) IS NULL THEN\n    RAISE NOTICE '[CreateTable] Tabela principal %.% não encontrada. Criando...', _sch, _tbl;\n    \n    -- Cria tabela principal v1.1.0\n    EXECUTE format('\n      CREATE TABLE %I.%I (\n        id                  integer GENERATED ALWAYS AS IDENTITY PRIMARY KEY,\n        chatwoot_base_url   text        NOT NULL,\n        chatwoot_api_version text       NOT NULL DEFAULT ''v1'',\n        chatwoot_token      text        NOT NULL,\n        chatwoot_account_id integer     NOT NULL CHECK (chatwoot_account_id > 0),\n        chatwoot_inbox_id   integer     NOT NULL CHECK (chatwoot_inbox_id > 0),\n        chatwoot_inbox_name text,\n        chatwoot_track_id   text        NOT NULL,\n        api_base_url        text        NOT NULL,\n        api_token           text        NOT NULL,\n        api_instance_name   text,\n        ignore_groups       boolean     NOT NULL DEFAULT true,\n        reply_messages      boolean     NOT NULL DEFAULT true,\n        edit_messages       boolean     NOT NULL DEFAULT true,\n        delete_messages     boolean     NOT NULL DEFAULT true,\n        reopen_conversation boolean     NOT NULL DEFAULT true,\n        conversation_pending boolean    NOT NULL DEFAULT false,\n        import_contacts     boolean     NOT NULL DEFAULT false,\n        import_messages     boolean     NOT NULL DEFAULT false,\n        import_days_limit   integer     NOT NULL DEFAULT 7 CHECK (import_days_limit >= 0),\n        sign_messages_mode  text        NOT NULL DEFAULT ''none'',\n        sign_delimiter      text        NOT NULL DEFAULT ''\\n\\n'',\n        created_at          timestamptz NOT NULL DEFAULT now(),\n        updated_at          timestamptz NOT NULL DEFAULT now(),\n        CONSTRAINT uq_%2$I_chatwoot_context UNIQUE (chatwoot_base_url, chatwoot_account_id, chatwoot_inbox_id),\n        CONSTRAINT uq_%2$I_api_token        UNIQUE (api_token),\n        CONSTRAINT chk_sign_messages_mode CHECK (sign_messages_mode IN (''none'', ''assigned_name'', ''assigned_display_name'', ''logged_name'', ''logged_display_name''))\n      );\n    ', _sch, _tbl);\n\n    -- Índices e Trigger\n    EXECUTE format('CREATE INDEX IF NOT EXISTS idx_%2$I_account_inbox ON %1$I.%2$I (chatwoot_account_id, chatwoot_inbox_id);', _sch, _tbl);\n    EXECUTE format('CREATE OR REPLACE FUNCTION %1$I.set_%2$I_updated_at() RETURNS trigger LANGUAGE plpgsql AS $f$ BEGIN NEW.updated_at := now(); RETURN NEW; END; $f$;', _sch, _tbl);\n    EXECUTE format('CREATE TRIGGER trg_%2$I_updated_at BEFORE UPDATE ON %1$I.%2$I FOR EACH ROW EXECUTE FUNCTION %1$I.set_%2$I_updated_at();', _sch, _tbl);\n\n    -- Cria tabela de versão e insere a versão\n    RAISE NOTICE '[CreateTable] Criando tabela de versão %.% e definindo versão para %', _sch, '_schema_version', _ver;\n    EXECUTE format('CREATE TABLE IF NOT EXISTS %I._schema_version (version TEXT PRIMARY KEY);', _sch);\n    EXECUTE format('INSERT INTO %I._schema_version (version) SELECT %L WHERE NOT EXISTS (SELECT 1 FROM %1$I._schema_version);', _sch, _ver);\n  ELSE\n    RAISE NOTICE '[CreateTable] Tabela principal %.% já existe. Criação pulada.', _sch, _tbl;\n  END IF;\nEND\n$$ LANGUAGE plpgsql;\n\n-- 4. Retorna sucesso se o script executou sem erro SQL\nSELECT true AS success, 'Tabela criada ou já existente.' AS message;","options":{"queryReplacement":"={{ [\n  String($('setCreate')?.item?.json?.schema ?? ''),\n  String($('setCreate')?.item?.json?.table_name ?? ''),\n  String($('setCreate')?.item?.json?.version ?? '')\n] }}"}},"id":"46c354f0-50c4-4439-a23d-d79dac72d16a","name":"createTable","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1392,768],"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}},"onError":"continueRegularOutput"},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{"responseCode":"={{ $json.ok ? 200 : ($json.code === '23505' ? 409 : 400) }}","responseHeaders":{"entries":[{"name":"Cache-Control","value":"no-store"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]}}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1744,1008],"id":"d49a8b00-7f4c-4d11-864d-bf3bbe385e7c","name":"respondDbUpsert"},{"parameters":{"assignments":{"assignments":[{"name":"schema","value":"={{ (String($('requestVerify')?.item?.json?.body?.schema || '')).trim() || 'public' }}","type":"string","id":"3965c494-077f-4bd9-bda6-798f71ee7d54"},{"name":"table_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.table_name || '')).trim() || 'chatwoot_config' }}","type":"string","id":"15d914d7-0f8d-4d8d-b2b7-4a5acb519c92"},{"name":"id","value":"={{ $('requestVerify').item.json.body.id ? Number( $('requestVerify').item.json.body.id) : null }}","type":"number","id":"8ec62017-3411-4619-9373-85513a72f519"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,1248],"id":"856944aa-ac8b-40bb-bb53-67b2dad464ba","name":"setDelete"},{"parameters":{"operation":"executeQuery","query":"DELETE FROM {{ $('setDelete')?.item?.json?.schema }}.{{ $('setDelete')?.item?.json?.table_name }}\nWHERE id = $1::integer\nRETURNING id;","options":{"queryReplacement":"={{ [\n  String($('setDelete')?.item?.json?.id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1392,1248],"id":"3f32d3c3-8fea-4378-816a-725185bc8a3f","name":"instanceDelete","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"-- Função temp: Obtém a versão atual do schema\nCREATE OR REPLACE FUNCTION pg_temp.get_current_db_version(_sch text)\nRETURNS text LANGUAGE plpgsql AS $$\nDECLARE _ver text := NULL; _tbl_oid oid := to_regclass(format('%I._schema_version', _sch));\nBEGIN IF _tbl_oid IS NOT NULL THEN EXECUTE format('SELECT version FROM %I._schema_version LIMIT 1', _sch) INTO _ver; END IF; RETURN _ver; END; $$;\n\n-- Função temp: testa existência de linhas\nCREATE OR REPLACE FUNCTION pg_temp.has_rows(_sch text, _tbl text)\nRETURNS boolean LANGUAGE plpgsql AS $$\nDECLARE _has boolean := false;\nBEGIN IF to_regclass(format('%I.%I', _sch, _tbl)) IS NOT NULL THEN EXECUTE format('SELECT EXISTS (SELECT 1 FROM %I.%I LIMIT 1)', _sch, _tbl) INTO _has; END IF; RETURN _has; END; $$;\n\n-- Função temp: devolve as linhas em JSON\nCREATE OR REPLACE FUNCTION pg_temp.get_instances(_sch text, _tbl text)\nRETURNS json LANGUAGE plpgsql AS $$\nDECLARE _rows json := '[]'::json;\nBEGIN IF to_regclass(format('%I.%I', _sch, _tbl)) IS NOT NULL THEN EXECUTE format('SELECT COALESCE(json_agg(t ORDER BY id) FILTER (WHERE true), ''[]''::json) FROM %I.%I t', _sch, _tbl) INTO _rows; END IF; RETURN _rows; END; $$;\n\n-- Query principal\nWITH\ncfg AS (\n  SELECT\n    $1::text AS sch,\n    $2::text AS tbl,\n    $3::text AS pth,\n    $4::text AS brd,\n    $5::text AS expected_version,\n    $6::text AS kit_version -- ADICIONADO\n),\nreg AS (\n  SELECT to_regclass(format('%I.%I', sch, tbl)) AS oid FROM cfg\n),\ndb_version AS (\n  SELECT pg_temp.get_current_db_version(cfg.sch) as current_db_version FROM cfg\n),\nflags AS (\n  SELECT\n    (r.oid IS NOT NULL) AS \"tableExists\",\n    CASE WHEN r.oid IS NULL THEN false\n         ELSE pg_temp.has_rows(cfg.sch, cfg.tbl)\n    END AS \"dataExists\"\n  FROM cfg LEFT JOIN reg r ON TRUE\n)\nSELECT\n  jsonb_build_object(\n    'schema', cfg.sch,\n    'table_name', cfg.tbl,\n    'version', cfg.expected_version,\n    'kitVersion', cfg.kit_version\n  ) AS database,\n  jsonb_build_object('path', cfg.pth) AS webhook,\n  jsonb_build_object('branding', cfg.brd) AS automation,\n  f.\"tableExists\",\n  f.\"dataExists\",\n  cfg.expected_version,\n  dv.current_db_version,\n  (f.\"tableExists\" AND dv.current_db_version IS DISTINCT FROM cfg.expected_version) AS \"needsMigration\",\n  CASE\n    WHEN f.\"tableExists\" AND f.\"dataExists\"\n      THEN pg_temp.get_instances(cfg.sch, cfg.tbl)\n    ELSE '[]'::json\n  END AS instances\nFROM cfg\nCROSS JOIN flags f\nCROSS JOIN db_version dv;","options":{"queryReplacement":"={{ [\n  String($('setVariables')?.item?.json?.database?.schema ?? ''),\n  String($('setVariables')?.item?.json?.database?.table_name ?? ''),\n  String($('setVariables')?.item?.json?.webhook?.path ?? ''),\n  String($('setVariables')?.item?.json?.automation?.branding ?? ''),\n  String($('authHeaderConfig')?.item?.json?.database?.version ?? ''),\n  String($('authHeaderConfig')?.item?.json?.database?.kitVersion ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1568,432],"id":"332b35a9-65dd-4383-baa7-e240a8cbff20","name":"checkTableData","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"assignments":{"assignments":[{"name":"schema","value":"={{ (String($('requestVerify')?.item?.json?.body?.schema || '')).trim() || 'public' }}","type":"string","id":"3965c494-077f-4bd9-bda6-798f71ee7d54"},{"name":"table_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.table_name || '')).trim() || 'chatwoot_config' }}","type":"string","id":"15d914d7-0f8d-4d8d-b2b7-4a5acb519c92"},{"id":"d4afb0cc-9b49-4d92-9564-c4b95ecf6d12","name":"version","value":"={{ (String($('requestVerify')?.item?.json?.body?.version || '')).trim() || '1.0.0' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,768],"id":"22560483-70d3-4820-b15b-fe20378287c3","name":"setCreate"},{"parameters":{"assignments":{"assignments":[{"id":"f2fa7b36-72ca-4a76-9c5a-33a022c77467","name":"database.schema","value":"chatwoot_uazapi","type":"string"},{"id":"a3997699-2003-4afe-8b83-09d6f0138f14","name":"database.table_name","value":"chatwoot_uazapi_config","type":"string"},{"id":"5ed9fe9a-5f61-4ac2-a60e-791b5c4a8302","name":"auth.user","value":"admin","type":"string"},{"id":"451c35f1-e069-4bef-8628-f6a929d61778","name":"auth.pass","value":"TeCo78964","type":"string"},{"id":"3cadfe0e-c710-4a9d-9a67-c4cea7c8fa64","name":"automation.branding","value":"SCALA Digital","type":"string"},{"id":"c7769d9c-e3e5-4f98-974d-c8c71fef9ec2","name":"webhook.path","value":"={{ $('webhookData')?.item?.json?.webhookUrl.split('/').last() }}","type":"string"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1040,512],"id":"9bd772e1-1bf3-4a6c-a307-f8c7e6800dee","name":"setVariables"},{"parameters":{"assignments":{"assignments":[{"name":"schema","value":"={{ (String($('requestVerify')?.item?.json?.body?.schema || '')).trim() || 'public' }}","type":"string","id":"3965c494-077f-4bd9-bda6-798f71ee7d54"},{"name":"table_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.table_name || '')).trim() || 'chatwoot_config' }}","type":"string","id":"15d914d7-0f8d-4d8d-b2b7-4a5acb519c92"},{"name":"id","value":"={{ $('requestVerify').item?.json?.body?.id ? Number( $('requestVerify').item?.json?.body?.id) : null }}","type":"number","id":"8ec62017-3411-4619-9373-85513a72f519"},{"name":"chatwoot_base_url","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_base_url || '')).trim() }}","type":"string","id":"6e943d37-e093-4715-9e3a-dd2e7fa75e4b"},{"name":"chatwoot_api_version","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_api_version || '')).trim() }}","type":"string","id":"bbba6579-e0ee-4c76-ac8f-1f284508fa8b"},{"name":"chatwoot_token","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_token || '')).trim() }}","type":"string","id":"3b0cb655-76ec-4ba1-b7a8-0ef36aa19a22"},{"name":"chatwoot_account_id","value":"={{ Number( ($('requestVerify')?.item?.json?.body?.chatwoot_account_id ?? 1) || 1 ) }}","type":"number","id":"4c6bd65f-3403-435d-ac29-2ec704b1eb6f"},{"name":"chatwoot_inbox_id","value":"={{ Number( ($('requestVerify')?.item?.json?.body?.chatwoot_inbox_id ?? 1) || 1 ) }}","type":"number","id":"5730dc70-4e4f-4919-b5cf-28da6459d383"},{"name":"chatwoot_inbox_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_inbox_name || '')).trim() }}","type":"string","id":"502ea6e0-7b81-4c4c-88ca-2047da047e04"},{"name":"chatwoot_track_id","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_track_id || '')).trim() }}","type":"string","id":"d437c928-59e9-45e5-92b7-f89251cc609f"},{"name":"api_base_url","value":"={{ (String($('requestVerify')?.item?.json?.body?.api_base_url || '')).trim() }}","type":"string","id":"247efa9f-bd69-47e0-af5e-02b91c39448b"},{"name":"api_token","value":"={{ (String($('requestVerify')?.item?.json?.body?.api_token || '')).trim() }}","type":"string","id":"a15f2508-69f0-4596-955a-d132361b2103"},{"name":"api_instance_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.api_instance_name || '')).trim() }}","type":"string","id":"d9455e57-2b7e-43c4-80d0-8f68c99f8bf3"},{"name":"ignore_groups","value":"={{ String(($('requestVerify')?.item?.json?.body?.ignore_groups ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"a305225c-c754-4ce0-9b9f-12edb2bb4d8a"},{"name":"reply_messages","value":"={{ String(($('requestVerify')?.item?.json?.body?.reply_messages ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"3e8f32eb-2ff9-4721-9b93-3be593f9a5c8"},{"name":"edit_messages","value":"={{ String(($('requestVerify')?.item?.json?.body?.edit_messages ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"782e8f1c-483e-4b3f-a735-097f43f4083b"},{"name":"delete_messages","value":"={{ String(($('requestVerify')?.item?.json?.body?.delete_messages ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"4d1e2377-848a-4642-a08f-98bb36a9f7b8"},{"name":"reopen_conversation","value":"={{ String(($('requestVerify')?.item?.json?.body?.reopen_conversation ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"11ba6686-555c-4016-829c-afea903605e8"},{"name":"conversation_pending","value":"={{ String(($('requestVerify')?.item?.json?.body?.conversation_pending ?? 'false')).toLowerCase() === 'true' }}","type":"boolean","id":"c75a0eea-5c6e-4af9-88b7-818b704de6ef"},{"name":"import_contacts","value":"={{ String(($('requestVerify')?.item?.json?.body?.import_contacts ?? 'false')).toLowerCase() === 'true' }}","type":"boolean","id":"6c430a9e-7fb5-407e-b220-692288ad462b"},{"name":"import_messages","value":"={{ String(($('requestVerify')?.item?.json?.body?.import_messages ?? 'false')).toLowerCase() === 'true' }}","type":"boolean","id":"69542908-e860-4c6d-b699-d2b34a707579"},{"name":"import_days_limit","value":"={{ Number($('requestVerify')?.item?.json?.body?.import_days_limit ?? 7) }}","type":"number","id":"4d9982dd-2506-43a0-b123-6fc8484e8a87"},{"name":"sign_messages_mode","value":"={{ (String($('requestVerify')?.item?.json?.body?.sign_messages_mode  || 'none')).trim() }}","type":"string","id":"bcf08949-1f5c-4baa-8f10-7e9eb652c95b"},{"name":"sign_delimiter","value":"={{\n  (v => {\n    if (v == null) return '\\\\n\\\\n';\n    if (v === '\\n\\n') return '\\\\n\\\\n';\n    if (v === '\\n')  return '\\\\n';\n    return (v === '\\\\n\\\\n' || v === '\\\\n' || v === ' ') ? v : '\\\\n\\\\n';\n  })($('requestVerify')?.item?.json?.body?.sign_delimiter)\n}}","type":"string","id":"ad1b1176-81f2-4a5d-8718-42c366ecab2f"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,1088],"id":"e228130f-f94a-4b20-91f2-9dbb2588459f","name":"setUpsert"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Function Item (executa 1x para o item atual)\nconst tbl = $json.table_name ?? 'chatwoot_uazapi_config';\nconst err = $json.error;\n\nconst response = {\n  ok: true,\n  httpStatus: 200,\n  friendlyMessage: 'Operação realizada com sucesso.'\n};\n\nif (err) {\n  response.ok = false;\n\n  // Mapa de constraints -> mensagens amigáveis (dinâmico por tabela)\n  const constraintMsg = {\n    [`uq_${tbl}_chatwoot_context`]:\n      'Erro: Esta combinação de URL, Conta e Caixa de Entrada já está em uso por outra instância.',\n    [`uq_${tbl}_chatwoot_token`]:\n      'Erro: O Token do Chatwoot informado já está em uso por outra instância.',\n    [`uq_${tbl}_api_token`]:\n      'Erro: O Token da UaZapi informado já está em uso por outra instância.',\n  };\n\n  response.friendlyMessage =\n    constraintMsg[err.constraint] ||\n    (($json.message || err.message)\n      ? `Erro de banco de dados: ${$json.message || err.message}`\n      : 'Ocorreu um erro inesperado no banco de dados.');\n\n  // 23505 = unique_violation\n  response.httpStatus = (err.code === '23505') ? 409 : 400;\n\n  response.error = {\n    code: err.code ?? null,\n    message: $json.message ?? err.message ?? null,\n    detail: err.detail ?? null,\n    constraint: err.constraint ?? null,\n  };\n} else {\n  // Tenta extrair o ID/flags do retorno do Postgres\n  const data = $json.rows?.[0] ?? $json[0] ?? $json;\n  response.id = data?.id ?? null;\n  response.success = data?.success ?? null;\n}\n\n// Opção A: retornar só a resposta (mais limpo para o Respond to Webhook)\nreturn { json: response };\n\n// --- Opção B (alternativa): mesclar com o payload original ---\n// return { json: { ...$json, ...response } };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1568,1008],"id":"33f99cb5-dd0d-476e-a637-bcc8e246d8c8","name":"formatDbResponse"},{"parameters":{"multipleMethods":true,"path":"colbiflex-manager","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[864,768],"id":"5c139abf-04a9-4da4-b262-041c7b10b774","name":"webhookData","webhookId":"f6b6cb9e-36de-4cdb-9f56-733d053a76f4"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('webhookData')?.item?.json?.body?.action ?? '' }}","rightValue":"=create","operator":{"type":"string","operation":"equals"},"id":"ab3cdb36-1c19-4462-b10d-23aeedbf8b80"}],"combinator":"and"},"renameOutput":true,"outputKey":"create"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"046d088d-274d-4db3-8c5b-c0935aecfa02","leftValue":"={{ $('webhookData')?.item?.json?.body?.action ?? '' }}","rightValue":"migrate","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"migrate"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0a255e36-852d-4aa1-9f9c-b8db60f064ca","leftValue":"={{ $('webhookData')?.item?.json?.body?.action ?? '' }}","rightValue":"upsert","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"upsert"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bda3070f-6c05-4461-b22f-6a4f17209777","leftValue":"={{ $('webhookData')?.item?.json?.body?.action ?? '' }}","rightValue":"delete","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"delete"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1040,976],"id":"ebfa0753-a146-4ccf-862f-70aacbe9fa4b","name":"requestVerify"},{"parameters":{"assignments":{"assignments":[{"id":"f2fa7b36-72ca-4a76-9c5a-33a022c77467","name":"database.schema","value":"chatwoot_uazapi","type":"string"},{"id":"a3997699-2003-4afe-8b83-09d6f0138f14","name":"database.table_name","value":"chatwoot_uazapi_config","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[240,2064],"id":"6cca0b6d-d517-4560-bdb7-5962d469f455","name":"setVariablesClean"},{"parameters":{"operation":"executeQuery","query":"-- 1. Define os parâmetros de sessão a partir do n8n\nSELECT\n  SET_CONFIG('n8n.schema', $1, false),\n  SET_CONFIG('n8n.table_name', $2, false);\n\n-- ============================================================\n-- SCRIPT DE LIMPEZA (inicia transação)\n-- ============================================================\nBEGIN;\n\n-- Bloco principal para toda a lógica de limpeza\nDO $$\nDECLARE\n  _sch text := current_setting('n8n.schema');\n  _tbl text := current_setting('n8n.table_name');\n  seq_full_name text;\nBEGIN\n  -- Validação (Previne apagar tudo se os parâmetros estiverem vazios)\n  IF _sch = '' OR _tbl = '' THEN\n    RAISE EXCEPTION 'Schema ou Table Name estão vazios. Abortando limpeza.';\n  END IF;\n\n  -- 1) Tabela principal e dependências diretas\n  RAISE NOTICE '[Cleaner] Dropping table: %.%', _sch, _tbl;\n  EXECUTE format('DROP TABLE IF EXISTS %I.%I CASCADE', _sch, _tbl);\n\n  -- 2) Tabela de versão do schema\n  RAISE NOTICE '[Cleaner] Dropping table: %._schema_version', _sch;\n  EXECUTE format('DROP TABLE IF EXISTS %I._schema_version CASCADE', _sch);\n\n  -- 3) Função do trigger\n  RAISE NOTICE '[Cleaner] Dropping function: %.set_%_updated_at()', _sch, _tbl;\n  EXECUTE format('DROP FUNCTION IF EXISTS %I.set_%I_updated_at()', _sch, _tbl);\n\n  -- 4) (Opcional) Limpeza de sequências órfãs\n  FOR seq_full_name IN\n    SELECT quote_ident(n.nspname) || '.' || quote_ident(c.relname)\n    FROM pg_class c\n    JOIN pg_namespace n ON n.oid = c.relnamespace\n    WHERE c.relkind = 'S' -- S = sequence\n      AND n.nspname = _sch\n      AND c.relname IN (_tbl || '_id_seq') -- Nome da sequência padrão\n  LOOP\n    RAISE NOTICE '[Cleaner] Dropping orphaned sequence: %', seq_full_name;\n    EXECUTE 'DROP SEQUENCE IF EXISTS ' || seq_full_name || ' CASCADE';\n  END LOOP;\nEND\n$$ LANGUAGE plpgsql;\n\n-- 5) Confirma transação\nCOMMIT;\n\n-- 6. Retorna sucesso\nSELECT true AS success, 'Schema cleanup completed.' AS message;","options":{"queryReplacement":"={{ [\n  String($json.database.schema ?? ''),\n  String($json.database.table_name ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[416,2064],"id":"e27c2056-0c66-4ee6-a8f5-ee97b4f65a5d","name":"databaseClean","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Mngr","height":176,"width":166,"color":3},"type":"n8n-nodes-base.stickyNote","position":[1536,400],"typeVersion":1,"id":"5bb5013f-5e18-4818-8fd6-66c8bd982a97","name":"Sticky Note"},{"parameters":{"content":"### Postgres Mngr","height":656,"width":166,"color":3},"type":"n8n-nodes-base.stickyNote","position":[1360,736],"typeVersion":1,"id":"3b7b26ed-5f3a-46a8-88db-b46fe4b9a82e","name":"Sticky Note1"},{"parameters":{"content":"### Postgres Mngr","height":192,"width":150,"color":3},"type":"n8n-nodes-base.stickyNote","position":[384,2016],"typeVersion":1,"id":"9d8fbca3-930e-491f-8aa7-3c91def1e3c4","name":"Sticky Note2"},{"parameters":{"content":"### Config","height":192,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[208,2016],"typeVersion":1,"id":"a4da8a17-eea1-4f89-9817-712323499810","name":"Sticky Note3"},{"parameters":{"content":"### Config","height":192,"width":150,"color":4},"type":"n8n-nodes-base.stickyNote","position":[1008,464],"typeVersion":1,"id":"5dd3ef5e-5495-4d86-b139-d64f7a61038a","name":"Sticky Note4"},{"parameters":{"content":"# 🚨 Danger Zone\n\nAo executar este bloco de automação, esteja ciente de que irá **EXCLUIR COMPLETAMENTE** a tabela do Manager, seus índices e todos os dados das instâncias armazenadas no banco.\n\n---\n","height":432,"width":768,"color":3},"type":"n8n-nodes-base.stickyNote","position":[0,1792],"typeVersion":1,"id":"cb88e3f0-5070-44a2-b55a-46effbe49504","name":"Sticky Note6"},{"parameters":{"content":"# 🧭 Gerenciador de Instâncias\n\nAqui você cria, edita e exclui as instâncias da Integração Premium do Chatwoot 🔁 UaZapi.\n\n---\n","height":1184,"width":1472},"type":"n8n-nodes-base.stickyNote","position":[800,224],"typeVersion":1,"id":"b9930c75-8327-4afd-8a9e-b6a0cc6087cb","name":"Sticky Note7"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2096,592],"id":"9c773a8d-ae24-4c5e-b001-cb93353de120","name":"endProcess"},{"parameters":{"content":"# 💬 Integração Premium Chatwoot 🔁 UaZapi\n### _**v1.0.1 • atualizado: 2025-11-17**_\n\n## Workflow que **exibe uma UI de gestão** e orquestra a **criação, edição e exclusão** das configurações de instâncias da UaZapi e das caixas de entrada do Chatwoot.\n---\n\n## 🧭 O que este fluxo faz\n- Recebe requisições **HTTP (GET/POST)** via Webhook do n8n para exibir a **UI de Configuração** e executar ações.  \n- **Verifica** se a tabela de configuração existe; se não existir, oferece **criação assistida**.  \n- Após criar a tabela, sugere a **instância modelo** (opcional) e abre o **gerenciador**.  \n- Permite **incluir, editar, excluir e listar** instâncias com validações e mensagens amigáveis.  \n- Protegido por **Basic Auth** (definido em `setVariables`) e com respostas HTTP padronizadas **200/409/400**.\n\n---\n\n## 🛠 Requisitos\nConfigure os nós de **parâmetros** e **banco** antes de abrir a UI:\n\n- **Parâmetros (nó `setVariables` em Verde)**\n  - `database.schema` → esquema do banco\n  - `database.table_name` → nome da tabela de configuração\n  - `database.version` → versão do esquema do banco  **( 🚨 NÃO ALTERAR 🚨 )**\n  - `auth.user` / `auth.pass` → credenciais de **Basic Auth** para acessar a UI\n  - `automation.branding` → nome/marca que será apresentada em \"Desenvolvido por\" na parte inferior das telas do Manager\n  - `webhook.path` → caminho da rota pública _(preenchido automaticamente a partir do Webhook)_\n\n- **Limpeza (nó `setVariablesClean`)**\n  - `database.schema` → esquema do banco\n  - `database.table_name` → nome da tabela de configuração\n\n- **Banco de dados (nós Postgres em Vermelho)**\n  - Defina/associe as credenciais **Postgres** nos nós:  \n    `checkTableData`, `createTable`, `updateTable`, `instanceUpsert`, `instanceDelete`, `databaseClean`.\n\n> **Dica:** use o mesmo `schema`/`table_name` em todos os pontos para manter consistência.\n\n---\n\n## ⚙️ Instruções de Instalação\n1. **Importe** o workflow no **n8n**.  \n2. Em **`setVariables`**, preencha `database.schema`, `database.table_name`, `database.version`, `auth.user`, `auth.pass` e `automation.brading`.\n3. (Opcional) Abra o nó **`webhookData`** e ajuste o **Path** (rota pública, ex.: `config-ui`).  \n4. **Associe a credencial Postgres** aos nós `checkTableData`, `createTable`, `updateTable`, `instanceUpsert`, `instanceDelete` e `databaseClean`.  \n5. Clique em **Save** para salvar o workflow.  \n6. Clique em **Activate** (canto superior direito) para ativar o workflow.  \n7. Copie a **Production URL** do `webhookData`, abra em uma nova aba e faça login com o **Basic Auth**.  \n8. Siga o **assistente de criação** da tabela; opcionalmente crie a **instância modelo** e, em seguida, use o **Gerenciador de Instâncias**.\n\n---\n\n## 🔐 Segurança\n- Acesse a UI somente via **HTTPS** e **Basic Auth** (credenciais definidas em `setVariables`).  \n- **Não compartilhe** a Production URL do Webhook.  \n- Armazene **tokens e segredos** fora do repositório e **rotacione** periodicamente.  \n- Restrinja acesso ao n8n e ao Chatwoot; os dados de mensagens podem ser **sensíveis**.\n","height":1536,"width":768,"color":5},"type":"n8n-nodes-base.stickyNote","position":[0,224],"typeVersion":1,"id":"484e7c67-a9c4-40ff-be16-446cc6204ab3","name":"Sticky Note8"},{"parameters":{"content":"# ⚖️ Aviso de Propriedade Intelectual & Suporte\n\nEste workflow e sua UI são **propriedade intelectual** da EMKT Consultoria e Tecnologia, protegidos pelas Leis **9.610/98 (Direitos Autorais)**, **9.609/98 (Software)** e pela **LGPD – 13.709/18**.\n---\n\n## Uso permitido\n- Licença de **uso interno**, não exclusiva e intransferível.\n- É vedada a **distribuição**, **revenda**, **locação**, **cessão**, **publicação** ou **exposição pública** (incl. repositórios/portais).\n\n## Proibições\n- **Cópia** total/parcial, **engenharia reversa**, **descompilação**, **circunvenção** de proteções.\n- **Modificações** não autorizadas, criação de **derivados** ou remoção de créditos/identificações.\n- **Compartilhamento** do pacote/fluxo, credenciais, URLs de webhook, telas ou prints com terceiros.\n\n## Suporte & Garantia\n- A **garantia de suporte** e atualizações está **condicionada** à manutenção do **estado original** do workflow.  \n- Qualquer **alteração não autorizada** (código, nós, credenciais, rotas, lógica ou layout) **invalida o suporte**.\n- Adequações/integrações adicionais requerem **contratação prévia** e **autorização por escrito**.\n\n---\n\n### 📞 Contato\nPrecisa de ajuda? Fale conosco pelo WhatsApp Business  \n**(41) 9 8473-9797** — [abrir conversa](https://api.whatsapp.com/message/FVXDCWKJFIM4M1)  \n**(79) 9 9977-7712** — [abrir conversa](https://api.whatsapp.com/message/2G6M66MXFH7TD1)\n\n> Dúvidas sobre uso, licença ou autorização: contate a EMKT.\n","height":784,"width":1472,"color":4},"type":"n8n-nodes-base.stickyNote","position":[800,1440],"typeVersion":1,"id":"41aac2de-ba3e-4c90-989d-300b741a6e94","name":"Sticky Note10"},{"parameters":{"content":"```\n                                ███       █                            ██          █████ █          █                   █              █   █      █████           █\n                                 █       ███                                       █     █         ███                 ███             █   █          █\n                                 █  █ ██  █  ████ ████ █ ██ ████ ████ ████ ████    █     ████ ████  █  █ █ █ ████ ████  █     █   █    █   █ ████    █  ████ ████ █           █    ███    █     ████ ████ ████ █████ █ █  █ █████\n                                 █  ██ █  █  █  █ █  █ ██      █ █       █ █  █    █     █  █    █  █  █ █ █ █  █ █  █  █      █ █     █   █    █   █      █ █  █ █          ██    █ █   ██     █  █ █  █ █    █ █ █ █ █  █ █ █ █\n                                 █  █  █  █  ████ █  █ █    ████ █    ████ █  █    █     █  █ ████  █  █ █ █ █  █ █  █  █       █      █   █ ████  █    ████ █  █ █     █ █   █    █ █    █  ██ ████ ████ ███  █ █ █ █ █  █ █ █ █\n                                 █  █  █  █  █    █  █ █    █  █ █    █  █ █  █    █     █  █ █  █  █  █ █ █ █  █ █  █  █      █ █     █   █ █  █ █     █  █ █  █ █     █ █   █    █ █    █     █    █ █  █    █ █ █ █ █  █ █ █ █\n                                ███ █  █  ██ ████ ████ █    ████ ████ ████ ████    █████ █  █ ████  ██  █ █  ████ ████  ██    █   █    █████ ████ █████ ████ ████ █      █   ███ █ ███ █ ███    █    █  █ ████ █ █ █ █ ████ █ █ █\n                                                     █             █                                                                                         █\n                                                  ████            █                                                                                          █\n```","height":200,"width":2268,"color":7},"type":"n8n-nodes-base.stickyNote","position":[0,0],"typeVersion":1,"id":"838c48c9-ee37-46ff-a827-3295a40476b8","name":"Sticky Note9"},{"parameters":{"assignments":{"assignments":[{"id":"42b92175-6da2-4f5e-85bf-49439eb48bb2","name":"body","value":"=<!doctype html>\n<html lang=\"pt-BR\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n  <title>Acesso Não Autorizado</title>\n  <script src=\"https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4\"></script>\n  <style>\n    /* Estilo do card, vindo do seu HTML original */\n    .card {\n      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05)\n    }\n  </style>\n</head>\n\n<body class=\"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900\">\n  \n  <main class=\"max-w-4xl mx-auto px-6 py-10\">\n    \n    <h1 class=\"text-3xl font-semibold tracking-tight mb-1\">Integração Chatwoot x UaZapi</h1>\n    \n    <div id=\"top-banner\" class=\"hidden\"></div>\n    \n    <section class=\"card rounded-xl border bg-white overflow-hidden\">\n        \n        <div class=\"m-5 flex items-start gap-3 rounded-lg border border-red-300 bg-red-50 px-4 py-3 text-sm text-red-900\" role=\"alert\">\n            \n            <div class=\"shrink-0 mt-0.5\">\n              <svg class=\"h-5 w-5 text-red-600\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\">\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\" />\n              </svg>\n            </div>\n            \n            <div class=\"flex-1\">\n              <p class=\"font-semibold\">Acesso Não Autorizado</p>\n              <p class=\"mt-1\">Autenticação necessária. Você deve fornecer um usuário e senha válidos para acessar este recurso.</p>\n            </div>\n        </div>\n\n    </section>\n\n    <p class=\"mt-6 text-center text-xs text-slate-500\">Disponibilizado por <strong>{{ $('setVariables')?.item?.json?.automation?.branding }}</strong></p>\n    \n  </main>\n</body>\n</html>","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1568,592],"id":"547f7ba9-eb6e-4b5c-9701-8561175f5e86","name":"noAuthMessage"},{"parameters":{"assignments":{"assignments":[{"name":"schema","value":"={{ (String($('requestVerify')?.item?.json?.body?.schema || '')).trim() || 'public' }}","type":"string","id":"3965c494-077f-4bd9-bda6-798f71ee7d54"},{"name":"table_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.table_name || '')).trim() || 'chatwoot_config' }}","type":"string","id":"15d914d7-0f8d-4d8d-b2b7-4a5acb519c92"},{"id":"d4afb0cc-9b49-4d92-9564-c4b95ecf6d12","name":"version","value":"={{ (String($('requestVerify')?.item?.json?.body?.version || '')).trim() || '1.0.0' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,928],"id":"0a8f0987-7f62-477a-a2e2-6b17ba064aa2","name":"setUpdate"},{"parameters":{"operation":"executeQuery","query":"-- 1. Define os parâmetros de sessão a partir do n8n\nSELECT\n  SET_CONFIG('n8n.schema', $1, false),\n  SET_CONFIG('n8n.table_name', $2, false),\n  SET_CONFIG('n8n.version', $3, false);\n\n-- 2. ==========================================================\n-- SCRIPT DE MIGRAÇÃO DE SCHEMA (Idempotente e Sequencial)\n-- ============================================================\nDO $$\nDECLARE\n  _sch text := current_setting('n8n.schema');\n  _tbl text := current_setting('n8n.table_name');\n  _target_ver text := current_setting('n8n.version'); -- Versão alvo\n  _current_ver text := NULL;\nBEGIN\n  -- PASSO 0: Validar parâmetros e verificar se a tabela principal existe\n  IF _sch = '' OR _tbl = '' OR _target_ver = '' THEN\n    RAISE EXCEPTION 'n8n.schema, n8n.table_name, ou n8n.version estão vazios.';\n  END IF;\n\n  IF to_regclass(format('%I.%I', _sch, _tbl)) IS NULL THEN\n    RAISE WARNING '[Migration Runner] Tabela principal %.% não encontrada. Nenhuma migração será aplicada.', _sch, _tbl;\n    RETURN; -- Sai do bloco se a tabela principal não existe\n  END IF;\n\n  -- PASSO 1: Obter a versão atual registrada no banco\n  BEGIN\n    EXECUTE format('SELECT version FROM %I._schema_version LIMIT 1', _sch) INTO _current_ver;\n    EXCEPTION WHEN undefined_table THEN\n      RAISE NOTICE '[Migration Runner] Tabela _schema_version não encontrada. Assumindo versão inicial (null).';\n      _current_ver := NULL; -- Trata como se fosse a versão inicial antes de 1.0.0\n  END;\n  RAISE NOTICE '[Migration Runner] Versão atual detectada: %. Versão alvo desta execução: %', COALESCE(_current_ver, 'Nenhuma (pré-1.0.0)'), _target_ver;\n\n  -- ============================================================\n  -- MIGRAÇÃO v1.1.0: sign_messages -> sign_messages_mode\n  -- ============================================================\n  -- Aplica SOMENTE SE a versão atual for anterior a 1.1.0\n  IF _current_ver IS NULL OR _current_ver < '1.1.0' THEN\n    RAISE NOTICE '[Migration v1.1.0] Aplicando alterações...';\n\n    -- 1.1: Adiciona coluna sign_messages_mode (se não existir)\n    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = _sch AND table_name = _tbl AND column_name = 'sign_messages_mode') THEN\n      RAISE NOTICE '[Migration v1.1.0] Adicionando coluna sign_messages_mode TEXT NOT NULL DEFAULT ''none''';\n      EXECUTE format('ALTER TABLE %I.%I ADD COLUMN sign_messages_mode TEXT NOT NULL DEFAULT ''none''', _sch, _tbl);\n      RAISE NOTICE '[Migration v1.1.0] Adicionando constraint chk_sign_messages_mode';\n      EXECUTE format('ALTER TABLE %I.%I ADD CONSTRAINT chk_sign_messages_mode CHECK (sign_messages_mode IN (''none'', ''assigned_name'', ''assigned_display_name'', ''logged_name'', ''logged_display_name''))', _sch, _tbl);\n    ELSE\n        RAISE NOTICE '[Migration v1.1.0] Coluna sign_messages_mode já existe.';\n    END IF;\n\n    -- 1.2: Migra dados da coluna antiga 'sign_messages' (se existir)\n    IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = _sch AND table_name = _tbl AND column_name = 'sign_messages') THEN\n      RAISE NOTICE '[Migration v1.1.0] Migrando dados de sign_messages (boolean) para sign_messages_mode (text)';\n      -- Atualiza apenas os registros que ainda não foram migrados (garantia extra)\n      EXECUTE format('UPDATE %I.%I SET sign_messages_mode = CASE WHEN sign_messages = true THEN ''assigned_display_name'' ELSE ''none'' END WHERE sign_messages IS NOT NULL AND (sign_messages_mode = ''none'' OR sign_messages_mode IS NULL);', _sch, _tbl);\n      RAISE NOTICE '[Migration v1.1.0] Removendo coluna antiga sign_messages';\n      EXECUTE format('ALTER TABLE %I.%I DROP COLUMN sign_messages', _sch, _tbl);\n    ELSE\n        RAISE NOTICE '[Migration v1.1.0] Coluna antiga sign_messages não encontrada para remover/migrar.';\n    END IF;\n\n    RAISE NOTICE '[Migration v1.1.0] Alterações concluídas.';\n  ELSE\n    RAISE NOTICE '[Migration v1.1.0] Schema já está na versão % ou superior. Nenhuma alteração aplicada para v1.1.0.', COALESCE(_current_ver, 'N/A');\n  END IF; -- Fim do IF _current_ver < '1.1.0'\n\n\n  -- ============================================================\n  -- PLACEHOLDER PARA PRÓXIMA MIGRAÇÃO (Exemplo: v1.2.0)\n  -- ============================================================\n  /*\n  -- Aplica SOMENTE SE a versão atual for anterior a 1.2.0\n  IF _current_ver IS NULL OR _current_ver < '1.2.0' THEN\n    RAISE NOTICE '[Migration v1.2.0] Aplicando alterações...';\n\n    -- Adicione aqui os comandos ALTER TABLE, UPDATE, etc. para a v1.2.0\n    -- Exemplo: EXECUTE format('ALTER TABLE %I.%I ADD COLUMN nova_feature BOOLEAN DEFAULT false', _sch, _tbl);\n\n    RAISE NOTICE '[Migration v1.2.0] Alterações concluídas.';\n  ELSE\n     RAISE NOTICE '[Migration v1.2.0] Schema já está na versão % ou superior. Nenhuma alteração aplicada para v1.2.0.', COALESCE(_current_ver, 'N/A');\n  END IF; -- Fim do IF _current_ver < '1.2.0'\n  */\n\n\n  -- ============================================================\n  -- PASSO FINAL: Atualizar a versão registrada no banco\n  -- ============================================================\n  -- Garante que a tabela de versão exista\n  EXECUTE format('CREATE TABLE IF NOT EXISTS %I._schema_version (version TEXT PRIMARY KEY)', _sch);\n  -- Atualiza ou insere a versão ALVO desta execução do script\n  RAISE NOTICE '[Migration Runner] Atualizando _schema_version para %', _target_ver;\n  EXECUTE format('INSERT INTO %I._schema_version (version) VALUES (%L) ON CONFLICT (version) DO UPDATE SET version = EXCLUDED.version;', _sch, _target_ver);\n\nEND\n$$ LANGUAGE plpgsql;\n\n-- 3. Retorna sucesso se o script executou sem erro SQL\nSELECT true AS success, format('Schema verificado/atualizado para versão %s.', $3) AS message;","options":{"queryReplacement":"={{ [\n  String($('setUpdate')?.item?.json?.schema ?? ''),\n  String($('setUpdate')?.item?.json?.table_name ?? ''),\n  String($('setUpdate')?.item?.json?.version ?? '')\n] }}"}},"id":"74ade02b-f58e-4670-a83f-1137a8ae38a1","name":"updateTable","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1392,928],"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}},"onError":"continueRegularOutput"}],"connections":{"executeManually":{"main":[[{"node":"setVariablesClean","type":"main","index":0}]]},"htmlConfig":{"main":[[{"node":"respondConfigUi","type":"main","index":0}]]},"authHeaderConfig":{"main":[[{"node":"authVerifyConfig","type":"main","index":0}]]},"authVerifyConfig":{"main":[[{"node":"checkTableData","type":"main","index":0}],[{"node":"noAuthMessage","type":"main","index":0}]]},"respondConfigUi":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"instanceUpsert":{"main":[[{"node":"formatDbResponse","type":"main","index":0}]]},"createTable":{"main":[[{"node":"formatDbResponse","type":"main","index":0}]]},"setDelete":{"main":[[{"node":"instanceDelete","type":"main","index":0}]]},"instanceDelete":{"main":[[{"node":"formatDbResponse","type":"main","index":0}]]},"checkTableData":{"main":[[{"node":"htmlConfig","type":"main","index":0}]]},"setCreate":{"main":[[{"node":"createTable","type":"main","index":0}]]},"setVariables":{"main":[[{"node":"authHeaderConfig","type":"main","index":0}]]},"setUpsert":{"main":[[{"node":"instanceUpsert","type":"main","index":0}]]},"formatDbResponse":{"main":[[{"node":"respondDbUpsert","type":"main","index":0}]]},"webhookData":{"main":[[{"node":"setVariables","type":"main","index":0}],[{"node":"requestVerify","type":"main","index":0}]]},"requestVerify":{"main":[[{"node":"setCreate","type":"main","index":0}],[{"node":"setUpdate","type":"main","index":0}],[{"node":"setUpsert","type":"main","index":0}],[{"node":"setDelete","type":"main","index":0}]]},"setVariablesClean":{"main":[[{"node":"databaseClean","type":"main","index":0}]]},"respondAuthConfig":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"respondDbUpsert":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"noAuthMessage":{"main":[[{"node":"respondAuthConfig","type":"main","index":0}]]},"setUpdate":{"main":[[{"node":"updateTable","type":"main","index":0}]]},"updateTable":{"main":[[{"node":"formatDbResponse","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"92d2a054-2a99-4281-8dcc-757bd37a17bc","activeVersionId":"92d2a054-2a99-4281-8dcc-757bd37a17bc","triggerCount":1,"shared":[{"updatedAt":"2025-11-20T17:35:53.188Z","createdAt":"2025-11-20T17:35:53.188Z","role":"workflow:owner","workflowId":"7k3THfFFNcTLmUnr","projectId":"Cf0rhzAQivp560yX"}],"activeVersion":{"updatedAt":"2025-11-26T21:17:26.817Z","createdAt":"2025-11-26T21:17:26.817Z","versionId":"92d2a054-2a99-4281-8dcc-757bd37a17bc","workflowId":"7k3THfFFNcTLmUnr","nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[64,2064],"id":"39c70610-cb61-4c38-bc29-87f40412cc2f","name":"executeManually","disabled":true},{"parameters":{"html":"<!doctype html>\n<html lang=\"pt-BR\">\n\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n  <title>Integração Chatwoot x UaZapi - Configuração</title>\n  <script src=\"https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4\"></script>\n  <style>\n    .card {\n      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05)\n    }\n\n    .btn {\n      padding: .5rem .75rem;\n      border-radius: .5rem;\n      font-size: .875rem;\n      line-height: 1rem;\n      cursor: pointer;\n      font-weight: 500\n    }\n\n    .btn:disabled {\n      opacity: .6;\n      cursor: not-allowed\n    }\n\n    .btn-secondary {\n      background: #e2e8f0;\n      color: #0f172a\n    }\n\n    .btn-secondary:hover:not(:disabled) {\n      background: #cbd5e1\n    }\n\n    .btn-primary {\n      background: #16a34a;\n      color: #fff\n    }\n\n    .btn-primary:hover:not(:disabled) {\n      background: #15803d\n    }\n\n    .btn-warn {\n      background: #f59e0b;\n      color: #111827\n    }\n\n    .btn-warn:hover:not(:disabled) {\n      background: #d97706\n    }\n\n    .tbl tr {\n      cursor: pointer\n    }\n\n    .tbl tr:hover {\n      background: #f8fafc\n    }\n\n    .tabs {\n      display: flex;\n      gap: .25rem;\n      padding: .25rem\n    }\n\n    .tab-btn {\n      appearance: none;\n      border: 1px solid #cbd5e1;\n      border-bottom: none;\n      background: #f1f5f9;\n      color: #475569;\n      padding: .5rem .75rem;\n      font-size: .875rem;\n      line-height: 1rem;\n      border-top-left-radius: .5rem;\n      border-top-right-radius: .5rem;\n      cursor: pointer\n    }\n\n    .tab-btn:hover {\n      background: #e2e8f0;\n      color: #0f172a\n    }\n\n    .tab-btn[aria-selected=\"true\"] {\n      background: #fff;\n      color: #0f172a;\n      box-shadow: inset 0 -3px 0 #16a34a;\n      position: relative;\n      z-index: 1\n    }\n\n    .tab-rail {\n      border-bottom: 1px solid #cbd5e1;\n      background: #f8fafc;\n      border-top-left-radius: .5rem;\n      border-top-right-radius: .5rem\n    }\n\n    .tab-panel {\n      display: none\n    }\n\n    .tab-panel.active {\n      display: block\n    }\n\n    .modal-body {\n      max-height: min(70vh, 800px);\n      overflow: auto\n    }\n\n    @media (max-width:640px) {\n      .modal-body {\n        max-height: 70vh\n      }\n    }\n\n    .modal-body::after {\n      content: '';\n      display: block;\n      height: 1.5rem\n    }\n\n    .toggle {\n      position: relative;\n      width: 44px;\n      height: 24px\n    }\n\n    .toggle input {\n      appearance: none;\n      width: 44px;\n      height: 24px;\n      border-radius: 999px;\n      background: #cbd5e1;\n      outline: none;\n      cursor: pointer;\n      transition: background .15s\n    }\n\n    .toggle input:checked {\n      background: #16a34a\n    }\n\n    .toggle .dot {\n      position: absolute;\n      top: 3px;\n      left: 3px;\n      width: 18px;\n      height: 18px;\n      border-radius: 999px;\n      background: #fff;\n      transition: transform .15s\n    }\n\n    .toggle input:checked+.dot {\n      transform: translateX(20px)\n    }\n\n    .field {\n      position: relative;\n      border: 1px solid #e2e8f0;\n      border-radius: .5rem;\n      padding: .5rem .75rem;\n      background: #fff\n    }\n\n    .help {\n      font-size: .8rem;\n      color: #64748b\n    }\n\n    .req::after {\n      content: \" *\";\n      color: #dc2626;\n      font-weight: 600\n    }\n\n    .tip-err {\n      margin-top: .25rem;\n      background: #fff7ed;\n      color: #92400e;\n      border: 1px solid #fcd34d;\n      padding: .4rem .6rem;\n      border-radius: .5rem;\n      font-size: .85rem;\n      display: flex;\n      align-items: center;\n      gap: .4rem\n    }\n\n    .tip-err svg {\n      width: 18px;\n      height: 18px\n    }\n\n    .field.err {\n      border-color: #fca5a5\n    }\n\n    input::placeholder,\n    textarea::placeholder {\n      color: #94a3b8;\n      opacity: 1;\n    }\n  </style>\n</head>\n\n<body class=\"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900\">\n  <main class=\"max-w-4xl mx-auto px-6 py-10\">\n    <h1 class=\"text-3xl font-semibold tracking-tight mb-1\">Integração Chatwoot x UaZapi</h1>\n    <div id=\"top-banner\" class=\"hidden\"></div>\n\n    <section id=\"setup-view\" class=\"card rounded-xl border bg-white overflow-hidden\"\n      style=\"{{ ($('checkTableData')?.item?.json?.tableExists && !$('checkTableData')?.item?.json?.needsMigration) ? 'display:none;' : '' }}\">\n\n      <div id=\"setup-create-content\" style=\"{{ $('checkTableData')?.item?.json?.tableExists ? 'display:none;' : '' }}\">\n\n        <div class=\"flex items-start gap-4 p-6 border-b\">\n          <div class=\"h-12 w-12 shrink-0 rounded-full bg-amber-100 flex items-center justify-center\">\n            <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-amber-700\" viewBox=\"0 0 24 24\" fill=\"none\"\n              stroke=\"currentColor\">\n              <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\n                d=\"M12 9v2m0 4h.01M12 19a7 7 0 100-14 7 7 0 000 14z\" />\n            </svg>\n          </div>\n\n          <div>\n            <h2 class=\"text-lg font-semibold text-amber-800\">Tabela de configuração não encontrada!</h2>\n            <p class=\"mt-1 text-slate-600\">A tabela <strong>{{ $('checkTableData')?.item?.json?.database?.schema\n                }}.{{ $('checkTableData')?.item?.json?.database?.table_name }}</strong> não existe. Deseja\n              criá-la agora?</p>\n\n          </div>\n        </div>\n\n        <div class=\"mx-6 mt-6 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg p-3\">\n          <div class=\"flex items-start gap-1.5\">\n            <svg class=\"h-5 w-5 shrink-0 text-amber-500 mt-0.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\"\n              aria-hidden=\"true\">\n              <path fill-rule=\"evenodd\"\n                d=\"M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.593c.74 1.316-.206 2.958-1.742 2.958H3.48c-1.536 0-2.482-1.642-1.741-2.958L8.257 3.1zM11 14a1 1 0 10-2 0 1 1 0 002 0zm-.25-6.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5z\"\n                clip-rule=\"evenodd\" />\n            </svg>\n            <div>\n              <strong>Atenção:</strong>\n              A VERSÃO DO SCHEMA não necessariamente precisa ser igual a versão do <strong>Kit de\n                Integração</strong>. Quando for necessário alterar, já informaremos a nova versão automaticamente.\n            </div>\n          </div>\n        </div>\n        <div class=\"p-6 grid gap-4 sm:grid-cols-[2fr_2fr_1fr]\">\n\n          <div class=\"rounded-lg bg-slate-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-slate-500\">SCHEMA</div>\n            <div class=\"mt-1 font-medium text-slate-900\">{{ $('checkTableData')?.item?.json?.database?.schema }}\n            </div>\n          </div>\n          <div class=\"rounded-lg bg-slate-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-slate-500\">TABELA</div>\n            <div class=\"mt-1 font-medium text-slate-900\">{{\n              $('checkTableData')?.item?.json?.database?.table_name }}</div>\n          </div>\n          <div class=\"rounded-lg bg-emerald-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-emerald-600 whitespace-nowrap\">VERSÃO DO SCHEMA\n            </div>\n            <div class=\"mt-1 font-medium text-emerald-800\">{{ $('checkTableData')?.item?.json?.expected_version\n              }}</div>\n          </div>\n        </div>\n\n      </div>\n      <div class=\"p-6 border-t flex flex-wrap gap-2 items-center\">\n        <form id=\"frmCreateDb\" class=\"flex gap-2 items-center\">\n          <input type=\"hidden\" name=\"action\" value=\"create\">\n          <input type=\"hidden\" name=\"schema\" value=\"{{ $('checkTableData')?.item?.json?.database?.schema }}\">\n          <input type=\"hidden\" name=\"table_name\" value=\"{{ $('checkTableData')?.item?.json?.database?.table_name }}\">\n          <input type=\"hidden\" name=\"version\" value=\"{{ $('checkTableData')?.item?.json?.database?.version}}\">\n          <button type=\"submit\" class=\"btn btn-warn\" id=\"btnCreateTable\">Criar Tabela Agora</button>\n        </form>\n      </div>\n      </div>\n\n      <div id=\"setup-migrate-content\"\n        style=\"{{ !($('checkTableData')?.item?.json?.tableExists && $('checkTableData')?.item?.json?.needsMigration) ? 'display:none;' : '' }}\">\n        <div class=\"flex items-start gap-4 p-6 border-b\">\n          <div class=\"h-12 w-12 shrink-0 rounded-full bg-blue-100 flex items-center justify-center\">\n            <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-blue-700\" fill=\"none\" viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\" stroke-width=\"2\">\n              <path stroke-linecap=\"round\" stroke-linejoin=\"round\"\n                d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15\" />\n            </svg>\n          </div>\n          <div>\n            <h2 class=\"text-lg font-semibold text-blue-800\">Atualização de Schema Necessária!</h2>\n            <p class=\"mt-1 text-slate-600\">\n              A estrutura da tabela <strong>{{ $('checkTableData')?.item?.json?.database?.schema }}.{{\n                $('checkTableData')?.item?.json?.database?.table_name }}</strong> precisa ser atualizada.\n            </p>\n            <div class=\"mt-2 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg p-3\">\n              <div class=\"flex items-start gap-1.5\">\n                <svg class=\"h-5 w-5 shrink-0 text-amber-500 mt-0.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\"\n                  aria-hidden=\"true\">\n                  <path fill-rule=\"evenodd\"\n                    d=\"M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.593c.74 1.316-.206 2.958-1.742 2.958H3.48c-1.536 0-2.482-1.642-1.741-2.958L8.257 3.1zM11 14a1 1 0 10-2 0 1 1 0 002 0zm-.25-6.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5z\"\n                    clip-rule=\"evenodd\" />\n                </svg>\n                <div>\n                  <strong>Atenção:</strong>\n                  Se precisar manter a versão atual (<strong>{{\n                    $('checkTableData')?.item?.json?.current_db_version || 'N/A' }}</strong>), você\n                  deverá reverter este workflow para uma versão compatível. Prosseguir atualizará o\n                  banco de dados para a versão <strong>{{\n                    $('checkTableData')?.item?.json?.expected_version }}</strong>.\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class=\"p-6 grid gap-4 sm:grid-cols-[2fr_2fr_1fr_1fr]\">\n          <div class=\"rounded-lg bg-slate-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-slate-500\">SCHEMA</div>\n            <div class=\"mt-1 font-medium text-slate-900\">{{ $('checkTableData')?.item?.json?.database?.schema }}\n            </div>\n          </div>\n          <div class=\"rounded-lg bg-slate-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-slate-500\">TABELA</div>\n            <div class=\"mt-1 font-medium text-slate-900\">{{\n              $('checkTableData')?.item?.json?.database?.table_name }}</div>\n          </div>\n          <div class=\"rounded-lg bg-red-50 border border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-red-600 whitespace-nowrap\">VERSÃO ATUAL</div>\n            <div class=\"mt-1 font-medium text-red-800\">{{ $('checkTableData')?.item?.json?.current_db_version\n              || 'N/A' }}</div>\n          </div>\n          <div class=\"rounded-lg bg-emerald-50 border p-4\">\n            <div class=\"text-xs uppercase tracking-wide text-emerald-600 whitespace-nowrap\">VERSÃO ESPERADA\n            </div>\n            <div class=\"mt-1 font-medium text-emerald-800\">{{ $('checkTableData')?.item?.json?.expected_version\n              }}</div>\n          </div>\n        </div>\n        <div class=\"p-6 border-t flex flex-wrap gap-2 items-center\">\n          <form id=\"frmUpdateSchema\" class=\"flex gap-2 items-center\">\n            <input type=\"hidden\" name=\"action\" value=\"migrate\">\n            <input type=\"hidden\" name=\"schema\" value=\"{{ $('checkTableData')?.item?.json?.database?.schema }}\">\n            <input type=\"hidden\" name=\"table_name\" value=\"{{ $('checkTableData')?.item?.json?.database?.table_name }}\">\n            <input type=\"hidden\" name=\"target_version\" value=\"{{ $('checkTableData')?.item?.json?.expected_version }}\">\n            <input type=\"hidden\" name=\"version\" value=\"{{ $('checkTableData')?.item?.json?.database?.version}}\">\n            <button type=\"submit\" class=\"btn btn-primary\" id=\"btnUpdateSchema\">Atualizar Schema\n              Agora</button>\n          </form>\n        </div>\n      </div>\n\n      <div id=\"setup-banner\" class=\"hidden mx-6 mb-4\"></div>\n    </section>\n\n    <section id=\"config-view\" class=\"card rounded-xl border bg-white overflow-hidden\"\n      style=\"{{ !($('checkTableData')?.item?.json?.tableExists && !$('checkTableData')?.item?.json?.needsMigration) ? 'display:none;' : '' }}\">\n\n      <header class=\"p-5 flex items-center justify-between border-b\">\n        <div>\n          <h2 class=\"text-xl font-semibold tracking-tight\">Configurar Instâncias</h2>\n          <div class=\"text-sm text-slate-600 mt-1\">Schema: <strong>{{\n              $('checkTableData')?.item?.json?.database?.schema }}</strong> • Tabela: <strong>{{\n              $('checkTableData')?.item?.json?.database?.table_name }}</strong></div>\n        </div>\n        <div class=\"flex gap-2\"><button id=\"btnAdd\" class=\"btn btn-primary\">Incluir instância</button></div>\n      </header>\n      <div\n        class=\"mx-5 mt-4 flex items-start gap-3 rounded-lg border border-amber-300 bg-amber-50 px-3 py-2 text-sm text-amber-900\"\n        role=\"alert\">\n        <svg class=\"h-5 w-5 shrink-0 text-amber-500 mt-0.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\" aria-hidden=\"true\">\n          <path fill-rule=\"evenodd\"\n            d=\"M8.257 3.099c.765-1.36 2.72-1.36 3.485 0l6.518 11.593c.74 1.316-.206 2.958-1.742 2.958H3.48c-1.536 0-2.482-1.642-1.741-2.958L8.257 3.1zM11 14a1 1 0 10-2 0 1 1 0 002 0zm-.25-6.75a.75.75 0 00-1.5 0v3.5a.75.75 0 001.5 0v-3.5z\"\n            clip-rule=\"evenodd\" />\n        </svg>\n        <p><span class=\"font-medium\">Dê um <em>duplo-clique</em></span> sobre a linha que quer editar ou clique\n          em <span class=\"italic\"><strong>Incluir instância</strong></span>.</p>\n      </div>\n      <div class=\"p-5\">\n        <div class=\"mb-3 flex flex-wrap items-center gap-3\">\n          <label class=\"text-sm text-slate-600\">Registros por página<select id=\"pageSize\"\n              class=\"ml-2 rounded-md border px-2 py-1\">\n              <option value=\"10\" selected>10</option>\n              <option value=\"20\">20</option>\n              <option value=\"50\">50</option>\n              <option value=\"100\">100</option>\n            </select></label>\n          <div class=\"text-sm text-slate-500\" id=\"rangeInfo\">Exibindo 0–0 de 0</div>\n          <div class=\"ml-auto flex items-center gap-2\"><button id=\"prevBtn\"\n              class=\"btn btn-secondary\">Anterior</button><span id=\"pageInfo\" class=\"text-sm text-slate-600\">Página\n              1/1</span><button id=\"nextBtn\" class=\"btn btn-secondary\">Próxima</button></div>\n        </div>\n        <div id=\"emptyState\" class=\"rounded-lg border bg-slate-50 p-6 text-center\" style=\"display: none;\">\n          <p class=\"text-slate-600 mb-3\">Nenhuma instância cadastrada.</p><button id=\"btnAddEmpty\"\n            class=\"btn btn-primary\">Incluir instância</button>\n        </div>\n        <div class=\"overflow-x-auto\">\n          <table id=\"grid\" class=\"tbl hidden w-full text-left text-sm border-separate border-spacing-y-2\"\n            style=\"display: none;\">\n            <thead>\n              <tr class=\"text-slate-500\">\n                <th class=\"px-3\">ID</th>\n                <th class=\"px-3\">Instance Name</th>\n                <th class=\"px-3\">Inbox Name</th>\n                <th class=\"px-3\">Account#</th>\n                <th class=\"px-3\">Inbox#</th>\n                <th class=\"px-3\">Atualizado</th>\n              </tr>\n            </thead>\n            <tbody id=\"tbody\"></tbody>\n          </table>\n        </div>\n      </div>\n    </section>\n    <p class=\"mt-6 text-center text-xs text-slate-500\">\n      Disponibilizado por <strong>{{ $('checkTableData')?.item?.json?.automation?.branding }}</strong>\n      <span class=\"ml-1\">|</span>\n      <span class=\"ml-1\">Kit de Integração v{{ $('checkTableData')?.item?.json?.database?.kitVersion }}, Schema v{{\n        $('checkTableData')?.item?.json?.database?.version }}</span>\n    </p>\n  </main>\n\n  <script>\n    // === VARIÁVEIS GLOBAIS ===\n    const CHECK = {{ JSON.stringify($('checkTableData')?.item?.json) }};\n    const INSTANCES = {{ JSON.stringify(($('checkTableData')?.item?.json?.instances) || []) }};\n    const SCHEMA = \"{{ $('checkTableData')?.item?.json?.database?.schema }}\";\n    const TABLE = \"{{ $('checkTableData')?.item?.json?.database?.table_name }}\";\n    const VERSION = \"{{ $('checkTableData')?.item?.json?.database?.version }}\";\n    const WEBHOOK_URL = \"/webhook/{{ $('checkTableData')?.item?.json?.webhook.path }}\";\n\n    // === HELPERS ===\n    const ls = { get(k) { try { return window.localStorage.getItem(k); } catch { return null; } }, set(k, v) { try { window.localStorage.setItem(k, v); } catch { } }, del(k) { try { window.localStorage.removeItem(k); } catch { } } };\n\n    function showBanner(id, kind, text) {\n      const el = document.getElementById(id);\n      if (!el) return;\n      const ICONS = { ok: `<svg class=\"h-5 w-5 text-emerald-600\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" /></svg>`, warn: `<svg class=\"h-5 w-5 text-amber-600\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z\" /></svg>`, error: `<svg class=\"h-5 w-5 text-red-600\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\" /></svg>` };\n      const iconHtml = ICONS[kind] || ICONS.error;\n      const colorClass = kind === 'error' ? 'border-red-300 bg-red-50 text-red-900' : kind === 'warn' ? 'border-amber-300 bg-amber-50 text-amber-900' : 'border-emerald-300 bg-emerald-50 text-emerald-900';\n      el.className = `mx-6 my-3 rounded-lg border px-4 py-3 text-sm ${colorClass}`;\n      el.innerHTML = `<div class=\"flex items-start gap-3\"><div class=\"shrink-0 mt-0.5\">${iconHtml}</div><div class=\"flex-1\">${text}</div></div>`;\n      el.classList.remove('hidden');\n    }\n\n    function showTopBanner(kind, text) {\n      const el = document.getElementById('top-banner');\n      if (!el) return;\n      const colorClass = kind === 'ok' ? 'border-emerald-300 bg-emerald-50 text-emerald-800' : kind === 'warn' ? 'border-amber-300 bg-amber-50 text-amber-800' : 'border-red-300 bg-red-50 text-red-800';\n      el.className = `mx-0 mb-4 rounded-lg border px-3 py-2 text-sm ${colorClass}`;\n      el.textContent = text;\n      el.classList.remove('hidden');\n    }\n\n    // === MODAL DE CONFIRMAÇÃO DE EXCLUSÃO (Global) ===\n    function showConfirmationModal() {\n      return new Promise((resolve, reject) => {\n        const modalHtml = `\n                <div id=\"confirm-modal-backdrop\" class=\"fixed inset-0 z-[60] grid place-items-center bg-black/40 p-4\">\n                  <div class=\"w-full max-w-md rounded-xl border bg-white card p-6 text-center\">\n                    <div class=\"mx-auto h-12 w-12 shrink-0 rounded-full bg-amber-100 flex items-center justify-center\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-amber-700\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01M12 19a7 7 0 100-14 7 7 0 000 14z\" />\n                      </svg>\n                    </div>\n                    <h2 class=\"text-lg font-semibold mt-4\">Confirmar Exclusão</h2>\n                    <p class=\"mt-2 text-slate-600\">Tem certeza que deseja excluir esta instância? A ação não poderá ser desfeita.</p>\n                    <div class=\"mt-6 flex justify-center gap-3\">\n                      <button type=\"button\" id=\"btnCancelDelete\" class=\"btn btn-secondary\">Cancelar</button>\n                      <button type=\"button\" id=\"btnConfirmDelete\" class=\"btn btn-warn\">Sim, Excluir</button>\n                    </div>\n                  </div>\n                </div>`;\n        const wrap = document.createElement('div');\n        wrap.innerHTML = modalHtml;\n        document.body.appendChild(wrap);\n        const backdrop = wrap.querySelector('#confirm-modal-backdrop');\n        const btnCancel = wrap.querySelector('#btnCancelDelete');\n        const btnConfirm = wrap.querySelector('#btnConfirmDelete');\n        const cleanup = () => {\n          document.removeEventListener('keydown', handleEsc);\n          wrap.remove();\n        };\n        const handleEsc = (e) => {\n          if (e.key === 'Escape') {\n            cleanup();\n            reject();\n          }\n        };\n        btnCancel.addEventListener('click', () => {\n          cleanup();\n          reject();\n        });\n        btnConfirm.addEventListener('click', () => {\n          cleanup();\n          resolve();\n        });\n        backdrop.addEventListener('click', (e) => {\n          if (e.target.id === 'confirm-modal-backdrop') {\n            cleanup();\n            reject();\n          }\n        });\n        document.addEventListener('keydown', handleEsc);\n        btnConfirm.focus();\n      });\n    }\n\n    // === MODAL DE CONFIRMAÇÃO DE MIGRAÇÃO (Global) ===\n    function showMigrationConfirmationModal() {\n      return new Promise((resolve, reject) => {\n        const modalHtml = `\n              <div id=\"migrate-confirm-modal-backdrop\" class=\"fixed inset-0 z-[60] grid place-items-center bg-black/40 p-4\">\n                <div class=\"w-full max-w-md rounded-xl border bg-white card p-6 text-center\">\n                   <div class=\"mx-auto h-12 w-12 shrink-0 rounded-full bg-blue-100 flex items-center justify-center\">\n                     <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-blue-700\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\">\n                       <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15\" />\n                     </svg>\n                   </div>\n                   <h2 class=\"text-lg font-semibold mt-4\">Confirmar Atualização do Schema</h2>\n                   <p class=\"mt-2 text-slate-600\">\n                     Tem certeza que deseja atualizar a estrutura do banco de dados para a versão <strong>${CHECK.expected_version}</strong>?\n                     Esta ação pode alterar ou remover colunas existentes.\n                   </p>\n                   <div class=\"mt-6 flex justify-center gap-3\">\n                     <button type=\"button\" id=\"btnCancelMigrate\" class=\"btn btn-secondary\">Cancelar</button>\n                     <button type=\"button\" id=\"btnConfirmMigrate\" class=\"btn btn-primary\">Sim, Atualizar Schema</button>\n                   </div>\n                 </div>\n              </div>`;\n        const wrap = document.createElement('div');\n        wrap.innerHTML = modalHtml;\n        document.body.appendChild(wrap);\n        const backdrop = wrap.querySelector('#migrate-confirm-modal-backdrop');\n        const btnCancel = wrap.querySelector('#btnCancelMigrate');\n        const btnConfirm = wrap.querySelector('#btnConfirmMigrate');\n        const cleanup = () => {\n          document.removeEventListener('keydown', handleEsc);\n          wrap.remove();\n        };\n        const handleEsc = (e) => {\n          if (e.key === 'Escape') {\n            cleanup();\n            reject();\n          }\n        };\n        btnCancel.addEventListener('click', () => {\n          cleanup();\n          reject();\n        });\n        btnConfirm.addEventListener('click', () => {\n          cleanup();\n          resolve();\n        });\n        backdrop.addEventListener('click', (e) => {\n          if (e.target.id === 'migrate-confirm-modal-backdrop') {\n            cleanup();\n            reject();\n          }\n        });\n        document.addEventListener('keydown', handleEsc);\n        btnConfirm.focus();\n      });\n    }\n\n    // === INICIALIZAÇÃO ===\n    document.addEventListener('DOMContentLoaded', () => {\n      if (ls.get('cw:uazapi:justCreated') === '1' && CHECK?.tableExists && !CHECK?.needsMigration) {\n        ls.del('cw:uazapi:justCreated'); showTopBanner('ok', 'Tabela criada com sucesso!');\n      }\n      if (ls.get('cw:uazapi:justMigrated') === '1' && CHECK?.tableExists && !CHECK?.needsMigration) {\n        ls.del('cw:uazapi:justMigrated'); showTopBanner('ok', `Schema atualizado para v${CHECK.expected_version}!`);\n      }\n      document.getElementById('frmCreateDb')?.addEventListener('submit', handleCreateDbSubmit);\n      document.getElementById('frmUpdateSchema')?.addEventListener('submit', handleUpdateSchemaSubmit);\n\n      const configView = document.getElementById('config-view');\n      if (configView && configView.style.display !== 'none') {\n        initList();\n      }\n    });\n\n    // === HANDLERS PARA SETUP VIEW ===\n    async function handleCreateDbSubmit(e) {\n      e.preventDefault();\n      const btn = document.getElementById('btnCreateTable');\n      btn.disabled = true;\n      btn.textContent = 'Criando...';\n\n      try {\n        const fd = new FormData(e.target);\n        fd.set('action', 'create');\n        const res = await fetch(WEBHOOK_URL, {\n          method: 'POST',\n          body: fd,\n          headers: { 'Accept': 'application/json' }\n        });\n\n        let data = {};\n        try {\n          data = await res.json();\n        } catch { }\n\n        if (!res.ok) {\n          throw new Error(data.friendlyMessage || 'Falha ao criar a tabela.');\n        }\n\n        // Função anônima para atualizar a UI para o estado de \"Sucesso\"\n        (() => {\n          const header = document.querySelector('#setup-view .border-b');\n          if (header) {\n            const iconWrap = header.querySelector('.h-12');\n            if (iconWrap) {\n              iconWrap.classList.remove('bg-amber-100');\n              iconWrap.classList.add('bg-emerald-100');\n              const svg = iconWrap.querySelector('svg');\n              if (svg) {\n                svg.outerHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-7 w-7 text-emerald-700\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"/></svg>`;\n              }\n            }\n            const h2 = header.querySelector('h2');\n            if (h2) {\n              h2.className = 'text-lg font-semibold text-emerald-800';\n              h2.textContent = 'Tudo certo!';\n            }\n            const p = header.querySelector('p');\n            if (p) {\n              p.innerHTML = `O banco de dados <strong>${SCHEMA}.${TABLE}</strong> já existe e está pronto para uso.`;\n            }\n          }\n          btn.textContent = 'Criado!';\n          btn.disabled = true;\n        })();\n\n        // HTML para o banner de sucesso pós-criação\n        const bannerHtml = `\n      <div class=\"flex items-start gap-3\">\n        <div class=\"flex-1\">\n          <p class=\"font-medium\">Tabela criada com sucesso!</p>\n          <p class=\"mt-1 text-slate-700\">Você pode criar uma instância modelo ou ir direto para o gerenciador.</p>\n          <div class=\"mt-3 flex items-center gap-3\">\n            <span class=\"text-sm\">Criar instância modelo</span>\n            <label class=\"toggle\">\n              <input id=\"seedToggle\" type=\"checkbox\" />\n              <span class=\"dot\"></span>\n            </label>\n          </div>\n          <div class=\"mt-4\">\n            <button id=\"goManagerBtn\" class=\"btn btn-primary\" type=\"button\">Ir para o Gerenciador</button>\n          </div>\n        </div>\n      </div>`;\n\n        showBanner('setup-banner', 'ok', bannerHtml);\n\n        // Adiciona o listener ao novo botão \"Ir para o Gerenciador\"\n        document.getElementById('goManagerBtn')?.addEventListener('click', async (ev) => {\n          ev.currentTarget.disabled = true;\n          ev.currentTarget.textContent = 'Processando...';\n\n          if (document.getElementById('seedToggle')?.checked) {\n            try {\n              await seedDefaultInstance();\n            } catch { }\n          }\n\n          ls.set('cw:uazapi:justCreated', '1');\n          (window.top || window).location.replace(WEBHOOK_URL);\n        });\n\n      } catch (err) {\n        showBanner('setup-banner', 'error', err.message || 'Ocorreu um erro de rede.');\n        btn.disabled = false;\n        btn.textContent = 'Criar Tabela Agora';\n      }\n    }\n\n    async function handleUpdateSchemaSubmit(e) {\n      e.preventDefault();\n      const btn = document.getElementById('btnUpdateSchema');\n      const originalText = btn.textContent;\n      const bannerId = 'setup-banner';\n\n      try {\n        await showMigrationConfirmationModal();\n      } catch {\n        return;\n      }\n\n      btn.disabled = true;\n      btn.textContent = 'Atualizando Schema...';\n\n      try {\n        const fd = new FormData(e.target);\n        const res = await fetch(WEBHOOK_URL, { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });\n        let data = {};\n        try {\n          data = await res.json();\n        } catch (parseError) {\n          const textResponse = await res.text();\n          if (!res.ok) {\n            throw new Error(data.friendlyMessage || `Falha ao atualizar o schema (HTTP ${res.status}). Resposta: ${textResponse}`);\n          }\n          console.warn(\"Status da resposta OK, mas parse JSON falhou.\");\n        }\n\n        if (!res.ok) {\n          throw new Error(data.friendlyMessage || 'Falha ao atualizar o schema.');\n        }\n\n        ls.set('cw:uazapi:justMigrated', '1');\n        showBanner(bannerId, 'ok', 'Schema atualizado com sucesso! Recarregando página...');\n        setTimeout(() => { (window.top || window).location.replace(WEBHOOK_URL); }, 1500);\n\n      } catch (err) {\n        showBanner(bannerId, 'error', err.message || 'Ocorreu um erro de rede ao tentar atualizar.');\n        btn.disabled = false;\n        btn.textContent = originalText;\n      }\n    }\n\n    async function seedDefaultInstance() {\n      const now = Date.now();\n      const fd = new FormData();\n      fd.set('action', 'upsert');\n      fd.set('schema', SCHEMA);\n      fd.set('table_name', TABLE);\n      fd.set('chatwoot_base_url', 'https://app.chatwoot.com');\n      fd.set('chatwoot_api_version', 'v1');\n      fd.set('chatwoot_token', `cw-token-exemplo-${now}`);\n      fd.set('chatwoot_account_id', '1');\n      fd.set('chatwoot_inbox_id', '1');\n      fd.set('chatwoot_inbox_name', 'Instância Modelo');\n      fd.set('chatwoot_track_id', `track-id-exemplo-${now}`);\n      fd.set('api_base_url', 'https://api.uazapi.com');\n      fd.set('api_token', `uazapi-token-exemplo-${now}`);\n      fd.set('api_instance_name', 'Instância Modelo');\n      fd.set('ignore_groups', 'true');\n      fd.set('reply_messages', 'true');\n      fd.set('edit_messages', 'true');\n      fd.set('delete_messages', 'true');\n      fd.set('reopen_conversation', 'true');\n      fd.set('conversation_pending', 'false');\n      fd.set('import_contacts', 'false');\n      fd.set('import_messages', 'false');\n      fd.set('import_days_limit', '7');\n      fd.set('sign_messages_mode', 'none');\n      fd.set('sign_delimiter', '\\\\n\\\\n');\n      const res = await fetch(WEBHOOK_URL, { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });\n      if (!res.ok) { console.warn('Falha ao criar instância modelo:', await res.json()); }\n    }\n\n    // === LÓGICA DA LISTA E MODAL (CONFIG VIEW) ===\n    function initList() {\n      const DATA = Array.isArray(INSTANCES) ? INSTANCES : [];\n      const tbody = document.getElementById('tbody');\n      const empty = document.getElementById('emptyState');\n      const grid = document.getElementById('grid');\n      const btnAdd = document.getElementById('btnAdd');\n      const btnAddEmpty = document.getElementById('btnAddEmpty');\n      const pageSizeEl = document.getElementById('pageSize');\n      const pageInfo = document.getElementById('pageInfo');\n      const rangeInfo = document.getElementById('rangeInfo');\n      const prevBtn = document.getElementById('prevBtn');\n      const nextBtn = document.getElementById('nextBtn');\n      let page = 1; let pageSize = parseInt(pageSizeEl.value, 10);\n\n      function fmtDate(s) { if (!s) return ''; try { return new Date(s).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }); } catch { return s; } }\n\n      function render() {\n        tbody.innerHTML = ''; const total = DATA.length;\n        if (!total) {\n          empty.style.display = 'block';\n          grid.style.display = 'none';\n          pageInfo.textContent = 'Página 1/1'; rangeInfo.textContent = 'Exibindo 0–0 de 0'; prevBtn.disabled = true; nextBtn.disabled = true; return;\n        }\n        empty.style.display = 'none';\n        grid.style.display = 'table';\n        const pages = Math.max(1, Math.ceil(total / pageSize)); page = Math.min(page, pages); const start = (page - 1) * pageSize; const end = Math.min(start + pageSize, total);\n        DATA.slice(start, end).forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td class=\"px-3 py-2 font-medium text-slate-800\">${r.id}</td><td class=\"px-3 py-2\">${r.api_instance_name ?? ''}</td><td class=\"px-3 py-2\">${r.chatwoot_inbox_name ?? ''}</td><td class=\"px-3 py-2\">${r.chatwoot_account_id ?? ''}</td><td class=\"px-3 py-2\">${r.chatwoot_inbox_id ?? ''}</td><td class=\"px-3 py-2 text-slate-500\">${fmtDate(r.updated_at)}</td>`; tr.addEventListener('dblclick', () => openModal(r)); tbody.appendChild(tr); });\n        pageInfo.textContent = `Página ${page}/${pages}`; rangeInfo.textContent = `Exibindo ${total ? start + 1 : 0}–${end} de ${total}`; prevBtn.disabled = page <= 1; nextBtn.disabled = page >= pages;\n      }\n\n      prevBtn?.addEventListener('click', () => { if (page > 1) { page--; render(); } });\n      nextBtn?.addEventListener('click', () => { if (page < Math.max(1, Math.ceil(DATA.length / pageSize))) { page++; render(); } });\n      pageSizeEl?.addEventListener('change', e => { pageSize = parseInt(e.target.value, 10); page = 1; render(); });\n      btnAdd?.addEventListener('click', () => openModal(null));\n      btnAddEmpty?.addEventListener('click', () => openModal(null));\n      render();\n\n      function activateTab(modal, btn, all) { all.forEach(b => { b.setAttribute('aria-selected', 'false'); b.tabIndex = -1; }); btn.setAttribute('aria-selected', 'true'); btn.tabIndex = 0; btn.focus(); const id = btn.getAttribute('data-tab'); modal.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active')); modal.querySelector('#' + id).classList.add('active'); }\n\n      function openModal(row) {\n        const isEdit = !!row;\n        const v = isEdit ? { ...row } : { chatwoot_base_url: '', chatwoot_api_version: 'v1', chatwoot_token: '', chatwoot_account_id: '', chatwoot_inbox_id: '', chatwoot_inbox_name: '', chatwoot_track_id: '', api_base_url: '', api_token: '', api_instance_name: '', ignore_groups: true, reply_messages: true, edit_messages: true, delete_messages: true, reopen_conversation: true, conversation_pending: false, import_contacts: false, import_messages: false, import_days_limit: 7, sign_messages_mode: 'none', sign_delimiter: '\\\\n\\\\n' };\n        const currentSignMode = v.sign_messages_mode ?? 'none';\n        let delim = v.sign_delimiter ?? '\\\\n\\\\n';\n        if (!['\\\\n\\\\n', '\\\\n', ' '].includes(delim)) delim = '\\\\n\\\\n';\n        const html = `<div class=\"fixed inset-0 z-50 grid place-items-center bg-black/40 p-4\" id=\"modal-backdrop\">\n                        <div class=\"w-full max-w-4xl rounded-xl border bg-white card\">\n                            <form id=\"frm\" novalidate class=\"p-0\">\n                            <input type=\"hidden\" name=\"schema\" value=\"${SCHEMA}\">\n                            <input type=\"hidden\" name=\"table_name\" value=\"${TABLE}\">\n                            <input type=\"hidden\" name=\"id\" value=\"${isEdit ? v.id : ''}\">\n                            <div class=\"px-6 pt-6 pb-4 flex items-start justify-between gap-4 border-b\">\n                                <h2 class=\"text-lg font-semibold\">\n                                ${isEdit ? 'Editar instância' : 'Nova instância'}\n                                ${isEdit ? `<span class=\"ml-2 text-xs font-normal text-slate-500\">ID ${v.id}</span>` : ''}\n                                </h2>\n                                <div class=\"flex gap-2\">\n                                <button type=\"button\" id=\"btnClose\" class=\"btn btn-secondary\">Fechar</button>\n                                ${isEdit ? `<button type=\"submit\" id=\"btnDelete\" class=\"btn btn-warn\">Excluir</button>` : ''}\n                                <button type=\"submit\" id=\"btnUpsert\" class=\"btn btn-primary\">${isEdit ? 'Salvar alterações' : 'Incluir'}</button>\n                                </div>\n                            </div>\n                            <div id=\"modal-banner\" class=\"hidden mx-6 mt-3\"></div>\n\n                            <div class=\"tab-rail px-4 pt-3\">\n                                <div class=\"tabs\" role=\"tablist\" aria-label=\"Seções de configuração\">\n                                <button type=\"button\" data-tab=\"tab-chatwoot\" class=\"tab-btn\" role=\"tab\" aria-selected=\"true\" tabindex=\"0\">Chatwoot</button>\n                                <button type=\"button\" data-tab=\"tab-api\" class=\"tab-btn\" role=\"tab\" aria-selected=\"false\" tabindex=\"-1\">UaZapi</button>\n                                <button type=\"button\" data-tab=\"tab-config\" class=\"tab-btn\" role=\"tab\" aria-selected=\"false\" tabindex=\"-1\">Configurações</button>\n                                </div>\n                            </div>\n\n                            <div class=\"modal-body px-6 pt-4 space-y-6\">\n                                <section id=\"tab-chatwoot\" class=\"tab-panel active\" role=\"tabpanel\">\n                                <div class=\"grid gap-4 md:grid-cols-2\">\n                                    <label class=\"block field\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">Base URL</span>\n                                        <span class=\"help\">Endereço da sua API do Chatwoot</span>\n                                    </div>\n                                    <input name=\"chatwoot_base_url\" required type=\"url\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"https://api.seuchatwoot.com\" value=\"${v.chatwoot_base_url}\">\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">API Version</span>\n                                        <span class=\"help\">Geralmente \"v1\"</span>\n                                    </div>\n                                    <input name=\"chatwoot_api_version\" required class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"v1\" value=\"${v.chatwoot_api_version}\">\n                                    </label>\n\n                                    <label class=\"block field md:col-span-2\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">Token</span>\n                                        <span class=\"help\">Token de acesso obtido no Perfil do Usuário</span>\n                                    </div>\n                                    <input name=\"chatwoot_token\" required type=\"password\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"seu-token-chatwoot\" value=\"${v.chatwoot_token}\">\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">Account ID</span>\n                                        <span class=\"help\">ID da conta no Chatwoot</span>\n                                    </div>\n                                    <input name=\"chatwoot_account_id\" required type=\"number\" min=\"1\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"1\" value=\"${v.chatwoot_account_id}\">\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">Inbox ID</span>\n                                        <span class=\"help\">ID da Caixa de Entrada</span>\n                                    </div>\n                                    <input name=\"chatwoot_inbox_id\" required type=\"number\" min=\"1\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"1\" value=\"${v.chatwoot_inbox_id}\">\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <span class=\"text-xs uppercase text-slate-500\">Inbox name</span>\n                                    <input name=\"chatwoot_inbox_name\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"nome-da-inbox\" value=\"${v.chatwoot_inbox_name}\">\n                                    <div class=\"help mt-1\">Apenas descritivo, para facilitar a identificação.</div>\n                                    </label>\n\n                                    <label class=\"block field\">\n                                    <span class=\"text-xs uppercase text-slate-500 req\">Track ID</span>\n                                    <input name=\"chatwoot_track_id\" required type=\"password\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"id-do-chatwoot\" value=\"${v.chatwoot_track_id}\">\n                                    <div class=\"help mt-1\">Installation Identifier, obtido em Settings no SuperAdmin.</div>\n                                    </label>\n                                </div>\n                                </section>\n\n                                <section id=\"tab-api\" class=\"tab-panel\" role=\"tabpanel\">\n                                <div class=\"grid gap-4 md:grid-cols-2\">\n                                    <label class=\"block field md:col-span-2\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">API Base URL</span>\n                                        <span class=\"help\">Endereço do seu Servidor da UaZapi</span>\n                                    </div>\n                                    <input name=\"api_base_url\" required type=\"url\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"https://api.seuservidor.com\" value=\"${v.api_base_url}\">\n                                    </label>\n\n                                    <label class=\"block field md:col-span-2\">\n                                    <div class=\"flex items-center justify-between\">\n                                        <span class=\"text-xs uppercase text-slate-500 req\">API Token</span>\n                                        <span class=\"help\">Token fornecido no Painel da UaZapi</span>\n                                    </div>\n                                    <input name=\"api_token\" required type=\"password\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"seu-token-api\" value=\"${v.api_token}\">\n                                    </label>\n\n                                    <label class=\"block field md:col-span-2\">\n                                    <span class=\"text-xs uppercase text-slate-500\">Instance name</span>\n                                    <input name=\"api_instance_name\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"minha-instancia\" value=\"${v.api_instance_name}\">\n                                    <div class=\"help mt-1\">Apenas descritivo, para facilitar a identificação.</div>\n                                    </label>\n                                </div>\n                                </section>\n\n                                <section id=\"tab-config\" class=\"tab-panel\" role=\"tabpanel\">\n                                <div class=\"grid gap-4\">\n                                    <div class=\"grid gap-3 md:grid-cols-2 lg:grid-cols-3\">\n                                    ${[\n            ['ignore_groups', 'Ignorar grupos', 'Evita receber mensagens de grupos.'],\n            ['reply_messages', 'Responder mensagens', 'Habilita as respostas de mensagens enviadas ou recebidas.'],\n            ['edit_messages', 'Permitir edição', 'Habilita o recebimento de mensagens editadas.'],\n            ['delete_messages', 'Permitir exclusão', 'Habilita a exclusão de mensagens enviadas ou recebidas.'],\n            ['reopen_conversation', 'Reabrir conversa', 'Reabrir a mesma conversa anterior, que foi marcada como Resolvida.'],\n            ['conversation_pending', 'Abrir como Pendente', 'Abrir uma nova conversa como Pendente.']\n          ].map(([n, l, h]) => `\n                                        <div class=\"field flex items-center justify-between gap-3\">\n                                        <div>\n                                            <div class=\"text-sm font-medium text-slate-800\">${l}</div>\n                                            <div class=\"help\">${h}</div>\n                                        </div>\n                                        <label class=\"toggle\">\n                                            <input type=\"checkbox\" name=\"${n}\" ${v[n] ? 'checked' : ''}/>\n                                            <span class=\"dot\"></span>\n                                        </label>\n                                        </div>`).join('')}\n                                    </div>\n\n                                    <div class=\"grid gap-3 md:grid-cols-3\">\n                                    <div class=\"field flex items-center justify-between gap-3 opacity-60 cursor-not-allowed\">\n                                        <div>\n                                        <div class=\"text-sm font-medium text-slate-800 flex items-center gap-2\">\n                                            Importar contatos\n                                            <span class=\"text-xs font-semibold bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full\">Em breve</span>\n                                        </div>\n                                        <div class=\"help\">Importar contatos na leitura do QrCode.</div>\n                                        </div>\n                                        <label class=\"toggle\">\n                                        <input type=\"checkbox\" name=\"import_contacts\" ${v.import_contacts ? 'checked' : ''} disabled/>\n                                        <span class=\"dot\"></span>\n                                        </label>\n                                    </div>\n\n                                    <div class=\"field flex items-center justify-between gap-3 opacity-60 cursor-not-allowed\">\n                                        <div>\n                                        <div class=\"text-sm font-medium text-slate-800 flex items-center gap-2\">\n                                            Importar mensagens\n                                            <span class=\"text-xs font-semibold bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full\">Em breve</span>\n                                        </div>\n                                        <div class=\"help\">Importar mensagens na leitura do QrCode.</div>\n                                        </div>\n                                        <label class=\"toggle\">\n                                        <input type=\"checkbox\" name=\"import_messages\" ${v.import_messages ? 'checked' : ''} disabled/>\n                                        <span class=\"dot\"></span>\n                                        </label>\n                                    </div>\n\n                                    <label class=\"block field opacity-60 cursor-not-allowed\">\n                                        <div class=\"flex items-center justify-between\">\n                                        <div class=\"text-sm font-medium text-slate-800 flex items-center gap-2\">\n                                            Dias a importar\n                                            <span class=\"text-xs font-semibold bg-sky-100 text-sky-800 px-2 py-0.5 rounded-full\">Em breve</span>\n                                        </div>\n                                        <span class=\"help\">Limitado pelo WhatsApp</span>\n                                        </div>\n                                        <input name=\"import_days_limit\" type=\"number\" min=\"0\" class=\"mt-1 w-full rounded-md border px-3 py-2\" placeholder=\"7\" value=\"${v.import_days_limit}\" disabled>\n                                    </label>\n                                    </div>\n\n                                    <div class=\"grid gap-3 md:grid-cols-2 items-stretch\">\n                                    <label class=\"block field md:col-span-1\">\n                                        <span class=\"text-sm font-medium text-slate-800\">Assinar mensagens</span>\n                                        <select name=\"sign_messages_mode\" class=\"mt-1 w-full rounded-md border px-3 py-2\">\n                                        <option value=\"none\" ${currentSignMode === 'none' ? 'selected' : ''}>Não assinar</option>\n                                        <option value=\"assigned_name\" ${currentSignMode === 'assigned_name' ? 'selected' : ''}>Nome do Agente Atribuído</option>\n                                        <option value=\"assigned_display_name\" ${currentSignMode === 'assigned_display_name' ? 'selected' : ''}>Nome de Exibição do Agente Atribuído</option>\n                                        <option value=\"logged_name\" ${currentSignMode === 'logged_name' ? 'selected' : ''}>Nome do Agente Logado</option>\n                                        <option value=\"logged_display_name\" ${currentSignMode === 'logged_display_name' ? 'selected' : ''}>Nome de Exibição do Agente Logado</option>\n                                        </select>\n                                        <div class=\"help mt-1\">Define qual nome usar (se houver) no início das mensagens.</div>\n                                    </label>\n\n                                    <label class=\"block field md:col-span-1\">\n                                        <span class=\"text-sm font-medium text-slate-800\">Delimitador</span>\n                                        <select name=\"sign_delimiter\" class=\"mt-1 w-full rounded-md border px-3 py-2\">\n                                        <option value=\"\\\\n\\\\n\" ${delim === '\\\\n\\\\n' ? 'selected' : ''}>Pular 2 linhas (\\\\n\\\\n)</option>\n                                        <option value=\"\\\\n\" ${delim === '\\\\n' ? 'selected' : ''}>Pular 1 linha (\\\\n)</option>\n                                        <option value=\" \" ${delim === ' ' ? 'selected' : ''}>Espaço ( )</option>\n                                        </select>\n                                        <div class=\"help mt-1\">Inserido após o nome do Agente, se a assinatura estiver habilitada.</div>\n                                    </label>\n                                    </div>\n                                </div>\n                                </section>\n                            </div>\n                            </form>\n                        </div>\n                        </div>`;\n        const wrap = document.createElement('div'); wrap.innerHTML = html; document.body.appendChild(wrap);\n        const tabs = wrap.querySelectorAll('[data-tab]'); tabs.forEach(btn => btn.addEventListener('click', () => activateTab(wrap, btn, tabs))); tabs.forEach((btn, idx) => btn.addEventListener('keydown', e => { if (e.key === 'ArrowRight') { e.preventDefault(); activateTab(wrap, tabs[(idx + 1) % tabs.length], tabs); } if (e.key === 'ArrowLeft') { e.preventDefault(); activateTab(wrap, tabs[(idx - 1 + tabs.length) % tabs.length], tabs); } }));\n        wrap.querySelector('#btnClose').addEventListener('click', () => wrap.remove());\n        const backdrop = wrap.querySelector('#modal-backdrop'); const dialog = backdrop.firstElementChild; backdrop.addEventListener('click', (e) => { if (e.target === e.currentTarget) { e.preventDefault(); e.stopPropagation(); } }); dialog.addEventListener('click', (e) => e.stopPropagation()); wrap.querySelector('#frm').addEventListener('submit', handleModalSubmit);\n      }\n\n      function clearFieldErrors(form) { form.querySelectorAll('.tip-err').forEach(el => el.remove()); form.querySelectorAll('.field.err').forEach(el => el.classList.remove('err')); }\n\n      function showFieldError(input, msg = 'Preencha este campo.') {\n        const field = input.closest('.field'); if (!field) return; field.classList.add('err'); const tip = document.createElement('div'); tip.className = 'tip-err'; tip.innerHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01M12 19a7 7 0 100-14 7 7 0 000 14z\"/></svg><span>${msg}</span>`; field.appendChild(tip);\n      }\n\n      async function handleModalSubmit(e) {\n        e.preventDefault();\n        const frm = e.target;\n        const submitter = e.submitter;\n        const original = submitter.textContent;\n\n        if (submitter.id === 'btnDelete') {\n          try {\n            await showConfirmationModal(); // Chama a função global\n          } catch {\n            return;\n          }\n        }\n\n        clearFieldErrors(frm);\n        const requiredNames = ['chatwoot_base_url', 'chatwoot_api_version', 'chatwoot_token', 'chatwoot_account_id', 'chatwoot_inbox_id', 'chatwoot_track_id', 'api_base_url', 'api_token'];\n        const invalid = [];\n        requiredNames.forEach(n => {\n          const el = frm.querySelector(`[name=\"${n}\"]`);\n          if (!el) return;\n          const val = (el.value ?? '').toString().trim();\n          if (!val || (el.type === 'number' && Number(val) < 1)) { invalid.push(el); showFieldError(el); }\n        });\n        if (invalid.length) {\n          showBanner('modal-banner', 'warn', 'Alguns campos obrigatórios precisam ser preenchidos.');\n          const first = invalid[0];\n          first.focus({ preventScroll: false });\n          first.scrollIntoView({ behavior: 'smooth', block: 'center' });\n          return;\n        }\n        submitter.disabled = true;\n        submitter.textContent = 'Aguarde…';\n\n        (function () {\n          const bools = ['ignore_groups', 'reply_messages', 'edit_messages', 'delete_messages', 'reopen_conversation', 'conversation_pending', 'import_contacts', 'import_messages'];\n          bools.forEach(n => {\n            const cb = frm.querySelector(`input[name=\"${n}\"]`);\n            if (!cb) return;\n            if (!cb.checked) {\n              const h = document.createElement('input'); h.type = 'hidden'; h.name = n; h.value = 'false'; frm.appendChild(h);\n            } else { cb.value = 'true'; }\n          });\n        })();\n\n        const fd = new FormData(frm);\n        if (submitter.id === 'btnDelete') {\n          fd.set('action', 'delete');\n        } else {\n          fd.set('action', 'upsert');\n        }\n\n        try {\n          const res = await fetch(WEBHOOK_URL, { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });\n          let data = {}; try { data = await res.json(); } catch { }\n          if (!res.ok) {\n            throw new Error(data.friendlyMessage || 'Falha ao processar a solicitação.');\n          }\n          showBanner('modal-banner', 'ok', 'Operação realizada com sucesso. Atualizando…');\n          setTimeout(() => { (window.top || window).location.replace(WEBHOOK_URL); }, 800);\n        } catch (err) {\n          showBanner('modal-banner', 'error', err.message || 'Ocorreu um erro de rede.');\n          submitter.disabled = false;\n          submitter.textContent = original;\n        }\n      }\n    }\n  </script>\n</body>\n\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[1744,432],"id":"46b50260-ee1a-4843-a1a6-1b5cfcc7f7ea","name":"htmlConfig"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{"responseHeaders":{"entries":[{"name":"Content-Type","value":"text/html; charset=utf-8"},{"name":"Cache-Control","value":"no-store"}]}}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1920,432],"id":"8efa3d82-b08d-458a-9c4b-895a9aa28fa5","name":"respondConfigUi"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// VALIDAÇÃO DO BASIC AUTH (Function Item / Each item)\n\n// Pega user/pass definidos no node \"setVariables\" (um único registro)\nconst { auth: { user, pass } } = $('setVariables')?.item?.json;\n\n// Monta o header esperado\nconst expected = 'Basic ' + Buffer.from(`${user}:${pass}`).toString('base64');\n\n// Escreve no item atual\n$json.expectedAuth = expected;\n$json.reqAuth = $('setVariables')?.item?.json?.headers?.authorization ?? '';\n\n// Versão do kit de integração\n$json.database.version = '1.0.0';\n\n// Versão do banco de dados\n$json.database.kitVersion = '1.0.1';\n\n// Retorna apenas o item atual (não um array)\nreturn $json;"},"id":"5f39d525-bd55-426c-b22b-2dc49e507112","name":"authHeaderConfig","type":"n8n-nodes-base.code","typeVersion":2,"position":[1216,512]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b150a62e-a3b4-442d-ba6d-5e7f4b718bb9","leftValue":"={{ $('authHeaderConfig')?.item?.json?.reqAuth }}","rightValue":"={{ $('authHeaderConfig')?.item?.json?.expectedAuth }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1392,512],"id":"17c8e17a-ebbb-40fe-8cea-c7c422ef51cb","name":"authVerifyConfig"},{"parameters":{"respondWith":"text","responseBody":"={{ $('noAuthMessage')?.item?.json?.body }}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"WWW-Authenticate","value":"Basic realm=\"Config UI\", charset=\"UTF-8\""},{"name":"Content-Type","value":"text/html; charset=utf-8"},{"name":"Cache-Control","value":"no-store"}]}}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1744,592],"id":"52fd7319-64b9-4e30-a66f-2c55b428084e","name":"respondAuthConfig"},{"parameters":{"operation":"executeQuery","query":"-- INSERT OU UPDATE DA INSTÂNCIA\nWITH\n-- 1) Normaliza os valores recebidos dos parâmetros\nvals AS (\n  SELECT\n    NULLIF($1, '')::text      AS chatwoot_base_url,\n    NULLIF($2, '')::text      AS chatwoot_api_version,\n    NULLIF($3, '')::text      AS chatwoot_token,\n    NULLIF($4, '')::int       AS chatwoot_account_id,\n    NULLIF($5, '')::int       AS chatwoot_inbox_id,\n    NULLIF($6, '')::text      AS chatwoot_inbox_name,\n    NULLIF($7, '')::text      AS chatwoot_track_id,\n    NULLIF($8, '')::text      AS api_base_url,\n    NULLIF($9, '')::text      AS api_token,\n    NULLIF($10, '')::text     AS api_instance_name,\n    NULLIF($11, '')::boolean  AS ignore_groups,\n    NULLIF($12, '')::boolean  AS reply_messages,\n    NULLIF($13, '')::boolean  AS edit_messages,\n    NULLIF($14, '')::boolean  AS delete_messages,\n    NULLIF($15, '')::boolean  AS reopen_conversation,\n    NULLIF($16, '')::boolean  AS conversation_pending,\n    NULLIF($17, '')::boolean  AS import_contacts,\n    NULLIF($18, '')::boolean  AS import_messages,\n    NULLIF($19, '')::int      AS import_days_limit,\n    NULLIF($20, '')::text     AS sign_messages_mode,\n    NULLIF($21, '')::text     AS sign_delimiter,\n    NULLIF($22, '')::bigint   AS _id\n),\n\n-- 2) Tenta ATUALIZAR somente se um ID explícito for fornecido\nupd AS (\n  UPDATE {{$json.schema}}.{{$json.table_name}} t\n  SET\n    chatwoot_base_url  = v.chatwoot_base_url,\n    chatwoot_api_version = v.chatwoot_api_version,\n    chatwoot_token       = v.chatwoot_token,\n    chatwoot_account_id  = v.chatwoot_account_id,\n    chatwoot_inbox_id    = v.chatwoot_inbox_id,\n    chatwoot_inbox_name  = v.chatwoot_inbox_name,\n    chatwoot_track_id    = v.chatwoot_track_id,\n    api_base_url         = v.api_base_url,\n    api_token            = v.api_token,\n    api_instance_name    = v.api_instance_name,\n    ignore_groups        = v.ignore_groups,\n    reply_messages       = v.reply_messages,\n    edit_messages        = v.edit_messages,\n    delete_messages      = v.delete_messages,\n    reopen_conversation  = v.reopen_conversation,\n    conversation_pending = v.conversation_pending,\n    import_contacts      = v.import_contacts,\n    import_messages      = v.import_messages,\n    import_days_limit    = v.import_days_limit,\n    sign_messages_mode   = v.sign_messages_mode,\n    sign_delimiter       = v.sign_delimiter,\n    updated_at           = NOW()\n  FROM vals v\n  WHERE\n      (v._id IS NOT NULL AND t.id = v._id)\n  RETURNING t.id\n)\n\n-- 3) Se não atualizou, faz o INSERT\nINSERT INTO {{$json.schema}}.{{$json.table_name}} (\n  chatwoot_base_url, chatwoot_api_version, chatwoot_token,\n  chatwoot_account_id, chatwoot_inbox_id, chatwoot_inbox_name, chatwoot_track_id,\n  api_base_url, api_token, api_instance_name,\n  ignore_groups, reply_messages, edit_messages, delete_messages,\n  reopen_conversation, conversation_pending,\n  import_contacts, import_messages, import_days_limit,\n  sign_messages_mode, sign_delimiter, updated_at\n)\nSELECT\n  v.chatwoot_base_url, v.chatwoot_api_version, v.chatwoot_token,\n  v.chatwoot_account_id, v.chatwoot_inbox_id, v.chatwoot_inbox_name, v.chatwoot_track_id,\n  v.api_base_url, v.api_token, v.api_instance_name,\n  v.ignore_groups, v.reply_messages, v.edit_messages, v.delete_messages,\n  v.reopen_conversation, v.conversation_pending,\n  v.import_contacts, v.import_messages, v.import_days_limit,\n  v.sign_messages_mode, v.sign_delimiter, NOW()\nFROM vals v\nWHERE NOT EXISTS (SELECT 1 FROM upd)\nRETURNING id;","options":{"queryReplacement":"={{ [\n  String($('setUpsert')?.item?.json?.chatwoot_base_url ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_api_version ?? 'v1'),\n  String($('setUpsert')?.item?.json?.chatwoot_token ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_account_id ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_inbox_id ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_inbox_name ?? ''),\n  String($('setUpsert')?.item?.json?.chatwoot_track_id ?? ''),\n  String($('setUpsert')?.item?.json?.api_base_url ?? ''),\n  String($('setUpsert')?.item?.json?.api_token ?? ''),\n  String($('setUpsert')?.item?.json?.api_instance_name ?? ''),\n  String($('setUpsert')?.item?.json?.ignore_groups ?? 'true'),\n  String($('setUpsert')?.item?.json?.reply_messages ?? 'true'),\n  String($('setUpsert')?.item?.json?.edit_messages ?? 'true'),\n  String($('setUpsert')?.item?.json?.delete_messages ?? 'true'),\n  String($('setUpsert')?.item?.json?.reopen_conversation ?? 'true'),\n  String($('setUpsert')?.item?.json?.conversation_pending ?? 'false'),\n  String($('setUpsert')?.item?.json?.import_contacts ?? 'false'),\n  String($('setUpsert')?.item?.json?.import_messages ?? 'false'),\n  String($('setUpsert')?.item?.json?.import_days_limit ?? '7'),\n  String($('setUpsert')?.item?.json?.sign_messages_mode ?? 'none'),\n  String($('setUpsert')?.item?.json?.sign_delimiter ?? '\\n\\n'),\n  String($('setUpsert')?.item?.json?.id ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1392,1088],"id":"0757d7bd-9f62-4152-a4e2-50eafebf98c7","name":"instanceUpsert","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"-- 1. Define os parâmetros de sessão a partir do n8n\nSELECT\n  SET_CONFIG('n8n.schema', $1, false),\n  SET_CONFIG('n8n.table_name', $2, false),\n  SET_CONFIG('n8n.version', $3, false);\n\n-- 2. Cria o schema (lendo a variável de sessão)\nDO $ddl$\nDECLARE\n  _sch text := current_setting('n8n.schema');\nBEGIN\n  IF _sch = '' THEN\n    RAISE EXCEPTION 'n8n.schema parameter is empty';\n  END IF;\n  EXECUTE format('CREATE SCHEMA IF NOT EXISTS %I', _sch);\nEND\n$ddl$;\n\n-- 3. Cria as tabelas (lendo as variáveis de sessão)\nDO $$\nDECLARE\n  _sch text := current_setting('n8n.schema');\n  _tbl text := current_setting('n8n.table_name');\n  _ver text := current_setting('n8n.version');\nBEGIN\n  IF _tbl = '' OR _ver = '' THEN\n     RAISE EXCEPTION 'n8n.table_name or n8n.version is empty';\n  END IF;\n  \n  IF to_regclass(format('%I.%I', _sch, _tbl)) IS NULL THEN\n    RAISE NOTICE '[CreateTable] Tabela principal %.% não encontrada. Criando...', _sch, _tbl;\n    \n    -- Cria tabela principal v1.1.0\n    EXECUTE format('\n      CREATE TABLE %I.%I (\n        id                  integer GENERATED ALWAYS AS IDENTITY PRIMARY KEY,\n        chatwoot_base_url   text        NOT NULL,\n        chatwoot_api_version text       NOT NULL DEFAULT ''v1'',\n        chatwoot_token      text        NOT NULL,\n        chatwoot_account_id integer     NOT NULL CHECK (chatwoot_account_id > 0),\n        chatwoot_inbox_id   integer     NOT NULL CHECK (chatwoot_inbox_id > 0),\n        chatwoot_inbox_name text,\n        chatwoot_track_id   text        NOT NULL,\n        api_base_url        text        NOT NULL,\n        api_token           text        NOT NULL,\n        api_instance_name   text,\n        ignore_groups       boolean     NOT NULL DEFAULT true,\n        reply_messages      boolean     NOT NULL DEFAULT true,\n        edit_messages       boolean     NOT NULL DEFAULT true,\n        delete_messages     boolean     NOT NULL DEFAULT true,\n        reopen_conversation boolean     NOT NULL DEFAULT true,\n        conversation_pending boolean    NOT NULL DEFAULT false,\n        import_contacts     boolean     NOT NULL DEFAULT false,\n        import_messages     boolean     NOT NULL DEFAULT false,\n        import_days_limit   integer     NOT NULL DEFAULT 7 CHECK (import_days_limit >= 0),\n        sign_messages_mode  text        NOT NULL DEFAULT ''none'',\n        sign_delimiter      text        NOT NULL DEFAULT ''\\n\\n'',\n        created_at          timestamptz NOT NULL DEFAULT now(),\n        updated_at          timestamptz NOT NULL DEFAULT now(),\n        CONSTRAINT uq_%2$I_chatwoot_context UNIQUE (chatwoot_base_url, chatwoot_account_id, chatwoot_inbox_id),\n        CONSTRAINT uq_%2$I_api_token        UNIQUE (api_token),\n        CONSTRAINT chk_sign_messages_mode CHECK (sign_messages_mode IN (''none'', ''assigned_name'', ''assigned_display_name'', ''logged_name'', ''logged_display_name''))\n      );\n    ', _sch, _tbl);\n\n    -- Índices e Trigger\n    EXECUTE format('CREATE INDEX IF NOT EXISTS idx_%2$I_account_inbox ON %1$I.%2$I (chatwoot_account_id, chatwoot_inbox_id);', _sch, _tbl);\n    EXECUTE format('CREATE OR REPLACE FUNCTION %1$I.set_%2$I_updated_at() RETURNS trigger LANGUAGE plpgsql AS $f$ BEGIN NEW.updated_at := now(); RETURN NEW; END; $f$;', _sch, _tbl);\n    EXECUTE format('CREATE TRIGGER trg_%2$I_updated_at BEFORE UPDATE ON %1$I.%2$I FOR EACH ROW EXECUTE FUNCTION %1$I.set_%2$I_updated_at();', _sch, _tbl);\n\n    -- Cria tabela de versão e insere a versão\n    RAISE NOTICE '[CreateTable] Criando tabela de versão %.% e definindo versão para %', _sch, '_schema_version', _ver;\n    EXECUTE format('CREATE TABLE IF NOT EXISTS %I._schema_version (version TEXT PRIMARY KEY);', _sch);\n    EXECUTE format('INSERT INTO %I._schema_version (version) SELECT %L WHERE NOT EXISTS (SELECT 1 FROM %1$I._schema_version);', _sch, _ver);\n  ELSE\n    RAISE NOTICE '[CreateTable] Tabela principal %.% já existe. Criação pulada.', _sch, _tbl;\n  END IF;\nEND\n$$ LANGUAGE plpgsql;\n\n-- 4. Retorna sucesso se o script executou sem erro SQL\nSELECT true AS success, 'Tabela criada ou já existente.' AS message;","options":{"queryReplacement":"={{ [\n  String($('setCreate')?.item?.json?.schema ?? ''),\n  String($('setCreate')?.item?.json?.table_name ?? ''),\n  String($('setCreate')?.item?.json?.version ?? '')\n] }}"}},"id":"46c354f0-50c4-4439-a23d-d79dac72d16a","name":"createTable","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1392,768],"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}},"onError":"continueRegularOutput"},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{"responseCode":"={{ $json.ok ? 200 : ($json.code === '23505' ? 409 : 400) }}","responseHeaders":{"entries":[{"name":"Cache-Control","value":"no-store"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]}}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1744,1008],"id":"d49a8b00-7f4c-4d11-864d-bf3bbe385e7c","name":"respondDbUpsert"},{"parameters":{"assignments":{"assignments":[{"name":"schema","value":"={{ (String($('requestVerify')?.item?.json?.body?.schema || '')).trim() || 'public' }}","type":"string","id":"3965c494-077f-4bd9-bda6-798f71ee7d54"},{"name":"table_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.table_name || '')).trim() || 'chatwoot_config' }}","type":"string","id":"15d914d7-0f8d-4d8d-b2b7-4a5acb519c92"},{"name":"id","value":"={{ $('requestVerify').item.json.body.id ? Number( $('requestVerify').item.json.body.id) : null }}","type":"number","id":"8ec62017-3411-4619-9373-85513a72f519"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,1248],"id":"856944aa-ac8b-40bb-bb53-67b2dad464ba","name":"setDelete"},{"parameters":{"operation":"executeQuery","query":"DELETE FROM {{ $('setDelete')?.item?.json?.schema }}.{{ $('setDelete')?.item?.json?.table_name }}\nWHERE id = $1::integer\nRETURNING id;","options":{"queryReplacement":"={{ [\n  String($('setDelete')?.item?.json?.id ?? 0)\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1392,1248],"id":"3f32d3c3-8fea-4378-816a-725185bc8a3f","name":"instanceDelete","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"-- Função temp: Obtém a versão atual do schema\nCREATE OR REPLACE FUNCTION pg_temp.get_current_db_version(_sch text)\nRETURNS text LANGUAGE plpgsql AS $$\nDECLARE _ver text := NULL; _tbl_oid oid := to_regclass(format('%I._schema_version', _sch));\nBEGIN IF _tbl_oid IS NOT NULL THEN EXECUTE format('SELECT version FROM %I._schema_version LIMIT 1', _sch) INTO _ver; END IF; RETURN _ver; END; $$;\n\n-- Função temp: testa existência de linhas\nCREATE OR REPLACE FUNCTION pg_temp.has_rows(_sch text, _tbl text)\nRETURNS boolean LANGUAGE plpgsql AS $$\nDECLARE _has boolean := false;\nBEGIN IF to_regclass(format('%I.%I', _sch, _tbl)) IS NOT NULL THEN EXECUTE format('SELECT EXISTS (SELECT 1 FROM %I.%I LIMIT 1)', _sch, _tbl) INTO _has; END IF; RETURN _has; END; $$;\n\n-- Função temp: devolve as linhas em JSON\nCREATE OR REPLACE FUNCTION pg_temp.get_instances(_sch text, _tbl text)\nRETURNS json LANGUAGE plpgsql AS $$\nDECLARE _rows json := '[]'::json;\nBEGIN IF to_regclass(format('%I.%I', _sch, _tbl)) IS NOT NULL THEN EXECUTE format('SELECT COALESCE(json_agg(t ORDER BY id) FILTER (WHERE true), ''[]''::json) FROM %I.%I t', _sch, _tbl) INTO _rows; END IF; RETURN _rows; END; $$;\n\n-- Query principal\nWITH\ncfg AS (\n  SELECT\n    $1::text AS sch,\n    $2::text AS tbl,\n    $3::text AS pth,\n    $4::text AS brd,\n    $5::text AS expected_version,\n    $6::text AS kit_version -- ADICIONADO\n),\nreg AS (\n  SELECT to_regclass(format('%I.%I', sch, tbl)) AS oid FROM cfg\n),\ndb_version AS (\n  SELECT pg_temp.get_current_db_version(cfg.sch) as current_db_version FROM cfg\n),\nflags AS (\n  SELECT\n    (r.oid IS NOT NULL) AS \"tableExists\",\n    CASE WHEN r.oid IS NULL THEN false\n         ELSE pg_temp.has_rows(cfg.sch, cfg.tbl)\n    END AS \"dataExists\"\n  FROM cfg LEFT JOIN reg r ON TRUE\n)\nSELECT\n  jsonb_build_object(\n    'schema', cfg.sch,\n    'table_name', cfg.tbl,\n    'version', cfg.expected_version,\n    'kitVersion', cfg.kit_version\n  ) AS database,\n  jsonb_build_object('path', cfg.pth) AS webhook,\n  jsonb_build_object('branding', cfg.brd) AS automation,\n  f.\"tableExists\",\n  f.\"dataExists\",\n  cfg.expected_version,\n  dv.current_db_version,\n  (f.\"tableExists\" AND dv.current_db_version IS DISTINCT FROM cfg.expected_version) AS \"needsMigration\",\n  CASE\n    WHEN f.\"tableExists\" AND f.\"dataExists\"\n      THEN pg_temp.get_instances(cfg.sch, cfg.tbl)\n    ELSE '[]'::json\n  END AS instances\nFROM cfg\nCROSS JOIN flags f\nCROSS JOIN db_version dv;","options":{"queryReplacement":"={{ [\n  String($('setVariables')?.item?.json?.database?.schema ?? ''),\n  String($('setVariables')?.item?.json?.database?.table_name ?? ''),\n  String($('setVariables')?.item?.json?.webhook?.path ?? ''),\n  String($('setVariables')?.item?.json?.automation?.branding ?? ''),\n  String($('authHeaderConfig')?.item?.json?.database?.version ?? ''),\n  String($('authHeaderConfig')?.item?.json?.database?.kitVersion ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1568,432],"id":"332b35a9-65dd-4383-baa7-e240a8cbff20","name":"checkTableData","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"assignments":{"assignments":[{"name":"schema","value":"={{ (String($('requestVerify')?.item?.json?.body?.schema || '')).trim() || 'public' }}","type":"string","id":"3965c494-077f-4bd9-bda6-798f71ee7d54"},{"name":"table_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.table_name || '')).trim() || 'chatwoot_config' }}","type":"string","id":"15d914d7-0f8d-4d8d-b2b7-4a5acb519c92"},{"id":"d4afb0cc-9b49-4d92-9564-c4b95ecf6d12","name":"version","value":"={{ (String($('requestVerify')?.item?.json?.body?.version || '')).trim() || '1.0.0' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,768],"id":"22560483-70d3-4820-b15b-fe20378287c3","name":"setCreate"},{"parameters":{"assignments":{"assignments":[{"id":"f2fa7b36-72ca-4a76-9c5a-33a022c77467","name":"database.schema","value":"chatwoot_uazapi","type":"string"},{"id":"a3997699-2003-4afe-8b83-09d6f0138f14","name":"database.table_name","value":"chatwoot_uazapi_config","type":"string"},{"id":"5ed9fe9a-5f61-4ac2-a60e-791b5c4a8302","name":"auth.user","value":"admin","type":"string"},{"id":"451c35f1-e069-4bef-8628-f6a929d61778","name":"auth.pass","value":"TeCo78964","type":"string"},{"id":"3cadfe0e-c710-4a9d-9a67-c4cea7c8fa64","name":"automation.branding","value":"SCALA Digital","type":"string"},{"id":"c7769d9c-e3e5-4f98-974d-c8c71fef9ec2","name":"webhook.path","value":"={{ $('webhookData')?.item?.json?.webhookUrl.split('/').last() }}","type":"string"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1040,512],"id":"9bd772e1-1bf3-4a6c-a307-f8c7e6800dee","name":"setVariables"},{"parameters":{"assignments":{"assignments":[{"name":"schema","value":"={{ (String($('requestVerify')?.item?.json?.body?.schema || '')).trim() || 'public' }}","type":"string","id":"3965c494-077f-4bd9-bda6-798f71ee7d54"},{"name":"table_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.table_name || '')).trim() || 'chatwoot_config' }}","type":"string","id":"15d914d7-0f8d-4d8d-b2b7-4a5acb519c92"},{"name":"id","value":"={{ $('requestVerify').item?.json?.body?.id ? Number( $('requestVerify').item?.json?.body?.id) : null }}","type":"number","id":"8ec62017-3411-4619-9373-85513a72f519"},{"name":"chatwoot_base_url","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_base_url || '')).trim() }}","type":"string","id":"6e943d37-e093-4715-9e3a-dd2e7fa75e4b"},{"name":"chatwoot_api_version","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_api_version || '')).trim() }}","type":"string","id":"bbba6579-e0ee-4c76-ac8f-1f284508fa8b"},{"name":"chatwoot_token","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_token || '')).trim() }}","type":"string","id":"3b0cb655-76ec-4ba1-b7a8-0ef36aa19a22"},{"name":"chatwoot_account_id","value":"={{ Number( ($('requestVerify')?.item?.json?.body?.chatwoot_account_id ?? 1) || 1 ) }}","type":"number","id":"4c6bd65f-3403-435d-ac29-2ec704b1eb6f"},{"name":"chatwoot_inbox_id","value":"={{ Number( ($('requestVerify')?.item?.json?.body?.chatwoot_inbox_id ?? 1) || 1 ) }}","type":"number","id":"5730dc70-4e4f-4919-b5cf-28da6459d383"},{"name":"chatwoot_inbox_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_inbox_name || '')).trim() }}","type":"string","id":"502ea6e0-7b81-4c4c-88ca-2047da047e04"},{"name":"chatwoot_track_id","value":"={{ (String($('requestVerify')?.item?.json?.body?.chatwoot_track_id || '')).trim() }}","type":"string","id":"d437c928-59e9-45e5-92b7-f89251cc609f"},{"name":"api_base_url","value":"={{ (String($('requestVerify')?.item?.json?.body?.api_base_url || '')).trim() }}","type":"string","id":"247efa9f-bd69-47e0-af5e-02b91c39448b"},{"name":"api_token","value":"={{ (String($('requestVerify')?.item?.json?.body?.api_token || '')).trim() }}","type":"string","id":"a15f2508-69f0-4596-955a-d132361b2103"},{"name":"api_instance_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.api_instance_name || '')).trim() }}","type":"string","id":"d9455e57-2b7e-43c4-80d0-8f68c99f8bf3"},{"name":"ignore_groups","value":"={{ String(($('requestVerify')?.item?.json?.body?.ignore_groups ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"a305225c-c754-4ce0-9b9f-12edb2bb4d8a"},{"name":"reply_messages","value":"={{ String(($('requestVerify')?.item?.json?.body?.reply_messages ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"3e8f32eb-2ff9-4721-9b93-3be593f9a5c8"},{"name":"edit_messages","value":"={{ String(($('requestVerify')?.item?.json?.body?.edit_messages ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"782e8f1c-483e-4b3f-a735-097f43f4083b"},{"name":"delete_messages","value":"={{ String(($('requestVerify')?.item?.json?.body?.delete_messages ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"4d1e2377-848a-4642-a08f-98bb36a9f7b8"},{"name":"reopen_conversation","value":"={{ String(($('requestVerify')?.item?.json?.body?.reopen_conversation ?? 'true')).toLowerCase() === 'true' }}","type":"boolean","id":"11ba6686-555c-4016-829c-afea903605e8"},{"name":"conversation_pending","value":"={{ String(($('requestVerify')?.item?.json?.body?.conversation_pending ?? 'false')).toLowerCase() === 'true' }}","type":"boolean","id":"c75a0eea-5c6e-4af9-88b7-818b704de6ef"},{"name":"import_contacts","value":"={{ String(($('requestVerify')?.item?.json?.body?.import_contacts ?? 'false')).toLowerCase() === 'true' }}","type":"boolean","id":"6c430a9e-7fb5-407e-b220-692288ad462b"},{"name":"import_messages","value":"={{ String(($('requestVerify')?.item?.json?.body?.import_messages ?? 'false')).toLowerCase() === 'true' }}","type":"boolean","id":"69542908-e860-4c6d-b699-d2b34a707579"},{"name":"import_days_limit","value":"={{ Number($('requestVerify')?.item?.json?.body?.import_days_limit ?? 7) }}","type":"number","id":"4d9982dd-2506-43a0-b123-6fc8484e8a87"},{"name":"sign_messages_mode","value":"={{ (String($('requestVerify')?.item?.json?.body?.sign_messages_mode  || 'none')).trim() }}","type":"string","id":"bcf08949-1f5c-4baa-8f10-7e9eb652c95b"},{"name":"sign_delimiter","value":"={{\n  (v => {\n    if (v == null) return '\\\\n\\\\n';\n    if (v === '\\n\\n') return '\\\\n\\\\n';\n    if (v === '\\n')  return '\\\\n';\n    return (v === '\\\\n\\\\n' || v === '\\\\n' || v === ' ') ? v : '\\\\n\\\\n';\n  })($('requestVerify')?.item?.json?.body?.sign_delimiter)\n}}","type":"string","id":"ad1b1176-81f2-4a5d-8718-42c366ecab2f"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,1088],"id":"e228130f-f94a-4b20-91f2-9dbb2588459f","name":"setUpsert"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Function Item (executa 1x para o item atual)\nconst tbl = $json.table_name ?? 'chatwoot_uazapi_config';\nconst err = $json.error;\n\nconst response = {\n  ok: true,\n  httpStatus: 200,\n  friendlyMessage: 'Operação realizada com sucesso.'\n};\n\nif (err) {\n  response.ok = false;\n\n  // Mapa de constraints -> mensagens amigáveis (dinâmico por tabela)\n  const constraintMsg = {\n    [`uq_${tbl}_chatwoot_context`]:\n      'Erro: Esta combinação de URL, Conta e Caixa de Entrada já está em uso por outra instância.',\n    [`uq_${tbl}_chatwoot_token`]:\n      'Erro: O Token do Chatwoot informado já está em uso por outra instância.',\n    [`uq_${tbl}_api_token`]:\n      'Erro: O Token da UaZapi informado já está em uso por outra instância.',\n  };\n\n  response.friendlyMessage =\n    constraintMsg[err.constraint] ||\n    (($json.message || err.message)\n      ? `Erro de banco de dados: ${$json.message || err.message}`\n      : 'Ocorreu um erro inesperado no banco de dados.');\n\n  // 23505 = unique_violation\n  response.httpStatus = (err.code === '23505') ? 409 : 400;\n\n  response.error = {\n    code: err.code ?? null,\n    message: $json.message ?? err.message ?? null,\n    detail: err.detail ?? null,\n    constraint: err.constraint ?? null,\n  };\n} else {\n  // Tenta extrair o ID/flags do retorno do Postgres\n  const data = $json.rows?.[0] ?? $json[0] ?? $json;\n  response.id = data?.id ?? null;\n  response.success = data?.success ?? null;\n}\n\n// Opção A: retornar só a resposta (mais limpo para o Respond to Webhook)\nreturn { json: response };\n\n// --- Opção B (alternativa): mesclar com o payload original ---\n// return { json: { ...$json, ...response } };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1568,1008],"id":"33f99cb5-dd0d-476e-a637-bcc8e246d8c8","name":"formatDbResponse"},{"parameters":{"multipleMethods":true,"path":"colbiflex-manager","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[864,768],"id":"5c139abf-04a9-4da4-b262-041c7b10b774","name":"webhookData","webhookId":"f6b6cb9e-36de-4cdb-9f56-733d053a76f4"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('webhookData')?.item?.json?.body?.action ?? '' }}","rightValue":"=create","operator":{"type":"string","operation":"equals"},"id":"ab3cdb36-1c19-4462-b10d-23aeedbf8b80"}],"combinator":"and"},"renameOutput":true,"outputKey":"create"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"046d088d-274d-4db3-8c5b-c0935aecfa02","leftValue":"={{ $('webhookData')?.item?.json?.body?.action ?? '' }}","rightValue":"migrate","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"migrate"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0a255e36-852d-4aa1-9f9c-b8db60f064ca","leftValue":"={{ $('webhookData')?.item?.json?.body?.action ?? '' }}","rightValue":"upsert","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"upsert"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bda3070f-6c05-4461-b22f-6a4f17209777","leftValue":"={{ $('webhookData')?.item?.json?.body?.action ?? '' }}","rightValue":"delete","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"delete"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1040,976],"id":"ebfa0753-a146-4ccf-862f-70aacbe9fa4b","name":"requestVerify"},{"parameters":{"assignments":{"assignments":[{"id":"f2fa7b36-72ca-4a76-9c5a-33a022c77467","name":"database.schema","value":"chatwoot_uazapi","type":"string"},{"id":"a3997699-2003-4afe-8b83-09d6f0138f14","name":"database.table_name","value":"chatwoot_uazapi_config","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[240,2064],"id":"6cca0b6d-d517-4560-bdb7-5962d469f455","name":"setVariablesClean"},{"parameters":{"operation":"executeQuery","query":"-- 1. Define os parâmetros de sessão a partir do n8n\nSELECT\n  SET_CONFIG('n8n.schema', $1, false),\n  SET_CONFIG('n8n.table_name', $2, false);\n\n-- ============================================================\n-- SCRIPT DE LIMPEZA (inicia transação)\n-- ============================================================\nBEGIN;\n\n-- Bloco principal para toda a lógica de limpeza\nDO $$\nDECLARE\n  _sch text := current_setting('n8n.schema');\n  _tbl text := current_setting('n8n.table_name');\n  seq_full_name text;\nBEGIN\n  -- Validação (Previne apagar tudo se os parâmetros estiverem vazios)\n  IF _sch = '' OR _tbl = '' THEN\n    RAISE EXCEPTION 'Schema ou Table Name estão vazios. Abortando limpeza.';\n  END IF;\n\n  -- 1) Tabela principal e dependências diretas\n  RAISE NOTICE '[Cleaner] Dropping table: %.%', _sch, _tbl;\n  EXECUTE format('DROP TABLE IF EXISTS %I.%I CASCADE', _sch, _tbl);\n\n  -- 2) Tabela de versão do schema\n  RAISE NOTICE '[Cleaner] Dropping table: %._schema_version', _sch;\n  EXECUTE format('DROP TABLE IF EXISTS %I._schema_version CASCADE', _sch);\n\n  -- 3) Função do trigger\n  RAISE NOTICE '[Cleaner] Dropping function: %.set_%_updated_at()', _sch, _tbl;\n  EXECUTE format('DROP FUNCTION IF EXISTS %I.set_%I_updated_at()', _sch, _tbl);\n\n  -- 4) (Opcional) Limpeza de sequências órfãs\n  FOR seq_full_name IN\n    SELECT quote_ident(n.nspname) || '.' || quote_ident(c.relname)\n    FROM pg_class c\n    JOIN pg_namespace n ON n.oid = c.relnamespace\n    WHERE c.relkind = 'S' -- S = sequence\n      AND n.nspname = _sch\n      AND c.relname IN (_tbl || '_id_seq') -- Nome da sequência padrão\n  LOOP\n    RAISE NOTICE '[Cleaner] Dropping orphaned sequence: %', seq_full_name;\n    EXECUTE 'DROP SEQUENCE IF EXISTS ' || seq_full_name || ' CASCADE';\n  END LOOP;\nEND\n$$ LANGUAGE plpgsql;\n\n-- 5) Confirma transação\nCOMMIT;\n\n-- 6. Retorna sucesso\nSELECT true AS success, 'Schema cleanup completed.' AS message;","options":{"queryReplacement":"={{ [\n  String($json.database.schema ?? ''),\n  String($json.database.table_name ?? '')\n] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[416,2064],"id":"e27c2056-0c66-4ee6-a8f5-ee97b4f65a5d","name":"databaseClean","credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}}},{"parameters":{"content":"### Postgres Mngr","height":176,"width":166,"color":3},"type":"n8n-nodes-base.stickyNote","position":[1536,400],"typeVersion":1,"id":"5bb5013f-5e18-4818-8fd6-66c8bd982a97","name":"Sticky Note"},{"parameters":{"content":"### Postgres Mngr","height":656,"width":166,"color":3},"type":"n8n-nodes-base.stickyNote","position":[1360,736],"typeVersion":1,"id":"3b7b26ed-5f3a-46a8-88db-b46fe4b9a82e","name":"Sticky Note1"},{"parameters":{"content":"### Postgres Mngr","height":192,"width":150,"color":3},"type":"n8n-nodes-base.stickyNote","position":[384,2016],"typeVersion":1,"id":"9d8fbca3-930e-491f-8aa7-3c91def1e3c4","name":"Sticky Note2"},{"parameters":{"content":"### Config","height":192,"width":150,"color":5},"type":"n8n-nodes-base.stickyNote","position":[208,2016],"typeVersion":1,"id":"a4da8a17-eea1-4f89-9817-712323499810","name":"Sticky Note3"},{"parameters":{"content":"### Config","height":192,"width":150,"color":4},"type":"n8n-nodes-base.stickyNote","position":[1008,464],"typeVersion":1,"id":"5dd3ef5e-5495-4d86-b139-d64f7a61038a","name":"Sticky Note4"},{"parameters":{"content":"# 🚨 Danger Zone\n\nAo executar este bloco de automação, esteja ciente de que irá **EXCLUIR COMPLETAMENTE** a tabela do Manager, seus índices e todos os dados das instâncias armazenadas no banco.\n\n---\n","height":432,"width":768,"color":3},"type":"n8n-nodes-base.stickyNote","position":[0,1792],"typeVersion":1,"id":"cb88e3f0-5070-44a2-b55a-46effbe49504","name":"Sticky Note6"},{"parameters":{"content":"# 🧭 Gerenciador de Instâncias\n\nAqui você cria, edita e exclui as instâncias da Integração Premium do Chatwoot 🔁 UaZapi.\n\n---\n","height":1184,"width":1472},"type":"n8n-nodes-base.stickyNote","position":[800,224],"typeVersion":1,"id":"b9930c75-8327-4afd-8a9e-b6a0cc6087cb","name":"Sticky Note7"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2096,592],"id":"9c773a8d-ae24-4c5e-b001-cb93353de120","name":"endProcess"},{"parameters":{"content":"# 💬 Integração Premium Chatwoot 🔁 UaZapi\n### _**v1.0.1 • atualizado: 2025-11-17**_\n\n## Workflow que **exibe uma UI de gestão** e orquestra a **criação, edição e exclusão** das configurações de instâncias da UaZapi e das caixas de entrada do Chatwoot.\n---\n\n## 🧭 O que este fluxo faz\n- Recebe requisições **HTTP (GET/POST)** via Webhook do n8n para exibir a **UI de Configuração** e executar ações.  \n- **Verifica** se a tabela de configuração existe; se não existir, oferece **criação assistida**.  \n- Após criar a tabela, sugere a **instância modelo** (opcional) e abre o **gerenciador**.  \n- Permite **incluir, editar, excluir e listar** instâncias com validações e mensagens amigáveis.  \n- Protegido por **Basic Auth** (definido em `setVariables`) e com respostas HTTP padronizadas **200/409/400**.\n\n---\n\n## 🛠 Requisitos\nConfigure os nós de **parâmetros** e **banco** antes de abrir a UI:\n\n- **Parâmetros (nó `setVariables` em Verde)**\n  - `database.schema` → esquema do banco\n  - `database.table_name` → nome da tabela de configuração\n  - `database.version` → versão do esquema do banco  **( 🚨 NÃO ALTERAR 🚨 )**\n  - `auth.user` / `auth.pass` → credenciais de **Basic Auth** para acessar a UI\n  - `automation.branding` → nome/marca que será apresentada em \"Desenvolvido por\" na parte inferior das telas do Manager\n  - `webhook.path` → caminho da rota pública _(preenchido automaticamente a partir do Webhook)_\n\n- **Limpeza (nó `setVariablesClean`)**\n  - `database.schema` → esquema do banco\n  - `database.table_name` → nome da tabela de configuração\n\n- **Banco de dados (nós Postgres em Vermelho)**\n  - Defina/associe as credenciais **Postgres** nos nós:  \n    `checkTableData`, `createTable`, `updateTable`, `instanceUpsert`, `instanceDelete`, `databaseClean`.\n\n> **Dica:** use o mesmo `schema`/`table_name` em todos os pontos para manter consistência.\n\n---\n\n## ⚙️ Instruções de Instalação\n1. **Importe** o workflow no **n8n**.  \n2. Em **`setVariables`**, preencha `database.schema`, `database.table_name`, `database.version`, `auth.user`, `auth.pass` e `automation.brading`.\n3. (Opcional) Abra o nó **`webhookData`** e ajuste o **Path** (rota pública, ex.: `config-ui`).  \n4. **Associe a credencial Postgres** aos nós `checkTableData`, `createTable`, `updateTable`, `instanceUpsert`, `instanceDelete` e `databaseClean`.  \n5. Clique em **Save** para salvar o workflow.  \n6. Clique em **Activate** (canto superior direito) para ativar o workflow.  \n7. Copie a **Production URL** do `webhookData`, abra em uma nova aba e faça login com o **Basic Auth**.  \n8. Siga o **assistente de criação** da tabela; opcionalmente crie a **instância modelo** e, em seguida, use o **Gerenciador de Instâncias**.\n\n---\n\n## 🔐 Segurança\n- Acesse a UI somente via **HTTPS** e **Basic Auth** (credenciais definidas em `setVariables`).  \n- **Não compartilhe** a Production URL do Webhook.  \n- Armazene **tokens e segredos** fora do repositório e **rotacione** periodicamente.  \n- Restrinja acesso ao n8n e ao Chatwoot; os dados de mensagens podem ser **sensíveis**.\n","height":1536,"width":768,"color":5},"type":"n8n-nodes-base.stickyNote","position":[0,224],"typeVersion":1,"id":"484e7c67-a9c4-40ff-be16-446cc6204ab3","name":"Sticky Note8"},{"parameters":{"content":"# ⚖️ Aviso de Propriedade Intelectual & Suporte\n\nEste workflow e sua UI são **propriedade intelectual** da EMKT Consultoria e Tecnologia, protegidos pelas Leis **9.610/98 (Direitos Autorais)**, **9.609/98 (Software)** e pela **LGPD – 13.709/18**.\n---\n\n## Uso permitido\n- Licença de **uso interno**, não exclusiva e intransferível.\n- É vedada a **distribuição**, **revenda**, **locação**, **cessão**, **publicação** ou **exposição pública** (incl. repositórios/portais).\n\n## Proibições\n- **Cópia** total/parcial, **engenharia reversa**, **descompilação**, **circunvenção** de proteções.\n- **Modificações** não autorizadas, criação de **derivados** ou remoção de créditos/identificações.\n- **Compartilhamento** do pacote/fluxo, credenciais, URLs de webhook, telas ou prints com terceiros.\n\n## Suporte & Garantia\n- A **garantia de suporte** e atualizações está **condicionada** à manutenção do **estado original** do workflow.  \n- Qualquer **alteração não autorizada** (código, nós, credenciais, rotas, lógica ou layout) **invalida o suporte**.\n- Adequações/integrações adicionais requerem **contratação prévia** e **autorização por escrito**.\n\n---\n\n### 📞 Contato\nPrecisa de ajuda? Fale conosco pelo WhatsApp Business  \n**(41) 9 8473-9797** — [abrir conversa](https://api.whatsapp.com/message/FVXDCWKJFIM4M1)  \n**(79) 9 9977-7712** — [abrir conversa](https://api.whatsapp.com/message/2G6M66MXFH7TD1)\n\n> Dúvidas sobre uso, licença ou autorização: contate a EMKT.\n","height":784,"width":1472,"color":4},"type":"n8n-nodes-base.stickyNote","position":[800,1440],"typeVersion":1,"id":"41aac2de-ba3e-4c90-989d-300b741a6e94","name":"Sticky Note10"},{"parameters":{"content":"```\n                                ███       █                            ██          █████ █          █                   █              █   █      █████           █\n                                 █       ███                                       █     █         ███                 ███             █   █          █\n                                 █  █ ██  █  ████ ████ █ ██ ████ ████ ████ ████    █     ████ ████  █  █ █ █ ████ ████  █     █   █    █   █ ████    █  ████ ████ █           █    ███    █     ████ ████ ████ █████ █ █  █ █████\n                                 █  ██ █  █  █  █ █  █ ██      █ █       █ █  █    █     █  █    █  █  █ █ █ █  █ █  █  █      █ █     █   █    █   █      █ █  █ █          ██    █ █   ██     █  █ █  █ █    █ █ █ █ █  █ █ █ █\n                                 █  █  █  █  ████ █  █ █    ████ █    ████ █  █    █     █  █ ████  █  █ █ █ █  █ █  █  █       █      █   █ ████  █    ████ █  █ █     █ █   █    █ █    █  ██ ████ ████ ███  █ █ █ █ █  █ █ █ █\n                                 █  █  █  █  █    █  █ █    █  █ █    █  █ █  █    █     █  █ █  █  █  █ █ █ █  █ █  █  █      █ █     █   █ █  █ █     █  █ █  █ █     █ █   █    █ █    █     █    █ █  █    █ █ █ █ █  █ █ █ █\n                                ███ █  █  ██ ████ ████ █    ████ ████ ████ ████    █████ █  █ ████  ██  █ █  ████ ████  ██    █   █    █████ ████ █████ ████ ████ █      █   ███ █ ███ █ ███    █    █  █ ████ █ █ █ █ ████ █ █ █\n                                                     █             █                                                                                         █\n                                                  ████            █                                                                                          █\n```","height":200,"width":2268,"color":7},"type":"n8n-nodes-base.stickyNote","position":[0,0],"typeVersion":1,"id":"838c48c9-ee37-46ff-a827-3295a40476b8","name":"Sticky Note9"},{"parameters":{"assignments":{"assignments":[{"id":"42b92175-6da2-4f5e-85bf-49439eb48bb2","name":"body","value":"=<!doctype html>\n<html lang=\"pt-BR\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n  <title>Acesso Não Autorizado</title>\n  <script src=\"https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4\"></script>\n  <style>\n    /* Estilo do card, vindo do seu HTML original */\n    .card {\n      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1), 0 4px 6px -2px rgba(0, 0, 0, .05)\n    }\n  </style>\n</head>\n\n<body class=\"min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900\">\n  \n  <main class=\"max-w-4xl mx-auto px-6 py-10\">\n    \n    <h1 class=\"text-3xl font-semibold tracking-tight mb-1\">Integração Chatwoot x UaZapi</h1>\n    \n    <div id=\"top-banner\" class=\"hidden\"></div>\n    \n    <section class=\"card rounded-xl border bg-white overflow-hidden\">\n        \n        <div class=\"m-5 flex items-start gap-3 rounded-lg border border-red-300 bg-red-50 px-4 py-3 text-sm text-red-900\" role=\"alert\">\n            \n            <div class=\"shrink-0 mt-0.5\">\n              <svg class=\"h-5 w-5 text-red-600\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\" stroke=\"currentColor\">\n                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z\" />\n              </svg>\n            </div>\n            \n            <div class=\"flex-1\">\n              <p class=\"font-semibold\">Acesso Não Autorizado</p>\n              <p class=\"mt-1\">Autenticação necessária. Você deve fornecer um usuário e senha válidos para acessar este recurso.</p>\n            </div>\n        </div>\n\n    </section>\n\n    <p class=\"mt-6 text-center text-xs text-slate-500\">Disponibilizado por <strong>{{ $('setVariables')?.item?.json?.automation?.branding }}</strong></p>\n    \n  </main>\n</body>\n</html>","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1568,592],"id":"547f7ba9-eb6e-4b5c-9701-8561175f5e86","name":"noAuthMessage"},{"parameters":{"assignments":{"assignments":[{"name":"schema","value":"={{ (String($('requestVerify')?.item?.json?.body?.schema || '')).trim() || 'public' }}","type":"string","id":"3965c494-077f-4bd9-bda6-798f71ee7d54"},{"name":"table_name","value":"={{ (String($('requestVerify')?.item?.json?.body?.table_name || '')).trim() || 'chatwoot_config' }}","type":"string","id":"15d914d7-0f8d-4d8d-b2b7-4a5acb519c92"},{"id":"d4afb0cc-9b49-4d92-9564-c4b95ecf6d12","name":"version","value":"={{ (String($('requestVerify')?.item?.json?.body?.version || '')).trim() || '1.0.0' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,928],"id":"0a8f0987-7f62-477a-a2e2-6b17ba064aa2","name":"setUpdate"},{"parameters":{"operation":"executeQuery","query":"-- 1. Define os parâmetros de sessão a partir do n8n\nSELECT\n  SET_CONFIG('n8n.schema', $1, false),\n  SET_CONFIG('n8n.table_name', $2, false),\n  SET_CONFIG('n8n.version', $3, false);\n\n-- 2. ==========================================================\n-- SCRIPT DE MIGRAÇÃO DE SCHEMA (Idempotente e Sequencial)\n-- ============================================================\nDO $$\nDECLARE\n  _sch text := current_setting('n8n.schema');\n  _tbl text := current_setting('n8n.table_name');\n  _target_ver text := current_setting('n8n.version'); -- Versão alvo\n  _current_ver text := NULL;\nBEGIN\n  -- PASSO 0: Validar parâmetros e verificar se a tabela principal existe\n  IF _sch = '' OR _tbl = '' OR _target_ver = '' THEN\n    RAISE EXCEPTION 'n8n.schema, n8n.table_name, ou n8n.version estão vazios.';\n  END IF;\n\n  IF to_regclass(format('%I.%I', _sch, _tbl)) IS NULL THEN\n    RAISE WARNING '[Migration Runner] Tabela principal %.% não encontrada. Nenhuma migração será aplicada.', _sch, _tbl;\n    RETURN; -- Sai do bloco se a tabela principal não existe\n  END IF;\n\n  -- PASSO 1: Obter a versão atual registrada no banco\n  BEGIN\n    EXECUTE format('SELECT version FROM %I._schema_version LIMIT 1', _sch) INTO _current_ver;\n    EXCEPTION WHEN undefined_table THEN\n      RAISE NOTICE '[Migration Runner] Tabela _schema_version não encontrada. Assumindo versão inicial (null).';\n      _current_ver := NULL; -- Trata como se fosse a versão inicial antes de 1.0.0\n  END;\n  RAISE NOTICE '[Migration Runner] Versão atual detectada: %. Versão alvo desta execução: %', COALESCE(_current_ver, 'Nenhuma (pré-1.0.0)'), _target_ver;\n\n  -- ============================================================\n  -- MIGRAÇÃO v1.1.0: sign_messages -> sign_messages_mode\n  -- ============================================================\n  -- Aplica SOMENTE SE a versão atual for anterior a 1.1.0\n  IF _current_ver IS NULL OR _current_ver < '1.1.0' THEN\n    RAISE NOTICE '[Migration v1.1.0] Aplicando alterações...';\n\n    -- 1.1: Adiciona coluna sign_messages_mode (se não existir)\n    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = _sch AND table_name = _tbl AND column_name = 'sign_messages_mode') THEN\n      RAISE NOTICE '[Migration v1.1.0] Adicionando coluna sign_messages_mode TEXT NOT NULL DEFAULT ''none''';\n      EXECUTE format('ALTER TABLE %I.%I ADD COLUMN sign_messages_mode TEXT NOT NULL DEFAULT ''none''', _sch, _tbl);\n      RAISE NOTICE '[Migration v1.1.0] Adicionando constraint chk_sign_messages_mode';\n      EXECUTE format('ALTER TABLE %I.%I ADD CONSTRAINT chk_sign_messages_mode CHECK (sign_messages_mode IN (''none'', ''assigned_name'', ''assigned_display_name'', ''logged_name'', ''logged_display_name''))', _sch, _tbl);\n    ELSE\n        RAISE NOTICE '[Migration v1.1.0] Coluna sign_messages_mode já existe.';\n    END IF;\n\n    -- 1.2: Migra dados da coluna antiga 'sign_messages' (se existir)\n    IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = _sch AND table_name = _tbl AND column_name = 'sign_messages') THEN\n      RAISE NOTICE '[Migration v1.1.0] Migrando dados de sign_messages (boolean) para sign_messages_mode (text)';\n      -- Atualiza apenas os registros que ainda não foram migrados (garantia extra)\n      EXECUTE format('UPDATE %I.%I SET sign_messages_mode = CASE WHEN sign_messages = true THEN ''assigned_display_name'' ELSE ''none'' END WHERE sign_messages IS NOT NULL AND (sign_messages_mode = ''none'' OR sign_messages_mode IS NULL);', _sch, _tbl);\n      RAISE NOTICE '[Migration v1.1.0] Removendo coluna antiga sign_messages';\n      EXECUTE format('ALTER TABLE %I.%I DROP COLUMN sign_messages', _sch, _tbl);\n    ELSE\n        RAISE NOTICE '[Migration v1.1.0] Coluna antiga sign_messages não encontrada para remover/migrar.';\n    END IF;\n\n    RAISE NOTICE '[Migration v1.1.0] Alterações concluídas.';\n  ELSE\n    RAISE NOTICE '[Migration v1.1.0] Schema já está na versão % ou superior. Nenhuma alteração aplicada para v1.1.0.', COALESCE(_current_ver, 'N/A');\n  END IF; -- Fim do IF _current_ver < '1.1.0'\n\n\n  -- ============================================================\n  -- PLACEHOLDER PARA PRÓXIMA MIGRAÇÃO (Exemplo: v1.2.0)\n  -- ============================================================\n  /*\n  -- Aplica SOMENTE SE a versão atual for anterior a 1.2.0\n  IF _current_ver IS NULL OR _current_ver < '1.2.0' THEN\n    RAISE NOTICE '[Migration v1.2.0] Aplicando alterações...';\n\n    -- Adicione aqui os comandos ALTER TABLE, UPDATE, etc. para a v1.2.0\n    -- Exemplo: EXECUTE format('ALTER TABLE %I.%I ADD COLUMN nova_feature BOOLEAN DEFAULT false', _sch, _tbl);\n\n    RAISE NOTICE '[Migration v1.2.0] Alterações concluídas.';\n  ELSE\n     RAISE NOTICE '[Migration v1.2.0] Schema já está na versão % ou superior. Nenhuma alteração aplicada para v1.2.0.', COALESCE(_current_ver, 'N/A');\n  END IF; -- Fim do IF _current_ver < '1.2.0'\n  */\n\n\n  -- ============================================================\n  -- PASSO FINAL: Atualizar a versão registrada no banco\n  -- ============================================================\n  -- Garante que a tabela de versão exista\n  EXECUTE format('CREATE TABLE IF NOT EXISTS %I._schema_version (version TEXT PRIMARY KEY)', _sch);\n  -- Atualiza ou insere a versão ALVO desta execução do script\n  RAISE NOTICE '[Migration Runner] Atualizando _schema_version para %', _target_ver;\n  EXECUTE format('INSERT INTO %I._schema_version (version) VALUES (%L) ON CONFLICT (version) DO UPDATE SET version = EXCLUDED.version;', _sch, _target_ver);\n\nEND\n$$ LANGUAGE plpgsql;\n\n-- 3. Retorna sucesso se o script executou sem erro SQL\nSELECT true AS success, format('Schema verificado/atualizado para versão %s.', $3) AS message;","options":{"queryReplacement":"={{ [\n  String($('setUpdate')?.item?.json?.schema ?? ''),\n  String($('setUpdate')?.item?.json?.table_name ?? ''),\n  String($('setUpdate')?.item?.json?.version ?? '')\n] }}"}},"id":"74ade02b-f58e-4670-a83f-1137a8ae38a1","name":"updateTable","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1392,928],"credentials":{"postgres":{"id":"ytsC5GyVBe0JcBFW","name":"[Colbiflex] Postgres Chatwoot"}},"onError":"continueRegularOutput"}],"connections":{"executeManually":{"main":[[{"node":"setVariablesClean","type":"main","index":0}]]},"htmlConfig":{"main":[[{"node":"respondConfigUi","type":"main","index":0}]]},"authHeaderConfig":{"main":[[{"node":"authVerifyConfig","type":"main","index":0}]]},"authVerifyConfig":{"main":[[{"node":"checkTableData","type":"main","index":0}],[{"node":"noAuthMessage","type":"main","index":0}]]},"respondConfigUi":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"instanceUpsert":{"main":[[{"node":"formatDbResponse","type":"main","index":0}]]},"createTable":{"main":[[{"node":"formatDbResponse","type":"main","index":0}]]},"setDelete":{"main":[[{"node":"instanceDelete","type":"main","index":0}]]},"instanceDelete":{"main":[[{"node":"formatDbResponse","type":"main","index":0}]]},"checkTableData":{"main":[[{"node":"htmlConfig","type":"main","index":0}]]},"setCreate":{"main":[[{"node":"createTable","type":"main","index":0}]]},"setVariables":{"main":[[{"node":"authHeaderConfig","type":"main","index":0}]]},"setUpsert":{"main":[[{"node":"instanceUpsert","type":"main","index":0}]]},"formatDbResponse":{"main":[[{"node":"respondDbUpsert","type":"main","index":0}]]},"webhookData":{"main":[[{"node":"setVariables","type":"main","index":0}],[{"node":"requestVerify","type":"main","index":0}]]},"requestVerify":{"main":[[{"node":"setCreate","type":"main","index":0}],[{"node":"setUpdate","type":"main","index":0}],[{"node":"setUpsert","type":"main","index":0}],[{"node":"setDelete","type":"main","index":0}]]},"setVariablesClean":{"main":[[{"node":"databaseClean","type":"main","index":0}]]},"respondAuthConfig":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"respondDbUpsert":{"main":[[{"node":"endProcess","type":"main","index":0}]]},"noAuthMessage":{"main":[[{"node":"respondAuthConfig","type":"main","index":0}]]},"setUpdate":{"main":[[{"node":"updateTable","type":"main","index":0}]]},"updateTable":{"main":[[{"node":"formatDbResponse","type":"main","index":0}]]}},"authors":"system migration","name":null,"description":null,"autosaved":false},"tags":[{"updatedAt":"2025-11-16T22:16:21.421Z","createdAt":"2025-11-16T22:16:21.421Z","id":"aawu1QmRhGC0eQOa","name":"Uazapi"},{"updatedAt":"2025-11-20T17:34:44.792Z","createdAt":"2025-11-20T17:34:44.792Z","id":"RhIrKuplA6oJB0ck","name":"Premium"},{"updatedAt":"2025-11-20T17:34:44.828Z","createdAt":"2025-11-20T17:34:44.828Z","id":"ffkEJ4KMIqqIHfFo","name":"Chatwoot"}]}